# 診断時の部品リストアップ機能 詳細設計

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: 診断画面での部品リストアップ機能

---

## 1. 機能概要

### 1-1. 目的

整備士が診断時に交換が必要な部品をリストアップし、見積もり作成時に自動的に表示されるようにする。これにより、フロントスタッフの入力負荷を軽減し、診断結果から見積もりへの連携をスムーズにする。

### 1-2. 主要機能

1. **部品の追加**
   - 手動入力
   - 音声入力（スマホの音声認識）
   - カテゴリに応じたレコメンド

2. **部品情報の入力**
   - 部品名
   - 緊急度（緊急/推奨/任意）
   - 推奨理由
   - 写真・動画の紐付け

3. **見積もり画面への連携**
   - 診断時にリストアップした部品が自動表示
   - フロントスタッフが金額を入力

---

## 2. UI/UX設計

### 2-1. 診断画面への統合

#### 2-1-1. 画面レイアウト

```
┌─────────────────────────────────────────────┐
│ [←] 田中様 BMW X3 車検診断                  │
│ 整備士: 中村                                 │
├─────────────────────────────────────────────┤
│ ...（車両情報、検査項目など）                │
├─────────────────────────────────────────────┤
│ 🔧 診断時の交換部品リスト                    │
│ [＋部品を追加] [🎤 音声入力]                │
│                                              │
│ ┌─────────────────────────────────────────┐ │
│ │ フロントブレーキパッド                   │ │
│ │ [緊急] 残り2mm                           │ │
│ │ 💬 パッド残量2mm。ローターも段付き摩耗  │ │
│ │    あり。セット交換推奨。                │ │
│ │ [📷写真] [🎥動画] [削除]                │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│ ┌─────────────────────────────────────────┐ │
│ │ エアフィルター                           │ │
│ │ [推奨] 汚れあり                          │ │
│ │ 💬 交換推奨です。                        │ │
│ │ [📷写真] [削除]                         │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│ ...（スクロール可能）                        │
└─────────────────────────────────────────────┘
```

### 2-2. 部品追加ダイアログ

#### 2-2-1. 画面レイアウト

```
┌─────────────────────────────────────────────┐
│ 部品を追加                                  │
├─────────────────────────────────────────────┤
│ 部品名                                      │
│ ┌─────────────────────────────────────────┐ │
│ │ [フロントブレーキパッド]                │ │
│ │ [🎤 音声入力]                           │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│ 💡 よく使う部品                              │
│ ┌─────────────────────────────────────────┐ │
│ │ [エンジン・オイル] [オイルフィルタ]     │ │
│ │ [ブレーキパッド] [エアフィルター]       │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│ 緊急度                                       │
│ ○ 緊急  ○ 推奨  ○ 任意                      │
│                                              │
│ 推奨理由（任意）                              │
│ ┌─────────────────────────────────────────┐ │
│ │ [残り2mm。危険です。]                   │ │
│ │ [🎤 音声入力]                           │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│ 写真・動画                                   │
│ [📷 写真を追加] [🎥 動画を追加]            │
│                                              │
│ [キャンセル] [追加]                          │
└─────────────────────────────────────────────┘
```

### 2-3. 音声入力機能

#### 2-3-1. 音声入力の流れ

```
1. 「🎤 音声入力」ボタンをタップ
   ↓
2. マイクの使用許可を確認
   ↓
3. 録音開始（最大30秒）
   ↓
4. 音声認識（Web Speech API または OpenAI Whisper API）
   ↓
5. 認識されたテキストを表示
   ↓
6. 部品名の候補を表示（マッチした場合）
   ↓
7. ユーザーが確認・修正
   ↓
8. 確定
```

#### 2-3-2. 部品名の認識ロジック

**実装方法**:
1. **音声認識**: Web Speech API（ブラウザ標準）または OpenAI Whisper API
2. **部品名マッチング**: 認識されたテキストから部品名を抽出
   - 部品マスタデータベースと照合
   - カテゴリに応じた部品リストを優先的に検索
   - 部分一致でも候補として表示

**例**:
- 音声入力: "フロントブレーキパッド"
- 認識結果: "フロントブレーキパッド"
- 候補: ["フロントブレーキパッド", "フロントブレーキパッドセット"]

### 2-4. カテゴリに応じたレコメンド

#### 2-4-1. レコメンドロジック

**カテゴリ別のよく使う部品**:

- **エンジン・ルーム点検**:
  - エンジン・オイル
  - オイルフィルタ
  - エアフィルター
  - バッテリー
  - ファンベルト

- **足廻り点検**:
  - フロントブレーキパッド
  - リアブレーキパッド
  - ブレーキローター
  - タイヤ

- **下廻り点検**:
  - ショックアブソーバー
  - スタビライザーリンク
  - ボールジョイント

- **外廻り点検**:
  - ワイパーブレード
  - ヘッドライトバルブ
  - テールライトバルブ

#### 2-4-2. 自動提案機能

**「要交換」と判定した検査項目から自動提案**:

```
検査項目: 「ブレーキパッド」→ 状態: 「要交換」
  ↓
自動提案: 「フロントブレーキパッド」「リアブレーキパッド」
  ↓
整備士が選択または追加
```

**実装方法**:
- 検査項目と部品のマッピングテーブルを作成
- 「要交換」と判定された項目から関連部品を自動提案
- 整備士が確認・修正可能

---

## 3. データモデル

### 3-1. DiagnosisPart（診断時の交換部品）

```typescript
/**
 * 診断時の交換部品（見積もり用）
 */
interface DiagnosisPart {
  /** 部品ID（一意） */
  id: string;
  
  /** 部品名（例: "フロントブレーキパッド"） */
  itemName: string;
  
  /** カテゴリ（どの検査項目から提案されたか） */
  category: InspectionCategory;
  
  /** 関連する検査項目ID */
  relatedItemId: string | null;
  
  /** 推奨理由（例: "残り2mm。危険です"） */
  reason?: string;
  
  /** 緊急度 */
  urgency: "緊急" | "推奨" | "任意";
  
  /** 写真URLの配列 */
  photos: string[];
  
  /** 動画URLの配列 */
  videos: string[];
  
  /** 作成日時 */
  createdAt: string;
  
  /** 更新日時 */
  updatedAt: string;
}
```

### 3-2. 部品マスタ

```typescript
/**
 * 部品マスタ
 */
interface PartMaster {
  /** 部品ID */
  id: string;
  
  /** 部品名 */
  name: string;
  
  /** カテゴリ */
  category: InspectionCategory;
  
  /** よくある交換理由 */
  commonReasons: string[];
  
  /** 音声認識用の別名（例: ["ブレーキパッド", "パッド"]） */
  aliases: string[];
}
```

---

## 4. API設計

### 4-1. 部品の追加

```typescript
/**
 * 診断時の部品を追加
 */
POST /api/jobs/:jobId/inspection/parts

Request: {
  itemName: string;
  category: InspectionCategory;
  relatedItemId?: string;
  reason?: string;
  urgency: "緊急" | "推奨" | "任意";
  photos?: string[];
  videos?: string[];
}

Response: {
  success: boolean;
  data: DiagnosisPart;
}
```

### 4-2. 部品の削除

```typescript
/**
 * 診断時の部品を削除
 */
DELETE /api/jobs/:jobId/inspection/parts/:partId

Response: {
  success: boolean;
}
```

### 4-3. 部品レコメンドの取得

```typescript
/**
 * カテゴリに応じた部品レコメンドを取得
 */
GET /api/parts/recommendations?category={category}

Response: {
  success: true;
  data: {
    parts: PartMaster[];
  };
}
```

### 4-4. 音声入力による部品名の認識

```typescript
/**
 * 音声入力をテキストに変換（部品名認識）
 */
POST /api/parts/speech-to-text

Request: FormData {
  audio: Blob;  // 音声データ
  category?: InspectionCategory;  // カテゴリ（文脈を考慮）
}

Response: {
  success: boolean;
  data: {
    text: string;  // 認識されたテキスト
    suggestions: PartMaster[];  // 部品名の候補（マッチした場合）
  };
}
```

---

## 5. 見積もり画面への連携

### 5-1. データフロー

```
1. 診断画面で部品をリストアップ
   ↓
2. 診断データに保存（InspectionData.diagnosisParts）
   ↓
3. 診断完了
   ↓
4. 見積もり画面を開く
   ↓
5. 診断データから部品リストを取得
   ↓
6. 部品リストを自動表示
   ↓
7. フロントスタッフが金額を入力
   ↓
8. 見積もりを作成
```

### 5-2. 見積もり画面での表示

```
┌─────────────────────────────────────────────┐
│ 🔧 部品代・工賃                              │
│ [＋項目を追加]                               │
│                                              │
│ ┌─────────────────────────────────────────┐ │
│ │ フロントブレーキパッド交換              │ │
│ │ [📷] [🎥] [緊急] 残り2mm                │ │
│ │ 💬 パッド残量2mm。危険です。            │ │
│ │ 金額: [¥33,000]                        │ │
│ │ [削除]                                   │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│ ┌─────────────────────────────────────────┐ │
│ │ エアフィルター交換                       │ │
│ │ [📷] [推奨] 汚れあり                     │ │
│ │ 💬 交換推奨です。                        │ │
│ │ 金額: [¥5,000]                          │ │
│ │ [削除]                                   │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

**UI/UXのポイント**:
- 診断時にリストアップした部品は自動的に表示
- 緊急度をバッジで表示（緊急: 赤、推奨: 黄、任意: 青）
- 写真・動画を表示（タップで拡大・再生）
- 推奨理由を表示
- フロントスタッフが金額を入力
- 不要な部品は削除可能

---

## 6. 実装の優先順位

### Phase 1: MVP（最小限の機能）

1. **部品の手動追加**
   - 部品名の入力
   - 緊急度の選択
   - 推奨理由の入力

2. **見積もり画面への連携**
   - 診断時の部品リストを表示
   - 金額の入力

### Phase 2: 拡張機能

1. **音声入力機能**
   - 音声認識
   - 部品名の自動入力

2. **レコメンド機能**
   - カテゴリに応じた部品レコメンド
   - 自動提案機能

3. **写真・動画の紐付け**
   - 部品に写真・動画を紐付け
   - 見積もり画面で表示

---

## 7. 技術的な実装要件

### 7-1. 音声認識

**実装方法**:
1. **Web Speech API**（ブラウザ標準）
   - メリット: 追加ライブラリ不要
   - デメリット: ブラウザ依存、精度が低い場合がある

2. **OpenAI Whisper API**
   - メリット: 高精度、日本語対応
   - デメリット: APIコスト、ネットワーク必須

**推奨**: 初期はWeb Speech API、必要に応じてWhisper APIに切り替え

### 7-2. 部品マスタデータベース

**データソース**:
- 既存の部品マスタ（基幹システム）
- または、アプリ内でマスタデータを作成

**実装方法**:
- JSONファイルまたはデータベースで管理
- カテゴリ、別名、よくある交換理由を含む

### 7-3. 自動提案機能

**実装方法**:
- 検査項目と部品のマッピングテーブルを作成
- 「要交換」と判定された項目から関連部品を検索
- 整備士に候補を表示

---

## 更新履歴

- 2025-01-XX: 初版作成



























