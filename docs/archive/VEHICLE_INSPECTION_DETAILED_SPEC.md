# 車検（法定24ヶ月点検）詳細設計仕様書

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: 車検（法定24ヶ月点検）のシステム設計
- **設計方針**: 世界最高のUI/UX、ITコンサルの目線での推奨を元に設計

---

## 1. 設計前提とユーザー要件

### 1-1. ユーザープロファイル

#### 整備士（主要ユーザー）
- **年齢**: 50代以上が中心
- **デバイス**: スマートフォン、タブレット
- **作業環境**: 
  - 手が汚れている状態で操作
  - 工場内でWi-Fiが届かない場所もある
  - 複数日にわたる作業
- **技術レベル**: スマホ操作は基本的にできるが、複雑な操作は苦手
- **作業スタイル**: 
  - 効率的に作業を進めたい
  - ミスを防ぎたい
  - 写真撮影と入力の両立

#### フロントスタッフ
- **年齢**: 30代〜50代
- **デバイス**: PC（デスクトップ/ノートPC）
- **作業環境**: カウンターで顧客対応しながら操作
- **技術レベル**: PC操作に慣れている

#### 顧客
- **年齢**: 30代〜60代
- **デバイス**: スマートフォン
- **技術レベル**: 基本的なスマホ操作は可能

### 1-2. 業務特性

- **複数日対応**: 基本は複数日（海外からの部品取り寄せなど）
- **検査項目**: 100項目以上（分解整備記録簿に基づく）
- **測定値**: CO・HC濃度、タイヤ溝深さ、ブレーキパッド厚さなど
- **写真撮影**: 不具合箇所の証拠写真
- **PDF出力**: 最終的に分解整備記録簿の形式でPDF出力

---

## 2. 確認が必要な不明点

### 2-1. 検査項目の入力方法

**質問1**: 検査項目は一度に全て入力しますか？それともカテゴリごとに入力しますか？

**推奨案（UI/UXベストプラクティス）**: ✅ **採用**

**「カテゴリごとの入力」の意味**:
- 100項目以上の検査項目を、6つのカテゴリ（エンジン・ルーム点検、室内点検、足廻り点検、下廻り点検、外廻り点検、日常点検）に分けて表示
- 画面の上部にタブを表示し、整備士が「エンジン・ルーム点検」のタブを選ぶと、そのカテゴリの項目だけが表示される
- 全ての項目を一度にスクロールするのではなく、カテゴリごとに切り替えて入力する方式

**設計決定**:
- **入庫区分が「車検」の場合**: PDFテンプレート（24か月点検用テンプレート.pdf）に基づき、6つのカテゴリ全てが表示される
  - エンジン・ルーム点検（デフォルト選択）
  - 室内点検
  - 足廻り点検
  - 下廻り点検
  - 外廻り点検
  - 日常点検
- タブ形式でカテゴリを表示（手動でも切り替え可能）
- 各カテゴリの完了状況を表示（例: 「エンジン・ルーム点検 15/20項目完了」）
- カテゴリごとに「完了」ボタンで一時保存
- 各項目の入力時に自動保存も実施
- 整備士は1つのカテゴリを完了してから次のカテゴリに進む（または途中で切り替え可能）

### 2-2. 作業の一時保存と再開

**質問2**: 作業を途中で中断した場合、どのように再開しますか？

**推奨案**: ✅ **採用**
- **自動保存**: 各項目の入力時に自動保存
- **明示的な保存**: カテゴリ完了時に「保存」ボタン
- **再開時の表示**: 未完了のカテゴリを強調表示
- **オフライン対応**: オフライン時もローカルストレージに保存、オンライン復帰時に自動同期

### 2-3. 測定値の入力方法

**質問3**: 測定値（CO・HC濃度、タイヤ溝深さ、ブレーキパッド厚さ）は、どのタイミングで入力しますか？

**推奨案**:
- **専用の測定値入力画面**を用意
  - 理由: 測定値は検査項目とは別のタイミングで測定されることが多い
  - 測定値入力画面で一括入力
  - 各測定値に写真を紐付け可能

### 2-4. 写真撮影のタイミング

**質問4**: 写真は各項目ごとに撮影しますか？それとも不具合が見つかった項目のみ撮影しますか？

**推奨案**: ✅ **採用**
- **不具合が見つかった項目のみ撮影**を推奨
  - 理由: 全ての項目に写真を撮るのは非効率
  - 「要交換」「注意」と判定した項目のみ写真・動画撮影を促す
  - 写真・動画は後から追加可能
  - **動画**: 異音など写真では伝わらない場合に使用（最大15秒）
  - **動画の保存先**: Google Drive

### 2-5. PDF出力のタイミング

**質問5**: 分解整備記録簿（PDF）はいつ出力しますか？

**推奨案**:
- **作業完了時**に出力
  - 理由: 全ての情報が揃った状態で出力する
  - 顧客承認前でも、整備士の記録として保存
  - 顧客承認後、最終版を再出力可能

### 2-6. 省略規則の適用

**質問6**: 省略規則（☆印は1年5,000km以下、★印は2年10,000km以下）は、システムで自動判定しますか？

**推奨案**:
- **自動判定**を推奨
  - 走行距離と経過年数を入力
  - 該当する項目を自動で「省略」に設定
  - 整備士が確認・修正可能

### 2-7. 交換部品の記録方法

**質問7**: 交換部品は、診断時に入力しますか？それとも作業時に入力しますか？

**推奨案**:
- **作業時に入力**を推奨
  - 理由: 診断時点では交換する部品が確定していない
  - 作業完了時に、実際に交換した部品を記録
  - 見積もりで提案した部品と、実際に交換した部品が異なる場合に対応

### 2-8. 整備主任者の記録

**質問8**: 整備主任者の氏名は、どのように記録しますか？

**推奨案**:
- **診断開始時に選択**（既存の整備士選択機能を活用）
- **作業完了時に確認・修正可能**

### 2-9. 見積もり画面での法定費用表示

**質問9**: 見積もり画面では、法定費用をどのように表示しますか？

**推奨案**:
- **内訳を表示**（車検費用、重量税、自賠責保険、印紙代など）
- **合計金額を大きく表示**
- **法定費用と部品代・工賃を明確に区分**

### 2-10. 部品代・工賃の入力者

**質問10**: 部品代・工賃は、誰が入力しますか？

**推奨案**:
- **フロントスタッフ（事務員）が入力**を推奨
  - 理由: 正確な金額は基幹システムで計算される
  - 整備士は診断結果のみ入力
  - フロントスタッフが基幹システムの金額を転記

### 2-11. 顧客承認後の作業指示

**質問11**: 顧客承認後、整備士に作業指示はどのように伝えますか？

**推奨案**:
- **作業画面に自動表示**
  - 承認された項目のみ表示
  - 見送られた項目は非表示またはグレーアウト
  - 通知機能で整備士に知らせる

### 2-12. 車検証更新手続きの記録

**質問12**: 車検証更新手続きは、誰が行いますか？システムでどのように記録しますか？

**推奨案**:
- **フロントスタッフが記録**
  - 更新日時を入力
  - 次回車検予定日を自動計算（2年後）
  - Google Sheets「【DB】車両マスタ」の「車検有効期限」を更新

### 2-13. 複数日の進捗管理

**質問13**: 複数日にわたる作業の場合、どのように進捗を管理しますか？

**推奨案**:
- **ステータス管理**:
  - 診断完了
  - 見積提示済み
  - 顧客承認待ち
  - 部品調達中
  - 作業中
  - 作業完了
  - 出庫待ち
  - 出庫済み
- **各ステータスで表示する情報を変更**

### 2-14. エラー処理

**質問14**: データ入力時のエラーは、どのように処理しますか？

**推奨案**:
- **リアルタイムバリデーション**
  - 必須項目の未入力チェック
  - 測定値の範囲チェック（例: タイヤ溝深さは1.6mm以上）
  - エラーメッセージを分かりやすく表示

### 2-15. オフライン対応

**質問15**: オフライン時の動作はどうしますか？

**推奨案**: ✅ **採用**
- **オフラインでも入力可能**
  - ローカルストレージに一時保存
  - オンライン復帰時に自動同期
  - オフライン状態を明示的に表示

### 2-16. PDFテンプレートの解析方法

**質問16**: PDFテンプレートは自動解析しますか？それとも手動で項目リストを作成しますか？

**回答**: ✅ **自動解析でも手動でも良い（間違いなければ）**

**推奨案**:
- **初期実装**: 手動で項目リストを作成（確実性を優先）
- **将来改善**: PDF自動解析機能を追加（効率化）

**理由**:
- 手動作成の方が確実
- 自動解析は誤認識のリスクがある
- 初期実装では確実性を優先し、後で効率化

### 2-17. 車両マスタのシート構造

**質問17**: 「【DB】車両マスタ」内の「車両_同期用」シートの構造は？

**回答**: ✅ **「【DB】車両マスタ」内に「車両_同期用」は別シートとして存在**

**設計決定**:
- Google Sheets APIで「【DB】車両マスタ」スプレッドシートを開く
- 「車両_同期用」シートを指定してデータを取得
- 車両IDをキーに検索

---

## 3. 推奨設計案（UI/UXベストプラクティスに基づく）

上記の質問への回答を待ちながら、世界最高のUI/UX、ITコンサルの目線での推奨設計案を以下に示します。

### 3-1. 診断画面の設計

#### 画面構成

```
┌─────────────────────────────────────┐
│ [←] 田中様 BMW X3 車検診断          │
├─────────────────────────────────────┤
│ 📋 車両情報（自動入力済み）          │
│ 登録番号: 堺 330 す 1669            │
│ 車台番号: VF3CUHNZTHY061316         │
├─────────────────────────────────────┤
│ [タブ] エンジン・ルーム | 室内 | ... │
│ ─────────────────────────────────── │
│                                      │
│ [カテゴリ: エンジン・ルーム点検]      │
│ 進捗: 15/20項目完了                 │
│                                      │
│ ┌────────────────────────────────┐ │
│ │ パワー・ステアリング            │ │
│ │ [OK] [注意] [要交換] [調整]     │ │
│ │ [📷 写真を追加]                 │ │
│ └────────────────────────────────┘ │
│                                      │
│ ┌────────────────────────────────┐ │
│ │ 冷却装置                        │ │
│ │ [OK] [注意] [要交換] [調整]     │ │
│ └────────────────────────────────┘ │
│                                      │
│ ...（スクロール可能）                │
│                                      │
│ [測定値入力] [交換部品] [その他]    │
│                                      │
│ [一時保存] [診断完了]                │
└─────────────────────────────────────┘
```

#### UI/UXのポイント

1. **大きなタッチターゲット**
   - ボタンは最低48x48px（指で押しやすいサイズ）
   - 信号機ボタンは画面幅いっぱいに配置

2. **視覚的なフィードバック**
   - 選択した状態を明確に表示
   - 進捗バーで全体の進捗を表示
   - 完了したカテゴリはチェックマークを表示

3. **音声入力対応**
   - コメント入力欄にマイクボタン
   - 手が汚れている状態でも入力可能

4. **写真撮影の簡易化**
   - カメラボタンを大きく表示
   - 撮影後、すぐにプレビュー表示
   - 複数枚撮影可能

5. **自動保存**
   - 各項目の入力時に自動保存
   - 「保存しました」のトースト表示（邪魔にならない程度に）

### 3-2. 測定値入力画面の設計

```
┌─────────────────────────────────────┐
│ [←] 測定値入力                      │
├─────────────────────────────────────┤
│ CO、HC濃度（アイドリング時）         │
│ CO:  [____] %                       │
│ HC:  [____] ppm                     │
│ [📷 測定値の写真]                   │
├─────────────────────────────────────┤
│ タイヤの溝の深さ（1.6mm以上）        │
│ 前輪左: [____] mm                   │
│ 前輪右: [____] mm                   │
│ 後輪左: [____] mm                   │
│ 後輪右: [____] mm                   │
│ [📷 タイヤの写真]                   │
├─────────────────────────────────────┤
│ ブレーキ・パッド、ライニングの厚さ   │
│ 前輪左: [____] mm                   │
│ 前輪右: [____] mm                   │
│ 後輪左: [____] mm                   │
│ 後輪右: [____] mm                   │
│ [📷 ブレーキパッドの写真]           │
├─────────────────────────────────────┤
│ [保存] [診断画面に戻る]              │
└─────────────────────────────────────┘
```

#### UI/UXのポイント

1. **数値入力の簡易化**
   - 数字キーパッドを表示
   - 単位を明示（mm、%、ppm）
   - 範囲チェック（例: タイヤ溝深さは1.6mm以上）

2. **写真との紐付け**
   - 各測定値に写真を紐付け可能
   - 測定中の写真を撮影できる

### 3-3. 見積もり画面の設計

```
┌─────────────────────────────────────┐
│ [←] 田中様 BMW X3 見積もり          │
├─────────────────────────────────────┤
│ 📋 法定費用（自動取得）              │
│ ┌────────────────────────────────┐ │
│ │ 車検（24ヶ月）    ¥66,000      │ │
│ │ 自動車重量税      ¥24,600      │ │
│ │ 自賠責保険料      ¥17,650      │ │
│ │ 印紙代            ¥2,300       │ │
│ │ 代行手数料        ¥19,800      │ │
│ │ ──────────────────────────── │ │
│ │ 法定費用合計      ¥130,350     │ │
│ └────────────────────────────────┘ │
├─────────────────────────────────────┤
│ 🔧 部品代・工賃                      │
│ [＋項目を追加]                       │
│                                      │
│ ┌────────────────────────────────┐ │
│ │ フロントブレーキパッド交換      │ │
│ │ [📷] [要交換] 残り2mm          │ │
│ │ 金額: [¥33,000]                │ │
│ │ [削除]                          │ │
│ └────────────────────────────────┘ │
│                                      │
│ ...（スクロール可能）                │
├─────────────────────────────────────┤
│ 💰 合計（税込）                      │
│        ¥163,350                     │
│                                      │
│ [プレビュー] [LINEで送信]            │
└─────────────────────────────────────┘
```

#### UI/UXのポイント

1. **法定費用の明確な表示**
   - 自動取得した法定費用を内訳表示
   - 合計金額を大きく表示
   - 法定費用と部品代・工賃を明確に区分

2. **部品代・工賃の入力**
   - 診断結果から自動で項目を追加
   - 写真とコメントを紐付け
   - 金額は手動入力（基幹システムから転記）

3. **顧客への説明資料**
   - プレビュー機能で顧客の見え方を確認
   - 写真付きで分かりやすく表示

### 3-4. 作業画面の設計

```
┌─────────────────────────────────────┐
│ [←] 田中様 BMW X3 作業中            │
├─────────────────────────────────────┤
│ 📋 承認された作業項目                │
│                                      │
│ ┌────────────────────────────────┐ │
│ │ ✅ フロントブレーキパッド交換    │ │
│ │ [Before写真] [After写真]        │ │
│ │ [📷 写真を追加]                 │ │
│ │ [完了]                          │ │
│ └────────────────────────────────┘ │
│                                      │
│ ┌────────────────────────────────┐ │
│ │ ⏳ エアフィルター交換             │ │
│ │ [Before写真]                    │ │
│ │ [📷 After写真を追加]            │ │
│ │ [完了]                          │ │
│ └────────────────────────────────┘ │
│                                      │
│ [交換部品を記録]                    │
│                                      │
│ [作業完了]                           │
└─────────────────────────────────────┘
```

#### UI/UXのポイント

1. **承認された項目のみ表示**
   - 見送られた項目は非表示
   - 完了した項目はチェックマークを表示
   - 進捗が一目で分かる

2. **Before/After写真**
   - 並べて比較表示
   - タップで拡大表示

3. **交換部品の記録**
   - 作業完了時に記録
   - 実際に交換した部品を記録

---

## 4. データフロー

### 4-1. 診断開始から完了まで

```
1. 整備士が診断画面を開く
   ↓
2. 車両情報を自動取得（Google Sheets「【DB】車両マスタ」）
   ↓
3. 検査項目を表示（PDFテンプレートから）
   ↓
4. 整備士が各項目を入力
   - 状態を選択（OK/注意/要交換/調整/清掃/省略/該当なし）
   - 測定値を入力
   - 写真を撮影
   ↓
5. 自動保存（各項目入力時）
   ↓
6. 診断完了ボタンを押す
   ↓
7. データをZoho CRMに保存
   - field7（詳細情報）に診断結果を保存
   - 写真をGoogle Driveにアップロード
   - field19（お客様共有フォルダ）にフォルダURLを保存
   ↓
8. フロントスタッフに通知
```

### 4-2. 見積もり作成から顧客承認まで

```
1. フロントスタッフが見積もり画面を開く
   ↓
2. 法定費用を自動取得（Google Sheets「【DB】車両マスタ」）
   ↓
3. 診断結果から部品代・工賃の項目を追加
   ↓
4. フロントスタッフが金額を入力（基幹システムから転記）
   ↓
5. プレビューで確認
   ↓
6. 顧客に送信（LINE/メール/SMS）
   ↓
7. 顧客が承認
   ↓
8. 承認された項目をZoho CRMに保存
   - field13（作業内容）に承認された項目を保存
   - field5（工程ステージ）を「作業待ち」に更新
   ↓
9. 整備士に通知
```

### 4-3. 作業完了からPDF出力まで

```
1. 整備士が作業画面を開く
   ↓
2. 承認された項目のみ表示
   ↓
3. 各項目の作業を実施
   - Before/After写真を撮影
   - 交換部品を記録
   ↓
4. 作業完了ボタンを押す
   ↓
5. 交換部品を記録
   ↓
6. 分解整備記録簿（PDF）を生成
   - 入力した検査項目をPDFテンプレートに転記
   - 測定値を転記
   - 交換部品を転記
   - 車両情報を自動入力
   ↓
7. PDFをGoogle Driveに保存
   ↓
8. Zoho CRMのfield19（お客様共有フォルダ）にURLを保存
   ↓
9. フロントスタッフに通知
```

---

## 5. 技術的な実装要件

### 5-1. データ構造

#### 検査項目データ

```typescript
interface InspectionItem {
  id: string;
  category: "エンジン・ルーム点検" | "室内点検" | "足廻り点検" | "下廻り点検" | "外廻り点検" | "日常点検";
  subCategory: string; // "パワー・ステアリング", "冷却装置", etc.
  itemName: string; // 具体的な項目名
  status: "正常" | "注意" | "要交換" | "調整" | "清掃" | "省略" | "該当なし" | null;
  measurement?: number; // 測定値（該当する場合）
  photos: string[]; // 写真URLの配列
  comment?: string; // コメント
  skipRule?: "☆" | "★"; // 省略規則
  isRequired: boolean; // 法定項目かどうか
  createdAt: string;
  updatedAt: string;
}

interface InspectionData {
  jobId: string;
  vehicleId: string;
  mechanicName: string;
  items: InspectionItem[];
  measurements: {
    co: number | null; // CO濃度（%）
    hc: number | null; // HC濃度（ppm）
    tireDepth: {
      前輪左: number | null;
      前輪右: number | null;
      後輪左: number | null;
      後輪右: number | null;
    };
    brakePadThickness: {
      前輪左: number | null;
      前輪右: number | null;
      後輪左: number | null;
      後輪右: number | null;
    };
  };
  replacedParts: {
    itemName: string;
    quantity: number;
    unit: string; // "l", "個", etc.
  }[];
  otherItems?: string; // その他の点検項目等
  inspectionDate: string; // 点検の年月日
  completionDate: string | null; // 整備完了年月日
  totalMileage: number; // 点検(整備)時の総走行距離
  status: "入力中" | "診断完了" | "見積提示済み" | "顧客承認待ち" | "作業中" | "作業完了";
  createdAt: string;
  updatedAt: string;
}
```

### 5-2. API設計

#### 検査項目の取得

```typescript
// 検査項目テンプレートを取得（PDFから解析、またはマスタデータから取得）
GET /api/inspection-templates/vehicle-inspection

Response: {
  categories: {
    name: string;
    items: InspectionItem[];
  }[];
}
```

#### 検査データの保存

```typescript
// 検査データを保存（一時保存）
POST /api/jobs/:jobId/inspection

Request: {
  items: InspectionItem[];
  measurements: {...};
  status: "入力中" | "診断完了";
}

Response: {
  success: boolean;
  data: InspectionData;
}
```

#### 法定費用の取得

```typescript
// 車両IDから法定費用を取得
GET /api/vehicles/:vehicleId/legal-fees

Response: {
  自動車重量税: number;
  印紙代: number;
  "車検（24ヶ月）": number;
  "12ヶ月点検": number;
  代行手数料: number;
  自賠責保険料: number;
  テスター代: number;
  車検_法定外費用: number;
  車検_法定費用: number;
  車検_総額: number;
}
```

#### PDF生成

```typescript
// 分解整備記録簿（PDF）を生成
POST /api/jobs/:jobId/inspection/pdf

Response: {
  success: boolean;
  pdfUrl: string; // Google DriveのURL
}
```

### 5-3. オフライン対応

- **Service Worker**: オフライン時もアプリが動作
- **IndexedDB**: ローカルストレージにデータを保存
- **Background Sync**: オンライン復帰時に自動同期

---

## 6. 確認済み事項

### 6-1. 車両マスタのシート構造

**確認済み**: 「【DB】車両マスタ」内に「車両_同期用」は別シートとして存在します。

**設計決定**:
- Google Sheets APIで「【DB】車両マスタ」スプレッドシートを開く
- 「車両_同期用」シートを指定してデータを取得
- 車両IDをキーに検索

### 6-2. PDFテンプレートの解析方法

**確認済み**: PDFは自動解析でも手動でも良い（間違いなければ）

**設計決定**:
- **初期実装**: 手動で項目リストを作成（確実性を優先）
- **将来改善**: PDF自動解析機能を追加（効率化）

---

## 7. 次のステップ

1. ✅ **不明点の確認**: 主要な不明点は解決済み
2. ✅ **詳細設計の確定**: 完全設計仕様書を作成済み
3. **プロトタイプ作成**: 主要画面のプロトタイプを作成
4. **ユーザーテスト**: 整備士にプロトタイプをテストしてもらう
5. **実装開始**: フィードバックを反映して実装開始

---

## 更新履歴

- 2025-01-XX: 初版作成
- 2025-01-XX: 確認済み事項を追加（車両マスタ、PDF解析方法）
- 2025-01-XX: 動画機能と診断時の部品リストアップ機能を追加



























