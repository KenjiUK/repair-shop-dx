# レストア 画面設計書

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.1
- **対象**: レストアの各画面の詳細設計
- **設計方針**: 世界最高のUI/UX、ITコンサルの目線での推奨を元に設計
- **業務フローパターン**: パターンA（入庫→診断→見積→承認→作業）
- **注意**: 長期プロジェクト（数週間から数カ月、場合によっては数年）、イレギュラーが多い、フェーズ管理、マイルストーン管理、進捗管理、部品取り寄せ管理、Before/After写真必須、PDF生成（独自フォーマット）

---

## 複数作業管理対応

この画面設計書は、1つの入庫に対して複数の作業を管理する「複数作業管理」に対応しています。

**対応内容**:
- 各画面は特定のワークオーダー（作業）に対応
- URLパラメータ `workOrderId` で対象ワークオーダーを識別
- 画面ヘッダーに現在の作業名を表示
- 「他の作業を表示」ボタンで同じJobの他のワークオーダーに切替可能
- データはZoho CRM `field_work_orders` フィールドに作業ごとに保存
- **長期プロジェクト**: レストアは長期プロジェクトのため、追加作業・見積もり変更が発生する可能性が高い

**詳細は [統合仕様書](./INTEGRATED_SPECIFICATION.md) の「2-4. 複数作業管理の実装」を参照してください。**

---

## 1. 画面一覧

### 1-1. フロントスタッフ向け画面

1. **受付画面** (`/admin/reception/[id]`)
   - 走行距離の入力
   - 前回レストア履歴の表示
   - 口頭見積メモの記録（参考程度）

### 1-2. 整備士向け画面

1. **診断画面** (`/mechanic/diagnosis/[id]`)
   - 現状確認（車体、エンジン、内装、電装系など）
   - 修復箇所の確認
   - レストアの種類選択（フルレストア/部分レストア）
   - Before写真の撮影（必須）

2. **見積画面** (`/admin/estimate/[id]`)
   - 修復内容、部品、作業内容に基づいて見積もりを作成
   - 部品リストの管理（取り寄せ状況、到着予定日、遅延アラート）
   - 作業期間の設定（かなり長期）
   - 追加作業の管理（イレギュラー対応）
   - 見積もりの変更履歴

3. **作業画面** (`/mechanic/work/[id]`)
   - フェーズ管理（分解、診断・評価、部品発注、修復、組み立て、仕上げ、最終確認）
   - マイルストーン管理
   - 進捗管理（0-100%）
   - 作業記録の入力（フェーズごと）
   - 作業中の写真撮影
   - 使用した部品の記録
   - 追加作業の記録（イレギュラー対応）
   - 見積もりの変更
   - 作業期間の延長

4. **引渡画面** (`/customer/handover/[id]`)
   - 修復内容の説明
   - After写真の表示（必須）
   - PDF生成（レストア完了報告書）

### 1-3. 特徴

- **長期プロジェクト**: 数週間から数カ月、場合によっては数年
- **イレギュラー対応**: 追加作業、見積もりの変更、部品の取り寄せ遅延など
- **フェーズ管理**: 7つのフェーズで作業を管理
- **マイルストーン管理**: 各フェーズの完了をマイルストーンとして管理
- **進捗管理**: 作業進捗を0-100%で管理
- **部品取り寄せ管理**: 部品の状態、到着予定日、遅延アラート
- **写真管理**: Before写真（必須）、作業中の写真、After写真（必須）
- **PDF生成**: レストア完了報告書（独自フォーマット）

---

## 2. 受付画面の詳細設計

### 2-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 レストア受付           │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ │ 初度登録: H29.10                    │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📏 走行距離                            │
│ ┌─────────────────────────────────────┐ │
│ │ 現在の走行距離: [____] km           │ │
│ │                                      │ │
│ │ 前回レストア履歴:                    │ │
│ │ 2020年3月: フルレストア             │ │
│ │ 2015年8月: エンジンレストア          │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💬 口頭見積メモ（参考程度）              │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  顧客との口頭での見積もり内容、     │ │
│ │  希望するレストア内容など            │ │
│ │  （参考程度として記録）              │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🚗 代車提供                            │
│ ┌─────────────────────────────────────┐ │
│ │ [ ] 代車を提供する                   │ │
│ │                                      │ │
│ │ （チェックした場合のみ表示）          │ │
│ │ 代車: [▼] 選択してください          │ │
│ │                                      │ │
│ │ ⚠️ セカンドカーが多いので大抵は      │ │
│ │   代車の提供は不要です。              │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 備考                                │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  その他の情報、特記事項など          │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│           [入庫確定]                    │
└─────────────────────────────────────────┘
```

### 2-2. コンポーネント設計

#### 走行距離セクション

**目的**: 現在の走行距離を記録し、前回のレストア履歴を表示

**UI要素**:
- **走行距離入力**: 数値入力フィールド（km単位）
- **前回履歴表示**: 過去のレストア履歴をリスト表示

**データソース**:
- 前回履歴: Zoho CRMから取得（同じ車両IDの過去のレストアジョブ）

#### 口頭見積メモセクション

**目的**: 顧客との口頭での見積もり内容を参考程度として記録

**UI要素**:
- **口頭見積メモ入力**: テキストエリア
- **注意メッセージ**: 参考程度であることを明示

**動作**:
- 口頭見積メモは参考程度として記録
- 実際の見積もりは診断後に作成

#### 代車提供セクション

**目的**: 代車の提供有無を記録（ケースバイケース、大抵は不要）

**UI要素**:
- **代車提供チェックボックス**: チェックボックス
- **代車選択**: ドロップダウン（チェックした場合のみ表示）
- **注意メッセージ**: セカンドカーが多いので大抵は不要であることを明示

**データソース**:
- 代車リスト: Google Sheets「【DB】代車マスタ」から取得

### 2-3. データフロー

1. **画面表示時**:
   - 車両情報を自動入力（編集不可）
   - 前回レストア履歴を取得して表示
   - 利用可能な代車リストを取得

2. **入庫確定時**:
   - 走行距離、口頭見積メモ、代車情報を保存
   - Jobステータスを「診断中」に更新

---

## 3. 診断画面の詳細設計

### 3-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 レストア診断            │
├─────────────────────────────────────────┤
│ 📋 車両情報（参照のみ）                  │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 走行距離: 45,000 km                 │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 レストアの種類                       │
│ ┌─────────────────────────────────────┐ │
│ │ [✓] フルレストア                     │ │
│ │ [ ] 部分レストア                     │ │
│ │ [ ] その他                           │ │
│ │                                      │ │
│ │ （選択に応じて診断項目が変化）        │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 現状確認                             │
│ ┌─────────────────────────────────────┐ │
│ │ [+ 確認項目を追加]                  │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 確認項目 #1                     │ │ │
│ │ │                                │ │ │
│ │ │ 箇所: [▼] 車体                  │ │ │
│ │ │  車体 / エンジン / 内装 /        │ │ │
│ │ │  電装系 / その他                │ │ │
│ │ │                                │ │ │
│ │ │ 状態: [▼] 中程度の劣化          │ │ │
│ │ │  良好 / 軽微な劣化 /            │ │ │
│ │ │  中程度の劣化 / 深刻な劣化 /    │ │ │
│ │ │  修復必要                        │ │ │
│ │ │                                │ │ │
│ │ │ 📷 写真: [写真を撮影]            │ │ │
│ │ │ [画像プレビュー]                │ │ │
│ │ │                                │ │ │
│ │ │ コメント:                       │ │ │
│ │ │ ────────────────────────────── │ │ │
│ │ │                                │ │ │
│ │ │ [削除]                          │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 修復箇所                             │
│ ┌─────────────────────────────────────┐ │
│ │ [+ 修復箇所を追加]                  │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 修復箇所 #1                     │ │ │
│ │ │                                │ │ │
│ │ │ 部位: [▼] フロントバンパー      │ │ │
│ │ │                                │ │ │
│ │ │ 修復内容: [▼] 修復              │ │ │
│ │ │  修復 / 交換 / 塗装 / その他    │ │ │
│ │ │                                │ │ │
│ │ │ 修復の程度: [▼] 中程度          │ │ │
│ │ │  軽微 / 中程度 / 深刻           │ │ │
│ │ │                                │ │ │
│ │ │ 📷 Before写真: [写真を撮影]     │ │ │
│ │ │ [画像プレビュー]                │ │ │
│ │ │                                │ │ │
│ │ │ コメント:                       │ │ │
│ │ │ ────────────────────────────── │ │ │
│ │ │                                │ │ │
│ │ │ [削除]                          │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📷 Before写真（全体）                   │
│ ┌─────────────────────────────────────┐ │
│ │ ⚠️ Before写真の撮影は必須です。      │ │
│ │                                      │ │
│ │ [写真を撮影]                        │ │
│ │                                      │ │
│ │ [画像1] [画像2] [画像3]             │ │
│ │                                      │ │
│ │ （車体全体、修復箇所の写真）         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 整備士の所見                        │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  診断結果、修復内容の提案など        │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│           [診断完了]                    │
└─────────────────────────────────────────┘
```

### 3-2. コンポーネント設計

#### レストアの種類セクション

**目的**: フルレストアか部分レストアかを選択し、診断項目を動的に変化

**UI要素**:
- **レストアの種類選択**: ラジオボタン
  - フルレストア / 部分レストア / その他

**動作**:
- 選択に応じて、現状確認項目や修復箇所の入力項目が変化
- フルレストアの場合、より詳細な確認項目を表示

#### 現状確認セクション

**目的**: 車両の現状を確認し、状態を記録

**UI要素**:
- **確認項目追加ボタン**: 「+ 確認項目を追加」ボタン
- **確認項目カード**: 各項目ごとにカード表示
  - **箇所選択**: ドロップダウン
    - 車体 / エンジン / 内装 / 電装系 / その他
  - **状態選択**: ドロップダウン
    - 良好 / 軽微な劣化 / 中程度の劣化 / 深刻な劣化 / 修復必要
  - **写真撮影**: カメラボタン（オプション）
    - 画像プレビュー表示
  - **コメント入力**: テキストエリア
  - **削除ボタン**: 項目を削除

**バリデーション**:
- 確認項目は最低1項目推奨（任意）
- 箇所と状態は必須

#### 修復箇所セクション

**目的**: 修復が必要な箇所を記録

**UI要素**:
- **修復箇所追加ボタン**: 「+ 修復箇所を追加」ボタン
- **修復箇所カード**: 各箇所ごとにカード表示
  - **部位選択**: ドロップダウン（自由入力も可能）
  - **修復内容選択**: ドロップダウン
    - 修復 / 交換 / 塗装 / その他
  - **修復の程度選択**: ドロップダウン
    - 軽微 / 中程度 / 深刻
  - **Before写真撮影**: カメラボタン（必須）
    - 画像プレビュー表示
  - **コメント入力**: テキストエリア
  - **削除ボタン**: 箇所を削除

**バリデーション**:
- 修復箇所は最低1箇所必須
- 各修復箇所でBefore写真は必須
- 部位、修復内容、修復の程度は必須

#### Before写真（全体）セクション

**目的**: 車体全体と修復箇所のBefore写真を撮影（必須）

**UI要素**:
- **写真撮影ボタン**: カメラボタン
- **画像プレビュー**: 撮影した写真をプレビュー表示
- **注意メッセージ**: Before写真の撮影が必須であることを明示

**バリデーション**:
- Before写真は最低1枚以上必須

### 3-3. データフロー

1. **画面表示時**:
   - 車両情報を表示
   - 既存の診断情報を表示（あれば）

2. **レストアの種類選択時**:
   - 選択に応じて、現状確認項目や修復箇所の入力項目を動的に変化

3. **診断完了時**:
   - レストアの種類、現状確認結果、修復箇所、Before写真を保存
   - Jobステータスを「見積作成待ち」に更新

---

## 4. 見積画面の詳細設計

### 4-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 レストア見積            │
├─────────────────────────────────────────┤
│ 📋 車両情報（参照のみ）                  │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 走行距離: 45,000 km                 │ │
│ │ レストアの種類: フルレストア         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💰 見積もり項目                         │
│ ┌─────────────────────────────────────┐ │
│ │ [+ 見積もり項目を追加]              │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 項目名: [エンジンオーバーホール] │ │ │
│ │ │ 数量: [1] 単価: [500,000] 円   │ │ │
│ │ │ 金額: [500,000] 円             │ │ │
│ │ │                                │ │ │
│ │ │ 備考:                           │ │ │
│ │ │ ────────────────────────────── │ │ │
│ │ │                                │ │ │
│ │ │ [削除]                          │ │ │
│ │ └────────────────────────────────┘ │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 小計: 2,500,000円               │ │ │
│ │ │ 消費税(10%): 250,000円         │ │ │
│ │ │ ────────────────────────────── │ │ │
│ │ │ 合計: 2,750,000円               │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 部品リスト                           │
│ ┌─────────────────────────────────────┐ │
│ │ [+ 部品を追加]                      │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 部品名: [エンジンオイル]         │ │ │
│ │ │ 数量: [5] 単価: [1,000] 円     │ │ │
│ │ │ 金額: [5,000] 円                │ │ │
│ │ │                                │ │ │
│ │ │ 取り寄せ状況: [▼] 発注済み     │ │ │
│ │ │  在庫あり / 発注済み /          │ │ │
│ │ │  取り寄せ中 / 到着済み / 遅延   │ │ │
│ │ │                                │ │ │
│ │ │ 到着予定日: [____/__/__]        │ │ │
│ │ │                                │ │ │
│ │ │ ⚠️ 到着予定日を過ぎています！    │ │ │
│ │ │   （遅延アラート）               │ │ │
│ │ │                                │ │ │
│ │ │ 備考:                           │ │ │
│ │ │ ────────────────────────────── │ │ │
│ │ │                                │ │ │
│ │ │ [削除]                          │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ ⏱️ 作業期間                             │
│ ┌─────────────────────────────────────┐ │
│ │ 予定作業期間:                       │ │
│ │ [____] 週間 または [____] カ月     │ │
│ │                                      │ │
│ │ ⚠️ 作業期間が長いため、車両を預ける  │ │
│ │   必要があります。                  │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ ➕ 追加作業（イレギュラー対応）          │
│ ┌─────────────────────────────────────┐ │
│ │ [+ 追加作業を追加]                  │ │
│ │                                      │ │
│ │ （追加作業は作業中にも追加可能）     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 見積もりの変更履歴                   │
│ ┌─────────────────────────────────────┐ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 2025/01/20 14:30               │ │ │
│ │ │ 変更内容: エンジンオーバーホール │ │ │
│ │ │         追加                   │ │ │
│ │ │ 変更前: 2,000,000円            │ │ │
│ │ │ 変更後: 2,500,000円            │ │ │
│ │ │ 理由: エンジンの状態が予想以上  │ │ │
│ │ │       に悪かったため           │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 備考                                │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  顧客への説明事項など                │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│           [見積もり確定]                │
└─────────────────────────────────────────┘
```

### 4-2. コンポーネント設計

#### 見積もり項目セクション

**目的**: 修復内容、作業内容に基づいて見積もりを作成

**基幹システム連携フロー**:
1. アドバイザー（フロントスタッフ）がWebアプリの見積作成画面を開く
2. 診断結果を確認（修復箇所と現状確認結果を確認）
3. **基幹システム（スマートカーディーラー）で該当作業の見積書を作成**（アドバイザーが実施）
4. **Webアプリに「品名」と「金額（税込）」を転記**（アドバイザーが実施）
5. 見積情報を保存（Zoho CRM field_work_orders内の該当作業の見積情報を更新）

**制約**:
- 見積計算は基幹システムで実施（Webアプリは転記のみ）
- 長期プロジェクトのため、追加作業・見積もり変更が発生する可能性がある

**UI要素**:
- **見積もり項目追加ボタン**: 「+ 見積もり項目を追加」ボタン
- **見積もり項目カード**: 各項目ごとにカード表示
  - **項目名入力**: テキスト入力
  - **数量入力**: 数値入力
  - **単価入力**: 数値入力（円単位）
  - **金額表示**: 自動計算（数量 × 単価）
  - **備考入力**: テキストエリア
  - **削除ボタン**: 項目を削除
- **小計表示**: 自動計算
- **消費税表示**: 自動計算（小計 × 10%）
- **合計表示**: 自動計算（小計 + 消費税）

**バリデーション**:
- 見積もり項目は最低1項目必須
- 各項目の項目名、数量、単価は必須
- 数量と単価は0より大きい値

#### 部品リストセクション

**目的**: 必要な部品を管理し、取り寄せ状況を追跡

**UI要素**:
- **部品追加ボタン**: 「+ 部品を追加」ボタン
- **部品カード**: 各部品ごとにカード表示
  - **部品名入力**: テキスト入力
  - **数量入力**: 数値入力
  - **単価入力**: 数値入力（円単位）
  - **金額表示**: 自動計算（数量 × 単価）
  - **取り寄せ状況選択**: ドロップダウン
    - 在庫あり / 発注済み / 取り寄せ中 / 到着済み / 遅延
  - **到着予定日入力**: 日付ピッカー（発注済み以降の場合）
  - **遅延アラート**: 到着予定日を過ぎている場合に警告表示
  - **備考入力**: テキストエリア
  - **削除ボタン**: 部品を削除

**バリデーション**:
- 部品名、数量、単価は必須
- 取り寄せ状況が「発注済み」以降の場合、到着予定日は推奨

**動作**:
- 到着予定日を過ぎている場合、遅延アラートを表示
- 部品の状態が変更された場合、履歴を記録

#### 作業期間セクション

**目的**: 作業期間を設定し、顧客に長期間預ける必要があることを明示

**UI要素**:
- **予定作業期間入力**: 数値入力（週間またはカ月単位）
- **単位選択**: ラジオボタン（週間/カ月）
- **警告メッセージ**: 作業期間が長いことを警告

**バリデーション**:
- 予定作業期間は必須
- 予定作業期間は1以上

#### 追加作業セクション

**目的**: イレギュラー対応として追加作業を管理

**UI要素**:
- **追加作業追加ボタン**: 「+ 追加作業を追加」ボタン
- **追加作業カード**: 各追加作業ごとにカード表示
  - **追加作業内容入力**: テキスト入力
  - **追加費用入力**: 数値入力（円単位）
  - **承認日時入力**: 日時ピッカー（承認後）
  - **備考入力**: テキストエリア
  - **削除ボタン**: 追加作業を削除

**動作**:
- 追加作業は見積作成時だけでなく、作業中にも追加可能
- 追加作業が追加された場合、見積もりの変更履歴に記録

#### 見積もりの変更履歴セクション

**目的**: 見積もりの変更内容と理由を記録

**UI要素**:
- **変更履歴カード**: 各変更ごとにカード表示
  - **変更日時表示**: テキスト表示
  - **変更内容表示**: テキスト表示
  - **変更前金額表示**: テキスト表示
  - **変更後金額表示**: テキスト表示
  - **変更理由表示**: テキスト表示

**動作**:
- 見積もりが変更された場合、自動的に履歴に追加
- 変更履歴は時系列で表示（新しい順）

### 4-3. データフロー

1. **画面表示時**:
   - 車両情報を表示
   - 診断情報を表示（レストアの種類、修復箇所など）
   - 既存の見積もり情報を表示（あれば）
   - 見積もりの変更履歴を表示

2. **見積もり項目追加時**:
   - 新しい見積もり項目カードを追加
   - 金額を自動計算

3. **部品追加時**:
   - 新しい部品カードを追加
   - 金額を自動計算

4. **見積もり変更時**:
   - 変更履歴に自動的に追加
   - 変更前後の金額を記録

5. **見積もり確定時**:
   - 見積もり情報を保存
   - 作業期間を保存
   - Jobステータスを「顧客承認待ち」に更新

---

## 5. 作業画面の詳細設計

### 5-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 レストア作業            │
├─────────────────────────────────────────┤
│ 📋 車両情報（参照のみ）                  │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 走行距離: 45,000 km                 │ │
│ │ レストアの種類: フルレストア         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📊 作業進捗                             │
│ ┌─────────────────────────────────────┐ │
│ │ 全体進捗: [████████░░] 80%         │ │
│ │                                      │ │
│ │ マイルストーン:                      │ │
│ │ [✓] 分解                             │ │
│ │ [✓] 診断・評価                       │ │
│ │ [✓] 部品発注                         │ │
│ │ [●] 修復（作業中）                   │ │
│ │ [ ] 組み立て                         │ │
│ │ [ ] 仕上げ                           │ │
│ │ [ ] 最終確認                         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📑 フェーズ選択                         │
│ ┌─────────────────────────────────────┐ │
│ │ [分解] [診断・評価] [部品発注]      │ │
│ │ [修復] [組み立て] [仕上げ] [最終確認]│ │
│ │                                      │ │
│ │ （現在選択: 修復）                   │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 作業記録（修復フェーズ）             │
│ ┌─────────────────────────────────────┐ │
│ │ フェーズ進捗: [██████░░░░] 60%      │ │
│ │                                      │ │
│ │ 開始日: 2025/01/25                   │ │
│ │ 予定完了日: 2025/02/15               │ │
│ │                                      │ │
│ │ [+ 作業記録を追加]                   │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 作業日: 2025/01/28              │ │ │
│ │ │                                │ │ │
│ │ │ 作業内容:                       │ │ │
│ │ │ ─────────────────────────── │ │ │
│ │ │ エンジンの分解を完了。           │ │ │
│ │ │ シリンダーヘッドを外し、         │ │ │
│ │ │ 内部の状態を確認。               │ │ │
│ │ │                                │ │ │
│ │ │ 作業時間: [4.5] 時間             │ │ │
│ │ │                                │ │ │
│ │ │ 📷 作業中の写真: [写真を撮影]   │ │ │
│ │ │ [画像1] [画像2]                 │ │ │
│ │ │                                │ │ │
│ │ │ 使用した部品:                   │ │ │
│ │ │ - エンジンオイル（5L）          │ │ │
│ │ │ - オイルフィルター（1個）        │ │ │
│ │ │                                │ │ │
│ │ │ コメント:                       │ │ │
│ │ │ ─────────────────────────── │ │ │
│ │ │                                │ │ │
│ │ │ [削除]                          │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 部品の取り寄せ状況                   │
│ ┌─────────────────────────────────────┐ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ エンジンオイル                   │ │ │
│ │ │ 数量: 5  単価: 1,000円          │ │ │
│ │ │ 状態: [●] 到着済み              │ │ │
│ │ │ 到着日: 2025/01/20              │ │ │
│ │ └────────────────────────────────┘ │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ シリンダーヘッドガスケット       │ │ │
│ │ │ 数量: 1  単価: 15,000円         │ │ │
│ │ │ 状態: [⚠️] 遅延                 │ │ │
│ │ │ 到着予定日: 2025/01/25          │ │ │
│ │ │ （3日遅延）                     │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ ➕ 追加作業（イレギュラー対応）          │
│ ┌─────────────────────────────────────┐ │
│ │ [+ 追加作業を追加]                  │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 追加作業内容: [エンジン内部洗浄] │ │ │
│ │ │ 追加費用: [50,000] 円           │ │ │
│ │ │                                │ │ │
│ │ │ 承認日時: [____/__/__ __:__]   │ │ │
│ │ │                                │ │ │
│ │ │ 備考:                           │ │ │
│ │ │ ────────────────────────────── │ │ │
│ │ │                                │ │ │
│ │ │ [削除]                          │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 見積もりの変更                        │
│ ┌─────────────────────────────────────┐ │
│ │ [見積もりを変更]                    │ │
│ │                                      │ │
│ │ （見積もり変更画面に遷移）           │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ ⏱️ 作業期間の延長                        │
│ ┌─────────────────────────────────────┐ │
│ │ [作業期間を延長]                    │ │
│ │                                      │ │
│ │ 現在の予定完了日: 2025/03/15        │ │
│ │ 延長後の予定完了日: [____/__/__]    │ │
│ │                                      │ │
│ │ 延長理由:                           │ │
│ │ ─────────────────────────────────── │ │
│ │                                      │ │
│ │ [延長を確定]                        │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│           [フェーズ完了]                │
└─────────────────────────────────────────┘
```

### 5-2. コンポーネント設計

#### 作業進捗セクション

**目的**: 全体の作業進捗を視覚的に表示

**UI要素**:
- **全体進捗バー**: プログレスバー（0-100%）
- **マイルストーン表示**: 各フェーズの完了状況を表示
  - 完了: [✓]
  - 作業中: [●]
  - 未開始: [ ]

**データソース**:
- 各フェーズの進捗から全体進捗を自動計算

#### フェーズ選択セクション

**目的**: 作業するフェーズを選択

**UI要素**:
- **フェーズタブ**: タブ形式で表示
  - 分解 / 診断・評価 / 部品発注 / 修復 / 組み立て / 仕上げ / 最終確認
- **現在選択中のフェーズ**: ハイライト表示

**動作**:
- フェーズを選択すると、そのフェーズの作業記録セクションが表示
- 前のフェーズが完了していない場合、警告を表示（任意）

#### 作業記録セクション

**目的**: 各フェーズごとに作業記録を入力

**UI要素**:
- **フェーズ進捗バー**: プログレスバー（0-100%）
- **開始日表示**: テキスト表示
- **予定完了日表示**: テキスト表示
- **作業記録追加ボタン**: 「+ 作業記録を追加」ボタン
- **作業記録カード**: 各記録ごとにカード表示
  - **作業日入力**: 日付ピッカー
  - **作業内容入力**: テキストエリア
  - **作業時間入力**: 数値入力（時間単位）
  - **作業中の写真撮影**: カメラボタン（オプション）
    - 画像プレビュー表示
  - **使用した部品表示**: リスト表示（見積画面で登録した部品から選択）
  - **コメント入力**: テキストエリア
  - **削除ボタン**: 記録を削除

**バリデーション**:
- 作業日、作業内容、作業時間は必須
- 作業時間は0より大きい値

**動作**:
- 作業記録が追加されると、フェーズ進捗が自動更新
- フェーズ進捗が100%になると、マイルストーンが完了として記録

#### 部品の取り寄せ状況セクション

**目的**: 部品の取り寄せ状況を確認し、遅延アラートを表示

**UI要素**:
- **部品カード**: 各部品ごとにカード表示
  - **部品名表示**: テキスト表示
  - **数量・単価表示**: テキスト表示
  - **状態表示**: バッジ表示
    - 在庫あり: 緑
    - 発注済み: 青
    - 取り寄せ中: 黄
    - 到着済み: 緑
    - 遅延: 赤（警告）
  - **到着予定日表示**: テキスト表示
  - **遅延アラート**: 到着予定日を過ぎている場合に警告表示

**動作**:
- 部品の状態が変更された場合、自動的に更新
- 到着予定日を過ぎている場合、遅延アラートを表示

#### 追加作業セクション

**目的**: イレギュラー対応として追加作業を記録

**UI要素**:
- **追加作業追加ボタン**: 「+ 追加作業を追加」ボタン
- **追加作業カード**: 各追加作業ごとにカード表示
  - **追加作業内容入力**: テキスト入力
  - **追加費用入力**: 数値入力（円単位）
  - **承認日時入力**: 日時ピッカー
  - **備考入力**: テキストエリア
  - **削除ボタン**: 追加作業を削除

**動作**:
- 追加作業が追加された場合、見積もりの変更履歴に自動的に記録

#### 見積もりの変更セクション

**目的**: 作業中に見積もりを変更する場合のボタン

**UI要素**:
- **見積もり変更ボタン**: ボタン

**動作**:
- ボタンをクリックすると、見積画面に遷移
- 見積もりを変更すると、変更履歴に自動的に記録

#### 作業期間の延長セクション

**目的**: イレギュラー対応として作業期間を延長

**UI要素**:
- **作業期間延長ボタン**: ボタン
- **延長フォーム**: モーダルまたはインライン表示
  - **現在の予定完了日表示**: テキスト表示
  - **延長後の予定完了日入力**: 日付ピッカー
  - **延長理由入力**: テキストエリア
  - **延長確定ボタン**: ボタン

**動作**:
- 作業期間を延長すると、延長履歴に記録
- 顧客に通知（将来実装）

### 5-3. データフロー

1. **画面表示時**:
   - 車両情報を表示
   - 診断情報を表示
   - 見積情報を表示
   - 各フェーズの進捗を計算して表示
   - 部品の取り寄せ状況を表示

2. **フェーズ選択時**:
   - 選択したフェーズの作業記録を表示

3. **作業記録追加時**:
   - 作業記録を保存
   - フェーズ進捗を更新
   - 全体進捗を更新

4. **フェーズ完了時**:
   - フェーズを完了として記録
   - マイルストーンを更新
   - 次のフェーズを開始可能にする

5. **追加作業追加時**:
   - 追加作業を保存
   - 見積もりの変更履歴に記録

6. **作業期間延長時**:
   - 延長履歴に記録
   - 予定完了日を更新

---

## 6. 引渡画面の詳細設計

### 6-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 レストア引渡            │
├─────────────────────────────────────────┤
│ 📋 車両情報（参照のみ）                  │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 走行距離: 45,000 km                 │ │
│ │ レストアの種類: フルレストア         │ │
│ │ 作業期間: 2025/01/10 ～ 2025/03/15 │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📊 作業完了サマリー                     │
│ ┌─────────────────────────────────────┐ │
│ │ 全体進捗: [██████████] 100%         │ │
│ │                                      │ │
│ │ 完了したフェーズ:                    │ │
│ │ [✓] 分解                             │ │
│ │ [✓] 診断・評価                       │ │
│ │ [✓] 部品発注                         │ │
│ │ [✓] 修復                             │ │
│ │ [✓] 組み立て                         │ │
│ │ [✓] 仕上げ                           │ │
│ │ [✓] 最終確認                         │ │
│ │                                      │ │
│ │ 総作業時間: 320時間                  │ │
│ │ 使用した部品数: 45個                 │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📷 Before/After写真                     │
│ ┌─────────────────────────────────────┐ │
│ │ Before写真:                          │ │
│ │ [画像1] [画像2] [画像3]             │ │
│ │                                      │ │
│ │ After写真:                           │ │
│ │ [画像1] [画像2] [画像3]              │ │
│ │                                      │ │
│ │ ⚠️ After写真の撮影は必須です。        │ │
│ │ [After写真を撮影]                   │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📄 レストア完了報告書                   │
│ ┌─────────────────────────────────────┐ │
│ │ [PDFを生成]                         │ │
│ │                                      │ │
│ │ （レストア完了報告書をPDFで生成）     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 引渡時の説明                         │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  顧客への説明事項、注意事項など      │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│           [引渡完了]                    │
└─────────────────────────────────────────┘
```

### 6-2. コンポーネント設計

#### 作業完了サマリーセクション

**目的**: レストア作業の完了状況をサマリー表示

**UI要素**:
- **全体進捗バー**: プログレスバー（100%）
- **完了したフェーズ表示**: リスト表示
- **総作業時間表示**: テキスト表示
- **使用した部品数表示**: テキスト表示

**データソース**:
- 作業記録から総作業時間を計算
- 使用した部品から部品数を計算

#### Before/After写真セクション

**目的**: Before/After写真を表示し、After写真を撮影（必須）

**UI要素**:
- **Before写真表示**: 画像ギャラリー（診断画面で撮影した写真）
- **After写真表示**: 画像ギャラリー（引渡時に撮影）
- **After写真撮影ボタン**: カメラボタン
- **注意メッセージ**: After写真の撮影が必須であることを明示

**バリデーション**:
- After写真は最低1枚以上必須

#### レストア完了報告書セクション

**目的**: レストア完了報告書をPDFで生成

**UI要素**:
- **PDF生成ボタン**: ボタン

**動作**:
- ボタンをクリックすると、レストア完了報告書をPDFで生成
- PDFの内容:
  - 表紙: 車両情報、レストアの種類、作業期間
  - Before/After写真: 修復前後の比較写真
  - 修復内容の詳細: 修復箇所、修復内容、修復前後の状態
  - 部品リスト: 使用した部品の一覧
  - 作業記録: 各フェーズごとの作業記録
  - 見積もりの変更履歴: 見積もりの変更内容と理由
  - 作業進捗: 各フェーズの進捗状況
  - 総括: 修復完了の総括、今後のメンテナンス推奨事項

### 6-3. データフロー

1. **画面表示時**:
   - 車両情報を表示
   - 作業完了サマリーを計算して表示
   - Before写真を表示
   - After写真を表示（あれば）

2. **After写真撮影時**:
   - After写真を保存

3. **PDF生成時**:
   - レストア完了報告書をPDFで生成
   - PDFをダウンロード可能にする

4. **引渡完了時**:
   - After写真を保存（まだ撮影していない場合）
   - Jobステータスを「出庫待ち」に更新

---

## 7. データモデル

### 7-1. RestoreJob

```typescript
/**
 * レストアジョブ
 */
export interface RestoreJob {
  /** Job ID */
  jobId: string;
  /** 入庫区分 */
  serviceKind: "レストア";
  
  /** 車両情報 */
  vehicle: {
    /** 車両ID */
    vehicleId: string;
    /** 走行距離 */
    mileage: number;
  };
  
  /** 診断情報 */
  diagnosis: {
    /** レストアの種類 */
    restoreType: "フルレストア" | "部分レストア" | "その他";
    /** 現状確認結果 */
    currentCondition: ConditionCheck[];
    /** 修復箇所 */
    restoreLocations: RestoreLocation[];
    /** Before写真 */
    beforePhotos: Photo[];
    /** コメント（整備士の所見） */
    comments: string;
  };
  
  /** 見積情報 */
  estimate: {
    /** 見積もり項目 */
    items: EstimateItem[];
    /** 部品リスト */
    parts: PartItem[];
    /** 小計 */
    subtotal: number;
    /** 消費税 */
    tax: number;
    /** 合計金額 */
    total: number;
    /** 作業期間 */
    workDuration: string;
    /** 承認日時 */
    approvedAt?: Date;
    /** 追加作業リスト（イレギュラー対応） */
    additionalWork: AdditionalWorkItem[];
    /** 見積もりの変更履歴 */
    changeHistory: EstimateChange[];
  };
  
  /** 作業情報 */
  work: {
    /** フェーズ管理 */
    phases: WorkPhase[];
    /** 実施した作業の記録 */
    workRecords: WorkRecord[];
    /** 作業中の写真 */
    progressPhotos: Photo[];
    /** 使用した部品 */
    usedParts: PartItem[];
    /** 総作業時間 */
    totalWorkDuration: number;
    /** 作業メモ */
    notes: string;
    /** 作業進捗 */
    progress: number; // 0-100%
    /** 追加作業の記録（イレギュラー対応） */
    additionalWorkRecords: WorkRecord[];
    /** 作業期間の延長記録 */
    extensionHistory: WorkExtension[];
  };
  
  /** 引渡情報 */
  handover: {
    /** After写真（必須） */
    afterPhotos: Photo[];
    /** 引渡日時 */
    handoverDate?: Date;
    /** 説明事項 */
    notes?: string;
  };
  
  /** 代車情報 */
  courtesyCar: {
    /** 代車の提供有無 */
    provided: boolean;
    /** 代車ID（提供した場合） */
    courtesyCarId?: string;
  };
  
  /** ステータス */
  status: "入庫待ち" | "診断中" | "見積作成待ち" | "顧客承認待ち" | "作業待ち" | "作業中" | "出庫待ち";
}

/**
 * 現状確認結果
 */
export interface ConditionCheck {
  /** 箇所 */
  location: string;
  /** 状態 */
  condition: "良好" | "軽微な劣化" | "中程度の劣化" | "深刻な劣化" | "修復必要";
  /** 写真 */
  photo?: Photo;
  /** コメント */
  comment?: string;
}

/**
 * 修復箇所
 */
export interface RestoreLocation {
  /** 部位 */
  location: string;
  /** 修復内容 */
  restoreType: "修復" | "交換" | "塗装" | "その他";
  /** 修復の程度 */
  severity: "軽微" | "中程度" | "深刻";
  /** Before写真 */
  photo: Photo;
  /** コメント */
  comment?: string;
}

/**
 * 部品項目
 */
export interface PartItem {
  /** 部品名 */
  name: string;
  /** 数量 */
  quantity: number;
  /** 単価 */
  unitPrice: number;
  /** 金額 */
  amount: number;
  /** 取り寄せ状況 */
  status: "在庫あり" | "発注済み" | "取り寄せ中" | "到着済み" | "遅延";
  /** 到着予定日 */
  expectedArrivalDate?: Date;
  /** 実際の到着日 */
  actualArrivalDate?: Date;
  /** 遅延アラート（到着予定日を過ぎている場合） */
  isDelayed?: boolean;
  /** 備考 */
  note?: string;
}

/**
 * 作業フェーズ
 */
export interface WorkPhase {
  /** フェーズID */
  id: string;
  /** フェーズ名 */
  name: "分解" | "診断・評価" | "部品発注" | "修復" | "組み立て" | "仕上げ" | "最終確認";
  /** フェーズの順序 */
  order: number;
  /** フェーズの状態 */
  status: "未開始" | "作業中" | "完了" | "保留";
  /** フェーズの開始日 */
  startDate?: Date;
  /** フェーズの完了日 */
  completionDate?: Date;
  /** フェーズの進捗 */
  progress: number; // 0-100%
  /** フェーズの作業記録 */
  workRecords: WorkRecord[];
  /** フェーズで使用した部品 */
  usedParts: PartItem[];
  /** マイルストーン（フェーズ完了） */
  isMilestone: boolean;
  /** 備考 */
  note?: string;
}

/**
 * 作業記録
 */
export interface WorkRecord {
  /** 作業日 */
  date: Date;
  /** 作業内容 */
  content: string;
  /** 作業時間 */
  duration: number;
  /** 写真 */
  photos?: Photo[];
  /** 使用した部品 */
  usedParts?: PartItem[];
  /** コメント */
  comment?: string;
}

/**
 * 追加作業項目
 */
export interface AdditionalWorkItem {
  /** 追加作業ID */
  id: string;
  /** 追加作業内容 */
  content: string;
  /** 追加費用 */
  additionalCost: number;
  /** 追加作業の承認日時 */
  approvedAt?: Date;
  /** 追加作業の実施日時 */
  completedAt?: Date;
  /** 備考 */
  note?: string;
}

/**
 * 見積もりの変更履歴
 */
export interface EstimateChange {
  /** 変更日時 */
  changedAt: Date;
  /** 変更内容 */
  changeContent: string;
  /** 変更前の金額 */
  previousTotal: number;
  /** 変更後の金額 */
  newTotal: number;
  /** 変更理由 */
  reason: string;
}

/**
 * 作業期間の延長記録
 */
export interface WorkExtension {
  /** 延長日時 */
  extendedAt: Date;
  /** 延長前の期間 */
  previousDuration: string;
  /** 延長後の期間 */
  newDuration: string;
  /** 延長理由 */
  reason: string;
}

/**
 * 写真
 */
export interface Photo {
  /** 写真ID */
  photoId: string;
  /** ファイルパス（Google Drive） */
  filePath: string;
  /** 撮影日時 */
  takenAt: Date;
  /** 説明 */
  description?: string;
}
```

---

## 8. API設計

### 8-1. 受付画面

#### POST /api/jobs/[id]/reception

**目的**: レストアの受付情報を保存

**リクエストボディ**:
```typescript
{
  mileage: number;
  verbalEstimate?: string;
  courtesyCar?: {
    provided: boolean;
    courtesyCarId?: string;
  };
  notes?: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

### 8-2. 診断画面

#### GET /api/jobs/[id]/diagnosis

**目的**: 診断情報を取得

**レスポンス**:
```typescript
{
  job: RestoreJob;
  diagnosis: RestoreJob["diagnosis"];
}
```

#### POST /api/jobs/[id]/diagnosis

**目的**: 診断情報を保存

**リクエストボディ**:
```typescript
{
  restoreType: "フルレストア" | "部分レストア" | "その他";
  currentCondition: ConditionCheck[];
  restoreLocations: RestoreLocation[];
  beforePhotos: Photo[];
  comments: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

### 8-3. 見積画面

#### GET /api/jobs/[id]/estimate

**目的**: 見積情報を取得

**レスポンス**:
```typescript
{
  job: RestoreJob;
  estimate: RestoreJob["estimate"];
}
```

#### POST /api/jobs/[id]/estimate

**目的**: 見積情報を保存

**リクエストボディ**:
```typescript
{
  items: EstimateItem[];
  parts: PartItem[];
  workDuration: string;
  notes?: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

#### POST /api/jobs/[id]/estimate/additional-work

**目的**: 追加作業を追加

**リクエストボディ**:
```typescript
{
  content: string;
  additionalCost: number;
  approvedAt?: Date;
  note?: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

### 8-4. 作業画面

#### GET /api/jobs/[id]/work

**目的**: 作業情報を取得

**レスポンス**:
```typescript
{
  job: RestoreJob;
  work: RestoreJob["work"];
}
```

#### POST /api/jobs/[id]/work/records

**目的**: 作業記録を追加

**リクエストボディ**:
```typescript
{
  phaseId: string;
  date: Date;
  content: string;
  duration: number;
  photos?: Photo[];
  usedParts?: PartItem[];
  comment?: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

#### POST /api/jobs/[id]/work/phases/[phaseId]/complete

**目的**: フェーズを完了

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

#### POST /api/jobs/[id]/work/extend

**目的**: 作業期間を延長

**リクエストボディ**:
```typescript
{
  newDuration: string;
  reason: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

### 8-5. 引渡画面

#### GET /api/jobs/[id]/handover

**目的**: 引渡情報を取得

**レスポンス**:
```typescript
{
  job: RestoreJob;
  handover: RestoreJob["handover"];
}
```

#### POST /api/jobs/[id]/handover

**目的**: 引渡情報を保存

**リクエストボディ**:
```typescript
{
  afterPhotos: Photo[];
  notes?: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  job: RestoreJob;
}
```

#### GET /api/jobs/[id]/handover/pdf

**目的**: レストア完了報告書をPDFで生成

**レスポンス**:
```typescript
{
  success: boolean;
  pdfUrl: string;
}
```

---

## 9. ユーザージャーニー

### 9-1. フルレストアの場合

1. **受付** (フロントスタッフ)
   - 車両情報を確認
   - 走行距離を入力
   - 口頭見積メモを記録（参考程度）
   - 入庫確定

2. **診断** (整備士)
   - レストアの種類を「フルレストア」に選択
   - 現状確認（車体、エンジン、内装、電装系など）
   - 修復箇所を確認
   - Before写真を撮影（必須）
   - 診断完了

3. **見積作成** (フロントスタッフ)
   - 修復内容、部品、作業内容に基づいて見積もりを作成
   - 部品リストを登録（取り寄せ状況を管理）
   - 作業期間（かなり長期）を設定
   - 見積もり確定

4. **顧客承認** (顧客)
   - 見積もりを確認して承認

5. **作業実施** (整備士)
   - フェーズごとに作業を実施
   - 各フェーズで作業記録を入力
   - 作業中の写真を撮影
   - 使用した部品を記録
   - 追加作業が発生した場合、追加作業を記録
   - 見積もりの変更が必要な場合、見積もりを変更
   - 作業期間の延長が必要な場合、作業期間を延長
   - 各フェーズを完了
   - 最終確認を完了

6. **引渡** (フロントスタッフ)
   - 作業完了サマリーを確認
   - After写真を撮影（必須）
   - レストア完了報告書をPDFで生成
   - 顧客に引渡

### 9-2. 部分レストアの場合

1. **受付** (フロントスタッフ)
   - 車両情報を確認
   - 走行距離を入力
   - 口頭見積メモを記録（参考程度）
   - 入庫確定

2. **診断** (整備士)
   - レストアの種類を「部分レストア」に選択
   - 修復箇所を確認（シートだけなど）
   - Before写真を撮影（必須）
   - 診断完了

3. **見積作成** (フロントスタッフ)
   - 修復内容、部品、作業内容に基づいて見積もりを作成
   - 部品リストを登録
   - 作業期間を設定
   - 見積もり確定

4. **顧客承認** (顧客)
   - 見積もりを確認して承認

5. **作業実施** (整備士)
   - フェーズごとに作業を実施（部分レストアの場合はフェーズが少ない場合もある）
   - 作業記録を入力
   - 作業中の写真を撮影
   - 使用した部品を記録
   - 各フェーズを完了

6. **引渡** (フロントスタッフ)
   - 作業完了サマリーを確認
   - After写真を撮影（必須）
   - レストア完了報告書をPDFで生成
   - 顧客に引渡

---

## 10. 実装上の注意点

### 10-1. 長期プロジェクト管理

- レストアは長期プロジェクトとして管理
- 作業期間が長いことを見積時に明示
- 作業期間の延長管理が必要

### 10-2. イレギュラー対応

- 追加作業の管理機能が必要
- 見積もりの変更管理機能が必要
- 部品の取り寄せ遅延の管理が必要
- 作業期間の延長管理が必要

### 10-3. フェーズ管理

- 7つのフェーズで作業を管理
- 各フェーズの進捗を0-100%で管理
- マイルストーン管理（各フェーズの完了）

### 10-4. 部品取り寄せ管理

- 部品の状態管理（在庫あり、発注済み、取り寄せ中、到着済み、遅延）
- 到着予定日管理
- 遅延アラート（到着予定日を過ぎている場合）

### 10-5. 写真管理

- Before写真（必須）
- 作業中の写真（必要）
- After写真（必須）

### 10-6. PDF生成

- レストア完了報告書をPDFで生成（独自フォーマット）
- 車検・12ヶ月点検とは異なる独自のPDF

---

## 11. 関連ドキュメント

- [統合仕様書](./INTEGRATED_SPECIFICATION.md): システム全体の統合仕様
  - 「2-3. データフローの統一」: マスタデータ同期の制約と対応方法
  - 「2-4. 複数作業管理の実装」: 複数作業管理の実装方法
  - 「4-2-6. 請求書統合フロー」: 基幹システムでの統合請求書作成手順
- [システム進化計画](./SYSTEM_EVOLUTION_PLAN.md): 基幹システム制約下での設計変更方針
- [ユーザーワークフロー詳細設計 v2.0](./USER_WORKFLOW_DETAILED_DESIGN_V2.md): ユーザー別業務・システム利用詳細設計

**マスタデータ同期の制約**:
- 車両マスタ・顧客マスタはGoogle Sheets経由で取得（基幹システムからGAS経由で同期）
- マスタデータの更新は基幹システムで実施（Webアプリからは更新不可）
- データ不整合が発生した場合は、「Human Middleware」（スタッフ）が基幹システムを修正

---

## 12. 更新履歴

- 2025-01-XX: 初版作成
- 2025-01-XX: 基幹システム連携フローを追加、関連ドキュメントへの参照を追加
- 2025-01-XX: マスタデータ同期の制約を追加

























