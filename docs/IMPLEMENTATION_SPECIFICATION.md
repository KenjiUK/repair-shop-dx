# 実装仕様書

**作成日:** 2024年
**目的:** 統合UX最適化計画に基づく実装仕様

---

## 概要

本仕様書は、`docs/COMPREHENSIVE_UX_OPTIMIZATION_PLAN.md` に基づき、実装に必要な詳細仕様を記載します。

---

## 実装優先順位

### 第1フェーズ（高優先度・業務の痛みポイント）

1. **2回予約フロー** - 約1日
2. **部品管理システム** - 約1週間

### 第2フェーズ（中優先度・業務効率向上）

3. **発注完了後の入庫連絡機能** - 約2-3日
4. **診断料金の管理** - 約2.5日

### 第3フェーズ（低優先度・既存機能拡張）

5. **ホワイトボード機能（簡易版）** - 約2-3日
6. **メカニックのダブルチェック機能（簡易版）** - 約1-2日
7. **診断後の一時帰宅管理** - 約0.5日

---

## 1. 2回予約フロー

### 概要
全部品到着時に顧客にZoho Bookings予約リンクを送信し、顧客が予約するとZoho CRMワークフローで自動的に既存ジョブと紐付けます。

### 詳細仕様
**参照:** `docs/DOUBLE_BOOKING_FLOW_UX_OPTIMIZATION.md`

### 実装内容

#### 1.1 Zoho CRMワークフローの設定（外部作業）

**条件:**
- 2回目の予約（Zoho Bookings）が入った時、以下の条件をチェック：
  - 同じ顧客ID (`field4`)
  - 同じ車両ID (`field6`)
  - ステータスが「見積提示済み」(`field5 = "見積提示済み"`)

**処理:**
- 条件に合致する既存ジョブがある場合：
  - 新しいレコードを作成せず、既存レコードを更新
  - `ID_BookingId_2` に2回目の予約IDを保存（または `field7` に記録）
  - `field22` (入庫日時) を2回目の予約日時に更新
  - ステータスを「作業待ち」に更新
- 条件に合致しない場合：
  - 通常通り新しいレコードを作成

#### 1.2 全部品到着時の連絡機能

**実装場所:** `src/app/admin/estimate/[id]/page.tsx`

**機能:**
- 全部品到着時に顧客への連絡ダイアログを自動表示
- Zoho Bookingsの予約リンクを含める
- メール・LINEで連絡

**参照:** 部品管理システムの「全部品到着時の自動処理」と統合

#### 1.3 アプリ側の表示改善

**実装場所:**
- `src/app/page.tsx` - トップページで「再入庫予定」を表示
- `src/components/features/job-card.tsx` - ジョブカードに「再入庫予定」を表示

**表示内容:**
- 「再入庫予定: 1/15 10:00」を表示
- ステータス「見積提示済み」の場合、「再入庫予定」として表示

#### 1.4 データ構造の拡張

**実装場所:** `src/types/index.ts`

```typescript
export interface ZohoJob {
  // ... 既存フィールド
  
  /** 1回目の予約ID */
  ID_BookingId?: string | null;
  
  /** 2回目の予約ID（新規追加） */
  ID_BookingId_2?: string | null;
  
  /** 1回目の入庫日時（field7に記録） */
  firstEntryDate?: string | null;
}
```

---

## 2. 部品管理システム

### 概要
見積画面に部品管理機能を統合し、全部品到着時に自動で顧客に連絡します。

### 詳細仕様

#### 2.1 見積画面での部品管理

**実装場所:** `src/app/admin/estimate/[id]/page.tsx`

**機能:**
- 部品リストに「発注先」「到着状況」「在庫場所」を追加
- 部品ごとに「到着済み」チェックボックス
- 到着時に「在庫場所」を入力（例: "A-1"）
- 発注状況サマリーを表示

**UI構成:**
```
┌─────────────────────────────────────┐
│ 見積作成 - 田中様  BMW X3           │
├─────────────────────────────────────┤
│                                     │
│  📋 見積項目                        │
│  ...                                │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📦 部品管理                        │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ ブレーキパッド  F型          │  │
│  │ 発注先: [A商事] を選択       │  │
│  │ ☑️ 到着済み                   │  │
│  │ 在庫場所: [A-1]               │  │
│  └─────────────────────────────┘  │
│                                     │
│  📊 発注状況: 2点中1点到着済み     │
│                                     │
│  ✅ 全部品到着時に自動で顧客連絡   │
└─────────────────────────────────────┘
```

#### 2.2 全部品到着時の自動処理

**実装場所:** `src/app/admin/estimate/[id]/page.tsx`

**機能:**
- 全部品到着時に自動で通知を表示
- 顧客への連絡ダイアログを自動表示
- Zoho Bookings予約リンクを含める

**参照:** 発注完了後の入庫連絡機能と統合

#### 2.3 データ構造の拡張

**実装場所:** `src/types/index.ts`

```typescript
export interface PartItem {
  /** 部品ID */
  id: string;
  /** 部品名 */
  name: string;
  /** 数量 */
  quantity: number;
  /** 発注先 */
  vendor?: string;
  /** 到着状況 */
  arrivalStatus: "未到着" | "到着済み";
  /** 到着日時 */
  arrivalDate?: string; // ISO8601
  /** 在庫場所（棚番号） */
  storageLocation?: string; // "A-1", "B-3" など
}
```

---

## 3. 発注完了後の入庫連絡機能

### 概要
全部品到着時に自動でダイアログを表示し、顧客にZoho Bookings予約リンクを含めて連絡します。

### 詳細仕様

#### 3.1 全部品到着時の自動処理

**実装場所:** `src/app/admin/estimate/[id]/page.tsx`

**機能:**
- 全部品到着時に自動で通知を表示
- 顧客への連絡ダイアログを自動表示
- Zoho Bookings予約リンクを含める

#### 3.2 連絡送信ダイアログ

**実装場所:** `src/components/features/parts-arrival-dialog.tsx` - 新規コンポーネント

**機能:**
- 連絡方法を選択（LINE、メール）
  - **LINE通知（推奨）:** 既存の`sendLineNotification`を使用
  - **メール送信（将来実装）:** メール送信APIの実装が必要
- メッセージテンプレートを使用
- Zoho Bookings予約リンクを含める
- マジックリンクを生成して送信

**参照:** `docs/CUSTOMER_NOTIFICATION_SYSTEM.md` - 顧客通知システム仕様

**UI構成:**
```
┌─────────────────────────────────────┐
│ 全部品到着 - 顧客への連絡           │
├─────────────────────────────────────┤
│                                     │
│  ✅ 全部品到着確認                  │
│                                     │
│  📦 到着部品一覧                    │
│  • ブレーキパッド  F型 ✓            │
│  • ブレーキローター  F型 ✓          │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📞 顧客への連絡                    │
│                                     │
│  連絡方法:                          │
│  ○ LINE                            │
│  ● メール                          │
│                                     │
│  メッセージ:                        │
│  ┌─────────────────────────────┐  │
│  │ 田中様                      │  │
│  │                             │  │
│  │ お待たせしております。      │  │
│  │ 発注していた部品が全て       │  │
│  │ 到着いたしました。          │  │
│  │                             │  │
│  │ 以下のリンクから、ご都合の  │  │
│  │ 良い日時で再入庫の予約を     │  │
│  │ お願いいたします。           │  │
│  │                             │  │
│  │ [Zoho Bookings予約リンク]   │  │
│  └─────────────────────────────┘  │
│                                     │
│  [連絡を送信] ボタン                │
└─────────────────────────────────────┘
```

---

## 4. 診断料金の管理

### 概要
見積画面で診断料金を一元管理し、診断完了時に簡易入力できるようにします。

### 詳細仕様
**参照:** `docs/DIAGNOSIS_FEE_MANAGEMENT_OPTIMIZED.md`

#### 4.1 見積画面での診断料金管理

**実装場所:** `src/app/admin/estimate/[id]/page.tsx`

**機能:**
- 診断料金の選択肢から選択（無料、¥3,000、¥5,000、¥10,000、その他）
- 作業項目がある場合、診断料金を自動で割引表示
- 割引後の金額を自動計算

#### 4.2 診断完了時の簡易入力

**実装場所:** `src/app/mechanic/diagnosis/[id]/page.tsx`

**機能:**
- 診断料金の選択肢から選択（任意）
- 診断時間（概算）を記録（参考情報）
- 常連顧客の場合は自動で¥0に設定（上書き可能）

#### 4.3 自動化機能

**常連顧客の自動判定:**
- 顧客マスタ（Zoho `Contacts`）から常連フラグを取得
- 常連顧客の場合は自動で¥0に設定
- 上書き可能

**作業実施時の自動割引:**
- 見積画面で作業項目がある場合、診断料金を自動で割引表示
- 合計金額から自動で診断料金を差し引く

#### 4.4 データ構造の拡張

**実装場所:** `src/types/index.ts`

```typescript
export interface ZohoJob {
  // ... 既存フィールド
  
  /** 診断料金（カスタムフィールド field23 または field7 に記録） */
  diagnosisFee?: number | null;
  
  /** 診断時間（概算・分）（参考情報） */
  diagnosisDuration?: number | null;
  
  /** 診断料金が事前に決まっているか */
  isDiagnosisFeePreDetermined?: boolean;
}
```

---

## 5. ホワイトボード機能（簡易版）

### 概要
トップページを拡張し、担当整備士別のビューを追加します。

### 詳細仕様

#### 5.1 トップページの拡張

**実装場所:** `src/app/page.tsx`

**機能:**
- 「担当整備士別」タブを追加
- 担当整備士ごとに車両をグループ化
- 作業状況を色分け表示
- 進捗バーで作業進捗を可視化
- 明日の作業予定を別セクションで表示

**UI構成:**
```
┌─────────────────────────────────────┐
│ 本日の入庫予定                      │
├─────────────────────────────────────┤
│                                     │
│  [全体] [担当別] [再入庫予定]      │
│                                     │
│  👤 山田整備士                       │
│  ┌─────────────────────────────┐  │
│  │ 🔧 作業中                     │  │
│  │ 田中様  BMW X3               │  │
│  │ 進捗: ████████░░ 80%         │  │
│  └─────────────────────────────┘  │
│                                     │
│  👤 鈴木整備士                       │
│  ┌─────────────────────────────┐  │
│  │ ⏳ 待機中                     │  │
│  │ 佐藤様  Mercedes C-Class     │  │
│  └─────────────────────────────┘  │
│                                     │
└─────────────────────────────────────┘
```

---

## 6. メカニックのダブルチェック機能（簡易版）

### 概要
見積画面に統合し、メカニック承認セクションを追加します。

### 詳細仕様

#### 6.1 見積画面での承認

**実装場所:** `src/app/admin/estimate/[id]/page.tsx`

**機能:**
- 見積画面の下部に「メカニック承認」セクションを追加
- 「承認済み」チェックボックス + 承認者名入力
- 承認後に「顧客に送信」ボタンを有効化

**UI構成:**
```
┌─────────────────────────────────────┐
│ 見積作成 - 田中様  BMW X3           │
├─────────────────────────────────────┤
│                                     │
│  📋 見積項目                        │
│  ...                                │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  ✅ メカニック承認                  │
│                                     │
│  ☑️ 承認済み                        │
│  承認者: [山田整備士]               │
│  承認日時: 2024/01/10 14:30        │
│                                     │
│  [顧客に送信] ボタン（承認後に有効）│
└─────────────────────────────────────┘
```

#### 6.2 データ構造の拡張

**実装場所:** `src/types/index.ts`

```typescript
export interface ZohoJob {
  // ... 既存フィールド
  
  /** メカニック承認済み */
  mechanicApproved?: boolean;
  
  /** 承認者名 */
  mechanicApprover?: string | null;
  
  /** 承認日時 */
  mechanicApprovedAt?: string | null; // ISO8601
}
```

---

## 7. 診断後の一時帰宅管理

### 概要
既存ステータスを活用し、診断完了時に一時帰宅判定を行います。

### 詳細仕様

#### 7.1 診断完了時の自動判定

**実装場所:** `src/app/mechanic/diagnosis/[id]/page.tsx`

**機能:**
- 診断完了時に「一時帰宅」か「入庫」を選択
- 一時帰宅の場合、ステータスを「見積作成待ち」に自動更新
- 再入庫予定日時を `field7` に記録

#### 7.2 トップページでの表示

**実装場所:** `src/app/page.tsx`

**機能:**
- ステータス「見積作成待ち」を「一時帰宅中」として表示
- 再入庫予定日時を表示

---

## 実装チェックリスト

### 第1フェーズ

- [ ] 2回予約フロー
  - [ ] Zoho CRMワークフローの設定（外部作業）
  - [ ] 全部品到着時の連絡機能
  - [ ] アプリ側の表示改善
  - [ ] データ構造の拡張

- [ ] 部品管理システム
  - [ ] 見積画面での部品管理
  - [ ] 全部品到着時の自動処理
  - [ ] データ構造の拡張

### 第2フェーズ

- [ ] 発注完了後の入庫連絡機能
  - [ ] 全部品到着時の自動処理
  - [ ] 連絡送信ダイアログ

- [ ] 診断料金の管理
  - [ ] 見積画面での診断料金管理
  - [ ] 診断完了時の簡易入力
  - [ ] 自動化機能
  - [ ] データ構造の拡張

### 第3フェーズ

- [ ] ホワイトボード機能（簡易版）
  - [ ] トップページの拡張

- [ ] メカニックのダブルチェック機能（簡易版）
  - [ ] 見積画面での承認
  - [ ] データ構造の拡張

- [ ] 診断後の一時帰宅管理
  - [ ] 診断完了時の自動判定
  - [ ] トップページでの表示

- [ ] 車検チェックリスト機能
  - [ ] 車検入庫時チェックリスト
  - [ ] 車検出庫時チェックリスト
  - [ ] データ構造の拡張

- [ ] 作業指示書PDF出力機能
  - [ ] 作業指示書PDF生成
  - [ ] 作業指示書PDF出力ボタン
  - [ ] PDF生成ライブラリの導入

- [ ] ジョブメモ機能
  - [ ] メモダイアログコンポーネント
  - [ ] メモ一覧表示
  - [ ] メモ追加・編集機能
  - [ ] 各画面へのメモボタン追加
  - [ ] データ構造の拡張

---

---

## 8. 車検チェックリスト機能

### 概要
車検入庫時と出庫時にチェックリストを表示し、確認項目をチェックできるようにします。

### 詳細仕様

#### 8.1 車検入庫時チェックリスト

**実装場所:** `src/app/page.tsx` - チェックイン時、または `src/components/features/inspection-checklist-dialog.tsx` - 新規コンポーネント

**チェック項目:**
- 車検証
- 自賠責
- 自動車税
- 鍵
- ホイールロックナット（有れば）
- 車内ETCカード
- 車内貴重品

**UI構成:**
```
┌─────────────────────────────────────┐
│ 車検入庫チェックリスト              │
├─────────────────────────────────────┤
│                                     │
│  田中様  BMW X3                     │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📋 入庫時確認項目                  │
│                                     │
│  ☐ 車検証                           │
│  ☐ 自賠責                           │
│  ☐ 自動車税                         │
│  ☐ 鍵                               │
│  ☐ ホイールロックナット（有れば）   │
│  ☐ 車内ETCカード                    │
│  ☐ 車内貴重品                       │
│                                     │
│  [チェック完了] ボタン              │
└─────────────────────────────────────┘
```

**実装内容:**
- チェックイン時にサービス種別が「車検」の場合、チェックリストダイアログを表示
- 各項目をチェック
- チェック完了後にチェックイン処理を実行

#### 8.2 車検出庫時チェックリスト

**実装場所:** `src/app/presentation/[id]/page.tsx` - 出庫時、または `src/components/features/inspection-checkout-checklist-dialog.tsx` - 新規コンポーネント

**チェック項目:**
- 車検証
- 自動車検査証記録事項（プリントアウトしてお渡しする）
- 自賠責
- 記録簿
- 鍵
- ホイールロックナット（有れば）
- ETCカード抜き忘れ
- ホイール増し締め（お客様と確認）

**UI構成:**
```
┌─────────────────────────────────────┐
│ 車検出庫チェックリスト              │
├─────────────────────────────────────┤
│                                     │
│  田中様  BMW X3                     │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📋 出庫時確認項目                  │
│                                     │
│  ☐ 車検証                           │
│  ☐ 自動車検査証記録事項             │
│     （プリントアウトしてお渡し）    │
│  ☐ 自賠責                           │
│  ☐ 記録簿                           │
│  ☐ 鍵                               │
│  ☐ ホイールロックナット（有れば）   │
│  ☐ ETCカード抜き忘れ                │
│  ☐ ホイール増し締め                 │
│     （お客様と確認）                │
│                                     │
│  [チェック完了] ボタン              │
└─────────────────────────────────────┘
```

**実装内容:**
- 出庫時にサービス種別が「車検」の場合、チェックリストダイアログを表示
- 各項目をチェック
- チェック完了後に出庫処理を実行

#### 8.3 データ構造の拡張

**実装場所:** `src/types/index.ts`

```typescript
export interface InspectionChecklist {
  /** 入庫時チェック項目 */
  entryItems: {
    vehicleRegistration: boolean; // 車検証
    compulsoryInsurance: boolean; // 自賠責
    automobileTax: boolean; // 自動車税
    key: boolean; // 鍵
    wheelLockNut: boolean; // ホイールロックナット（有れば）
    etcCard: boolean; // 車内ETCカード
    valuables: boolean; // 車内貴重品
  };
  
  /** 出庫時チェック項目 */
  checkoutItems: {
    vehicleRegistration: boolean; // 車検証
    inspectionRecord: boolean; // 自動車検査証記録事項
    compulsoryInsurance: boolean; // 自賠責
    recordBook: boolean; // 記録簿
    key: boolean; // 鍵
    wheelLockNut: boolean; // ホイールロックナット（有れば）
    etcCardRemoved: boolean; // ETCカード抜き忘れ
    wheelTightening: boolean; // ホイール増し締め（お客様と確認）
  };
}
```

---

## 9. 作業指示書PDF出力機能

### 概要
入庫時の診断前、作業前に内容をPDFで作業指示書を印刷できるようにします。

### 詳細仕様

#### 9.1 作業指示書PDF生成

**実装場所:** `src/lib/work-order-pdf-generator.ts` - 新規ファイル

**機能:**
- ジョブ情報から作業指示書PDFを生成
- 顧客情報、車両情報、作業指示内容を含める
- 診断前、作業前の両方に対応

**PDF内容:**
- 顧客名
- 車両情報（車名、ナンバープレート）
- 入庫日時
- 作業指示内容（`field` フィールド）
- サービス種別
- 担当整備士（設定されている場合）

#### 9.2 作業指示書PDF出力ボタン

**実装場所:**
- `src/app/page.tsx` - チェックイン後
- `src/components/features/job-card.tsx` - ジョブカード
- `src/app/mechanic/diagnosis/[id]/page.tsx` - 診断画面
- `src/app/mechanic/work/[id]/page.tsx` - 作業画面

**UI構成:**
```
┌─────────────────────────────────────┐
│ ジョブカード                        │
├─────────────────────────────────────┤
│                                     │
│  田中様  BMW X3                     │
│                                     │
│  [作業指示書を印刷] ボタン          │
│                                     │
└─────────────────────────────────────┘
```

**実装内容:**
- 「作業指示書を印刷」ボタンを追加
- クリックするとPDFを生成してダウンロード
- ブラウザの印刷機能を使用（window.print()）

#### 9.3 PDF生成ライブラリ

**推奨ライブラリ:**
- `react-pdf` / `@react-pdf/renderer` - ReactでPDFを生成
- または `jspdf` - シンプルなPDF生成

**実装方針:**
- クライアント側でPDFを生成（サーバー負荷を減らす）
- 既存のPDF生成機能（請求書PDFなど）を参考にする

#### 9.4 データ構造

**実装場所:** `src/types/index.ts`

```typescript
export interface WorkOrderPDFData {
  /** ジョブID */
  jobId: string;
  /** 顧客名 */
  customerName: string;
  /** 車両情報 */
  vehicleInfo: {
    name: string; // 車名
    licensePlate: string; // ナンバープレート
  };
  /** 入庫日時 */
  entryDate: string; // ISO8601
  /** 作業指示内容 */
  workOrder: string | null;
  /** サービス種別 */
  serviceKind: ServiceKind;
  /** 担当整備士 */
  assignedMechanic?: string | null;
  /** 生成日時 */
  generatedAt: string; // ISO8601
}
```

---

## 10. ジョブメモ機能

### 概要
プロセスが長くなったため、ジョブ全体でスタッフ間の情報共有や作業中の気づきを記録できるメモ機能を追加します。

### 詳細仕様
**参照:** `docs/JOB_MEMO_SPEC.md`

#### 10.1 メモダイアログ

**実装場所:** `src/components/features/job-memo-dialog.tsx` - 新規コンポーネント

**機能:**
- メモ一覧を時系列で表示
- 新しいメモを追加
- メモの編集・削除（作成者のみ、または管理者のみ）

#### 10.2 各画面へのメモボタン追加

**実装場所:**
- `src/components/features/job-card.tsx` - メモボタンを追加
- `src/app/admin/estimate/[id]/page.tsx` - 見積画面にメモセクション
- `src/app/mechanic/diagnosis/[id]/page.tsx` - 診断画面にメモセクション
- `src/app/mechanic/work/[id]/page.tsx` - 作業画面にメモセクション

#### 10.3 データ構造の拡張

**実装場所:** `src/types/index.ts`

```typescript
export interface JobMemo {
  /** メモID */
  id: string;
  
  /** ジョブID */
  jobId: string;
  
  /** メモ内容 */
  content: string;
  
  /** 作成者名 */
  author: string;
  
  /** 作成日時 */
  createdAt: string; // ISO8601
  
  /** 更新日時 */
  updatedAt?: string | null; // ISO8601
}

export interface ZohoJob {
  // ... 既存フィールド
  
  /** ジョブメモ（カスタムフィールド field26 または field7 にJSON形式で記録） */
  jobMemos?: JobMemo[];
  
  /** メモの最終更新日時 */
  lastMemoUpdatedAt?: string | null; // ISO8601
}
```

---

## 実装チェックリスト（更新）

### 第1フェーズ

- [ ] 2回予約フロー
  - [ ] Zoho CRMワークフローの設定（外部作業）
  - [ ] 全部品到着時の連絡機能
  - [ ] アプリ側の表示改善
  - [ ] データ構造の拡張

- [ ] 部品管理システム
  - [ ] 見積画面での部品管理
  - [ ] 全部品到着時の自動処理
  - [ ] データ構造の拡張

### 第2フェーズ

- [ ] 発注完了後の入庫連絡機能
  - [ ] 全部品到着時の自動処理
  - [ ] 連絡送信ダイアログ

- [ ] 診断料金の管理
  - [ ] 見積画面での診断料金管理
  - [ ] 診断完了時の簡易入力
  - [ ] 自動化機能
  - [ ] データ構造の拡張

### 第3フェーズ

- [ ] ホワイトボード機能（簡易版）
  - [ ] トップページの拡張

- [ ] メカニックのダブルチェック機能（簡易版）
  - [ ] 見積画面での承認
  - [ ] データ構造の拡張

- [ ] 診断後の一時帰宅管理
  - [ ] 診断完了時の自動判定
  - [ ] トップページでの表示

- [ ] 車検チェックリスト機能
  - [ ] 車検入庫時チェックリスト
  - [ ] 車検出庫時チェックリスト
  - [ ] データ構造の拡張

- [ ] 作業指示書PDF出力機能
  - [ ] 作業指示書PDF生成
  - [ ] 作業指示書PDF出力ボタン
  - [ ] PDF生成ライブラリの導入

---

---

## 11. 事前オンラインチェックイン機能（仕様あり・未実装）

### 概要
SPECIFICATION.mdには記載されているが、現在実装されていない機能です。

### 仕様上の定義
**参照:** `SPECIFICATION.md` - Phase 0.3 システム連携＆事前チェックイン

**機能:**
- 予約確定時 / 入庫前日にメール自動送信
- 事前チェックイン（Web受付票）のリンクを記載
- 顧客がスマホでリンクを開いて入力

**入力内容:**
1. 車両の特定（保有車両リストから選択、または新規車両登録）
2. 顧客情報の確認（住所・電話番号の変更）
3. パーミッション（メール配信同意）
4. 問診（走行距離、不具合、代車の希望）

### 現在の実装状況

**✅ 実装済み:**
- 事前入力情報の表示（`field7`の内容を確認）
- 「📝事前入力あり」バッジの表示

**❌ 未実装:**
- 事前チェックインページ（`/customer/pre-checkin/[id]`）
- マジックリンク生成（事前チェックイン用）
- 車両選択機能
- データ保存機能
- メール送信機能

### 実装が必要な項目

**実装場所:**
- `src/app/customer/pre-checkin/[id]/page.tsx` - 新規作成
- `src/components/features/vehicle-selector.tsx` - 新規作成
- `src/lib/line-api.ts` - マジックリンク生成の拡張
- `src/lib/email.ts` - メール送信クライアント（新規作成）
- `src/lib/email-templates.ts` - メールテンプレート（新規作成）
- `src/app/api/email/send/route.ts` - メール送信API Route（新規作成）

**メール送信機能の実装方針:**

**推奨: Webアプリからの送信（SMTP使用）**

**理由:**
- マジックリンクを動的に生成する必要があるため、Zoho CRMの自動メールでは実現が困難
- 既存のLINE通知パターンと統一できる
- Google WorkspaceのGmailアカウントを使用可能

**最新情報（2024-2025）:**
- ⚠️ **重要:** 2024年9月30日以降、「安全性の低いアプリ」のアクセスは完全に無効化されました
- **アプリパスワードまたはOAuth 2.0が必須**
- 2段階認証プロセスを有効化する必要があります
- ✅ **送信履歴:** Gmailの「送信済み」フォルダに自動保存されます（追加の設定は不要）

**実装詳細:**
- `nodemailer` ライブラリを使用
- SMTP経由でメール送信（ポート587: TLS、またはポート465: SSL）
- アプリパスワードで認証（16桁）
- 環境変数で設定（`.env.local`）

**外部設定:**
- Google Workspaceのアプリパスワードを生成
- 環境変数を設定（SMTP設定）

**参照:**
- `docs/PRE_CHECKIN_STATUS.md` - 事前チェックイン実装状況
- `docs/PRE_CHECKIN_EMAIL_STRATEGY.md` - メール送信戦略の詳細（最新情報を含む）

---

## 参照ドキュメント

- `docs/COMPREHENSIVE_UX_OPTIMIZATION_PLAN.md` - 統合UX最適化計画
- `docs/EXTERNAL_SETUP_REQUIREMENTS.md` - 外部設定要件（Zoho CRM設定など）
- `docs/CUSTOMER_NOTIFICATION_SYSTEM.md` - 顧客通知システム仕様
- `docs/PRE_CHECKIN_STATUS.md` - 事前チェックイン実装状況
- `docs/PRE_CHECKIN_EMAIL_STRATEGY.md` - メール送信戦略の詳細（最新情報を含む）
- `docs/DOUBLE_BOOKING_FLOW_UX_OPTIMIZATION.md` - 2回予約フローのUX最適化
- `docs/DIAGNOSIS_FEE_MANAGEMENT_OPTIMIZED.md` - 診断料金管理の最適化仕様
- `docs/INSPECTION_CHECKLIST_SPEC.md` - 車検チェックリスト機能仕様
- `docs/WORK_ORDER_PDF_SPEC.md` - 作業指示書PDF出力機能仕様
- `docs/JOB_MEMO_SPEC.md` - ジョブメモ機能仕様







