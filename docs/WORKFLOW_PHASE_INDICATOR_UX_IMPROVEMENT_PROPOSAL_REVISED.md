# ワークフロー・フェーズ表示 UI/UX 改善提案書（改訂版）

**作成日**: 2025-01-XX  
**改訂日**: 2025-01-XX  
**目的**: ワークフロー型業務アプリとして、ユーザー業務目線・現場での使用を考慮した最高のUI/UXを実現  
**前提**: JOBカードのステータス（field5）と実際のワークフローを連動させる

---

## 📋 現状の課題（再評価）

### 1. 視認性の問題
- **ドット表示（●/○）だけでは分かりにくい**: 何を意味するか直感的に理解できない
- **フェーズ番号だけでは情報不足**: "Phase 2/6"だけでは、現在何をしているのか、次に何をすべきか分からない
- **フェーズ名が表示されていない**: 各フェーズが何を意味するか、テキストで表示されていない

### 2. ナビゲーション機能の欠如
- **進む・戻る機能がない**: 前後のフェーズに移動できない
- **全体像の把握が困難**: 現在のフェーズが全体の中でどの位置にあるか分かりにくい

### 3. ユーザーロール別の最適化不足
- **整備士**: 診断（Phase 2）と作業（Phase 5）のみを扱うが、全体が見えない
- **サービスフロント**: 受付（Phase 1）、見積（Phase 3）を主に扱うが、全体を見たい場合もある
- **ロールに応じた表示がない**: 全員に同じ表示をしている

### 4. **新たに発見された課題**: ステータス（field5）との連動不足
- **JOBカードのステータスとワークフローインジケーターが連動していない**
- **実際のステータス遷移とフェーズ表示が一致していない**
- **スキップされるフェーズ（見積・承認）が実際にスキップされた場合に表示が更新されない**

---

## 🔍 実際のワークフロー仕様（確認結果）

### ステータス遷移（field5）

```
入庫待ち → 入庫済み → 見積作成待ち → 見積提示済み → 作業待ち → 出庫待ち → 出庫済み
```

### フェーズとステータスの対応関係

| Phase | フェーズ名 | 対応するfield5ステータス | 担当者 |
|-------|-----------|------------------------|--------|
| 0 | 事前チェックイン | - | 顧客 |
| 1 | 受付 | 入庫待ち → 入庫済み | サービスフロント |
| 2 | 診断 | 入庫済み → 見積作成待ち or 作業待ち | 整備士 |
| 3 | 見積 | 見積作成待ち → 見積提示済み | サービスフロント |
| 4 | 承認 | 見積提示済み → 作業待ち | 顧客 |
| 5 | 作業 | 作業待ち → 出庫待ち | 整備士 |
| 6 | 報告 | 出庫待ち → 出庫済み | サービスフロント |

### スキップされるケース

**車検・12ヵ月点検で追加見積もりがない場合**:
- Phase 3（見積）とPhase 4（承認）をスキップ
- ステータス遷移: `入庫済み` → `作業待ち`（`見積作成待ち`と`見積提示済み`をスキップ）

---

## 🎯 改善提案（改訂版）

### 提案1: ステータス連動型ステップインジケーター（推奨）

**コンセプト**: JOBカードのステータス（field5）と連動し、実際のワークフローを正確に反映

#### デスクトップ表示

```
┌─────────────────────────────────────────────────────────────────┐
│ [←] 受入点検（車検）診断                                          │
│                                                                   │
│ ┌──────┬──────┬──────┬──────┬──────┐                          │
│ │ 受付  │ 診断  │ 見積  │ 作業  │ 報告  │  ← ステップバー      │
│ │  ✓   │  ●   │  ─   │  ○   │  ○   │  ← スキップ表示        │
│ │完了済み│作業中 │スキップ│未完了 │未完了 │                          │
│ └──────┴──────┴──────┴──────┴──────┘                          │
│   [←前へ: 受付]              [次へ: 作業 →]                      │
└─────────────────────────────────────────────────────────────────┘
```

**要素**:
- **ステップバー**: 各フェーズを横並びで表示
  - 完了: ✓（グレー）+ "完了済み"
  - 現在: ●（青、大きく表示）+ "作業中"
  - スキップ: ─（点線）+ "スキップ"
  - 未完了: ○（グレー）+ "未完了"
- **フェーズ名**: 各ステップに明確な名称を表示
- **ステータス表示**: 各ステップの状態をテキストで表示
- **ナビゲーションボタン**: 前後のフェーズに移動（権限がある場合のみ）

#### モバイル表示（コンパクト）

```
┌─────────────────────────────────────┐
│ [←] 受入点検（車検）診断              │
│                                       │
│ 診断 (2/5)                            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ 受付 ✓  診断 ●  見積 ─  作業 ○  報告 ○ │
│ [←前へ] [次へ→]                      │
└─────────────────────────────────────┘
```

### 提案2: ステータス（field5）連動ロジック

#### ステータスからフェーズ状態を判定

```typescript
/**
 * ステータス（field5）からフェーズの状態を判定
 */
function getPhaseStatusFromJobStatus(
  phase: number,
  jobStatus: string,
  skippedPhases: number[] = []
): "active" | "completed" | "skipped" | "pending" {
  // スキップされたフェーズ
  if (skippedPhases.includes(phase)) {
    return "skipped";
  }
  
  // Phase 0: 事前チェックイン
  if (phase === 0) {
    // field7に「【事前入力】」が含まれている場合、またはfield22（入庫日時）が設定されている場合
    return jobStatus !== "入庫待ち" ? "completed" : "pending";
  }
  
  // Phase 1: 受付
  if (phase === 1) {
    if (jobStatus === "入庫待ち") return "active";
    if (["入庫済み", "見積作成待ち", "見積提示済み", "作業待ち", "出庫待ち", "出庫済み"].includes(jobStatus)) {
      return "completed";
    }
    return "pending";
  }
  
  // Phase 2: 診断
  if (phase === 2) {
    if (jobStatus === "入庫済み") return "active";
    if (["見積作成待ち", "見積提示済み", "作業待ち", "出庫待ち", "出庫済み"].includes(jobStatus)) {
      return "completed";
    }
    return "pending";
  }
  
  // Phase 3: 見積
  if (phase === 3) {
    if (jobStatus === "見積作成待ち") return "active";
    if (["見積提示済み", "作業待ち", "出庫待ち", "出庫済み"].includes(jobStatus)) {
      return "completed";
    }
    return "pending";
  }
  
  // Phase 4: 承認
  if (phase === 4) {
    if (jobStatus === "見積提示済み") return "active";
    if (["作業待ち", "出庫待ち", "出庫済み"].includes(jobStatus)) {
      return "completed";
    }
    return "pending";
  }
  
  // Phase 5: 作業
  if (phase === 5) {
    if (jobStatus === "作業待ち") return "active";
    if (["出庫待ち", "出庫済み"].includes(jobStatus)) {
      return "completed";
    }
    return "pending";
  }
  
  // Phase 6: 報告
  if (phase === 6) {
    if (jobStatus === "出庫待ち") return "active";
    if (jobStatus === "出庫済み") {
      return "completed";
    }
    return "pending";
  }
  
  return "pending";
}
```

#### スキップフェーズの判定

```typescript
/**
 * スキップされるフェーズを判定
 * 車検・12ヵ月点検で追加見積もりがない場合、Phase 3（見積）とPhase 4（承認）をスキップ
 */
function getSkippedPhases(
  job: ZohoJob,
  hasAdditionalEstimate: boolean
): number[] {
  const isInspection = job.serviceKind === "車検" || job.serviceKind === "12ヵ月点検";
  
  if (isInspection && !hasAdditionalEstimate) {
    return [3, 4]; // 見積・承認をスキップ
  }
  
  return [];
}
```

### 提案3: ユーザーロール別の表示最適化（改訂版）

#### 整備士（Mechanic）向け表示

**主な業務**: 診断（Phase 2）、作業（Phase 5）

**表示内容**:
- **診断画面**: 診断と作業のみを表示（Phase 2, 5）
- **作業画面**: 診断と作業のみを表示（Phase 2, 5）
- **前後のフェーズへの移動**: 必要に応じて前後のフェーズに移動可能（権限チェック付き）

```
┌─────────────────────────────────────┐
│ 診断 (1/2)                           │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ 診断 ●  作業 ○                       │
│ [←前へ] [次へ→]                      │
└─────────────────────────────────────┘
```

#### サービスフロント（Front）向け表示

**主な業務**: 受付（Phase 1）、見積（Phase 3）、顧客へのプレゼンテーション

**表示内容**:
- **全体表示**: 全フェーズを表示（Phase 0-6、スキップされたフェーズは点線表示）
- **現在のフェーズを強調**: 現在作業中のフェーズをハイライト
- **前後のフェーズへの移動**: 必要に応じて前後のフェーズに移動可能

```
┌─────────────────────────────────────────────────────────────┐
│ 見積 (3/7)                                                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 事前問診 ✓  受付 ✓  診断 ✓  見積 ●  承認 ○  作業 ○  報告 ○ │
│ [←前へ] [次へ→]                                              │
└─────────────────────────────────────────────────────────────┘
```

**スキップされたフェーズがある場合**:
```
┌─────────────────────────────────────────────────────────────┐
│ 作業 (5/7)                                                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 事前問診 ✓  受付 ✓  診断 ✓  見積 ─  承認 ─  作業 ●  報告 ○ │
│ [←前へ] [次へ→]                                              │
└─────────────────────────────────────────────────────────────┘
```

### 提案4: インタラクティブなナビゲーション（改訂版）

#### クリック可能なステップ

- **完了したフェーズ**: クリックでそのフェーズのページに移動（権限がある場合）
- **現在のフェーズ**: クリックで詳細モーダルを表示
- **スキップされたフェーズ**: クリックで「このフェーズはスキップされました」などのメッセージを表示
- **未完了のフェーズ**: クリックで「このフェーズはまだ完了していません」などのメッセージを表示

#### 前後ナビゲーションボタン

- **前へボタン**: 前のフェーズに移動（権限がある場合、完了している場合）
- **次へボタン**: 次のフェーズに移動（権限がある場合、現在のフェーズが完了している場合）
- **無効化**: 権限がない、または前のフェーズが完了していない場合は無効化
- **スキップされたフェーズ**: スキップされたフェーズは自動的に飛ばす

---

## 🔧 実装設計（改訂版）

### コンポーネント設計

#### `WorkflowStepIndicator`（新規コンポーネント）

```typescript
interface WorkflowStepIndicatorProps {
  /** 現在のフェーズ（0-6） */
  currentPhase: number;
  /** ジョブステータス（field5） */
  jobStatus?: string;
  /** 完了したフェーズのリスト（オプション、jobStatusから自動判定も可能） */
  completedPhases?: number[];
  /** スキップするフェーズのリスト（オプション、jobStatusから自動判定も可能） */
  skippedPhases?: number[];
  /** 除外するフェーズのリスト（JOBカードに表示するため除外） */
  excludePhases?: number[];
  /** ユーザーロール */
  userRole?: UserRole;
  /** ジョブID（ナビゲーション用） */
  jobId?: string;
  /** 追加見積もりの有無（スキップ判定用） */
  hasAdditionalEstimate?: boolean;
  /** モバイル表示モード */
  mobileMode?: boolean;
  /** ナビゲーション有効化 */
  enableNavigation?: boolean;
}
```

#### ステータス連動ロジック

```typescript
/**
 * ジョブステータスからフェーズの状態を自動判定
 */
function usePhaseStatusFromJob(
  job: ZohoJob | null,
  currentPhase: number,
  hasAdditionalEstimate: boolean = true
) {
  const skippedPhases = useMemo(() => {
    if (!job) return [];
    return getSkippedPhases(job, hasAdditionalEstimate);
  }, [job, hasAdditionalEstimate]);
  
  const completedPhases = useMemo(() => {
    if (!job?.field5) return [];
    const phases: number[] = [];
    
    // Phase 0: 事前チェックイン
    if (job.field7 || job.field22) {
      phases.push(0);
    }
    
    // Phase 1: 受付
    if (job.field5 !== "入庫待ち") {
      phases.push(1);
    }
    
    // Phase 2: 診断
    if (["見積作成待ち", "見積提示済み", "作業待ち", "出庫待ち", "出庫済み"].includes(job.field5)) {
      phases.push(2);
    }
    
    // Phase 3: 見積（スキップされていない場合）
    if (!skippedPhases.includes(3) && ["見積提示済み", "作業待ち", "出庫待ち", "出庫済み"].includes(job.field5)) {
      phases.push(3);
    }
    
    // Phase 4: 承認（スキップされていない場合）
    if (!skippedPhases.includes(4) && ["作業待ち", "出庫待ち", "出庫済み"].includes(job.field5)) {
      phases.push(4);
    }
    
    // Phase 5: 作業
    if (["出庫待ち", "出庫済み"].includes(job.field5)) {
      phases.push(5);
    }
    
    // Phase 6: 報告
    if (job.field5 === "出庫済み") {
      phases.push(6);
    }
    
    return phases;
  }, [job, skippedPhases]);
  
  return { completedPhases, skippedPhases };
}
```

---

## 🎨 UI/UXデザイン詳細（改訂版）

### デスクトップ表示（推奨）

```
┌─────────────────────────────────────────────────────────────────────┐
│ [←] 受入点検（車検）診断                                             │
│                                                                       │
│ ┌──────────┬──────────┬──────────┬──────────┬──────────┐           │
│ │   受付    │   診断    │   見積    │   作業    │   報告    │           │
│ │          │          │          │          │          │           │
│ │    ✓     │    ●     │    ─     │    ○     │    ○     │           │
│ │ 完了済み  │ 作業中    │ スキップ  │ 未完了    │ 未完了    │           │
│ └──────────┴──────────┴──────────┴──────────┴──────────┘           │
│                                                                       │
│ [← 前へ: 受付]              [次へ: 作業 →]                            │
└─────────────────────────────────────────────────────────────────────┘
```

**要素**:
- **ステップカード**: 各フェーズをカード形式で表示
  - 高さ: `h-20`（80px、タッチターゲット48px以上）
  - 幅: 等幅（`flex-1`）
  - パディング: `p-4`
  - フォントサイズ: `text-base`（16px以上）
- **アイコン**: 完了（✓）、現在（●）、スキップ（─）、未完了（○）
- **フェーズ名**: 明確な名称を表示
- **ステータス**: "完了済み"、"作業中"、"スキップ"、"未完了"などのテキスト
- **ナビゲーションボタン**: 前後のフェーズに移動（権限がある場合のみ、スキップされたフェーズは自動的に飛ばす）

### モバイル表示（コンパクト）

```
┌─────────────────────────────────────┐
│ [←] 受入点検（車検）診断              │
│                                       │
│ 診断 (2/5)                            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                       │
│ [受付] [診断] [見積] [作業] [報告]   │
│   ✓     ●     ─     ○     ○        │
│                                       │
│ [← 前へ]        [次へ →]             │
└─────────────────────────────────────┘
```

---

## 🚀 実装手順（改訂版）

### Step 1: 新しいコンポーネントの作成

**ファイル**: `src/components/features/workflow-step-indicator.tsx`

**実装内容**:
1. ステップインジケーターコンポーネントの作成
2. **ステータス連動ロジックの実装**（重要）
3. ユーザーロール別の表示ロジック
4. ナビゲーション機能（前後ボタン、クリック可能なステップ）
5. レスポンシブデザイン（デスクトップ・モバイル）

### Step 2: 既存コンポーネントの置き換え

**ファイル**: `src/app/mechanic/diagnosis/[id]/page.tsx`, `src/app/mechanic/work/[id]/page.tsx`

**実装内容**:
1. `WorkflowPhaseIndicator`を`WorkflowStepIndicator`に置き換え
2. **ジョブステータス（field5）の取得と渡し**（重要）
3. **追加見積もりの有無の取得と渡し**（スキップ判定用）
4. ユーザーロールの取得と渡し
5. ジョブIDの取得と渡し（ナビゲーション用）

### Step 3: ナビゲーション機能の実装

**実装内容**:
1. フェーズとURLのマッピング
2. 権限チェックロジック
3. 前後ボタンの実装（スキップされたフェーズは自動的に飛ばす）
4. クリック可能なステップの実装

### Step 4: ユーザーロール別の最適化

**実装内容**:
1. 整備士向けの表示（診断・作業のみ）
2. サービスフロント向けの表示（全フェーズ、スキップされたフェーズは点線表示）
3. 顧客向けの表示（事前問診・承認・報告のみ）

---

## ✅ 実装チェックリスト（改訂版）

- [ ] `WorkflowStepIndicator`コンポーネントの作成
- [ ] **ステータス連動ロジックの実装**（重要）
- [ ] **スキップフェーズ判定ロジックの実装**（重要）
- [ ] ステップインジケーター形式のUI実装
- [ ] フェーズ名の表示
- [ ] 進捗バーの実装
- [ ] ナビゲーションボタン（前後）の実装（スキップされたフェーズは自動的に飛ばす）
- [ ] クリック可能なステップの実装
- [ ] ユーザーロール別の表示ロジック
- [ ] 権限チェックロジック
- [ ] フェーズとURLのマッピング
- [ ] レスポンシブデザイン（デスクトップ・モバイル）
- [ ] 診断ページでの実装（ジョブステータスと追加見積もりの有無を渡す）
- [ ] 作業ページでの実装（ジョブステータスと追加見積もりの有無を渡す）
- [ ] 見積ページでの実装
- [ ] 動作確認（整備士・サービスフロント・顧客）
- [ ] **スキップされたフェーズの表示確認**（重要）

---

## 🎯 期待される効果（改訂版）

1. **視認性の向上**: フェーズ名を表示することで、現在の位置と次のステップが明確になる
2. **ステータス連動**: JOBカードのステータスとワークフローインジケーターが一致し、混乱を防ぐ
3. **スキップ表示**: スキップされたフェーズが明確に表示され、ワークフローの理解が容易になる
4. **ナビゲーションの改善**: 前後のフェーズに移動できることで、業務効率が向上
5. **ユーザーロール別の最適化**: 各ユーザーの業務に合わせた表示により、使いやすさが向上
6. **全体像の把握**: サービスフロントが全体を見ることで、業務の流れを把握しやすくなる

---

## 📝 重要な変更点

### 既存提案からの変更点

1. **ステータス連動ロジックの追加**: JOBカードのステータス（field5）と連動してフェーズの状態を自動判定
2. **スキップフェーズ判定の追加**: 車検・12ヵ月点検で追加見積もりがない場合、Phase 3（見積）とPhase 4（承認）をスキップ
3. **スキップ表示の追加**: スキップされたフェーズを点線（─）で表示
4. **ナビゲーションの改善**: スキップされたフェーズは自動的に飛ばす

### 実装上の注意点

1. **ジョブステータスの取得**: 各ページでジョブステータス（field5）を取得し、コンポーネントに渡す必要がある
2. **追加見積もりの有無の取得**: 診断ページと作業ページで追加見積もりの有無を判定し、コンポーネントに渡す必要がある
3. **スキップ判定のタイミング**: 診断完了時に追加見積もりの有無を判定し、スキップフェーズを決定する





