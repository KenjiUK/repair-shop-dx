# 修理・整備 確認済み仕様書

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: 修理・整備の確認済み仕様
- **ステータス**: 実装準備完了

---

## 1. 確認済み事項

### 1-1. 業務フローパターン

**質問**: パターンA（入庫→診断→見積→承認→作業）で正しいか？

**回答**: ✅ **パターンA（入庫→診断→見積→承認→作業）で正しい**

**設計決定**:
- 入庫してから診断を実施
- 診断時に診断機にあてる場合もある
- 診断結果に基づいて見積を作成
- **承認**: 現場で口頭で許可をもらったり、事前にもらう場合もある
- 承認後に作業を実施

### 1-2. 故障診断との関係

**質問**: 修理・整備は故障診断の結果を受けて実施する場合と、独立した入庫区分として実施する場合があるのか？

**回答**: ✅ **両方ある。故障診断で入庫で預かったものが、そのまま同じレコードで修理・整備に代わる感じ。新しく予定を入れない**

**設計決定**:
- **パターン1（故障診断から移行）**: 故障診断で入庫で預かったものが、そのまま同じレコード（Job）で修理・整備に移行
  - 新しく予定を入れない
  - 同じJobレコードで入庫区分が「故障診断」から「修理・整備」に変わる
- **パターン2（独立した入庫区分）**: 独立した入庫区分として「修理・整備」で入庫
  - 新しく予定を入れる
  - 独立したJobレコードとして管理

### 1-3. 複数日にまたがる場合

**質問**: 部品取り寄せなどで複数日にまたがる場合の扱いは？

**回答**: ✅ **部品取り寄せが必要だったり、色々なケースがある**

**設計決定**:
- 部品取り寄せが必要な場合は、複数日にまたがる
- 様々なケースがあるため、柔軟に対応できる設計が必要
- ステータス管理で対応（「部品取り寄せ中」「作業待ち」など）

### 1-4. 診断機の利用

**質問**: 診断機の利用について

**回答**: ✅ **診断時に診断機にあてる場合もある**

**設計決定**:
- 診断時に診断機にあてる場合がある
- 診断機を使用する場合は、診断機費用を見積に含める
- 診断機の結果は故障診断と同様に扱う

### 1-5. 承認フロー

**質問**: 承認フローについて

**回答**: ✅ **現場で口頭で許可をもらったり、事前にもらう場合もある**

**設計決定**:
- 承認は口頭でも事前でもあり得る
- システム上は承認フローを簡易化（確認のみ）
- 口頭承認の場合は、システム上は承認済みとして扱う

### 1-6. データソース

**質問**: データソースについて

**回答**: ✅ **すべて同じ**

**設計決定**:
- 車両情報: Google Sheets「【DB】車両マスタ」の「車両_同期用」シートから取得
- 費用情報: 同じく「車両_同期用」シートから取得（該当する場合）
- 部品情報: 部品マスタから取得（今後実装）

### 1-7. PDF生成

**質問**: PDF生成について

**回答**: ✅ **不要。PDFで出すのは車検と12ヶ月点検のみ**

**設計決定**:
- 修理・整備ではPDF生成は不要
- 作業記録はシステム内で管理
- 顧客への説明は口頭または画面で実施

---

## 2. 確定した仕様サマリー

### 2-1. 業務フロー（パターンA）

```
1. 入庫: 修理希望の車両が入庫
2. 受付: 修理内容を確認（5分）
3. 診断: 修理箇所の確認・簡易検査を実施（30分-1時間）
   - 診断機にあてる場合もある
4. 見積作成: 部品代・工賃の見積もりを作成（30分）
5. 顧客承認: 見積内容を確認して承認
   - 現場で口頭で許可をもらう場合
   - 事前にもらう場合
6. 作業実施: 承認後に修理を実施（1-4時間）
   - 部品取り寄せが必要な場合は複数日にまたがる
7. 引渡・説明: 修理内容を説明して引渡（15分）
```

### 2-2. 故障診断からの移行

**パターン1（故障診断から移行）**:
- 故障診断で入庫で預かったものが、そのまま同じレコード（Job）で修理・整備に移行
- 新しく予定を入れない
- 同じJobレコードで入庫区分が「故障診断」から「修理・整備」に変わる
- ステータス管理で対応

**パターン2（独立した入庫区分）**:
- 独立した入庫区分として「修理・整備」で入庫
- 新しく予定を入れる
- 独立したJobレコードとして管理

### 2-3. 診断機の利用

**設計決定**:
- 診断時に診断機にあてる場合がある
- 診断機を使用する場合は、診断機費用を見積に含める
- 診断機の結果は故障診断と同様に扱う

### 2-4. 承認フロー

**設計決定**:
- 承認は口頭でも事前でもあり得る
- システム上は承認フローを簡易化（確認のみ）
- 口頭承認の場合は、システム上は承認済みとして扱う

### 2-5. 複数日にまたがる場合

**設計決定**:
- 部品取り寄せが必要な場合は、複数日にまたがる
- 様々なケースがあるため、柔軟に対応できる設計が必要
- ステータス管理で対応（「部品取り寄せ中」「作業待ち」など）

### 2-6. 検査項目

**設計決定**:
- 修理箇所の確認
- 関連箇所の簡易点検
- 診断機を使用する場合もある

### 2-7. 写真撮影

**設計決定**:
- Before/After写真を撮影（必要に応じて）
- 動画撮影はケースバイケース

### 2-8. 測定値

**設計決定**:
- 必要に応じて測定値を入力
- 診断機を使用する場合は、診断機の結果を優先

### 2-9. PDF生成

**設計決定**:
- 修理・整備ではPDF生成は不要
- 作業記録はシステム内で管理

### 2-10. データソース

**設計決定**:
- 車両情報: Google Sheets「【DB】車両マスタ」の「車両_同期用」シートから取得
- 費用情報: 同じく「車両_同期用」シートから取得（該当する場合）
- 部品情報: 部品マスタから取得（今後実装）

---

## 3. 画面設計

### 3-1. 受付画面（Phase 1）

#### 修理内容の確認

**設計**:
- 修理内容の確認
- 走行距離を入力
- 前回整備履歴の表示

**UI要素**:
- 修理内容入力欄（テキストエリア）
- 走行距離入力欄
- 前回整備履歴表示

### 3-2. 診断画面（Phase 2）

#### 簡易検査項目

**設計**:
- 修理箇所の確認
- 関連箇所の簡易点検
- 診断機の利用選択（必要に応じて）
- 測定値の入力（必要に応じて）
- 写真撮影（Before）

**UI要素**:
- 検査項目リスト（修理箇所に応じて動的）
- 診断機利用選択（チェックボックス、必要に応じて）
- 測定値入力フィールド（必要に応じて）
- 写真撮影ボタン
- コメント入力欄

### 3-3. 見積画面（Phase 3）

#### 部品代・工賃の見積もり

**設計**:
- 部品代・工賃の見積もり
- 作業時間の見積もり
- 診断機費用（診断機を使用した場合）
- 写真・コメントの紐付け

**UI要素**:
- 部品選択UI
- 工賃入力欄
- 作業時間見積もり入力欄
- 診断機費用表示（診断機を使用した場合）
- 合計金額表示
- 写真・コメントの紐付け

### 3-4. 作業画面（Phase 4）

#### 作業記録

**設計**:
- 実施した作業の記録
- Before/After写真の撮影
- 交換部品の記録
- 動作確認の結果

**UI要素**:
- 作業記録入力欄
- Before/After写真撮影ボタン
- 交換部品入力欄
- 動作確認チェックボックス
- 作業メモ入力欄

---

## 4. データモデル

### 4-1. 修理・整備ジョブデータ

```typescript
/**
 * 修理・整備ジョブ
 */
export interface RepairMaintenanceJob {
  /** Job ID */
  jobId: string;
  /** 入庫区分 */
  serviceKind: "修理・整備";
  /** 故障診断からの移行か */
  isFromFaultDiagnosis?: boolean;
  /** 元の故障診断Job ID（移行の場合） */
  originalFaultDiagnosisJobId?: string;
  
  /** 修理情報 */
  repair: {
    /** 修理内容（顧客の説明） */
    description: string;
    /** 走行距離 */
    mileage: number;
  };
  
  /** 診断情報 */
  diagnosis: {
    /** 診断機の利用有無 */
    usesDiagnosticTool?: boolean;
    /** 診断機費用 */
    diagnosticToolCost?: number;
    /** 診断機結果PDF URL */
    diagnosticToolResultUrl?: string;
    /** 検査項目の結果 */
    inspectionResults: InspectionResult[];
    /** 測定値 */
    measurements?: Record<string, number>;
    /** 写真 */
    photos: Photo[];
    /** コメント（整備士の所見） */
    comments: string;
  };
  
  /** 見積情報 */
  estimate: {
    /** 部品代・工賃の見積もり */
    parts: Part[];
    labor: number;
    /** 作業時間の見積もり */
    estimatedDuration: number;
    /** 診断機費用 */
    diagnosticToolCost?: number;
    total: number;
    /** 承認方法 */
    approvalMethod: "oral" | "prior" | "system";
  };
  
  /** 作業情報 */
  work: {
    /** 実施した作業の記録 */
    repairRecords: RepairRecord[];
    /** Before/After写真 */
    photos: Photo[];
    /** 交換部品 */
    replacedParts: ReplacedPart[];
    /** 動作確認結果 */
    operationCheck: OperationCheckResult;
  };
  
  /** ステータス */
  status: "診断中" | "見積作成待ち" | "部品取り寄せ中" | "作業待ち" | "作業中" | "出庫待ち";
}
```

---

## 5. 実装方針

### 5-1. 故障診断からの移行実装

**設計**:
- 故障診断で入庫で預かったものが、そのまま同じレコード（Job）で修理・整備に移行
- 新しく予定を入れない
- 同じJobレコードで入庫区分が「故障診断」から「修理・整備」に変わる
- `isFromFaultDiagnosis`フラグで移行元を記録
- `originalFaultDiagnosisJobId`で元のJob IDを記録（必要に応じて）

### 5-2. 承認フローの実装

**設計**:
- 承認は口頭でも事前でもあり得る
- システム上は承認フローを簡易化（確認のみ）
- `approvalMethod`で承認方法を記録（"oral" | "prior" | "system"）
- 口頭承認の場合は、システム上は承認済みとして扱う

### 5-3. 複数日にまたがる場合の実装

**設計**:
- 部品取り寄せが必要な場合は、複数日にまたがる
- ステータス管理で対応（「部品取り寄せ中」「作業待ち」など）
- 様々なケースがあるため、柔軟に対応できる設計が必要

### 5-4. 診断機の利用実装

**設計**:
- 診断時に診断機にあてる場合がある
- 診断機を使用する場合は、診断機費用を見積に含める
- 診断機の結果は故障診断と同様に扱う

---

## 6. 次のステップ

1. **故障診断からの移行機能の実装**: 同じJobレコードで入庫区分を変更する機能
2. **承認フローの実装**: 口頭承認・事前承認・システム承認の対応
3. **ステータス管理の実装**: 部品取り寄せ中などのステータス管理
4. **診断機連携の実装**: 診断機システムとの連携（必要に応じて）

---

## 更新履歴

- 2025-01-XX: 初版作成（確認済み仕様書）


































