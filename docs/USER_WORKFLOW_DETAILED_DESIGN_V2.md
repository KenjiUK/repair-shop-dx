# **ユーザー別業務・システム利用詳細設計 v2.0：複数作業管理対応版**

## **変更履歴**

- **v2.0 (2025-01-XX)**: 複数作業管理・ワークオーダー対応を追加
  - 1つの入庫に対して複数の作業（車検、オイル交換、コーティングなど）を管理可能に
  - 各作業ごとの診断・見積・作業実施を個別に管理
  - 基幹システムで統合請求書を作成

---

# **ユーザー別業務・システム利用詳細設計：1. お客様（顧客）**

## **1-1. 新規のお客様：「問い合わせから予約まで」**

**【裏側の動き】** HP/電話 → 商談 (Deals) → 受注 → 入庫管理 (CustomModule2)

- **Step 1: 問い合わせ**
    - **行動:** HPのフォーム送信、または電話で問い合わせる。
    - **利用ツール:** Webフォーム or 電話
    - **データ連携ロジック:**
        - **HPフォームの場合:** WordPressの連携プラグインにより、自動的にZoho CRMの**「商談 (Deals)」**にレコードが作成される。
        - **電話の場合:** スタッフが応対。その場で予約が決まればZoho Bookings経由で入力し、自動でCRMに登録される。
        - **見積進行の場合:** 商談が進み、見積もりを出す段階で事務員が**「スマートカーディーラー（基幹）」**に顧客・車両情報を登録する。
        - **同期:** 翌朝のデータ更新時（CSV Export/Import）に、基幹システムの情報がZoho CRMの顧客・車両情報として正式に上書き・補完される。

- **Step 2: 予約を入れる（金額合意後）**
    - **行動:** スタッフから送られてきたメールリンクをクリックし、予約画面を開く。
    - **利用ツール:** **Zoho Bookings**
    - **データ整合性のポイント:**
        - **紐付け:** スタッフは、商談ID等が紐付いた「個別予約URL」を送付するのが理想（自動名寄せのため）。
        - **名寄せ:** 汎用URLの場合でも、**「メールアドレス」**をキーにして既存の商談/顧客データと自動結合する設定とする。
        - **電話番号処理（重要）:** 新規作成時、Bookingsに入力された電話番号は一時フィールド（Booking_Phone_Temp）に入る。
            - **ワークフロー:** **「レコード作成時」かつ「メインの携帯電話(Mobile)が空欄」の場合**、一時フィールドの値をMobileにコピーする処理を走らせる。

    - **カレンダーへの反映:**
        - お客様が「10月15日 10:00」を選択。
        - → Zoho Bookingsが Zoho CRMの「予定 (Events)」 モジュールにデータを登録。
        - → これが Zoho Calendar に自動同期され、全スタッフが確認できる状態になる。
        - → 同時に自動ワークフローが走り、**「入庫管理 (CustomModule2)」** にレコードが作成される。
        - **【v2.0新機能】:** 入庫管理レコード作成時、初期の入庫区分（例：車検）が`field_service_kinds`に設定され、最初のワークオーダーが`field_work_orders`（JSON形式）に自動生成される。

## **1-2. 既存のお客様：「車検・点検の予約」**

**【裏側の動き】** Zoho Campaigns → Bookings → 入庫管理 (CustomModule2)

- **Step 1: リマインド受信**
    - **行動:** 「車検（または12ヶ月点検）のご案内」メールが届く。
    - **利用ツール:** **Zoho Campaigns**
    - **データ:** Zoho CRMの「車両データ（車検満了日/次回点検日）」をトリガーに自動送信される。

- **Step 2: 即時予約**
    - **行動:** メール内のリンクから **Zoho Bookings** を開き、希望日時をポチる。
    - **利用ツール:** **Zoho Bookings**
    - **データ:** 予約完了と同時に、Zoho CRM内に「入庫管理レコード」が自動生成される。
    - **【不整合対策（電話番号）】:**
        - **課題:** お客様が「自宅」や「変わった携帯番号」を入力して、CRM上の正しい携帯番号が上書きされるのを防ぐ。
        - **解決策:** Bookingsの電話番号項目は、CRMの **「予約時連絡先 (Booking_Phone_Temp)」** にマッピングする（Mobile にはマッピングしない）。
        - **結果:** 基幹由来の正しい携帯番号は守られ、今回入力された番号は備考として残る。
    - **【v2.0新機能】:** 入庫管理レコード作成時、初期の入庫区分（例：12ヶ月点検）が`field_service_kinds`に設定され、最初のワークオーダーが`field_work_orders`（JSON形式）に自動生成される。

## **1-3. 入庫前日〜当日：「事前チェックイン（Web受付票）」**

**【裏側の動き】** 新アプリ → Zoho更新 (入庫管理・顧客備考)

- **Step 1: 案内受信 & アクセス**
    - **行動:** 予約確定時メール、または入庫前日のリマインドメールにある**「Web受付票（事前チェックイン）」**のリンクを開く。
    - **利用ツール:** **新アプリ (Next.js)**

- **Step 2: 車両の特定 (Vehicle Selection)**
    - **行動:** 「今回ご入庫のお車はどちらですか？」の問いに対し、表示されたリストから選択する。
    - **データロジック (Sheets連携):**
        - アプリはZohoの顧客ID (ID1) をキーに、Google Sheets (車両マスタ) を検索してリストを表示する。
        - **【既存車両の場合】:** リストから選択 → Zoho CustomModule2 の field6 (車両ID) に紐付けられる。
        - **【新規車両/代替えの場合】:** リストにないため**「別の車（新規）」**を選択する。
            - → **「車種名（例: BMW X3）」をテキスト入力**し、スマホで車検証を撮影してアップロード。
            - → 車種名は field7 (詳細情報) に、画像は field12 (関連ファイル) に保存される。
            - → (後工程) 事務員がこれらを見て、基幹システムへ正確に登録する。

- **Step 3: 顧客情報の確認 (不整合対策)**
    - **行動:** 現在登録されている住所・電話番号を確認し、変更があれば修正入力する。
    - **データロジック (重要):**
        - **メール配信同意:** チェックボックスON/OFF → Zoho Contacts の Email_Opt_Out を即時更新。
        - **住所・電話変更:** 入力された新情報は、Zoho Contacts の**「備考 (Description)」**に「【アプリ変更届】新住所：...」として追記される。
            - ※基幹システムとの不整合を防ぐため、メインの住所フィールドは上書きしない。

- **Step 4: 問診入力 (Details)**
    - **行動:** 現在の走行距離、不具合の内容（「ブレーキから異音」など）、代車希望の有無を入力して送信。
    - **データ:**
        - 走行距離 → field10
        - 不具合内容 → field7 (詳細情報)

    - **完了:** これで当日の受付準備が整い、フロントのタブレットに「📝事前入力あり」アイコンが表示されるようになる。

## **1-4. 【v2.0新機能】見積承認：「複数作業の選択と承認」**

**【裏側の動き】** 新アプリ → Zoho更新 (承認済み作業の記録)

- **Step 1: 見積通知受信**
    - **行動:** LINE/メールで「お見積もりの準備ができました」という通知を受け取る。
    - **利用ツール:** **新アプリ (Next.js)**
    - **URL:** マジックリンク方式で、ログイン不要でアクセス可能。

- **Step 2: 複数作業の見積確認**
    - **行動:** 見積画面を開き、複数の作業項目を確認する。
    - **画面構成:**
        - **Section A: 必須整備 (Mandatory)**
            - 例：「法定24ヶ月点検」「諸費用」など
            - チェックボックスはONのまま固定（外せない）
        - **Section B: 推奨整備 (Recommended)**
            - 例：「フロントブレーキパッド交換」「ファンベルト交換」など
            - メカニックが「🔴 要交換」と判定したもの
            - 証拠写真・動画が紐付けられている
            - デフォルトはON（OFFにできる）
        - **Section C: 任意整備 (Optional)**
            - 例：「ワイパー交換」「エアコンフィルター」など
            - デフォルトはOFF（ONにできる）
    - **【v2.0新機能】各作業ごとの表示:**
        - 各作業項目には、対応するワークオーダーIDが紐付けられている
        - 作業ごとに証拠写真・動画が表示される
        - 作業ごとに金額が表示され、リアルタイムで合計金額が再計算される

- **Step 3: 作業の選択・調整**
    - **行動:** 予算に合わせて、各作業をON/OFFで調整する。
    - **例:**
        - 「ワイパーは自分でやるからOFF（-¥8,000）」
        - 「エアコン臭いからフィルターはON（+¥5,000）」
    - **リアルタイム計算:** 画面下部の「お支払い合計」がリアルタイムで再計算される。

- **Step 4: 承認確定**
    - **行動:** 内容が決まったら、画面最下部の **[この内容で作業を依頼する]** ボタンをタップ。
    - **【v2.0新機能】データ保存:**
        - 承認された作業のみが`field_work_orders`内に記録される
        - 各ワークオーダーのステータスが「顧客承認済み」に更新される
        - 承認されなかった作業は`field_work_orders`内に残るが、ステータスが「見送り」になる
    - **完了画面:** 「ありがとうございます。作業を開始いたします。完了まで今しばらくお待ち下さい」

---

# **ユーザー別業務・システム利用詳細設計：2. サービスフロント（石塚・岡島）**

**役割:** お客様対応の最前線であり、基幹システム（金庫）とアプリ（現場）の橋渡し役。

**基本スタンス:** スケジュールは「Zoho Calendar」、対面対応は「新アプリ（タブレット/PC）」、計算は「スマートカーディーラー（基幹）」で行う。

## **2-1. 開店前〜来店前：「本日の予定確認」**

**【裏側の動き】** Zoho Calendar (Booking連携済み) / CRM → 新アプリ Dashboard

- **業務:** 本日の入庫予定と、代車の準備状況、および事前に受けている相談内容を確認する。
- **利用ツール:** **Zoho Calendar**（全体俯瞰） / **新アプリ**（詳細確認）
- **アクション:**
    1. Zoho Calendarで全体のスケジュール感を把握する。
    2. 新アプリのダッシュボードを見る。
    3. **「📝申し送りあり」アイコンの確認:**
        - 事前チェックインでお客様が不具合（ブレーキ異音など）を入力していた場合、アイコンが表示されているのでチェックする。
    4. **「⚠作業指示あり」アイコンの確認:**
        - 数日前に電話があり、**Zoho Forms** で入力しておいた「ETCセットアップ」などの指示がここに表示されているので内容を確認する。
    5. **【v2.0新機能】実施作業リストの確認:**
        - Jobカード内に、実施予定の作業リスト（バッジ形式）が表示されている
        - 例：「車検」「オイル交換」「コーティング」
        - 各作業のステータス（診断中、見積作成待ち、作業待ち、完了）が表示される
    6. 朝礼でメカニック（中村・谷口・永見）に「田中様のBMW、ブレーキ音とETCの確認よろしく」と申し送りをする。

## **2-2. 来店受付：「タグ紐付けとデジタル受付」**

**【裏側の動き】** 新アプリ → 内部DB (Tagging) → Zoho入庫管理 (Status Update)

- **業務:** お客様を出迎え、鍵を預かり、タグを付け、その場で言われた要望をメモしてメカニックへ引き継ぐ。
- **利用ツール:** **新アプリ（タブレット）**
- **アクション:**
    1. **タグ取付:** 預かった鍵に「タグNo.05」を付ける。
    2. **紐付け:** アプリ画面で、来店した「田中様」の横にある **[05]** ボタンをタップする。
        - ※これで「タグ05 ＝ 田中様のBMW」という定義がシステム内で確立されます。
    3. **既存指示の確認:** 画面に「⚠ETCセットアップ」と出ているので、「ETCですね、承っております」とお客様に伝える。
    4. **【v2.0新機能】当日追加作業の受付:**
        - 「あと、ついでにオイル交換もお願いします」と言われたら、**「作業を追加」**ボタンを押す。
        - 作業種類を選択（オイル交換、コーティングなど）
        - 作業詳細を入力（必要に応じて）
        - 追加された作業が`field_service_kinds`に追加され、新しいワークオーダーが`field_work_orders`内に作成される
        - 画面に「オイル交換」が追加されたことが表示される
    5. **当日追加:** 「あと、ついでにワイパーも見て」と言われたら、**その場のアプリ画面内**の作業指示メモ欄で「ワイパー確認」と追記する。
        - *(※ここでZoho Formsを開くのは手間なのでアプリで完結させる)*
    6. **受付完了:** **[受付完了]** ボタンを押す。
        - Zohoのステータスが「入庫済み」になり、メカニックのスマホにも「田中様 入庫」が表示されます。

## **2-3. 【v2.0新機能】見積作成：「複数作業の個別見積作成」**

**【裏側の動き】** App(Drive参照) → 基幹入力（各作業ごと） → App入力（各作業ごと） → Zoho保存

- **業務:** 診断結果を確認し、各作業ごとに基幹システムで正確な計算を行い、アプリで見せる見積もりを作る。
- **利用ツール:** **新アプリ** ➕ **スマートカーディーラー（基幹）**
- **アクション:**
    1. **診断確認 (App):** 新アプリでメカニックが撮った写真・動画とコメント（赤・黄判定）を確認。
    2. **【v2.0新機能】作業選択:**
        - 見積作成画面で、**作業選択タブまたはドロップダウン**から作業を選択する
        - 例：「車検」「オイル交換」「コーティング」
        - 選択された作業の診断結果が表示される
    3. **正確な計算 (基幹):** 横のPCで**スマートカーディーラー**を開き、**選択された作業ごとに**部品商に発注をかけつつ、正確な見積書（税・工賃込み）を作る。
        - 例：車検 → 合計 134,750円
        - 例：オイル交換 → 合計 10,560円
        - 例：コーティング → 合計 50,000円
    4. **アプリ転記 (App):** 新アプリの「見積作成画面」に戻り、**選択された作業**の項目（松竹梅）を作る。
        - 項目：「Fブレーキパッド交換」 / 金額：「33,000円」
        - *(※品番などの詳細は不要。品名と税込金額のみ)*
        - 入力した見積情報が`field_work_orders`内の該当作業に保存される
    5. **【v2.0新機能】他の作業の見積作成:**
        - 作業選択タブまたはドロップダウンで別の作業を選択
        - 上記3-4の手順を繰り返して、各作業ごとの見積を作成
    6. **証拠紐付け (App):**
        - **写真:** 該当項目の横に、ドラッグ＆ドロップで紐付ける。
        - **動画 (MVP仕様):** 動画がある場合は「動画リンクボタン」が表示されているので、それを項目に紐付ける（クリックするとDriveへ飛ぶリンクとして機能する）。
    7. **【v2.0新機能】統合見積の確認:**
        - すべての作業の見積が完了したら、統合見積画面で確認
        - 合計金額が自動計算されて表示される
        - 各作業ごとの金額と証拠写真・動画が一覧表示される
    8. **送信:** **[LINEで送信]** ボタンを押す。
        - 顧客に統合見積が送信される

## **2-4. 【v2.0新機能】整備完了・統合請求書発行：「複数作業をまとめた請求書作成」**

**【裏側の動き】** 基幹PDF出力（統合請求書） → アプリ経由でDrive保存

- **業務:** すべての作業が完了したら、複数作業をまとめた統合請求書を基幹システムで作成し、アプリに登録する。
- **利用ツール:** **スマートカーディーラー** ➕ **新アプリ**
- **アクション:**
    1. **完了確認:** 新アプリで、すべての承認された作業が「完了」ステータスになっていることを確認する。
    2. **基幹システムで統合請求書作成:**
        - スマートカーディーラーを開く
        - `field_base_system_id`を参照して、基幹システムの入庫IDまたは伝票番号を確認
        - 基幹システムで、すべての完了したワークオーダーをまとめた統合請求書を作成
        - 例：車検（134,750円）+ オイル交換（10,560円）+ コーティング（50,000円）= 合計 195,310円
    3. **PDF化:** 統合請求書をPDFとしてデスクトップに保存する。
    4. **命名規則 (統一ルール):** ファイル名には必ず**「invoice」「seikyu」「請求書」**のいずれかの文字列を含めること。
        - *OK例:* 20251015_田中様_請求書.pdf (日本語OK、部分一致)
    5. **登録 (App):** 新アプリの管理画面から **[請求書PDF登録]** ボタンを押し、保存したPDFをアップロードする。
        - 請求書IDを`field_work_orders`内の`baseSystemInvoiceId`に記録
        - *(システムが自動でDriveの正しいフォルダに保存)*
    6. **通知:** **[完了通知送信]** ボタンを押す（引取予約リンクが送信される）。

## **2-5. 出庫・説明：「タブレット・プレゼン」**

**【裏側の動き】** 新アプリ → Zohoステータス更新 (Closed)

- **業務:** お客様に結果を説明し、車を返し、タグを回収する。
- **利用ツール:** **新アプリ（タブレット）**
- **アクション:**
    1. **プレゼン:** アプリの「完了報告モード」で、Before（摩耗した部品）とAfter（新品）の写真を並べて見せる。
        - **【v2.0新機能】:** 各作業ごとのBefore/After写真が表示される
    2. **会計:** レジで精算（基幹システム）。
    3. **タグ回収:** 鍵から「タグNo.05」を外し、回収ボックスへ戻す。
    4. **出庫処理:** アプリで **[出庫完了]** ボタンを押す。
        - これでタグNo.05はシステム上で「空き」になり、次の人のために使えるようになります。

## **2-6. 情報不整合の修正（Human Middleware）**

**【裏側の動き】** Zoho備考欄 → 基幹修正 → 翌朝同期

- **業務:** アプリで受け付けた変更届を、正（基幹）に反映する。ここが情報の不整合を正す業務である。
- **タイミング:** 手が空いた時、または夕方。
- **トリガー:**
    1. 新アプリのダッシュボードに**「📝住所変更あり」**のアイコンが出ている。
    2. または、Zoho Bookingsからの通知（備考欄への記載）がきている。

- **アクション:**
    1. Zoho CRMの当該顧客を開き、Description（備考）を見る。
        - *「【アプリ変更届】新住所：大阪市...」*
        - *「Booking_Phone_Temp: 090-xxxx-xxxx」*
    2. **スマートカーディーラー（基幹）** を開き、顧客マスタを正しい情報に修正する。
    3. **完了処理 (DX):** 新アプリ上の **[変更対応完了]** ボタンを押す。
        - *(裏側: API経由でZoho CRMの備考欄から【アプリ変更届】の文字列を削除し、アイコンを消灯させる)*

---

# **ユーザー別業務・システム利用詳細設計：3. 整備士（中村・谷口・永見）**

**役割:** PCには触らない。スマホ片手に、整備と記録だけに集中するプロフェッショナル。

**基本スタンス:** 汚れた手でも操作できるUI（親指操作・音声入力）を徹底する。

## **3-1. 着手：「車両特定と申し送り確認」**

**【裏側の動き】** 新アプリ (Tag Scan) → 情報表示

- **業務:** 目の前の車が「誰の車」で「何をすべきか」を把握する。
- **利用ツール:** **新アプリ（スマホ）**
- **アクション:**
    1. **アプリ起動:** スマホでアプリを開き、「本日の入庫リスト」を確認する。
    2. **特定:** 鍵に付いている「タグNo.05」のQRコードをカメラでスキャンする（またはリストからタップ）。
    3. **情報確認:**
        - 画面に**「田中様 BMW X3」**と表示される。
        - **「📝申し送り：ブレーキ異音」**（事前チェックイン情報）
        - **「⚠作業指示：ワイパー確認」**（フロントからの追加指示）
        - **【v2.0新機能】実施作業リスト:**
            - 「車検」「オイル交換」「コーティング」などの実施予定作業が表示される
            - 各作業のステータス（診断中、見積作成待ち、作業待ち、完了）が表示される
        - これらを一目で確認し、作業のポイントを把握する。

## **3-2. 【v2.0新機能】診断・撮影：「各作業ごとの診断実施」**

**【裏側の動き】** 画像圧縮(Client) → Drive保存 → 診断データDB保存（各作業ごと）

- **業務:** 各作業ごとに車両の状態を記録し、不具合箇所を特定する。
- **利用ツール:** **新アプリ（スマホ）**
- **アクション:**
    1. **【v2.0新機能】作業選択:**
        - 診断画面で、**作業選択タブまたはドロップダウン**から作業を選択する
        - 例：「車検」「オイル交換」「コーティング」
        - 選択された作業の診断情報が表示される（初回は空）
    2. **入庫撮影:**
        - ガイドに従い「前・後・左・右」のリズムで4枚撮影する。
        - **(重要: アプリがクライアントサイドで500KB以下に圧縮・透かし入れ・リネームしてDriveへ送る)**
    3. **点検:**
        - チェックリストをタップしていく（信号機方式）。
        - 異常なしなら **[🟢]** を連打。
        - パッドが減っていたら **[🔴]** をタップ。
    4. **証拠撮影:**
        - [🔴] を押すとカメラが起動。該当箇所を接写する。
        - **動画 (MVP仕様):** 異音などがある場合は動画モードで撮影。
            - *(裏側: Driveにアップロードされ、アプリ上では再生プレイヤーではなく「動画リンク」として扱われる)*
    5. **コメント:**
        - 手が汚れているため、マイクボタンを押し**「パッド残2ミリ、交換推奨」**と喋る。
        - *(裏側: Whisper APIでテキスト化され入力される)*
    6. **【v2.0新機能】診断結果の保存:**
        - 診断結果が`field_work_orders`内の該当作業に保存される
        - 該当作業のステータスが「診断完了」に更新される
    7. **【v2.0新機能】他の作業の診断:**
        - 作業選択タブまたはドロップダウンで別の作業を選択
        - 上記2-6の手順を繰り返して、各作業ごとの診断を実施
    8. **完了:** すべての作業の診断が完了したら、**[診断完了]** ボタンをスワイプ。フロントへ通知が飛ぶ。

## **3-3. 【v2.0新機能】作業実施：「各作業ごとの承認項目のみ実行」**

**【裏側の動き】** 見積確定データ参照（各作業ごと） → 作業完了通知

- **業務:** フロントがお客様から承認を得た各作業の項目だけを作業する。
- **利用ツール:** **新アプリ（スマホ）**
- **タイミング:** フロントから「作業許可降りました（通知）」が届いた後。
- **アクション:**
    1. **【v2.0新機能】作業選択:**
        - アプリの作業画面で、**作業選択タブまたはドロップダウン**から作業を選択する
        - 例：「車検」「オイル交換」「コーティング」
    2. **リスト確認:**
        - 選択された作業の作業リストを開く。
        - ここには**「承認された項目（Fブレーキパッド交換）」**だけが表示されており、見送られた「ワイパー交換」は消えている（またはグレーアウト）。
        - *(これにより、「言われた・言わない」や「やりすぎ」のミスを防ぐ)*
    3. **作業 & 証拠撮影:**
        - 部品交換を行う。
        - **[証拠撮影 (Capture After)]** ボタンを押し、「新品と旧品」を並べて撮影する。
    4. **【v2.0新機能】作業結果の保存:**
        - 作業結果が`field_work_orders`内の該当作業に保存される
        - 該当作業のステータスが「作業完了」に更新される
    5. **【v2.0新機能】他の作業の作業:**
        - 作業選択タブまたはドロップダウンで別の作業を選択
        - 上記2-4の手順を繰り返して、各作業ごとの作業を実施
    6. **完了:** すべての承認された作業が完了したら、**[作業完了 (Job Done)]** をスワイプ。
        - フロントへ「終わったよ（請求書作って）」という合図になる。

## **3-4. 広報協力：「ブログ素材収集（ボーナストラック）」**

**【裏側の動き】** ブログ用フォルダへ保存

- **業務:** 珍しい車や面白い整備事例があった時、広報担当（本庄さん）のために素材を残す。
- **利用ツール:** **新アプリ（スマホ）**
- **アクション:**
    1. **モード切替:** 撮影画面でタブを **[ブログモード]** に切り替える。
    2. **撮影:** 「カッコいいアングル」で数枚撮る。
    3. **タグ付け:** 「入庫車両」「作業風景」などのタグを選んで保存。
        - *(裏側: 顧客用フォルダではなく、広報用の共有Driveフォルダに保存される)*

---

# **ユーザー別業務・システム利用詳細設計：4. 事務（今福）**

**役割:** 基幹システム（スマートカーディーラー）の守護神。新アプリは直接の接客には使わないが、データの入出力と整合性を管理する。

## **4-1. 朝のルーチン：「マスタデータの同期」**

**【裏側の動き】** 基幹CSV出力 → Drive → GASでSheetsへ展開

- **業務:** 新アプリで最新の車両情報（車検日など）を使えるように、基幹データをエクスポートする。
- **利用ツール:** **スマートカーディーラー** ➕ **Google Drive**
- **アクション:**
    1. **出力:** スマートカーディーラーから「顧客マスタ」「車両マスタ」をCSV（またはExcel）で出力する。
    2. **アップロード:** PC上のGoogle Drive同期フォルダ（所定の場所）にファイルを上書き保存する。
    3. **完了:** 後の処理（Google Sheetsへの反映）はGASが自動で行うため、これだけで作業終了。

## **4-2. 【v2.0新機能】請求書発行管理：「複数作業をまとめた統合請求書のPDF化とアプリ登録」**

**【裏側の動き】** 基幹PDF出力（統合請求書） → アプリ経由でDrive保存

- **業務:** フロントが確定させた複数の整備作業に基づき、公式な統合請求書を発行・保存する。
- **利用ツール:** **スマートカーディーラー** ➕ **新アプリ（管理画面）**
- **アクション:**
    1. **【v2.0新機能】完了確認:**
        - 新アプリの管理画面で、すべての承認された作業が「完了」ステータスになっていることを確認する
        - `field_work_orders`内の各作業のステータスを確認
    2. **基幹システムで統合請求書作成:**
        - スマートカーディーラーを開く
        - `field_base_system_id`を参照して、基幹システムの入庫IDまたは伝票番号を確認
        - 基幹システムで、すべての完了したワークオーダーをまとめた統合請求書を作成
        - 例：車検（134,750円）+ オイル交換（10,560円）+ コーティング（50,000円）= 合計 195,310円
    3. **発行:** スマートカーディーラーで統合請求書を作成し、PDFとしてPCに保存する。
    4. **命名規則 (統一ルール):** ファイル名には必ず**「invoice」「seikyu」「請求書」**のいずれかの文字列を含めること。
        - *OK例:* 20251015_田中様_請求書.pdf、invoice_tanaka.pdf (日本語OK、部分一致)
    5. **登録:** 新アプリの管理画面（PC）を開き、当該案件の **[請求書PDF登録]** ボタンからアップロードする。
        - 請求書IDを`field_work_orders`内の`baseSystemInvoiceId`に記録
        - *(※直接Google Driveに置くのではなく、必ずアプリ経由で行うことで、格納先ミスを防ぐ)*

## **4-3. 【最重要】マスタデータの修正（Human Middleware）**

**【裏側の動き】** Zoho備考欄参照 → 基幹手入力修正 → 完了ボタン

- **業務:** アプリ経由で届いた「住所変更」や「新規車両」の情報を、正本である基幹システムに反映させる。
- **利用ツール:** **Zoho CRM** ➕ **スマートカーディーラー** ➕ **新アプリ**
- **タイミング:** 夕方、または手が空いた時。
- **アクション:**
    1. **変更届の確認:** 新アプリの管理画面（またはZoho CRM）で、「変更申請あり」の顧客を確認する。
        - *備考欄: 「【アプリ変更届】新住所：...」*
        - *関連ファイル: 新規車両の車検証画像*
    2. **基幹修正:** 記載された新住所や画像を見て、スマートカーディーラーの顧客・車両情報を手動で修正・登録する。
    3. **消込 (DX):** 作業が終わったら、新アプリ上で **[変更対応完了]** ボタンを押す。
        - *(裏側: システムがAPI経由でZoho CRMの備考欄から【アプリ変更届】の文字列を削除し、アイコンを消灯させる)*

---

# **ユーザー別業務・システム利用詳細設計：5. ブログ担当（本庄）**

**役割:** 現場に行かずとも、自動で集まってくる素材を活用して広報活動を行う。

## **5-1. 素材収集と執筆**

**【裏側の動き】** Drive（ブログ用フォルダ）参照

- **業務:** ブログやSNSの記事を書く。
- **利用ツール:** **Google Drive** ➕ **WordPress / Instagram**
- **アクション:**
    1. **素材探し:** Google Driveの「ブログ素材」フォルダを見る。
    2. **発見:** メカニックが撮影した「珍しい旧車のエンジンルーム」の写真が入っているのを見つける。
    3. **執筆:** その写真をダウンロードし、ブログ記事を作成してアップロードする。
        - *(わざわざ工場に降りていき「何かネタない？」と聞く必要がなくなる)*

---

# **ユーザー別業務・システム利用詳細設計：6. システム担当（小椋賢二＝あなた）**

**役割:** このエコシステム全体の創造主であり、監視者。Cursorを使って継続的に改善を行う。

## **6-1. 開発・改善サイクル**

**【裏側の動き】** Cursor → GitHub → Vercel

- **業務:** 現場からの「ここ使いにくい」という要望を即座に反映させる。
- **利用ツール:** **Cursor AI** ➕ **Vercel**
- **アクション:**
    1. **要望:** フロントから「文字が小さくて読めない」と言われる。
    2. **修正:** Cursorを開き、「v0で作ったUIのフォントサイズを上げて」と指示。
    3. **デプロイ:** 修正を確認し、GitHubへプッシュ。Vercelが自動で本番環境を更新する。

## **6-2. 監視・メンテナンス**

**【裏側の動き】** 各種管理画面

- **業務:** システムが停止しないよう監視する。
- **利用ツール:** **Zoho設定** / **Google Cloud Console**
- **アクション:**
    1. **API監視:** ZohoのAPI使用量が上限に達していないか、たまにチェックする（設計上は余裕あり）。
    2. **Drive容量:** 画像圧縮が正しく機能しているか、Driveの容量推移をチェックする。
    3. **アカウント管理:** 退職者が出た場合のZohoアカウント停止など。
    4. **【v2.0新機能】ワークオーダーデータの整合性確認:**
        - `field_work_orders`（JSON形式）のデータ整合性を確認
        - 各作業のステータスが正しく更新されているか確認
        - 基幹システムの請求書ID（`baseSystemInvoiceId`）が正しく記録されているか確認

---

## **【v2.0新機能】システム全体のデータフロー図**

```
┌─────────────────────────────────────┐
│  基幹システム（スマートカーディーラー）│
│  - 統合請求書の作成・確定            │
│  - マスタデータの管理                │
└─────────────────────────────────────┘
           │ CSV/Excel (マスタ)
           ↓
┌─────────────────────────────────────┐
│  Google Sheets（マスタキャッシュ）   │
│  - Read Only                        │
└─────────────────────────────────────┘
           │ API
           ↓
┌─────────────────────────────────────┐
│  Zoho CRM（Transaction Hub）        │
│  - 入庫管理（CustomModule2）        │
│    - field_service_kinds: 実施作業  │
│    - field_work_orders: 詳細(JSON) │
│    - field_base_system_id: 連携ID  │
└─────────────────────────────────────┘
           │ API
           ↓
┌─────────────────────────────────────┐
│  Webアプリ（Next.js）               │
│  - 複数作業の管理                    │
│  - 各作業ごとの診断・見積・作業     │
│  - 統合見積・承認                    │
└─────────────────────────────────────┘
```

---

## **【v2.0新機能】主要な変更点のまとめ**

### **1. 複数作業の管理**
- 1つの入庫に対して複数の作業（車検、オイル交換、コーティングなど）を管理可能
- 各作業は個別のワークオーダーとして管理される

### **2. 各作業ごとの診断・見積・作業**
- 診断画面、見積作成画面、作業画面に作業選択機能を追加
- 各作業ごとに診断結果、見積情報、作業結果を保存

### **3. 統合見積・承認**
- すべての作業の見積をまとめて顧客に提示
- 顧客が各作業ごとに承認・却下を選択可能

### **4. 統合請求書の作成**
- すべての作業完了後、基幹システムで統合請求書を作成
- 請求書IDを`field_work_orders`内に記録

### **5. 当日追加作業の受付**
- 受付時または診断中に、新しい作業を追加可能
- 追加された作業も同じ入庫に紐付けられる

---

## **更新履歴**

- **v2.0 (2025-01-XX)**: 複数作業管理・ワークオーダー対応を追加
- **v1.0 (2025-01-XX)**: 初版作成


























