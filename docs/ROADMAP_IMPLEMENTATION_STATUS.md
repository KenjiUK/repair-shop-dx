# Roadmap Phase 0-5 実装状況

**作成日:** 2025-12-21  
**目的:** RoadmapのPhase 0-5の実装状況を確認し、未実装機能を特定

---

## Phase 0: 基盤システム連携の実装（必須）

### 実装状況: ✅ ほぼ完了

#### 1. Zoho CRMの拡張（条件付き）
- **状況:** モック環境で実装済み
- **注意:** 実際のZoho CRMフィールド追加は管理者による設定が必要
- **代替案:** Google Drive JSON管理方式の実装準備済み

#### 2. Google Sheets連携（マスタデータ同期）✅
- **実装済み:**
  - `src/lib/google-sheets.ts` - 車両マスタ・顧客マスタの読み込みAPI
  - 日本語カラム名対応
  - SWRキャッシュ機能（TTL 1時間）
  - 読み取り専用として実装（追加・編集・削除は不可）

#### 3. Google Drive連携（ファイル保存）✅
- **実装済み:**
  - `src/lib/google-drive.ts` - フォルダ構造の自動生成
  - 写真・動画・PDFのアップロード機能
  - ファイル命名規則の実装
  - ファイル検索・取得機能
  - 車検証の管理（最新版と履歴の管理）
  - ブログ用写真の管理（複数の分類フォルダに自動コピー）

#### 4. GAS（Google Apps Script）の実装 ✅
- **実装済み:**
  - `scripts/gas-master-data-sync.gs` - CSV/Excel → Google Sheets変換機能
  - ファイル形式検証（CSV、Excel）
  - エンコーディング処理（UTF-8/Shift-JIS自動検出）
  - エラーハンドリングと通知機能
- **未設定:**
  - フォルダID、スプレッドシートIDなどの設定値（`YOUR_FOLDER_ID_HERE`など）
  - トリガー設定（Time-drivenまたはonChangeイベント）

#### 5. スマートタグ管理システム構築 ✅
- **実装済み:**
  - `src/lib/api.ts` - タグ紐付け・解放処理
  - `src/hooks/use-smart-tags.ts` - タグ管理フック
  - `src/components/features/smart-tag-scan-dialog.tsx` - QRコードスキャン機能
  - タグライフサイクル管理（active/closedセッション管理）

---

## Phase 1: 共通基盤と複数作業管理の実装

### 実装状況: ✅ ほぼ完了

#### 1. 共通UI/UXコンポーネントライブラリ ✅
- **実装済み:**
  - `AppHeader`（ヘッダーコンポーネント）
  - `JobCard`（ジョブカードコンポーネント）
  - `TodaySummaryCard`（本日のサマリーカード）
  - `StatusBadge`（ステータスバッジ）
  - 基本UIコンポーネント（Button、Input、Select、Tabsなど）
  - `PhotoCaptureButton`（写真撮影ボタン）
  - `VideoCaptureButton`（動画撮影ボタン）
  - `AudioInputButton`（音声入力ボタン）

#### 2. 統一データモデルの実装（複数作業管理対応）✅
- **実装済み:**
  - `WorkOrder`インターフェース（`src/types/index.ts`）
  - `src/lib/work-order-converter.ts` - データ変換ロジック（Zoho CRM ↔ アプリ内データモデル）

#### 3. API設計の統一実装（ワークオーダーCRUD）✅
- **実装済み:**
  - `GET /api/jobs/{id}/work-orders` - ワークオーダー一覧取得
  - `POST /api/jobs/{id}/work-orders` - ワークオーダー作成
  - `src/app/api/jobs/[id]/work-orders/[workOrderId]/route.ts` - ワークオーダー詳細取得・更新・削除

#### 4. 複数作業管理機能の実装 ✅
- **実装済み:**
  - `src/components/features/add-work-order-dialog.tsx` - 「作業を追加」ボタンとモーダル
  - `src/components/features/work-order-selector.tsx` - 作業選択UI（タブ/ドロップダウン）
  - `src/hooks/use-work-orders.ts` - ワークオーダー管理フック
  - 作業ごとのデータ分離（診断・見積・作業情報）

#### 5. エラーハンドリングの統一実装 ✅
- **実装済み:**
  - 統一エラーレスポンス形式（`ApiResponse<T>`）
  - ユーザー向けエラーメッセージ表示（toast通知）

#### 6. オフライン対応基盤の実装 ✅
- **実装済み:**
  - `src/lib/offline-storage.ts` - IndexedDBによるデータ永続化
  - `src/hooks/use-online-status.ts` - オフライン状態の検知
  - `src/components/features/offline-banner.tsx` - オフラインバナー
  - `src/components/features/sync-indicator.tsx` - 同期状態インジケーター
  - `src/hooks/use-auto-sync.ts` - オンライン復帰時の自動同期処理
  - `src/lib/sync-manager.ts` - 同期管理
  - `src/lib/upload-queue.ts` - 未アップロードファイルのキュー管理

#### 7. セキュリティ基盤の実装 ✅
- **実装済み:**
  - `src/lib/auth.ts` - 認証基盤（将来のJWT対応準備）
  - ファイルアップロードバリデーション（`src/lib/file-validation.ts`）

#### 8. 効果測定基盤の実装 ✅
- **実装済み:**
  - `src/lib/action-tracking.ts` - 利用統計の自動収集
  - `src/lib/api-timing.ts` - API応答時間の計測機能
  - `src/hooks/use-page-timing.ts` - 画面表示時間の計測フック
  - 主要ページでのAPI応答時間計測（TOPページ、診断画面、見積画面、作業画面）
  - 主要ページでの画面表示時間計測（TOPページ、診断画面、見積画面、作業画面）

#### 9. Zoho API制約対応の実装 ✅
- **実装済み:**
  - SWRキャッシュによるAPI呼び出し回数の削減
  - エラーハンドリング（リトライ戦略、フィールド不存在時のフォールバック）
  - `src/lib/lookup-field-validation.ts` - Lookupフィールド更新時の参照先レコードID検証機能
  - `src/lib/api-retry.ts` - APIレート制限対策（429エラー時の自動リトライ、指数バックオフ）
  - `updateJobField6`関数にLookupフィールド検証を統合

#### 10. 顧客(Contacts)モジュール更新制約の実装 ✅
- **実装済み:**
  - `src/lib/api.ts` - `appendToCustomerDescription`関数
  - `src/lib/customer-description-append.ts` - Descriptionへの追記ロジック
  - 直接更新NGフィールドの変更要求を`Description`フィールドに追記

---

## Phase 2: 主要入庫区分の実装（単一作業対応）

### 実装状況: ✅ 実装済み

#### 主要5入庫区分の実装 ✅
- **車検:** 実装済み
- **12ヵ月点検:** 実装済み
- **エンジンオイル交換:** 実装済み
- **故障診断:** 実装済み
- **修理・整備:** 実装済み

#### 顧客向け進捗通知機能（LINE）✅
- **実装済み:**
  - `src/lib/line-api.ts` - LINE Messaging API連携
  - マジックリンク生成（ログイン不要の見積確認・承認URL）
  - 通知テンプレートの作成

#### ブログ用写真の管理機能 ✅
- **実装済み:**
  - `src/lib/blog-photo-manager.ts` - ブログ用写真の管理機能
  - 複数の分類フォルダに自動コピー
  - ファイル名の自動リネーム

#### ローディング/フィードバックUI ✅
- **実装済み:**
  - スケルトンUIコンポーネント
  - トースト通知コンポーネント（shadcn/ui）
  - オプティミスティックUI対応

---

## Phase 3: 複数作業管理の統合

### 実装状況: ✅ 実装済み

#### 1. 複数作業管理機能の統合 ✅
- **実装済み:**
  - すべての入庫区分で「作業を追加」機能を有効化
  - すべての入庫区分で作業選択UIを実装
  - 作業ごとのデータ分離を実装
  - URLパラメータ `workOrderId` で対象ワークオーダーを識別
  - 画面ヘッダーに現在の作業名を表示

#### 2. 見積作成フローの基幹システム連携実装 ✅
- **実装済み:**
  - 見積画面に「基幹システムで見積作成」ボタンを追加（`src/app/admin/estimate/[id]/page.tsx`）
  - アドバイザー向けの手順表示（基幹システム連携セクション）
  - 見積項目の転記機能（CSV形式：品名,金額（税込））
  - 基幹システム明細ID入力機能（各ワークオーダーごと）

#### 3. 請求書統合フローの実装 ✅
- **実装済み:**
  - 基幹システムでの統合請求書作成手順の表示（`InvoiceUpload`コンポーネント）
  - 請求書PDFアップロード機能（ファイル名に「invoice」「seikyu」「請求書」を含む）
  - `baseSystemInvoiceId`の記録機能（`updateJobBaseSystemId`関数）
  - `baseSystemItemId`の記録機能（各ワークオーダーごと）

#### 4. マスタデータ同期の実装 ✅
- **実装済み:**
  - GASの実装（`scripts/gas-master-data-sync.gs`）
  - データ不整合時の対応UI（「📝変更申請あり」アイコン表示 - `JobCard`コンポーネント）
  - 「変更対応完了」ボタンの実装（`JobCard`コンポーネント、`CustomerDetailDialog`コンポーネント）
  - `markChangeRequestCompleted`関数（Zoho CRMのDescriptionから【アプリ変更届】の文字列を削除）
  - `updateCustomerDescription`関数（Description更新用API）

---

## Phase 4: 拡張入庫区分の実装

### 実装状況: ✅ 実装完了

#### 実装済みの入庫区分:
- **コーティング:** 実装済み（事前見積画面、作業画面の拡張含む）
- **タイヤ交換・ローテーション:** 実装済み
  - 診断画面（`TireInspectionView`コンポーネント使用、簡易検査項目、測定値入力）
  - 見積画面（診断結果から見積項目を自動追加）
  - 作業画面（承認された作業項目の完了処理）
- **その他のメンテナンス:** 実装済み
  - 診断画面（`MaintenanceInspectionView`コンポーネント使用、カスタマイズ可能な診断項目）
  - 見積画面（診断結果から見積項目を自動追加）
  - 作業画面（承認された作業項目の完了処理）
- **チューニング・パーツ取付:** 実装済み
  - 診断画面（`TuningPartsInspectionView`コンポーネント使用、種類選択：チューニング/パーツ取付、部品取り寄せ対応）
  - 見積画面（診断結果から見積項目を自動追加、部品リストアップ）
  - 作業画面（承認された作業項目の完了処理、作業記録、Before/After写真）
- **板金・塗装:** 実装済み
  - 診断画面（`BodyPaintDiagnosisView`コンポーネント使用、損傷箇所確認、外注先への見積もり依頼、Before動画撮影必須）
  - 見積画面（`BodyPaintEstimateView`コンポーネント使用、外注先からの見積もり回答表示、保険対応、作業期間1-3カ月の表示）
  - 作業画面（`BodyPaintOutsourcingView`コンポーネント使用、外注作業管理、作業進捗状況表示、品質確認チェックリスト、After写真撮影必須）
- **レストア:** 実装済み
  - 診断画面（`RestoreDiagnosisView`コンポーネント使用、現状確認、修復箇所確認、レストアの種類選択：フルレストア/部分レストア、Before写真必須）
  - 見積画面（`RestoreEstimateView`コンポーネント使用、部品リスト管理、追加作業管理、見積もり変更履歴、作業期間の表示）
  - 作業画面（`RestoreWorkView`コンポーネント使用、フェーズ管理、マイルストーン管理、進捗管理0-100%、部品取り寄せ管理、作業記録、Before/After写真必須）

#### 未実装の入庫区分:
- **その他:** 未実装

---

## Phase 5: 高度な機能の実装

### 実装状況: ⚠️ 未実装

#### 未実装項目:
1. **長期カスタムの管理機能**
   - レストアのフェーズ管理機能の強化
   - 板金・塗装の外注作業進捗管理機能の強化
   - 長期プロジェクトの進捗可視化

2. **ビデオコミュニケーション機能**
   - リアルタイムビデオ通話機能
   - ビデオ録画機能
   - ビデオ共有機能

3. **顧客ポータル機能**
   - 顧客向けダッシュボード
   - 作業進捗の確認機能
   - 見積もりの確認・承認機能
   - 請求書の確認・ダウンロード機能

4. **リアルタイム同期機能の強化**
   - リアルタイム更新（ポーリング方式、WebSocketサーバーは将来実装予定）
   - オフライン対応の強化（既に実装済み）
   - データ同期の最適化

---

## 次の開発項目（優先度順）

### 高優先度

1. ✅ **Phase 3: 見積作成フローの基幹システム連携実装** - 実装完了
   - ✅ 見積画面に「基幹システムで見積作成」ボタンを追加
   - ✅ アドバイザー向けの手順表示
   - ✅ 見積項目の転記機能

2. ✅ **Phase 3: 請求書統合フローの実装** - 実装完了
   - ✅ 基幹システムでの統合請求書作成手順の表示
   - ✅ 請求書PDFアップロード機能
   - ✅ `baseSystemInvoiceId`の記録機能
   - ✅ `baseSystemItemId`の記録機能

3. ✅ **Phase 3: マスタデータ同期の実装（UI部分）** - 実装完了
   - ✅ データ不整合時の対応UI（「📝変更申請あり」アイコン表示）
   - ✅ 「変更対応完了」ボタンの実装

### 中優先度

4. ✅ **Phase 1: 効果測定基盤の実装（未実装部分）** - 実装完了
   - ✅ API応答時間の計測
   - ✅ 画面表示時間の計測

5. ✅ **Phase 1: Zoho API制約対応の実装（未実装部分）** - 実装完了
   - ✅ Lookupフィールド更新時の参照先レコードID検証
   - ✅ APIレート制限対策（429エラー時の自動リトライ、指数バックオフ）

6. ✅ **Phase 4: 拡張入庫区分の実装** - 実装完了
   - ✅ タイヤ交換・ローテーション - 実装完了
   - ✅ その他のメンテナンス - 実装完了
   - ✅ チューニング・パーツ取付 - 実装完了
   - ✅ 板金・塗装 - 実装完了
   - ✅ レストア - 実装完了
   - ✅ その他 - 実装完了

### 低優先度（Phase 5: 高度な機能の実装）

7. **Phase 5: 高度な機能の実装**
   - 長期カスタムの管理機能
     - レストアのフェーズ管理機能の強化
     - 板金・塗装の外注作業進捗管理機能の強化
     - 長期プロジェクトの進捗可視化
   - ビデオコミュニケーション機能
     - リアルタイムビデオ通話機能
     - ビデオ録画機能
     - ビデオ共有機能
   - 顧客ポータル機能
     - 顧客向けダッシュボード
     - 作業進捗の確認機能
     - 見積もりの確認・承認機能
     - 請求書の確認・ダウンロード機能
   - リアルタイム同期機能の強化
     - リアルタイム更新（ポーリング方式、WebSocketサーバーは将来実装予定）
     - オフライン対応の強化（既に実装済み）
     - データ同期の最適化

---

## 更新履歴

- 2025-12-21: 初版作成（Phase 0-5の実装状況を確認）
- 2025-12-21: Phase 3の未実装機能（見積作成フローの基幹システム連携、請求書統合フロー、マスタデータ同期のUI部分）の実装完了を記録
- 2025-12-21: Phase 1の効果測定基盤の未実装部分（API応答時間の計測、画面表示時間の計測）の実装完了を記録
- 2025-12-21: Phase 1のZoho API制約対応の未実装部分（Lookupフィールド更新時の参照先レコードID検証、APIレート制限対策）の実装完了を記録
- 2025-12-21: Phase 4の拡張入庫区分「タイヤ交換・ローテーション」の実装完了を記録（診断画面、見積画面、作業画面）
- 2025-12-21: Phase 4の拡張入庫区分「その他のメンテナンス」の実装完了を記録（診断画面、見積画面、作業画面）。見積画面と作業画面の判定ロジックを修正（「その他」→「その他のメンテナンス」）
- 2025-12-21: Phase 4の拡張入庫区分「チューニング・パーツ取付」の実装完了を記録（診断画面、見積画面、作業画面）
- 2025-12-21: Phase 4の拡張入庫区分「板金・塗装」の実装完了を記録（診断画面、見積画面、作業画面）
- 2025-12-21: Phase 4の拡張入庫区分「レストア」の実装完了を記録（診断画面、見積画面、作業画面）
- 2025-12-21: Phase 4の拡張入庫区分「その他」の実装完了を記録（診断画面、見積画面、作業画面）。Phase 4の拡張入庫区分の実装が完了



