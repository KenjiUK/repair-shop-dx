# 一時帰宅機能 - ユーザージャーニー分析

**作成日:** 2025-01-XX
**目的:** 一時帰宅機能のユーザージャーニーを理解し、実装の不備を特定・修正

---

## ユーザージャーニー分析

### パターン1: 一時帰宅して戻ってくる（見積承認パターン）

**フロー:**
1. **診断完了**
   - メカニックが診断を完了
   - 「一時帰宅」を選択
   - 再入庫予定日時を入力（例: 明日の10:00）
   - ステータス: 「見積作成待ち」（一時帰宅中として表示）

2. **見積作成・提示**
   - 事務員が見積を作成
   - 顧客に見積を提示（LINE送信）
   - ステータス: 「見積提示済み」（一時帰宅情報は保持）

3. **見積承認**
   - 顧客が見積を承認
   - ステータス: 「作業待ち」に更新
   - **問題**: 一時帰宅中の場合は、再入庫が必要
   - **対応**: 一時帰宅情報がある場合、「作業待ち」でも「再入庫待ち」として表示すべき

4. **再入庫**
   - 再入庫予定日時に顧客が再入庫
   - チェックイン処理を実行
   - 一時帰宅情報を削除（または「再入庫済み」として記録）
   - ステータス: 「入庫済み」または「作業待ち」（一時帰宅情報なし）

5. **作業開始**
   - メカニックが作業を開始
   - ステータス: 「作業待ち」→「作業中」（通常のフロー）

---

### パターン2: 一時帰宅して戻ってこない（見積却下または作業依頼しないパターン）

**フロー:**
1. **診断完了**
   - メカニックが診断を完了
   - 「一時帰宅」を選択
   - 再入庫予定日時を入力（例: 明日の10:00）
   - ステータス: 「見積作成待ち」（一時帰宅中として表示）

2. **見積作成・提示**
   - 事務員が見積を作成
   - 顧客に見積を提示（LINE送信）
   - ステータス: 「見積提示済み」（一時帰宅情報は保持）

3. **見積却下または作業依頼しない**
   - 顧客が見積を却下、または作業を依頼しない
   - **問題**: 一時帰宅情報を削除する必要があるかもしれない
   - **対応**: 見積却下時、または一定期間経過後、一時帰宅情報を削除する処理を追加

4. **ジョブ終了**
   - ステータス: 「出庫済み」または「キャンセル」
   - 一時帰宅情報を削除

---

## 現在の実装の問題点

### 1. 見積承認後の処理

**問題:**
- 見積承認後、ステータスが「作業待ち」になるが、一時帰宅中の場合は再入庫が必要
- 一時帰宅情報がある場合、「作業待ち」でも「再入庫待ち」として表示すべき

**現在の実装:**
```typescript
// src/components/features/job-card.tsx
const isTemporaryReturn = job.field5 === "見積作成待ち" && reentryDateTime !== null;
```

**問題点:**
- 「見積作成待ち」の場合のみ一時帰宅中として表示
- 「作業待ち」の場合、一時帰宅情報があっても「作業待ち」として表示される

**修正が必要:**
- 「作業待ち」でも一時帰宅情報がある場合は「再入庫待ち」として表示
- 再入庫予定日時を表示

---

### 2. 見積却下時の処理

**問題:**
- 見積却下の機能が実装されていない
- 一時帰宅情報を削除する処理が必要かもしれない

**対応:**
- 見積却下機能を実装するか、手動で一時帰宅情報を削除できる機能を追加
- または、一定期間経過後、自動で一時帰宅情報を削除

---

### 3. 再入庫時の処理

**問題:**
- 再入庫時に一時帰宅情報を削除する処理が必要
- チェックイン時に一時帰宅情報を確認し、削除する処理を追加

**対応:**
- チェックイン時に一時帰宅情報がある場合、自動で削除する処理を追加

---

## 修正方針

### 1. 一時帰宅中の判定ロジックを拡張

**修正内容:**
- 「見積作成待ち」だけでなく、「作業待ち」でも一時帰宅情報がある場合は「再入庫待ち」として表示
- 「見積提示済み」でも一時帰宅情報がある場合は「一時帰宅中」として表示

**実装場所:**
- `src/components/features/job-card.tsx`
- `src/app/page.tsx`（フィルター処理）

---

### 2. 見積承認時の一時帰宅情報の保持

**修正内容:**
- 見積承認時、一時帰宅情報を保持する（削除しない）
- 一時帰宅情報がある場合、「作業待ち」でも「再入庫待ち」として表示

**実装場所:**
- `src/lib/api.ts` - `approveEstimate`関数（一時帰宅情報を保持）

---

### 3. チェックイン時の一時帰宅情報の削除

**修正内容:**
- チェックイン時に一時帰宅情報がある場合、自動で削除する処理を追加
- 再入庫予定日時と現在日時を比較し、再入庫が完了したと判断

**実装場所:**
- `src/app/page.tsx` - `handleCourtesyCarSelect`関数（チェックイン処理）

---

### 4. 見積却下時の一時帰宅情報の削除（オプション）

**修正内容:**
- 見積却下機能を実装する場合、一時帰宅情報を削除する処理を追加
- または、手動で一時帰宅情報を削除できる機能を追加

**実装場所:**
- `src/app/customer/approval/[id]/page.tsx`（見積却下機能を実装する場合）
- `src/app/admin/estimate/[id]/page.tsx`（手動削除機能を追加する場合）

---

## 実装優先順位

1. **最優先**: 一時帰宅中の判定ロジックを拡張（「作業待ち」でも一時帰宅情報がある場合は「再入庫待ち」として表示）
2. **高優先度**: チェックイン時の一時帰宅情報の削除
3. **中優先度**: 見積却下時の一時帰宅情報の削除（見積却下機能を実装する場合）

---

## 参照

- `docs/IMPLEMENTATION_ROADMAP.md` - 実装ロードマップ
- `docs/TEMPORARY_RETURN_IMPLEMENTATION_STATUS.md` - 一時帰宅機能の実装状況







