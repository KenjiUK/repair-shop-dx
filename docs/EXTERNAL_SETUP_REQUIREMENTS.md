# 外部設定要件

**作成日:** 2024年
**目的:** アプリケーション以外で設定が必要な項目をまとめたドキュメント

---

## 概要

本ドキュメントは、統合UX最適化計画の実装において、アプリケーション側の実装とは別に、Zoho CRMやその他の外部システムで設定が必要な項目をまとめています。

---

## Zoho CRM設定

### 0. 事前チェックイン用メール送信（オプション）

**優先度:** 低（実装されていない機能のため）

**目的:**
予約確定時 / 入庫前日にメール自動送信し、事前チェックイン（Web受付票）のリンクを記載します。

**実装方針:**

#### 推奨: Webアプリからの送信（SMTP使用）

**理由:**
- マジックリンクを動的に生成する必要があるため、Zoho CRMの自動メールでは実現が困難
- 既存のLINE通知パターンと統一できる
- Google WorkspaceのGmailアカウントを使用可能

**設定内容:**

1. **環境変数の設定**
   ```env
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your-email@yourdomain.com
   SMTP_PASSWORD=your-app-password
   SMTP_FROM_NAME=Your Shop Name
   ```

2. **Google Workspaceの設定（最新情報：2024-2025）**
   - ⚠️ **重要:** 2024年9月30日以降、「安全性の低いアプリ」のアクセスは完全に無効化されました
   - **アプリパスワードまたはOAuth 2.0が必須**
   - 2段階認証プロセスを有効化
   - アプリパスワードを生成（16桁）
   - 詳細: `docs/PRE_CHECKIN_EMAIL_STRATEGY.md` を参照

3. **送信履歴について**
   - ✅ Gmailの「送信済み」フォルダに自動保存されます
   - GmailのSMTPサーバーを使用する場合、送信したメールは自動的に「送信済み」フォルダに保存されます
   - 追加の設定は不要です

3. **実装場所**
   - `src/lib/email.ts` - メール送信クライアント
   - `src/lib/email-templates.ts` - メールテンプレート
   - `src/app/api/email/send/route.ts` - メール送信API Route

**注意事項:**
- 現在、事前チェックインページは未実装
- 実装後にメール送信機能を統合

**参照:**
- `docs/PRE_CHECKIN_STATUS.md` - 事前チェックイン実装状況
- `docs/PRE_CHECKIN_EMAIL_STRATEGY.md` - メール送信戦略の詳細

---

### 1. 2回予約フローの自動紐付けワークフロー

**優先度:** 高（第1フェーズで必要）

**目的:**
2回目の予約（Zoho Bookings）が入った時、既存のジョブレコードと自動的に紐付けます。

**設定内容:**

#### ワークフロー条件
- **トリガー:** Zoho Bookingsから新しい予約が作成された時
- **対象モジュール:** CustomModule2（入庫管理）

#### 条件チェック
以下の条件をすべて満たす既存ジョブレコードを検索：
- 同じ顧客ID (`field4` = 予約の顧客ID)
- 同じ車両ID (`field6` = 予約の車両ID)
- ステータスが「見積提示済み」(`field5 = "見積提示済み"`)

#### 処理内容
条件に合致する既存ジョブがある場合：
1. 新しいレコードを作成せず、既存レコードを更新
2. `ID_BookingId_2` に2回目の予約IDを保存
   - または `field7`（詳細情報）に記録（カスタムフィールドが追加できない場合）
3. `field22` (入庫日時) を2回目の予約日時に更新
4. ステータスを「作業待ち」に更新

条件に合致しない場合：
- 通常通り新しいレコードを作成

**参照:** `docs/DOUBLE_BOOKING_FLOW_UX_OPTIMIZATION.md`

---

### 2. カスタムフィールドの追加（オプション）

**優先度:** 中（データ管理の柔軟性向上のため）

#### 2.1 2回目の予約ID用フィールド

**フィールド名:** `ID_BookingId_2`
**タイプ:** Text
**モジュール:** CustomModule2（入庫管理）
**説明:** 2回目の予約IDを保存

**代替案:**
- カスタムフィールドが追加できない場合、`field7`（詳細情報）にJSON形式で記録

---

#### 2.2 ジョブメモ用フィールド（オプション）

**フィールド名:** `field26`
**タイプ:** Multi-Line Text
**モジュール:** CustomModule2（入庫管理）
**説明:** ジョブメモをJSON形式で保存

**データ形式:**
```json
[
  {
    "id": "memo1",
    "content": "メモ内容",
    "author": "作成者名",
    "createdAt": "2024-01-10T10:15:00Z",
    "updatedAt": null
  }
]
```

**代替案:**
- カスタムフィールドが追加できない場合、`field7`（詳細情報）に区切り文字（`---MEMO---`）で区切って記録

---

#### 2.3 診断料金用フィールド（オプション）

**フィールド名:** `field23`
**タイプ:** Number
**モジュール:** CustomModule2（入庫管理）
**説明:** 診断料金を保存

**代替案:**
- カスタムフィールドが追加できない場合、`field7`（詳細情報）に記録

---

### 3. 既存フィールドの活用

以下の既存フィールドを活用します：

- **field7** - 詳細情報
  - 1回目の入庫日時（`firstEntryDate`）
  - 診断料金情報（カスタムフィールドが追加できない場合）
  - ジョブメモ（カスタムフィールドが追加できない場合）
  - 再入庫予定日時（一時帰宅管理）

- **field** - 作業指示書
  - 社内からの申し送り事項

---

## 設定の優先順位

### 必須設定（第1フェーズ）

1. **2回予約フローの自動紐付けワークフロー**
   - アプリ側の表示改善と同時に設定が必要
   - 設定が完了しないと、2回目の予約が正しく紐付けられない

### 推奨設定（第2フェーズ以降）

2. **カスタムフィールドの追加**
   - データ管理の柔軟性向上のため
   - 既存フィールド（`field7`）でも代替可能

---

## 設定手順

### Zoho CRMワークフローの設定手順

1. Zoho CRMにログイン
2. **設定** → **自動化** → **ワークフロー** に移動
3. **新しいワークフローを作成** をクリック
4. ワークフロー名を入力（例: "2回目予約自動紐付け"）
5. **トリガー** を設定：
   - **モジュール:** CustomModule2（入庫管理）
   - **イベント:** レコードが作成された時
   - **条件:** Zoho Bookingsからの予約であることを判定
6. **条件** を設定：
   - 同じ顧客ID (`field4`)
   - 同じ車両ID (`field6`)
   - ステータスが「見積提示済み」(`field5 = "見積提示済み"`)
7. **アクション** を設定：
   - 既存レコードを更新
   - `ID_BookingId_2` に予約IDを保存
   - `field22` を予約日時に更新
   - ステータスを「作業待ち」に更新
8. ワークフローを保存して有効化

### カスタムフィールドの追加手順

1. Zoho CRMにログイン
2. **設定** → **カスタマイズ** → **モジュール** に移動
3. **CustomModule2（入庫管理）** を選択
4. **フィールド** タブをクリック
5. **フィールドを追加** をクリック
6. フィールド名、タイプ、説明を入力
7. フィールドを保存

---

## 注意事項

### ワークフローの設定

- **テスト環境での検証を推奨**
  - 本番環境に適用する前に、テスト環境で動作確認を行う
  - 条件に合致しない場合の動作も確認する

- **既存データへの影響**
  - ワークフローは既存のレコードには影響しない（新規作成時のみ発動）
  - 既存の2回目予約がある場合は、手動で紐付けが必要

### カスタムフィールドの追加

- **既存フィールドの活用を優先**
  - カスタムフィールドが追加できない場合、既存の`field7`を活用
  - データ形式を統一する（JSON形式など）

- **データ移行**
  - 既存データがある場合、データ移行が必要な場合がある

---

## 設定確認チェックリスト

### 第1フェーズ

- [ ] 2回予約フローの自動紐付けワークフローを設定
- [ ] ワークフローの動作確認（テスト環境）
- [ ] 本番環境への適用

### 第2フェーズ以降（オプション）

- [ ] カスタムフィールド `ID_BookingId_2` を追加
- [ ] カスタムフィールド `field26`（ジョブメモ）を追加
- [ ] カスタムフィールド `field23`（診断料金）を追加
- [ ] 既存データの移行（必要な場合）

---

## トラブルシューティング

### ワークフローが動作しない場合

1. **ワークフローが有効になっているか確認**
   - Zoho CRMのワークフロー設定で有効化されているか確認

2. **条件の確認**
   - 条件が正しく設定されているか確認
   - テストデータで条件を満たすか確認

3. **権限の確認**
   - ワークフローを実行するユーザーに適切な権限があるか確認

### カスタムフィールドが追加できない場合

1. **既存フィールドの活用**
   - `field7`（詳細情報）にJSON形式で記録
   - 区切り文字を使用して複数の情報を記録

2. **Zoho CRMの制限を確認**
   - カスタムフィールドの追加制限を確認
   - 必要に応じてZohoサポートに問い合わせ

---

## 参照ドキュメント

- `docs/DOUBLE_BOOKING_FLOW_UX_OPTIMIZATION.md` - 2回予約フローのUX最適化
- `docs/IMPLEMENTATION_SPECIFICATION.md` - 実装仕様書
- `docs/IMPLEMENTATION_ROADMAP.md` - 実装ロードマップ

---

## 更新履歴

- 2024年: 初版作成







