# 車検の「3つの箱」に基づくプロセスフロー

**作成日**: 2025-01-XX  
**目的**: 提案した「3つの箱」の整理に基づく、その後のプロセス（ワークフロー）をまとめる

---

## 📋 全体フロー概要

```
[Phase 1] 受付
    ↓
[Phase 2] 受入れ点検（診断）
    ├── 箱①: 法定必須（Must）→ 点検項目のステータスで記録
    ├── 箱②: 車検推奨（Should）→ 点検項目のステータスで記録
    └── 箱③: 車検外提案（Optional / Separate）→ 「追加見積内容」または「新しい作業を追加」
    ↓
[Phase 3] 見積作成
    ├── 箱①・②: 自動的に見積項目に追加
    ├── 箱③（追加見積内容）: 見積項目に追加
    └── 箱③（新しい作業）: 新しいワークオーダーとして独立
    ↓
[Phase 4] 承認
    ├── 箱①: 法的に必須なので承認は形式的
    ├── 箱②: 顧客の意思決定が必要
    └── 箱③: 顧客の意思決定が必要（別案件として判断）
    ↓
[Phase 5] 作業
    ├── 車検作業: 承認された箱①・②の項目を実施
    └── 新しい作業: 承認された箱③の項目を実施（独立したワークフロー）
    ↓
[Phase 6] 報告・出庫
    ├── 車検完了報告
    └── 新しい作業完了報告（独立）
```

---

## 🔄 各フェーズの詳細プロセス

### Phase 2: 受入れ点検（診断）

#### 2-1. 点検項目のチェック

**整備士の行動:**
1. 診断画面を開く
2. 6カテゴリの点検項目をチェック
3. 各項目のステータスを記録（レ=良好、×=交換、△=修理、A=調整など）

**システムの処理:**
- 点検項目のステータスを`WorkOrder.diagnosis.items`に保存
- 箱①（法定必須）と箱②（車検推奨）の項目は、点検項目のステータスで記録される

**例:**
- ブレーキパッドの摩耗 → ステータス: ×（交換）→ 箱①（法定必須）
- タイヤの溝の深さ不足 → ステータス: ×（交換）→ 箱①（法定必須）
- エンジンオイルの劣化 → ステータス: ×（交換）→ 箱②（車検推奨）

#### 2-2. 車検外提案の記録（段階化アプローチ）

**整備士の判断:**
- 点検項目に該当しない問題を発見
- **説明文脈: 車検とは切り分けて説明した方が分かりやすい内容**

**Step 1: まずはすべて「追加見積内容」で記録**
- 整備士は迷わず「追加見積内容」に入力
- 「車検外提案（車検とは切り分けて説明した方が分かりやすい内容）」セクションで入力
- 3分類で入力: 「今回絶対必要」「やったほうがいい」「お客さん次第」
- **判断の負担を軽減**

**例:**
- エアコンの不具合 → まず「追加見積内容」で入力
- ナビゲーションの故障 → まず「追加見積内容」で入力
- ドアの開閉不良 → まず「追加見積内容」で入力

**システムの処理:**
- 「追加見積内容」の項目は`WorkOrder.diagnosis.additionalEstimateRequired/Recommended/Optional`に保存

**Step 2: 後から「独立作業に昇格」（フロント判断）**
- 追加見積内容の各項目に「独立作業にする」ボタンが表示される
- フロントが判断して昇格できる
- 作業粒度を後から調整できる

**例:**
- エアコンの不具合（追加見積内容で入力済み）→ 「独立作業にする」ボタン → 「エアコン修理」という新しいワークオーダーが作成される
- ナビゲーションの故障（追加見積内容で入力済み）→ 「独立作業にする」ボタン → 「ナビゲーション修理」という新しいワークオーダーが作成される

**システムの処理:**
- 「独立作業にする」ボタンで作成されたワークオーダーは、`field_work_orders`に追加される
- 追加見積内容から該当項目を削除

---

### Phase 3: 見積作成

#### 3-1. 箱①・②の見積項目の自動追加

**システムの処理:**
1. 診断画面で記録された点検項目のステータス（×、△、Aなど）を確認
2. 問題があった項目を自動的に見積項目に追加
3. 箱①（法定必須）の項目は「今回絶対必要」として追加
4. 箱②（車検推奨）の項目は「やったほうがいい」として追加

**見積画面の表示:**
- 箱①・②の項目が自動的に見積項目として表示される
- 各項目に写真・動画が紐付けられる（診断画面で撮影したもの）
- 金額は手動入力（基幹システムから転記）

**例:**
- ブレーキパッドの摩耗（×=交換）→ 自動的に見積項目に追加（箱①: 法定必須）
- タイヤの溝の深さ不足（×=交換）→ 自動的に見積項目に追加（箱①: 法定必須）
- エンジンオイルの劣化（×=交換）→ 自動的に見積項目に追加（箱②: 車検推奨）

#### 3-2. 箱③（追加見積内容）の見積項目の追加

**システムの処理:**
1. 診断画面で「追加見積内容」セクションに入力された項目を確認
2. 見積画面に表示される
3. 3分類で表示: 「今回絶対必要」「やったほうがいい」「お客さん次第」
4. 金額は手動入力

**見積画面の表示:**
- 箱③の項目が「車検外提案（車検とは切り分けて説明した方が分かりやすい内容）」セクションとして表示される
- 箱①・②の項目とは視覚的に区別される（別セクション、別カラーなど）
- **各項目に「独立作業にする」ボタンが表示される**

**例:**
- エアコンの不具合（追加見積内容で入力）→ 見積項目に追加（箱③: 車検外提案、「車検とは切り分けて説明した方が分かりやすい内容」）

#### 3-3. 箱③（新しい作業）の見積作成

**システムの処理:**
1. 「新しい作業を追加」ボタンで作成されたワークオーダーを確認
2. 新しい作業の見積画面を開く
3. 新しい作業の見積項目を入力
4. 車検の見積とは独立して管理される

**見積画面の表示:**
- 新しい作業の見積は、車検の見積とは別画面で表示される
- 案件カードの下に、各作業ごとの見積が表示される

**例:**
- エアコンの不具合（新しい作業として追加）→ 「エアコン修理」の見積画面で見積を作成

#### 3-4. 見積履歴の記録（差分表示）

**システムの処理:**
- 見積 v1（事前）: 受付時に作成された仮見積（該当する場合）
- 見積 v2（受入れ）: 受入れ点検後に作成された見積
- 見積 v3（作業中）: 作業中に発見された問題を追加した見積（該当する場合）
- **見積変更時に変更理由を必須入力**

**見積履歴の表示（差分表示）:**
- **履歴は"一覧"ではなく"差分"で表示**
- 最低限必要な表示:
  - v2 → v3 の変更点
  - 追加された項目
  - 削除された項目
  - 金額差分
  - 変更理由（必須入力）

**UI実装例:**
```
見積履歴
├── v1（事前）: ¥50,000
├── v2（受入れ）: ¥80,000
│   └── 差分: +¥30,000
│       ├── 追加: ブレーキパッド交換 +¥30,000
│       └── 理由: 受入れ点検で発見
└── v3（作業中）: ¥90,000
    └── 差分: +¥10,000
        ├── 追加: バッテリー交換 +¥10,000
        └── 理由: 作業中に発見
```

**メリット:**
- クレーム回避
- 説明品質の向上
- 信頼性の向上

---

### Phase 4: 承認

#### 4-1. 箱①（法定必須）の承認

**顧客の行動:**
- 箱①の項目は法的に必須なので、承認は形式的
- 「やらない選択肢がない」ため、承認は自動的に処理される

**システムの処理:**
- 箱①の項目は自動的に承認される
- 承認画面で「法的に必須のため承認が必要です」と表示される

**例:**
- ブレーキパッドの摩耗（箱①: 法定必須）→ 自動的に承認される

#### 4-2. 箱②（車検推奨）の承認

**顧客の行動:**
- 箱②の項目は顧客の意思決定が必要
- 見積内容を確認し、承認・却下を選択

**システムの処理:**
- 箱②の項目は顧客が承認・却下を選択できる
- 承認された項目のみ作業に進む

**例:**
- エンジンオイルの劣化（箱②: 車検推奨）→ 顧客が承認・却下を選択

#### 4-3. 箱③（追加見積内容）の承認

**顧客の行動:**
- 箱③の項目は顧客の意思決定が必要
- 別案件、別予算、別判断として扱われる
- 見積内容を確認し、承認・却下を選択

**システムの処理:**
- 箱③の項目は顧客が承認・却下を選択できる
- 承認された項目のみ作業に進む
- 箱①・②の項目とは別セクションで表示される

**例:**
- エアコンの不具合（箱③: 追加見積内容）→ 顧客が承認・却下を選択

#### 4-4. 箱③（新しい作業）の承認

**顧客の行動:**
- 箱③の新しい作業は、車検とは独立して承認される
- 判断軸が変わる、説明が変わる、承諾の意味が変わる
- 見積内容を確認し、承認・却下を選択

**システムの処理:**
- 新しい作業の見積は、車検の見積とは別画面で承認される
- 承認された新しい作業は、独立したワークフローで進む

**例:**
- エアコンの不具合（箱③: 新しい作業）→ 「エアコン修理」の見積画面で承認・却下を選択

#### 4-5. 統合承認画面

**システムの処理:**
- すべての作業の見積をまとめて表示
- 各作業ごとに承認・却下を選択可能
- 箱①・②・③を視覚的に区別して表示

**承認画面の表示:**
- 箱①（法定必須）: 自動承認、視覚的に区別
- 箱②（車検推奨）: 承認・却下を選択可能
- 箱③（追加見積内容）: 承認・却下を選択可能、別セクションで表示
- 箱③（新しい作業）: 承認・却下を選択可能、別作業として表示

---

### Phase 5: 作業

#### 5-1. 車検作業（箱①・②・③（追加見積内容））

**整備士の行動:**
1. 作業画面を開く
2. 車検の作業を選択
3. 承認された項目のみ作業リストに表示される
4. 各項目を実施
5. Before/After写真を撮影
6. 交換部品を記録
7. 作業完了

**システムの処理:**
- 承認された箱①・②・③（追加見積内容）の項目のみ作業リストに表示される
- 作業結果を`WorkOrder.work`に保存
- 作業完了後、ステータスを「完了」に更新

**例:**
- ブレーキパッドの摩耗（箱①: 法定必須、承認済み）→ 作業リストに表示 → 作業実施
- エンジンオイルの劣化（箱②: 車検推奨、承認済み）→ 作業リストに表示 → 作業実施
- エアコンの不具合（箱③: 追加見積内容、承認済み）→ 作業リストに表示 → 作業実施

#### 5-2. 新しい作業（箱③（新しい作業））

**整備士の行動:**
1. 作業画面を開く
2. 新しい作業（例: エアコン修理）を選択
3. 承認された項目のみ作業リストに表示される
4. 各項目を実施
5. Before/After写真を撮影
6. 交換部品を記録
7. 作業完了

**システムの処理:**
- 新しい作業の作業結果は、独立したワークオーダーに保存される
- 作業完了後、新しい作業のステータスを「完了」に更新
- 車検の作業とは独立して管理される

**例:**
- エアコンの不具合（箱③: 新しい作業、承認済み）→ 「エアコン修理」の作業画面で作業実施

#### 5-3. 作業中の問題発見

**整備士の行動:**
- 作業中に新しい問題を発見
- 診断画面に戻って記録
- または、作業画面から直接記録

**システムの処理:**
- 作業中に発見された問題は、見積 v3（作業中）として記録される
- 見積履歴に追加される
- 顧客に追加見積を提示

**例:**
- 作業中にバッテリーの劣化を発見 → 見積 v3（作業中）として記録 → 顧客に追加見積を提示

---

### Phase 6: 報告・出庫

#### 6-1. 車検完了報告

**整備士の行動:**
1. 車検の作業が完了
2. 分解整備記録簿PDFを生成
3. 作業結果を確認
4. 報告完了

**システムの処理:**
- 車検の作業結果を`WorkOrder.work`に保存
- 分解整備記録簿PDFを生成してGoogle Driveに保存
- ステータスを「完了」に更新

**報告内容:**
- 箱①（法定必須）の作業結果
- 箱②（車検推奨）の作業結果
- 箱③（追加見積内容）の作業結果

#### 6-2. 新しい作業完了報告

**整備士の行動:**
1. 新しい作業（例: エアコン修理）の作業が完了
2. 作業結果を確認
3. 報告完了

**システムの処理:**
- 新しい作業の作業結果を独立したワークオーダーに保存
- ステータスを「完了」に更新
- 車検の作業とは独立して管理される

**報告内容:**
- 箱③（新しい作業）の作業結果

#### 6-3. 統合請求書の作成

**システムの処理:**
1. すべての作業が完了
2. 基幹システムで統合請求書を作成
3. 請求書IDを`field_work_orders`内に記録

**請求書の内容:**
- 車検の作業費用（箱①・②・③（追加見積内容））
- 新しい作業の費用（箱③（新しい作業））

---

## 📊 データフローのまとめ

### 箱①・②（点検項目のステータスで記録）

```
診断画面
  ↓ 点検項目のステータス（×、△、Aなど）
WorkOrder.diagnosis.items
  ↓ 自動的に見積項目に追加
見積画面
  ↓ 顧客が承認
WorkOrder.estimate.items（承認された項目のみ）
  ↓ 作業実施
WorkOrder.work（作業結果）
  ↓ 報告
分解整備記録簿PDF
```

### 箱③（追加見積内容）

```
診断画面
  ↓ 「追加見積内容」セクションで入力
WorkOrder.diagnosis.additionalEstimateRequired/Recommended/Optional
  ↓ 見積項目に追加
見積画面
  ↓ 顧客が承認
WorkOrder.estimate.items（承認された項目のみ）
  ↓ 作業実施
WorkOrder.work（作業結果）
  ↓ 報告
分解整備記録簿PDF
```

### 箱③（新しい作業）

```
診断画面
  ↓ 「新しい作業を追加」ボタン
新しいWorkOrder（独立）
  ↓ 見積作成
新しいWorkOrder.estimate.items
  ↓ 顧客が承認
新しいWorkOrder.estimate.items（承認された項目のみ）
  ↓ 作業実施
新しいWorkOrder.work（作業結果）
  ↓ 報告
新しい作業の報告
```

---

## 🎯 重要なポイント

### 1. 説明文脈の分離

**箱①・②（車検枠内）:**
- **説明文脈: 「車検の説明の中でそのまま伝えられる内容」**
- 車検と一体で説明できる
- 同じ見積に入れる

**箱③（車検外）:**
- **説明文脈: 「車検とは切り分けて説明した方が分かりやすい内容」**
- 説明・予算・判断軸が別
- 同じ見積に入れると話が壊れる

**注意:**
- 「判断軸」という言葉は仕様書内部だけに使い、UIでは使わない
- 現場の判断基準は「説明文脈」に統一

### 2. 見積回数が増えることは正常

**見積 v1（事前）**  
**見積 v2（受入れ）**  
**見積 v3（作業中）**

これは**履歴として残すべき価値ある情報**。

### 3. 新しい作業の独立性（段階化）

**新しい作業は:**
- **まず「追加見積内容」で記録**
- **後から「独立作業にする」ボタンで昇格**
- 説明が変わる
- 承諾の意味が変わる
- 独立したワークフローで進む

**メリット:**
- 入力時は迷わない
- フロント判断で昇格できる
- 作業粒度を後から調整できる

---

## 📝 実装時の注意点

### 1. UI/UXの設計

- 箱①・②・③を視覚的に区別して表示
- 箱②の説明を「車検の説明の中でそのまま伝えられる内容」に変更
- 箱③の説明を「車検とは切り分けて説明した方が分かりやすい内容」に変更
- 「判断軸」という言葉をUIから削除
- 「追加見積内容」セクションのタイトルを「車検外提案（車検とは切り分けて説明した方が分かりやすい内容）」に変更
- 追加見積内容の各項目に「独立作業にする」ボタンを追加
- 見積履歴機能を実装（差分表示）

### 2. データ管理

- 箱①・②の項目は`WorkOrder.diagnosis.items`に保存
- 箱③（追加見積内容）の項目は`WorkOrder.diagnosis.additionalEstimateRequired/Recommended/Optional`に保存
- 箱③（新しい作業）は独立した`WorkOrder`として管理

### 3. ワークフローの分岐（段階化）

- 箱①・②・③（追加見積内容）は車検のワークフローで進む
- 箱③（追加見積内容）から「独立作業にする」ボタンで昇格した新しい作業は独立したワークフローで進む
- 判断の負担を軽減（まず追加見積内容、後から昇格）

---

## 🔗 関連ドキュメント

- [VEHICLE_INSPECTION_ADDITIONAL_ESTIMATE_SPEC_PROPOSAL.md](./VEHICLE_INSPECTION_ADDITIONAL_ESTIMATE_SPEC_PROPOSAL.md) - 提案書
- [VEHICLE_INSPECTION_ADDITIONAL_ESTIMATE_SPEC_REVIEW.md](./VEHICLE_INSPECTION_ADDITIONAL_ESTIMATE_SPEC_REVIEW.md) - レビュー結果
- [PAGE_SPECIFICATION.md](./PAGE_SPECIFICATION.md) - ページ単位詳細設計仕様書
- [USER_WORKFLOW_DETAILED_DESIGN_V2.md](./USER_WORKFLOW_DETAILED_DESIGN_V2.md) - ユーザーワークフロー詳細設計

---

**End of Document**

