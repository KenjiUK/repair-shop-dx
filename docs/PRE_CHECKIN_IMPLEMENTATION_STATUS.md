# 事前チェックイン機能 - 実装状況

**作成日:** 2025-01-XX
**ステータス:** ✅ **基本実装完了**（一部機能は将来実装予定）

---

## 実装完了項目

### 1. 事前チェックインページ ✅

**実装内容:**
- `/customer/pre-checkin/[id]` ページを作成
- 車両選択機能（保有車両リストから選択、または新規車両登録）
- 顧客情報の確認（住所・電話番号の表示）
- パーミッション（メール配信同意）
- 問診（走行距離、不具合、代車の希望）

**実装場所:**
- `src/app/customer/pre-checkin/[id]/page.tsx` - 新規作成

**機能詳細:**
- ジョブIDからジョブ情報を取得
- 顧客IDから顧客情報と車両リストを取得
- フォーム入力データをZoho CRMに保存

---

### 2. 車両選択機能 ✅

**実装内容:**
- 顧客の保有車両リストを表示
- ラジオボタンで車両を選択
- 新規車両登録機能（車種名入力、車検証画像アップロード）

**実装場所:**
- `src/app/customer/pre-checkin/[id]/page.tsx` 内に実装
- `fetchVehiclesByCustomerId` APIを使用して車両リストを取得

**UI:**
- 登録済み車両はラジオボタンで選択
- 「別の車（新規）」ボタンで新規車両登録モードに切り替え
- 新規車両の場合は車種名入力と車検証画像アップロード

---

### 3. データ保存機能 ✅

**実装内容:**
- 車両IDの更新（`updateJobField6`）
- 走行距離の更新（`updateJobField10`）
- 不具合内容の追記（`updateJobField7`）
- 代車希望の追記（`updateJobField7`）

**実装場所:**
- `src/lib/api.ts`
  - `updateJobField6`: 車両IDを更新
  - `updateJobField10`: 走行距離を更新
  - `updateJobField7`: 詳細情報を追記（既存実装）

**データ保存先:**
- 車両ID: `field6`
- 走行距離: `field10`
- 不具合内容: `field7`に追記
- 代車希望: `field7`に追記

---

## 未実装項目（将来実装予定）

### 1. マジックリンク生成機能の拡張（事前チェックイン用）

**現状:**
- 見積承認用のマジックリンクは実装済み
- 事前チェックイン用のマジックリンクは未実装

**実装予定:**
- `generateMagicLink`関数を拡張して、事前チェックイン用のリンクを生成
- リンク先: `/customer/pre-checkin/[id]`
- 有効期限: 入庫日まで（または7日間）

**参照:**
- `src/lib/line-api.ts` - 既存のマジックリンク生成機能

---

### 2. 新規車両画像のアップロード機能

**現状:**
- 画像プレビュー機能は実装済み
- `field12`への画像アップロード機能は未実装

**実装予定:**
- Google Driveへの画像アップロード
- `field12`（関連ファイル）へのURL保存

---

### 3. 顧客情報の更新機能

**現状:**
- 住所・電話番号の変更表示は実装済み
- 顧客の`Description`への追記機能は未実装

**実装予定:**
- 顧客の`Description`フィールドに変更内容を追記
- 形式: `【アプリ変更届】住所変更: ...` または `【アプリ変更届】電話番号変更: ...`

---

### 4. メール配信同意の更新機能

**現状:**
- チェックボックスは実装済み
- Zoho CRMの`Email_Opt_Out`更新機能は未実装

**実装予定:**
- 顧客の`Email_Opt_Out`フィールドを更新
- 同意時は`false`、非同意時は`true`に設定

---

## 実装結果

### 完了した機能

1. ✅ **事前チェックインページ**
   - 基本的なフォーム入力機能
   - 車両選択機能
   - 顧客情報の確認
   - 問診機能

2. ✅ **車両選択機能**
   - 保有車両リストからの選択
   - 新規車両登録（UIのみ）

3. ✅ **データ保存機能**
   - 車両ID、走行距離、不具合内容、代車希望の保存

---

## UI構成

```
[ヘッダー]
[事前チェックインタイトル]
[フォーム]
  - 車両選択セクション
    - 保有車両リスト（ラジオボタン）
    - 「別の車（新規）」ボタン
    - 新規車両登録フォーム（条件付き表示）
  - 顧客情報確認セクション
    - 住所入力
    - 電話番号入力
  - パーミッションセクション
    - メール配信同意チェックボックス
  - 問診セクション
    - 走行距離入力
    - 不具合・気になるところ入力
    - 代車希望チェックボックス
  - 送信ボタン
```

---

## 技術的な詳細

### 使用しているAPI関数

- `fetchJobById`: ジョブ情報を取得
- `fetchCustomerById`: 顧客情報を取得
- `fetchVehiclesByCustomerId`: 顧客の保有車両リストを取得
- `updateJobField6`: 車両IDを更新
- `updateJobField10`: 走行距離を更新
- `updateJobField7`: 詳細情報を追記

### データフロー

1. ジョブIDからジョブ情報を取得
2. 顧客IDから顧客情報と車両リストを取得
3. フォーム入力データを収集
4. Zoho CRM API経由でデータを保存
5. 成功時にトップページにリダイレクト

---

## テスト推奨事項

1. **事前チェックインページのテスト**
   - ジョブIDが正しく取得できることを確認
   - 顧客情報と車両リストが正しく表示されることを確認
   - フォーム入力が正しく動作することを確認

2. **車両選択機能のテスト**
   - 保有車両リストが正しく表示されることを確認
   - 車両選択が正しく動作することを確認
   - 新規車両登録モードが正しく動作することを確認

3. **データ保存機能のテスト**
   - 車両IDが正しく保存されることを確認
   - 走行距離が正しく保存されることを確認
   - 不具合内容が正しく追記されることを確認
   - 代車希望が正しく追記されることを確認

---

## 次のステップ

事前チェックイン機能の基本実装が完了しました。次は以下の機能を実装します：

1. **マジックリンク生成機能の拡張**
   - 事前チェックイン用のマジックリンクを生成
   - メール送信機能との統合

2. **新規車両画像のアップロード機能**
   - Google Driveへの画像アップロード
   - `field12`へのURL保存

3. **顧客情報の更新機能**
   - 住所・電話番号の変更を`Description`に追記

4. **メール配信同意の更新機能**
   - `Email_Opt_Out`フィールドの更新

**参照:**
- `docs/PRE_CHECKIN_STATUS.md` - 事前チェックイン実装状況（詳細）
- `docs/PRE_CHECKIN_EMAIL_STRATEGY.md` - メール送信戦略
- `SPECIFICATION.md` - Phase 0.3 システム連携＆事前チェックイン







