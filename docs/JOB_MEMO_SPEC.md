# ジョブメモ機能仕様

**作成日:** 2024年
**目的:** ジョブ全体のメモ機能の詳細仕様

---

## 概要

プロセスが長くなったため、ジョブ全体でスタッフ間の情報共有や作業中の気づきを記録できるメモ機能を追加します。

---

## 業務要件

### 使用シーン

1. **入庫時**
   - 受付スタッフが顧客からの申し送り事項を記録
   - 車両の状態や注意点を記録

2. **診断時**
   - メカニックが診断中の気づきを記録
   - 追加で確認したい点を記録

3. **見積作成時**
   - 見積作成者が顧客とのやり取りを記録
   - 特別な要望や条件を記録

4. **作業時**
   - 作業中の気づきや問題点を記録
   - 次回の参考情報を記録

5. **出庫時**
   - 引渡し時の注意事項を記録
   - 次回の参考情報を記録

---

## 実装仕様

### メモの種類

#### 1. ジョブ全体メモ（推奨）

**特徴:**
- ジョブ全体で共有されるメモ
- 時系列で記録される
- 誰がいつ記録したかが分かる

**実装場所:**
- `src/components/features/job-memo-dialog.tsx` - 新規コンポーネント
- `src/components/features/job-card.tsx` - メモボタンを追加
- `src/app/admin/estimate/[id]/page.tsx` - 見積画面にメモセクション
- `src/app/mechanic/diagnosis/[id]/page.tsx` - 診断画面にメモセクション
- `src/app/mechanic/work/[id]/page.tsx` - 作業画面にメモセクション

#### 2. ステージ別メモ（簡易版）

**特徴:**
- 各ステージ（入庫、診断、見積、作業、出庫）ごとにメモを記録
- 既存の`field7`や`field`を活用

---

## UI構成

### ジョブカードでの表示

```
┌─────────────────────────────────────┐
│ ジョブカード                        │
├─────────────────────────────────────┤
│                                     │
│  田中様  BMW X3                     │
│                                     │
│  [📝 メモ] ボタン                   │
│  （メモがある場合はバッジ表示）     │
│                                     │
└─────────────────────────────────────┘
```

### メモダイアログ

```
┌─────────────────────────────────────┐
│ ジョブメモ                          │
├─────────────────────────────────────┤
│                                     │
│  田中様  BMW X3                     │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📝 メモ一覧                        │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ 2024/01/10 10:15 山田スタッフ│  │
│  │ 顧客から「エンジン音が気になる│  │
│  │ ので確認してほしい」とのこと │  │
│  └─────────────────────────────┘  │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ 2024/01/10 14:30 鈴木整備士 │  │
│  │ 診断結果：エンジンオイルの   │  │
│  │ 劣化が原因。交換を推奨。     │  │
│  └─────────────────────────────┘  │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📝 新しいメモを追加                │
│                                     │
│  [メモ入力エリア（複数行）]         │
│                                     │
│  [保存] [キャンセル]                │
└─────────────────────────────────────┘
```

### 見積画面でのメモセクション

```
┌─────────────────────────────────────┐
│ 見積作成 - 田中様  BMW X3           │
├─────────────────────────────────────┤
│                                     │
│  📋 見積項目                        │
│  ...                                │
│                                     │
│  ────────────────────────────────  │
│                                     │
│  📝 ジョブメモ                      │
│                                     │
│  [メモを表示/編集] ボタン            │
│  （最新のメモをプレビュー表示）      │
│                                     │
└─────────────────────────────────────┘
```

---

## データ構造

### JobMemo型

```typescript
export interface JobMemo {
  /** メモID */
  id: string;
  
  /** ジョブID */
  jobId: string;
  
  /** メモ内容 */
  content: string;
  
  /** 作成者名 */
  author: string;
  
  /** 作成日時 */
  createdAt: string; // ISO8601
  
  /** 更新日時 */
  updatedAt?: string | null; // ISO8601
}
```

### ZohoJob型の拡張

```typescript
export interface ZohoJob {
  // ... 既存フィールド
  
  /** ジョブメモ（カスタムフィールド field26 または field7 にJSON形式で記録） */
  jobMemos?: JobMemo[];
  
  /** メモの最終更新日時 */
  lastMemoUpdatedAt?: string | null; // ISO8601
}
```

---

## データ保存方法

### オプション1: Zoho CRMカスタムフィールド（推奨）

- **field26** を新規追加（Multi-Line Text）
- JSON形式でメモ配列を保存
- 例: `[{"id":"memo1","content":"...","author":"山田","createdAt":"2024-01-10T10:15:00Z"}]`

### オプション2: field7に統合

- 既存の`field7`（詳細情報）にメモを追記
- 区切り文字（例: `---MEMO---`）で区切る
- シンプルだが、検索や管理が難しい

### オプション3: アプリ内DB（Vercel Postgres / Supabase）

- メモ専用テーブルを作成
- より柔軟な検索や管理が可能
- ただし、Zoho CRMとの同期が必要

**推奨:** オプション1（Zoho CRMカスタムフィールド）

---

## 実装優先順位

### 第3フェーズ（低優先度・既存機能拡張）

- **ジョブメモ機能** - 約1-2日
  - メモダイアログコンポーネント
  - メモ一覧表示
  - メモ追加・編集機能
  - 各画面へのメモボタン追加

---

## 実装のポイント

- ✅ 時系列でメモを表示（新しいメモが上に）
- ✅ 作成者名と日時を表示
- ✅ メモがある場合はジョブカードにバッジ表示
- ✅ 各画面（診断、見積、作業）から簡単にアクセス可能
- ✅ メモの検索機能（将来的に追加可能）
- ✅ メモの編集・削除機能（作成者のみ、または管理者のみ）

---

## 既存機能との統合

### 既存のメモ関連フィールド

- **field7** - 詳細情報（顧客が事前入力した不具合・問診内容）
- **field** - 作業指示書（社内からの申し送り事項）

### 新規メモ機能との使い分け

- **field7** - 顧客からの申し送り事項（事前入力）
- **field** - 作業指示書（社内からの申し送り事項）
- **jobMemos** - ジョブ全体のメモ（スタッフ間での情報共有、作業中の気づき）

---

## 参照

- 既存のメモ機能: `field7`, `field` フィールド
- チェックリストの備考欄: `docs/INSPECTION_CHECKLIST_SPEC.md`







