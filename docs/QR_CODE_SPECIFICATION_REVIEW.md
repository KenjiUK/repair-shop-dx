# QRコード仕様見直しドキュメント

**作成日:** 2024年  
**目的:** タグ用QRコードの仕様見直しと業界ベストプラクティスの提案  
**更新日:** 2024年（入庫時の流れを明確化）

---

## 入庫時の流れ（運用フロー）

### 1. お客様来店 → 受付開始

1. **お客様が来店**
2. **受付スタッフが受付を開始**（アプリで「受付開始」ボタンをタップ）
3. **ICタグを紐づけ**（例: 0番のタグ）
   - 手元にあるカラビナ付きの「空きスマートタグ（例: No.0）」を手に取り
   - 顧客から預かった車の鍵に取り付ける（物理的な紐づけ）
   - アプリ上でタグID（例: "0"）を選択して紐づけ（デジタルな紐づけ）

### 2. タグとお客様情報の結びつけ

- **タグIDとJob IDを結びつける**（管理画面上で）
- **タグのステータスを更新**（`available` → `in_use`）
- **入庫日時を記録**（`field22`）

### 3. タグの運用

- **決まった数のタグを用意**（例: 20個のタグ）
- **お客様に合わせてタグを割り振る**
- **違うお客様に変えることも可能**（タグの再利用）
- **入庫から出庫まで同じタグを使用**

### 4. QRコードの役割

- **タグIDをQRコード化**（例: タグID "0" をQRコード化）
- **タグ（キーホルダー）に印刷して貼り付ける**
- **整備士がQRコードをスキャン** → タグIDで案件を検索 → 適切な画面に遷移

---

## 現在の実装状況

### 1. 顧客向けQRコード（現在の実装）

**実装場所:** `src/components/features/job-card.tsx`（デバッグセクション）

**生成されるQRコード:**
- 事前問診: `/customer/pre-checkin/[jobId]`
- 見積承認: `/customer/approval/[jobId]`

**問題点:**
- ❌ 顧客向けQRコードをタグに印刷する想定になっているが、実際にはメール/LINEで案内する方が一般的
- ❌ セキュリティ上の懸念（タグに直接URLが記載されている）
- ❌ マジックリンク（トークンベース認証）を使用していない

---

### 2. 整備士向けQRコード（現在の実装）

**実装場所:** `src/components/features/job-card.tsx`（デバッグセクション）

**生成されるQRコード:**
- 診断ページ: `/mechanic/diagnosis/[jobId]`
- 作業ページ: `/mechanic/work/[jobId]`
- 作業選択ページ: `/mechanic/work/[jobId]?workOrderId=[workOrderId]`

**問題点:**
- ❌ 案件ごとに異なるQRコードが生成される（タグに印刷するには不適切）
- ❌ タグは入庫から出庫まで同じものを使うため、固定QRコードが必要

---

## 現在の仕様（ドキュメントより）

### 顧客向け通知方法

#### 1. 事前問診

**現在の仕様:**
- 予約確定時または入庫前日にメールを送信（未実装）
- Zoho CRMからの自動メール送信が検討されているが、マジックリンクの動的生成が困難
- **推奨:** WebアプリからSMTP経由でメール送信（`docs/PRE_CHECKIN_EMAIL_STRATEGY.md`）

**実装状況:**
- ✅ 事前問診ページは実装済み（`/customer/pre-checkin/[id]`）
- ❌ メール送信機能は未実装
- ❌ マジックリンク生成機能は未実装（事前問診用）

**参照:**
- `docs/PRE_CHECKIN_EMAIL_STRATEGY.md`
- `docs/CUSTOMER_NOTIFICATION_SYSTEM.md`

#### 2. 見積承認

**現在の仕様:**
- ✅ LINE通知でマジックリンクを送信（実装済み）
- ✅ マジックリンクは7日間有効
- ✅ トークンベースの認証を使用

**実装状況:**
- ✅ 見積承認ページは実装済み（`/customer/approval/[id]`）
- ✅ マジックリンク生成機能は実装済み（`/api/line/magic-link`）
- ✅ LINE通知送信機能は実装済み

**参照:**
- `src/app/api/line/magic-link/route.ts`
- `src/lib/line-api.ts`

---

### 整備士向けQRコード

**現在の仕様:**
- 受付時にタグを車の鍵に取り付ける
- タグID（例: "05"）で案件を検索
- タグのQRコードをスキャンして、案件の適切な画面に遷移

**実装状況:**
- ✅ タグスキャン機能は実装済み（`SmartTagScanDialog`）
- ✅ タグIDで案件を検索する機能は実装済み（`fetchJobByTagId`）
- ✅ 案件のステータスに応じて適切な画面に遷移する機能は実装済み

**参照:**
- `src/components/features/smart-tag-scan-dialog.tsx`
- `src/lib/api.ts` - `fetchJobByTagId`

---

## 業界のベストプラクティス

### 1. 顧客向けアクセス方法

**一般的な方法:**
- ✅ **メール/SMS/LINEでマジックリンクを送信**
  - セキュリティが高い（トークンベース認証）
  - 有効期限を設定できる
  - 顧客の連絡先に直接送信できる
  - 印刷物が不要

- ❌ **QRコードを印刷物に記載**
  - セキュリティ上の懸念（URLが直接見える）
  - 印刷コストがかかる
  - 配布の手間がかかる

**参考事例:**
- 自動車整備業界: メール/SMSでマジックリンクを送信
- 医療業界: メール/SMSで予約確認リンクを送信
- 飲食業界: メール/SMSで予約確認リンクを送信

---

### 2. 整備士向けQRコード

**一般的な方法:**
- ✅ **タグに固定QRコード（タグID）を印刷**
  - タグは物理的な識別子として機能
  - タグIDをスキャンして案件を検索
  - 入庫から出庫まで同じタグを使用

- ❌ **案件ごとに異なるQRコードを生成**
  - タグに印刷できない（案件ごとに変わるため）
  - 管理が複雑になる

**参考事例:**
- 自動車整備業界: タグにタグID（例: "05"）をQRコード化
- 物流業界: 荷物に固定の識別子（バーコード/QRコード）を貼付
- 製造業界: 部品に固定の識別子を貼付

---

## 提案する仕様変更

### 1. 顧客向けQRコードの削除

**理由:**
- 顧客向けはメール/LINEでマジックリンクを送信するため、QRコードは不要
- セキュリティ上の懸念を解消

**変更内容:**
- デバッグセクションから「顧客向けQRコード」を削除
- 顧客向けはメール/LINE通知のみを使用

---

### 2. 整備士向けQRコードの変更

**現在の問題:**
- 案件ごとに異なるQRコードが生成される
- タグに印刷するには不適切

**提案:**
- **タグIDベースの固定QRコードに変更**
- QRコードの値: タグID（例: "05"）
- スキャン時の動作:
  1. タグIDで案件を検索（`fetchJobByTagId`）
  2. 案件のステータスに応じて適切な画面に遷移
     - 入庫済み → 診断ページ
     - 作業待ち/作業中 → 作業ページ
     - 見積作成待ち → 見積ページ
     - など

**実装内容:**
- タグID（`job.tagId`）をQRコード化
- 1つのQRコードのみを表示（診断ページ、作業ページなどは不要）
- タグIDをスキャンすると、既存の`SmartTagScanDialog`と同じロジックで遷移

---

## 実装方針

### Phase 1: 顧客向けQRコードの削除

1. `src/components/features/job-card.tsx`から顧客向けQRコードセクションを削除
2. 顧客向けはメール/LINE通知のみを使用（既存の実装を維持）

---

### Phase 2: 整備士向けQRコードの変更

1. **タグIDベースの固定QRコードに変更**
   - QRコードの値: `job.tagId`（例: "05"）
   - 1つのQRコードのみを表示

2. **スキャン時の動作（既存の実装を活用）**
   - `SmartTagScanDialog`のロジックを参照
   - タグIDで案件を検索（`fetchJobByTagId`）
   - 案件のステータスに応じて適切な画面に遷移

3. **表示場所**
   - 作業一覧の下のデバッグセクション
   - タグIDが存在する場合のみ表示

---

## 実装例

### 変更後のコード（整備士向けQRコードのみ）

```typescript
{/* デバッグ: タグ用QRコード（整備士向けのみ） */}
{job.tagId && (
  <div className="pt-4 mt-4 border-t border-slate-300">
    <div className="text-base font-semibold text-slate-700 mb-3">
      デバッグ: タグ用QRコード（印刷用）
    </div>
    <div className="flex flex-col items-center gap-2 p-4 bg-white rounded-lg border border-slate-200 max-w-xs mx-auto">
      <div className="text-base font-medium text-slate-700">タグID: {job.tagId}</div>
      <QRCodeSVG
        value={job.tagId}
        size={200}
        level="M"
        includeMargin={true}
      />
      <div className="text-sm text-slate-500 text-center">
        このQRコードをタグに印刷して貼り付けてください
      </div>
      <div className="text-xs text-slate-400 text-center mt-2">
        スキャンすると、現在の案件の適切な画面に遷移します
      </div>
    </div>
  </div>
)}
```

---

## まとめ

### 変更前
- ❌ 顧客向けQRコードをタグに印刷する想定（不適切）
- ❌ 整備士向けQRコードが案件ごとに異なる（タグに印刷できない）

### 変更後
- ✅ 顧客向けはメール/LINE通知のみ（QRコード不要）
- ✅ 整備士向けはタグIDベースの固定QRコード（タグに印刷可能）

### メリット
1. **セキュリティ向上**: 顧客向けはマジックリンク（トークンベース認証）を使用
2. **運用性向上**: タグに固定QRコードを印刷できる
3. **管理の簡素化**: 1つのQRコードのみを管理
4. **業界標準に準拠**: 一般的なベストプラクティスに沿った実装

---

## 参照ドキュメント

- `docs/PRE_CHECKIN_EMAIL_STRATEGY.md` - 事前問診メール送信戦略
- `docs/CUSTOMER_NOTIFICATION_SYSTEM.md` - 顧客通知システム仕様
- `SPECIFICATION.md` - 全体仕様書（タグ紐付けの詳細）
- `src/components/features/smart-tag-scan-dialog.tsx` - タグスキャン実装

---

## 更新履歴

- 2024年: 初版作成（仕様見直し）

