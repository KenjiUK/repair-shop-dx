# 長期プロジェクトカード統合レビュー

## 📋 概要

長期プロジェクトカード（`LongTermProjectCard`）を通常のJOBカード（`JobCard`）と同じフォーマットに統合する可能性をレビューします。

**レビュー日**: 2025-01-XX  
**対象**: `src/components/features/long-term-project-card.tsx` と `src/components/features/job-card.tsx`

---

## 🔍 現状分析

### 1. 長期プロジェクトの定義と仕様

**長期プロジェクトとは:**
- `serviceKind`が"レストア"または"板金・塗装"のジョブ
- 作業期間: 数週間から数カ月（場合によっては数年）
- 進捗管理が必要（0-100%）
- フェーズ管理（レストア: 7つのフェーズ、板金・塗装: 外注ステータス管理）
- 遅延チェックが必要

**判定ロジック:**
```typescript
// src/lib/long-term-project-utils.ts
export function isLongTermProject(job: ZohoJob): boolean {
  const serviceKinds = job.field_service_kinds || (job.serviceKind ? [job.serviceKind] : []);
  return (
    serviceKinds.includes("レストア" as ServiceKind) ||
    serviceKinds.includes("板金・塗装" as ServiceKind)
  );
}
```

### 2. なぜTOPページにリストされるか

**業務上の理由:**
1. **進捗監視**: 長期プロジェクトは数週間から数カ月かかるため、定期的な進捗確認が必要
2. **遅延アラート**: 予定完了日を過ぎても完了していない場合、遅延として表示
3. **優先度管理**: 通常のジョブとは別に管理・監視する必要がある
4. **一目で把握**: TOPページで進捗率、遅延フラグを一目で確認できる

**表示場所:**
- TOPページ: 通常のジョブカードとは別のセクション（「長期プロジェクト」セクション）に表示
- 長期プロジェクト管理画面（`/projects/long-term`）: 過去30日以内の長期プロジェクトを一覧表示

### 3. 長期プロジェクトカードの特徴

**現在の実装（`LongTermProjectCard`）:**
- 通常のJOBカードと似た構造（写真、顧客情報、車両情報、ステータス、受付メモなど）
- **追加情報**:
  - 進捗バー（0-100%）
  - 進捗率表示
  - 遅延フラグ（赤枠表示）
  - 開始日、予定完了日
  - 現在のフェーズ/ステータス
- **追加ボタン**:
  - "進捗詳細"ボタン（`LongTermProjectDetailDialog`を開く）
  - "作業画面へ"ボタン（`/mechanic/work/[id]`に遷移）

**通常のJOBカード（`JobCard`）との違い:**
1. 進捗情報の表示（進捗バー、進捗率、開始日、予定完了日）
2. 遅延フラグの表示（赤枠）
3. "進捗詳細"ボタン
4. 作業一覧（`WorkOrderList`）の表示がない（長期プロジェクトは単一作業が多い）

### 4. 進捗詳細ボタンの必要性

**進捗詳細ボタン（`LongTermProjectDetailDialog`）の機能:**
- 全体の進捗率サマリー
- 各工程（フェーズ）の進捗状況
- 予定終了日と実際の終了予測日
- 遅延チェック

**必要性の評価:**
- ✅ **必要**: 長期プロジェクトの詳細な進捗情報を確認する必要がある
- ✅ **有用**: 遅延の原因を特定するため、各フェーズの進捗を確認できる
- ⚠️ **ただし**: 通常のJOBカードには不要（通常のジョブは進捗管理が不要）

### 5. 作業画面へのボタンの必要性

**作業画面へのボタンの機能:**
- `/mechanic/work/[id]`に遷移
- 長期プロジェクトの場合は、進捗管理画面（`RestoreWorkView`または`BodyPaintOutsourcingView`）に遷移

**必要性の評価:**
- ✅ **必要**: 通常のJOBカードと同じく、作業画面に遷移する必要がある
- ✅ **統一性**: 通常のJOBカードのアクションボタンと同じ機能

---

## 🔄 統合可能性の検討

### 1. 構造の類似性

**共通点:**
- 写真セクション（車両写真、サンプル画像）
- 顧客情報（顧客名、重要な顧客フラグ）
- 車両情報（車両名、ナンバープレート）
- ステータスバッジ
- 入庫区分バッジ
- 入庫日時、タグ、担当整備士、代車
- お客様入力情報、受付メモ、変更申請、承認済み作業内容
- アイコンボタン（星、フォルダ、プリンタ）

**相違点:**
- 長期プロジェクト: 進捗情報（進捗バー、進捗率、開始日、予定完了日、現在のフェーズ）
- 通常のJOBカード: 作業一覧（`WorkOrderList`）、複合業務対応
- 長期プロジェクト: "進捗詳細"ボタン
- 通常のJOBカード: "受付を開始" / "引渡しを開始" / "診断を開始" / "作業を開始"ボタン

### 2. 統合アプローチ

**提案: 条件分岐による統合**

`JobCard`コンポーネント内で、長期プロジェクトかどうかを判定し、条件分岐で表示を切り替える。

**実装方針:**
1. `JobCard`に`isLongTermProject`判定を追加
2. 長期プロジェクトの場合:
   - 進捗情報セクションを表示（進捗バー、進捗率、開始日、予定完了日）
   - "進捗詳細"ボタンを表示
   - "作業画面へ"ボタンを表示（または通常のアクションボタン）
   - 遅延フラグを表示（赤枠）
3. 通常のジョブの場合:
   - 既存の表示ロジックを維持
   - 作業一覧（`WorkOrderList`）を表示
   - 通常のアクションボタンを表示

**メリット:**
- ✅ コードの重複を削減
- ✅ UI/UXの一貫性を保つ
- ✅ メンテナンス性が向上
- ✅ デザインシステムの統一

**デメリット:**
- ⚠️ `JobCard`コンポーネントが複雑になる（条件分岐が増える）
- ⚠️ 長期プロジェクト特有のロジックが混在する

### 3. 統合の実現可能性

**技術的な実現可能性:**
- ✅ **可能**: 条件分岐で実装可能
- ✅ **データ取得**: `extractLongTermProjectData`で長期プロジェクトデータを取得可能
- ✅ **進捗情報**: `long-term-project-utils.ts`の関数で進捗情報を取得可能

**UI/UXの実現可能性:**
- ✅ **可能**: 進捗情報セクションを条件付きで表示可能
- ✅ **レイアウト**: 既存のレイアウトに進捗情報を追加可能
- ⚠️ **注意**: カードの高さが増える可能性がある（進捗情報を追加するため）

---

## 📝 統合実装計画

### Phase 1: 条件分岐の追加

1. `JobCard`に`isLongTermProject`判定を追加
2. 長期プロジェクトデータ（進捗、開始日、予定完了日など）を取得
3. 条件分岐で進捗情報セクションを表示

### Phase 2: 進捗情報セクションの統合

1. 進捗バー、進捗率、開始日、予定完了日を表示
2. 遅延フラグを表示（赤枠）
3. "進捗詳細"ボタンを追加

### Phase 3: アクションボタンの統合

1. 長期プロジェクトの場合、"作業画面へ"ボタンを表示
2. 通常のジョブの場合、既存のアクションボタンを表示

### Phase 4: 既存コードの削除

1. `LongTermProjectCard`コンポーネントを削除
2. `src/app/page.tsx`の長期プロジェクトセクションを通常のジョブカードセクションに統合
3. `src/app/projects/long-term/page.tsx`も`JobCard`を使用するように変更

---

## ✅ 結論と推奨事項

### 統合の推奨

**推奨: ✅ 統合すべき**

**理由:**
1. **コードの重複削減**: 現在、`LongTermProjectCard`と`JobCard`で多くのコードが重複している
2. **UI/UXの一貫性**: 同じフォーマットで表示することで、ユーザーの認知負荷を減らす
3. **メンテナンス性**: 1つのコンポーネントで管理することで、メンテナンスが容易になる
4. **デザインシステムの統一**: `DESIGN_SYSTEM.md`に準拠した統一されたUIを提供できる

### 実装時の注意点

1. **条件分岐の明確化**: 長期プロジェクトかどうかの判定を明確にする
2. **進捗情報の表示位置**: 進捗情報をどこに表示するか（上部セクション、下部セクション、別セクション）
3. **カードの高さ**: 進捗情報を追加することでカードの高さが増える可能性がある
4. **パフォーマンス**: 条件分岐が増えることで、パフォーマンスへの影響を確認する

### 次のステップ

1. **ユーザー確認**: 統合方針をユーザーに確認
2. **実装開始**: Phase 1から順に実装
3. **テスト**: 統合後の動作確認
4. **リファクタリング**: 既存コードの削除

---

## 📚 参考資料

- `src/components/features/long-term-project-card.tsx`: 現在の長期プロジェクトカード実装
- `src/components/features/job-card.tsx`: 通常のJOBカード実装
- `src/lib/long-term-project-utils.ts`: 長期プロジェクト判定・進捗データ抽出ロジック
- `docs/INTEGRATED_SPECIFICATION.md`: 長期プロジェクトの仕様詳細


