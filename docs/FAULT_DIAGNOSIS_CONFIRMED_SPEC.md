# 故障診断 確認済み仕様書

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: 故障診断の確認済み仕様
- **ステータス**: 実装準備完了

---

## 1. 確認済み事項

### 1-1. 業務フローパターン

**質問**: パターンA（入庫→診断→見積→承認→作業）で正しいですか？

**回答**: ✅ **パターンA（入庫→診断→見積→承認→作業）で正しい**

**設計決定**:
- 入庫してから診断を実施
- 診断結果に基づいて見積を作成
- 顧客承認後に作業を実施

### 1-2. 症状カテゴリと検査項目

**質問**: 症状カテゴリごとに検査項目を自動表示する設計で問題ありませんか？

**回答**: ✅ **症状は様々なパターンがある。カテゴリごとに検査項目を自動表示する設計で問題ない**

**設計決定**:
- 症状カテゴリを選択すると、関連する検査項目を自動表示
- 症状カテゴリは様々なパターンに対応できる設計
- 検査項目はカテゴリごとに動的に表示

### 1-3. 診断機の利用

**質問**: 診断機の利用について

**回答**: ✅ **診断機を利用する場合とないケースがある。診断機を使う場合は費用がかかる**

**設計決定**:
- 診断機の利用有無を選択可能
- 診断機を使用する場合は、診断機費用を見積に含める
- 診断機の結果はシステムから出力される（PDFなど）
- 診断機の結果は顧客に渡す

### 1-4. 測定値の入力

**質問**: 測定値の入力について

**回答**: ✅ **一般的な測定値を入れておいて。ただほとんどが診断機を使う**

**設計決定**:
- 一般的な測定値（圧力、電圧、温度、抵抗など）の入力フィールドを用意
- ただし、ほとんどが診断機を使うため、手動入力は補助的な役割
- 診断機の結果を優先的に使用

### 1-5. エラーランプ

**質問**: エラーランプについて

**回答**: ✅ **エラーランプがあって入庫するケースがある**

**設計決定**:
- エラーランプの有無を記録
- エラーランプの種類（エンジン、ABS、エアバッグなど）を記録
- エラーランプがある場合は、診断機での読み取りを推奨

### 1-6. 動画撮影

**質問**: 動画撮影について

**回答**: ✅ **動画撮影はケースバイケースで必要**

**設計決定**:
- 動画撮影は任意（必須ではない）
- 必要に応じて動画を撮影
- 動画はGoogle Driveに保存

### 1-7. 異音の録音

**質問**: 異音の録音について

**回答**: ✅ **異音の録音は音声のみで問題ない。Google Drive保存**

**設計決定**:
- 異音の録音は音声のみ（動画は不要）
- 音声ファイルはGoogle Driveに保存
- 音声録音機能を実装

### 1-8. 緊急度の管理

**質問**: 緊急度の管理について

**回答**: ✅ **緊急度はどうやって管理すればいいかわからない（要検討）**

**設計決定（暫定）**:
- 緊急度の管理方法は今後検討
- 現時点では、緊急度の設定機能は実装しない（将来の拡張として残す）
- 安全に関わる場合は、コメント欄で明記

### 1-9. そのまま帰る人や預ける人

**質問**: そのまま帰る人や預ける人について

**回答**: ✅ **そのまま帰る人や預ける人などケースバイケース**

**設計決定**:
- 診断結果によって、そのまま帰る場合と預ける場合がある
- そのまま帰る場合: 診断結果を説明して帰る（修理は後日）
- 預ける場合: 診断結果に基づいて見積を作成し、承認後に作業
- ステータス管理で対応（「診断完了（帰宅）」「診断完了（預かり）」など）

### 1-10. PDF生成

**質問**: PDF生成について

**回答**: ✅ **故障診断ではPDFは生成しない。診断機がある場合はシステムが出してくれるのでそれを渡す**

**設計決定**:
- 故障診断ではPDF生成は不要
- 診断機を使用する場合は、診断機システムから出力されるPDFを顧客に渡す
- 診断機の結果はGoogle Driveに保存（必要に応じて）

### 1-11. データソース

**質問**: データソースについて

**回答**: ✅ **データソースはすべて同じ**

**設計決定**:
- 車両情報: Google Sheets「【DB】車両マスタ」の「車両_同期用」シートから取得
- 費用情報: 同じく「車両_同期用」シートから取得（該当する場合）
- 部品情報: 部品マスタから取得（今後実装）

---

## 2. 確定した仕様サマリー

### 2-1. 業務フロー（パターンA）

```
1. 入庫: 不具合を感じた車両が入庫
2. 受付: 不具合の詳細を確認（5-10分）
3. 診断: 症状に応じた検査を実施（1-3時間）
   - 診断機を使用する場合とない場合がある
   - 診断機を使用する場合は費用がかかる
4. 見積作成: 原因特定の結果に基づいて見積を作成（30分-1時間）
5. 顧客承認: 見積内容を確認して承認（即決〜数日）
6. 作業実施: 承認後に修理を実施（1-4時間）
7. 引渡・説明: 修理内容を説明して引渡（15-30分）
```

**ケースバイケース**:
- **そのまま帰る場合**: 診断結果を説明して帰る（修理は後日）
- **預ける場合**: 診断結果に基づいて見積を作成し、承認後に作業

### 2-2. 症状カテゴリと検査項目

**設計決定**:
- 症状カテゴリを選択すると、関連する検査項目を自動表示
- 症状カテゴリは様々なパターンに対応できる設計
- 検査項目はカテゴリごとに動的に表示

**症状カテゴリ例**:
- エンジン不調
- ブレーキ不調
- 異音
- 電装系不調
- エアコン不調
- エラーランプ
- その他

### 2-3. 診断機の利用

**設計決定**:
- 診断機の利用有無を選択可能
- 診断機を使用する場合は、診断機費用を見積に含める
- 診断機の結果はシステムから出力される（PDFなど）
- 診断機の結果は顧客に渡す
- 診断機の結果はGoogle Driveに保存（必要に応じて）

### 2-4. 測定値の入力

**設計決定**:
- 一般的な測定値（圧力、電圧、温度、抵抗など）の入力フィールドを用意
- ただし、ほとんどが診断機を使うため、手動入力は補助的な役割
- 診断機の結果を優先的に使用

**一般的な測定値例**:
- 圧力（kPa）
- 電圧（V）
- 温度（℃）
- 抵抗（Ω）
- その他

### 2-5. エラーランプ

**設計決定**:
- エラーランプの有無を記録
- エラーランプの種類（エンジン、ABS、エアバッグなど）を記録
- エラーランプがある場合は、診断機での読み取りを推奨

### 2-6. 動画・音声撮影

**設計決定**:
- **動画撮影**: ケースバイケースで必要（任意）
- **異音の録音**: 音声のみで問題ない
- **動画・音声**: Google Driveに保存

### 2-7. 緊急度の管理

**設計決定（暫定）**:
- 緊急度の管理方法は今後検討
- 現時点では、緊急度の設定機能は実装しない（将来の拡張として残す）
- 安全に関わる場合は、コメント欄で明記

### 2-8. そのまま帰る人や預ける人

**設計決定**:
- 診断結果によって、そのまま帰る場合と預ける場合がある
- そのまま帰る場合: 診断結果を説明して帰る（修理は後日）
- 預ける場合: 診断結果に基づいて見積を作成し、承認後に作業
- ステータス管理で対応（「診断完了（帰宅）」「診断完了（預かり）」など）

### 2-9. PDF生成

**設計決定**:
- 故障診断ではPDF生成は不要
- 診断機を使用する場合は、診断機システムから出力されるPDFを顧客に渡す
- 診断機の結果はGoogle Driveに保存（必要に応じて）

### 2-10. データソース

**設計決定**:
- 車両情報: Google Sheets「【DB】車両マスタ」の「車両_同期用」シートから取得
- 費用情報: 同じく「車両_同期用」シートから取得（該当する場合）
- 部品情報: 部品マスタから取得（今後実装）

---

## 3. 画面設計

### 3-1. 受付画面（Phase 1）

#### 不具合情報の入力

**設計**:
- 不具合の詳細を入力（いつから、どんな症状、頻度など）
- エラーランプの有無を選択
- エラーランプの種類を選択（該当する場合）
- 走行距離を入力
- 前回整備履歴の表示

**UI要素**:
- 不具合詳細入力欄（テキストエリア）
- エラーランプ選択（チェックボックス）
- エラーランプ種類選択（ドロップダウン、該当する場合）
- 走行距離入力欄
- 前回整備履歴表示

### 3-2. 診断画面（Phase 2）

#### 症状カテゴリの選択と検査項目の表示

**設計**:
- **症状カテゴリを選択**: エンジン不調、ブレーキ不調、異音、電装系不調、エアコン不調、エラーランプ、その他
- **検査項目の自動表示**: 選択されたカテゴリに応じて、関連する検査項目を自動表示
- **診断機の利用選択**: 診断機を使用するかどうかを選択
- **測定値の入力**: 一般的な測定値の入力フィールド（補助的）
- **動画・音声撮影**: 必要に応じて動画・音声を撮影
- **コメント入力**: 整備士の所見を記録

**UI要素**:
- 症状カテゴリ選択（ドロップダウンまたはラジオボタン）
- 検査項目リスト（カテゴリに応じて動的）
- 診断機利用選択（チェックボックス）
- 測定値入力フィールド（一般的な測定値）
- 動画撮影ボタン（任意）
- 音声録音ボタン（異音の場合）
- 写真撮影ボタン
- コメント入力欄

### 3-3. 見積画面（Phase 3）

#### 原因の説明と修理方法の提案

**設計**:
- **原因の説明**: 写真・動画・音声を交えた説明
- **診断機費用**: 診断機を使用した場合は費用を表示
- **修理方法の提案**: 複数の選択肢がある場合、複数提案可能
- **部品代・工賃の見積もり**: 明確な内訳表示
- **診断機の結果**: 診断機を使用した場合は、結果PDFを表示・ダウンロード可能

**UI要素**:
- 原因説明欄（写真・動画・音声を紐付け）
- 診断機費用表示（診断機を使用した場合）
- 診断機結果PDF表示・ダウンロード（診断機を使用した場合）
- 修理方法選択肢（複数の場合）
- 部品代・工賃の見積もり
- 合計金額表示

### 3-4. 作業画面（Phase 4）

#### 作業記録

**設計**:
- **実施した修理の記録**: 修理内容を詳細に記録
- **Before/After写真**: 修理前後の写真
- **交換部品の記録**: 交換した部品の種類・型番・数量
- **動作確認の結果**: 動作確認の結果を記録

**UI要素**:
- 作業記録入力欄
- Before/After写真撮影ボタン
- 交換部品入力欄
- 動作確認チェックボックス
- 作業メモ入力欄

---

## 4. データモデル

### 4-1. 故障診断ジョブデータ

```typescript
/**
 * 故障診断ジョブ
 */
export interface FaultDiagnosisJob {
  /** Job ID */
  jobId: string;
  /** 入庫区分 */
  serviceKind: "故障診断";
  
  /** 不具合情報 */
  fault: {
    /** 不具合の詳細（顧客の説明） */
    description: string;
    /** 症状カテゴリ */
    symptomCategory: SymptomCategory;
    /** エラーランプの有無 */
    hasErrorLamp: boolean;
    /** エラーランプの種類 */
    errorLampType?: ErrorLampType;
    /** 走行距離 */
    mileage: number;
  };
  
  /** 診断情報 */
  diagnosis: {
    /** 診断機の利用有無 */
    usesDiagnosticTool: boolean;
    /** 診断機費用 */
    diagnosticToolCost?: number;
    /** 診断機結果PDF URL */
    diagnosticToolResultUrl?: string;
    /** 検査項目の結果 */
    inspectionResults: InspectionResult[];
    /** 測定値 */
    measurements: Record<string, number>;
    /** 写真・動画・音声 */
    photos: Photo[];
    videos: Video[];
    audio: Audio[];
    /** コメント（整備士の所見） */
    comments: string;
    /** 原因の推測 */
    suspectedCauses: SuspectedCause[];
  };
  
  /** 見積情報 */
  estimate: {
    /** 原因の説明 */
    causeExplanation: string;
    /** 修理方法の提案 */
    repairOptions: RepairOption[];
    /** 部品代・工賃の見積もり */
    parts: Part[];
    labor: number;
    /** 診断機費用 */
    diagnosticToolCost?: number;
    total: number;
  };
  
  /** 作業情報 */
  work: {
    /** 実施した修理の記録 */
    repairRecords: RepairRecord[];
    /** Before/After写真 */
    photos: Photo[];
    /** 交換部品 */
    replacedParts: ReplacedPart[];
    /** 動作確認結果 */
    operationCheck: OperationCheckResult;
  };
  
  /** ステータス */
  status: "診断中" | "診断完了（帰宅）" | "診断完了（預かり）" | "見積作成待ち" | "作業待ち" | "出庫待ち";
}

/**
 * 症状カテゴリ
 */
export type SymptomCategory =
  | "エンジン不調"
  | "ブレーキ不調"
  | "異音"
  | "電装系不調"
  | "エアコン不調"
  | "エラーランプ"
  | "その他";

/**
 * エラーランプの種類
 */
export type ErrorLampType =
  | "エンジン"
  | "ABS"
  | "エアバッグ"
  | "バッテリー"
  | "その他";

/**
 * 原因の推測
 */
export interface SuspectedCause {
  /** 原因ID */
  id: string;
  /** 原因の説明 */
  description: string;
  /** 確信度（%） */
  confidence: number;
}

/**
 * 修理方法の選択肢
 */
export interface RepairOption {
  /** 選択肢ID */
  id: string;
  /** 修理方法の説明 */
  description: string;
  /** 費用 */
  cost: number;
  /** 所要時間 */
  duration: number;
  /** 推奨度 */
  recommendation: "recommended" | "alternative" | "optional";
}
```

---

## 5. 実装方針

### 5-1. 症状カテゴリと検査項目の実装

**設計**:
- 症状カテゴリをマスタデータとして管理
- 各カテゴリに紐づく検査項目をマスタデータとして管理
- カテゴリ選択により、検査項目を動的に表示

### 5-2. 診断機の利用実装

**設計**:
- 診断機の利用有無を選択可能
- 診断機を使用する場合は、診断機費用を見積に含める
- 診断機の結果PDFをGoogle Driveに保存
- 診断機の結果PDFを表示・ダウンロード可能

### 5-3. 動画・音声撮影の実装

**設計**:
- 動画撮影は任意（ケースバイケース）
- 異音の録音は音声のみ
- 動画・音声はGoogle Driveに保存

### 5-4. ステータス管理の実装

**設計**:
- 「診断完了（帰宅）」「診断完了（預かり）」などのステータスを管理
- そのまま帰る場合と預ける場合を区別

---

## 6. 次のステップ

1. **症状カテゴリマスタの作成**: 各症状カテゴリと検査項目をマスタデータとして管理
2. **診断機連携の実装**: 診断機システムとの連携（必要に応じて）
3. **動的UIの実装**: 症状カテゴリに応じた診断画面の動的表示
4. **動画・音声撮影の実装**: 動画・音声撮影機能の実装
5. **ステータス管理の実装**: そのまま帰る場合と預ける場合のステータス管理

---

## 更新履歴

- 2025-01-XX: 初版作成（確認済み仕様書）


































