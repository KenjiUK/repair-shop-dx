# 診断後の一時帰宅管理 - 実装状況

**作成日:** 2025-01-XX
**最終更新日:** 2025-01-XX
**ステータス:** ✅ **完了**（ユーザージャーニー対応完了）

---

## 実装完了項目

### 1. 一時帰宅/入庫選択ダイアログの作成 ✅

**実装内容:**
- 診断完了時に「一時帰宅」か「入庫」を選択するダイアログを作成
- 一時帰宅を選択した場合、再入庫予定日時を入力できるようにする
- デフォルトで明日の10:00を設定

**実装ファイル:**
- `src/components/features/temporary-return-dialog.tsx`
  - 新規作成: 一時帰宅/入庫選択ダイアログコンポーネント

**機能:**
- 一時帰宅/入庫の選択（ラジオボタン）
- 再入庫予定日時の入力（日付と時刻）
- デフォルト値の設定（明日の10:00）

---

### 2. 診断完了処理への統合 ✅

**実装内容:**
- 診断料金入力ダイアログの後に一時帰宅/入庫選択ダイアログを表示
- 一時帰宅情報をfield7に保存（既存の内容を保持）
- 一時帰宅情報のパーサーを作成

**実装ファイル:**
- `src/app/mechanic/diagnosis/[id]/page.tsx`
  - 行533-537: 一時帰宅管理の状態管理
  - 行1900-1904: 診断完了ハンドラ（一時帰宅/入庫選択ダイアログ表示）
  - 行2135-2204: 診断完了処理（一時帰宅情報の保存）
  - 行2800-2815: 一時帰宅/入庫選択ダイアログの表示
- `src/lib/temporary-return-parser.ts`
  - 新規作成: 一時帰宅情報のパーサー
- `src/lib/api.ts`
  - 行128-149: `updateJobField7`関数を追加

**動作:**
- 診断料金入力後、一時帰宅/入庫選択ダイアログを表示
- 一時帰宅を選択した場合、再入庫予定日時を入力
- 一時帰宅情報をfield7に保存（既存の内容を保持）
- 入庫を選択した場合、一時帰宅情報を削除

---

### 3. トップページでの表示 ✅

**実装内容:**
- ジョブカードで「見積作成待ち」を「一時帰宅中」として表示（一時帰宅情報がある場合）
- 再入庫予定日時を表示

**実装ファイル:**
- `src/components/features/job-card.tsx`
  - 行197-202: 一時帰宅情報の取得と表示判定（拡張: 見積提示済み・作業待ちでも対応）
  - 行202-212: 表示用ステータスの判定（「一時帰宅中」「再入庫待ち」）
  - 行82-146: `getActionConfig`関数（「再入庫待ち」の場合、「受付を開始」ボタンを表示）
  - 行410-428: ステータスバッジの表示と再入庫予定日時の表示
- `src/lib/api.ts`
  - 行232-237: チェックイン時の一時帰宅情報の削除処理
  - 行239-247: 再入庫時のステータス更新処理（見積承認済みの場合は「作業待ち」のまま）

**UI改善点:**
- 一時帰宅中の場合は「一時帰宅中」として表示（見積作成待ち・見積提示済み）
- 「作業待ち」で一時帰宅情報がある場合、「再入庫待ち」として表示
- 再入庫予定日時を視覚的に表示（カレンダーアイコン付き）
- 「再入庫待ち」の場合、アクションボタンを「受付を開始」に変更

---

## 実装結果

### 完了した機能

1. ✅ **一時帰宅/入庫選択ダイアログ**
   - 診断完了時に「一時帰宅」か「入庫」を選択
   - 一時帰宅の場合、再入庫予定日時を入力

2. ✅ **一時帰宅情報の保存**
   - 一時帰宅情報をfield7に保存（既存の内容を保持）
   - 一時帰宅情報のパーサーを作成

3. ✅ **トップページでの表示**
   - ジョブカードで「見積作成待ち」「見積提示済み」を「一時帰宅中」として表示
   - 「作業待ち」で一時帰宅情報がある場合は「再入庫待ち」として表示
   - 再入庫予定日時を表示

4. ✅ **見積承認後の処理**
   - 見積承認後、一時帰宅情報を保持
   - 「作業待ち」で一時帰宅情報がある場合は「再入庫待ち」として表示
   - 「再入庫待ち」の場合、アクションボタンを「受付を開始」に変更

5. ✅ **チェックイン時の一時帰宅情報の削除**
   - 再入庫時にチェックイン処理を実行する際、一時帰宅情報を自動削除
   - 見積承認済み（作業待ち）で再入庫した場合、ステータスを「作業待ち」のまま維持

---

## テスト推奨事項

1. **一時帰宅/入庫選択ダイアログのテスト**
   - 診断完了時に一時帰宅/入庫選択ダイアログが表示されることを確認
   - 一時帰宅を選択した場合、再入庫予定日時を入力できることを確認
   - 入庫を選択した場合、正常に処理が完了することを確認

2. **一時帰宅情報の保存処理のテスト**
   - 一時帰宅情報がfield7に正しく保存されることを確認
   - 既存のfield7の内容が保持されることを確認
   - 入庫を選択した場合、一時帰宅情報が削除されることを確認

3. **トップページでの表示のテスト**
   - 一時帰宅中のジョブが「一時帰宅中」として表示されることを確認
   - 再入庫予定日時が正しく表示されることを確認

---

## ユーザージャーニー対応

### パターン1: 一時帰宅して戻ってくる（見積承認パターン）

**フロー:**
1. 診断完了 → 一時帰宅を選択 → 再入庫予定日時を入力
2. ステータス: 「見積作成待ち」（一時帰宅中として表示）
3. 見積作成・提示 → ステータス: 「見積提示済み」（一時帰宅中として表示）
4. 見積承認 → ステータス: 「作業待ち」（再入庫待ちとして表示）
5. 再入庫 → チェックイン処理 → 一時帰宅情報を削除 → ステータス: 「作業待ち」（通常の作業待ち）
6. 作業開始 → 通常のフロー

**対応状況:** ✅ **完了**
- 見積承認後、一時帰宅情報を保持
- 「作業待ち」で一時帰宅情報がある場合、「再入庫待ち」として表示
- 「再入庫待ち」の場合、アクションボタンを「受付を開始」に変更
- チェックイン時に一時帰宅情報を自動削除

---

### パターン2: 一時帰宅して戻ってこない（見積却下または作業依頼しないパターン）

**フロー:**
1. 診断完了 → 一時帰宅を選択 → 再入庫予定日時を入力
2. ステータス: 「見積作成待ち」（一時帰宅中として表示）
3. 見積作成・提示 → ステータス: 「見積提示済み」（一時帰宅中として表示）
4. 見積却下または作業依頼しない
5. ジョブ終了 → 一時帰宅情報を削除（手動または自動）

**対応状況:** ⚠️ **部分対応**
- 見積却下機能は未実装（将来実装予定）
- 一時帰宅情報は手動で削除可能（見積画面などから）
- 一定期間経過後の自動削除は未実装（将来実装予定）

---

## 次のステップ

診断後の一時帰宅管理の実装が完了しました。ユーザージャーニーに対応し、見積承認後の処理とチェックイン時の一時帰宅情報の削除を実装しました。

**参照:**
- `docs/IMPLEMENTATION_ROADMAP.md` - 実装ロードマップ
- `docs/TEMPORARY_RETURN_USER_JOURNEY.md` - ユーザージャーニー分析







