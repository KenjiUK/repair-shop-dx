# データソース構造ドキュメント

## 目的

本ドキュメントは、システムが参照・利用する各種データソース（Google Sheets、Zoho CRM等）の構造と、各項目の用途を記録するための資料です。

---

## 1. Google Sheets（マスタデータ）

### 1-1. 車両マスタ（【DB】車両マスタ）

**シート名**: `【DB】車両マスタ`

**URL**: https://docs.google.com/spreadsheets/d/1iXrkhZDt81SRYaJtz8zBxOC8zug47vmUCMAGJ6y4fvo/edit?gid=0#gid=0

**用途**: 車両情報と車検費用などの法定費用を管理するマスタデータ

**検索キー**: `車両ID`（Zoho CRMの`CustomModule1.Name`と一致）

**注意**: 「【DB】車両マスタ」内に「車両_同期用」という別シートが存在します。法定費用の取得はこの「車両_同期用」シートから行います。

**用途**: 車両情報と車検費用などの法定費用を管理するマスタデータ

**検索キー**: `車両ID`（Zoho CRMの`CustomModule1.Name`と一致）

#### 主要カラム一覧

| カラム名 | データ型 | 用途 | 備考 |
|---------|---------|------|------|
| 車両ID | Text | 主キー | Zoho CRMの`CustomModule1.Name`と一致 |
| 顧客ID | Text | 顧客との紐付け | Zoho CRMの`Contacts.ID1`と一致 |
| 顧客名 | Text | 表示用 | |
| 顧客名ふりがな | Text | 表示用 | |
| 顧客〒 | Text | 表示用 | |
| 顧客住所連結 | Text | 表示用 | |
| 顧客TEL | Text | 表示用 | |
| 顧客携帯番号 | Text | 表示用 | |
| 顧客FAX | Text | 表示用 | |
| 初年月連結 | Text | 車両情報 | |
| 登録番号連結 | Text | 車両情報 | ナンバープレート情報 |
| メーカー | Text | 車両情報 | |
| 車名 | Text | 車両情報 | |
| グレード | Text | 車両情報 | |
| 型式 | Text | 車両情報 | |
| 車台番号 | Text | 車両情報 | |
| 原動機の型式 | Text | 車両情報 | |
| 型式指定 | Text | 車両情報 | |
| 類別 | Text | 車両情報 | |
| 排気量 | Number | 車両情報 | |
| 排気量_車検証 | Number | 車両情報 | |
| 定員 | Number | 車両情報 | |
| 定員※ | Text | 車両情報 | |
| 車両重量 | Number | 車両情報 | |
| 最大積載量 | Number | 車両情報 | |
| 最大積載量※ | Text | 車両情報 | |
| 車両総重量 | Number | 車両情報 | |
| 車両総重量※ | Text | 車両情報 | |
| 前前軸重 | Number | 車両情報 | |
| 前後軸重 | Number | 車両情報 | |
| 後前軸重 | Number | 車両情報 | |
| 後後軸重 | Number | 車両情報 | |
| 車両長さ | Number | 車両情報 | |
| 車両幅 | Number | 車両情報 | |
| 車両高さ | Number | 車両情報 | |
| **車検有効期限** | **Date** | **車検管理** | **次回車検予定日の計算に使用** |
| **次回点検日** | **Date** | **点検管理** | **次回点検予定日の計算に使用** |
| 走行距離 | Number | 車両情報 | |
| 車体の形状 | Text | 車両情報 | |
| 車体色 | Text | 車両情報 | |
| 色番号 | Text | 車両情報 | |
| ミッション | Text | 車両情報 | |
| 燃料 | Text | 車両情報 | |
| 駆動 | Text | 車両情報 | |
| キーナンバー | Text | 車両情報 | |
| タイヤ前 | Text | 車両情報 | |
| タイヤ後 | Text | 車両情報 | |
| バッテリー | Text | 車両情報 | |
| オイル | Text | 車両情報 | |
| オイルフィルター | Text | 車両情報 | |
| リサイクル券番号 | Text | 車両情報 | |
| リサイクル預託料金 | Number | 車両情報 | |
| 車種区分1 | Text | 車両情報 | |
| 車種区分3 | Text | 車両情報 | |
| 車種区分2 | Text | 車両情報 | |
| 車両管理情報 | Text | 車両情報 | |
| 管理対象外 | Text | 車両情報 | |
| 変換_初年月連結 | Date | 車両情報 | |
| 経過月数 | Number | 車両情報 | |
| 印紙代判定ナンバー | Number | 費用計算 | |
| 自動車重量税_元 | Number | 費用計算（元データ） | |
| 印紙代_元 | Number | 費用計算（元データ） | |
| 車検（24ヶ月）_元 | Number | 費用計算（元データ） | |
| 12ヶ月点検_元 | Number | 費用計算（元データ） | |
| 車検可能日 | Date | 車検管理 | |
| **自動車重量税** | **Number** | **法定費用** | **見積画面で表示** |
| **印紙代** | **Number** | **法定費用** | **見積画面で表示** |
| **車検（24ヶ月）** | **Number** | **法定費用** | **見積画面で表示** |
| **12ヶ月点検** | **Number** | **法定費用** | **見積画面で表示** |
| **代行手数料** | **Number** | **法定費用** | **見積画面で表示（該当する場合）** |
| **自賠責保険料** | **Number** | **法定費用** | **見積画面で表示** |
| **テスター代** | **Number** | **法定費用** | **見積画面で表示（該当する場合）** |
| **車検_法定外費用** | **Number** | **法定外費用（合計）** | **見積画面で表示** |
| **車検_法定費用** | **Number** | **法定費用（合計）** | **見積画面で表示** |
| **車検_総額** | **Number** | **総額** | **見積画面で表示** |
| 点検推奨月算出用 | Number | 計算用 | |
| 点検推奨月 | Number | 計算用 | |

#### データ取得方法

```typescript
// 例: 車両IDから車両情報と法定費用を取得
const vehicleId = "A1019"; // Zoho CRMのCustomModule1.Name
const vehicleData = await getVehicleFromSheet(vehicleId);

// 取得できる情報
const {
  車名,              // "2008"
  登録番号連結,      // "堺 330 す 1669"
  車検有効期限,      // "2026/10/30"
  次回点検日,        // "2027/10/30"
  自動車重量税,      // 24,600
  印紙代,            // 2,300
  "車検（24ヶ月）",  // 66,000
  "12ヶ月点検",      // 26,400
  代行手数料,        // 19,800
  自賠責保険料,      // 17,650
  テスター代,        // 4,400
  車検_法定外費用,   // 90,200
  車検_法定費用,     // 44,550
  車検_総額,         // 134,750
} = vehicleData;
```

#### 使用例

**車検の見積画面で**:
1. 車両ID（`ZohoJob.field6.Name`）を取得
2. 「【DB】車両マスタ」シート（または「車両_同期用」データ範囲）から該当レコードを検索
3. 法定費用の項目を取得して表示
4. 顧客承認後、これらの情報をPDFに転記

**注意**: 「【DB】車両マスタ」内の「車両_同期用」シートから法定費用を取得します。

---

### 1-2. 顧客マスタ

**シート名**: `SheetID_Customer`（仮称、実際のシート名は要確認）

**用途**: 顧客情報を管理するマスタデータ

**検索キー**: `顧客ID`（Zoho CRMの`Contacts.ID1`と一致）

#### 主要カラム一覧

| カラム名 | データ型 | 用途 | 備考 |
|---------|---------|------|------|
| 顧客ID | Text | 主キー | Zoho CRMの`Contacts.ID1`と一致 |
| 顧客名 | Text | 表示用 | |
| 住所連結 | Text | 表示用 | |
| 電話番号 | Text | 表示用 | |
| 携帯番号 | Text | 表示用 | |

---

## 2. Zoho CRM

### 2-1. 入庫管理（CustomModule2）

詳細は `SPECIFICATION.md` の「0-2. Zoho CRM モジュール・フィールド・APIマッピング」を参照。

**主要フィールド**:
- `id`: レコードID
- `field22`: 入庫日時
- `field5`: 工程ステージ
- `field4`: 顧客名（Lookup）
- `field6`: 車両ID（Lookup）
- `field`: 作業指示書
- `field7`: 詳細情報
- `field10`: 走行距離
- `field13`: 作業内容
- `field19`: お客様共有フォルダ

### 2-2. 車両（CustomModule1）

**主要フィールド**:
- `Name`: 車両ID（主キー、Google Sheetsの「車両ID」と一致）
- `field44`: 登録番号連結
- `ID1`: 顧客ID
- `field7`: 車検有効期限

### 2-3. 顧客（Contacts）

**主要フィールド**:
- `id`: レコードID
- `ID1`: 顧客ID（主キー、Google Sheetsの「顧客ID」と一致）
- `Last_Name`, `First_Name`: 氏名
- `Mobile`: 携帯番号
- `Phone`: 電話番号

---

## 3. 前回整備履歴の参照方法

### 3-1. 現状

**重要**: 現在、前回整備履歴を表示するシステムはまだ実装されていません。

**今後の要件**: 前回整備履歴を参照できる機能を実装する必要があります。

### 3-2. データソース（将来実装）

前回整備履歴は、**Zoho CRMの入庫管理（CustomModule2）**から取得する予定です。

### 3-3. 取得方法（将来実装）

```typescript
// 例: 車両IDから前回整備履歴を取得
const vehicleId = "A1019";
const previousJobs = await getPreviousJobsByVehicle(vehicleId);

// 取得できる情報
const previousJob = previousJobs[0]; // 最新の整備履歴
const {
  id,                    // 前回のJob ID
  field22,               // 前回の入庫日時
  field10,               // 前回の走行距離
  field13,               // 前回の作業内容
  field19,               // 前回のGoogle DriveフォルダURL
} = previousJob;
```

### 3-4. 表示場所（将来実装）

以下の画面で前回整備履歴を参照可能にする：

1. **診断画面**
   - 前回整備からの走行距離を表示
   - 前回の診断結果を参照可能にする
   - 前回の分解整備記録簿（PDF）を参照可能にする

2. **見積画面**
   - 前回整備内容を表示
   - 前回との比較を表示
   - 前回の交換部品を表示

3. **作業画面**
   - 前回整備内容を参照
   - 前回の作業写真を参照

4. **顧客向けレポート画面**
   - 過去の整備履歴一覧を表示
   - 各整備の分解整備記録簿（PDF）を参照可能にする

### 3-5. 実装時の考慮事項

1. **データ保存**: 分解整備記録簿（PDF）をGoogle Driveに保存し、Zoho CRMの`field19`（お客様共有フォルダ）に紐付ける
2. **履歴の検索**: 車両IDをキーに、過去の入庫管理レコードを時系列で取得
3. **パフォーマンス**: 履歴が多くなった場合の検索パフォーマンスを考慮
4. **データ移行**: 既存の整備履歴がある場合、それらをシステムに移行する方法を検討

---

## 4. 検査項目テンプレート（分解整備記録簿）

### 4-1. PDFテンプレート

**ファイル**: `public/24か月点検用テンプレート.pdf`

**正式名称**: 「分解整備記録簿（2年定期点検用整備記録簿）」

**用途**: 車検の検査項目（100項目以上）のテンプレート。車両の2年定期点検における詳細な検査項目、結果、および実施された整備内容を記録するための公式な書類。

**実装要件**:
1. モバイルで項目を取得
2. 各項目の状態を入力（正常/注意/要交換）
3. 測定値が必要な項目は数値入力
4. 写真撮影（不具合箇所）
5. 最終的にPDFに情報転記

### 4-2. PDFテンプレートの構造

#### 上部ヘッダーセクション（車両・依頼者情報）

以下の項目は、Google Sheets「【DB】車両マスタ」から自動取得・入力：

- **依頼者(使用者)の氏名又は名称**: 顧客名
- **車名及び型式**: 車名、型式
- **自動車登録番号又は車両番号**: 登録番号連結
- **原動機の型式**: 原動機の型式
- **初度登録年又は初度検査年**: 初年月連結
- **車台番号**: 車台番号

**点検項目の省略規則**:
- ☆印は1年 5,000km以下
- ★印は2年 10,000km以下

**整備区分を示すチェックボックス**:
- 「自家」、「点検良好」、「レ 交換」、「× 調整」、「A 清掃」、「C 省略」、「P 住所」、「該当なし」

#### 主要点検項目セクション（6つのカテゴリ）

**1. エンジン・ルーム点検**
- パワー・ステアリング（ベルトの緩み、損傷、オイル漏れ、オイル量など）
- 冷却装置（ファンベルトの緩み、損傷、冷却水漏れなど）
- 点火装置（スパーク・プラグの状態、点火時期、ディストリビュータのキャップの状態など）
- 燃料装置（燃料の漏れ）
- バッテリ、電気配線（ターミナル部の緩み、腐食、電気配線の緩み、損傷など）
- 公害発散防止装置等（メターリングバルブの状態、ブローバイ・ガス還元装置の配管損傷など）
- エンジン（排気ガスの色、CO・HC濃度、エア・クリーナ・エレメントの汚れ、詰まり、損傷など）

**2. 室内点検**
- ハンドル（操作具合、遊び、がた）
- ブレーキ・ペダル（遊び、踏み込んだ時の床板とのすき間、きき具合）
- パーキング・ブレーキ・レバー(ペダル)（引きしろ（踏みしろ）、きき具合）
- クラッチ・ペダル（遊び、切れた時の床板とのすき間）

**3. 足廻り点検**
- かじ取り車輪（ホイール・アライメント）
- ショック・アブソーバ（損傷、オイル漏れ）
- サスペンション（取付部、連結部の緩み、がた、損傷）
- ホイール（タイヤの空気圧、亀裂、損傷、溝の深さ、異常な磨耗、ボルト・ナットの緩み、ホイール・ベアリングのがた）
- ブレーキ・ディスク、ドラム（ディスクとパッドのすき間、パッドの磨耗、ディスクの磨耗、損傷、ドラムとライニングのすき間、ブレーキシューの摺動部分、ライニングの磨耗）
- ブレーキのマスタ・シリンダ、ホイール・シリンダ、ディスク、キャリパ（液漏れ、機能、磨耗、損傷）

**4. 下廻り点検**
- エンジン・オイル（漏れ）
- ステアリング・ギヤ・ボックス（取付けの緩み）
- ステアリングのロッド、アーム類（緩み、がた、損傷、ボール・ジョイントのダスト・ブーツの亀裂、損傷）
- トランスミッション、トランスファ（オイル漏れ、オイル量）
- プロペラシャフト・ドライブシャフト（連結部の緩み、ダスト・ブーツの亀裂、損傷）
- デファレンシャル（オイル漏れ、オイル量）
- ブレーキ・ホース、パイプ（漏れ、損傷、取付状態）
- エグゾースト・パイプ、マフラ（取付けの緩み、損傷、腐食、遮熱板の取付けの緩み、損傷、腐食、マフラの機能）

**5. 外廻り点検**
- フレーム、ボデー（緩み、損傷）

**6. 日常点検**
- ブレーキ液の量、バッテリ液の量、冷却水の量、エンジン・オイルの量
- エンジンのかかり具合、異音、低速と加速の状態
- ヘッドランプ・ストップ・ランプ・ウインカ・ランプ等の点灯、汚れ、損傷
- ウインド・ウォッシャ液の量、噴射状態、ワイパの拭き取り状態

#### 測定値入力欄

**CO、HC濃度（アイドリング時）**:
- CO：____ %
- HC：____ ppm

**タイヤの溝の深さ（1.6mm以上）**:
- 前輪左 ____ mm 右 ____ mm
- 後輪左 ____ mm 右 ____ mm

**ブレーキ・パッド、ライニングの厚さ**:
- 前輪左 ____ mm 右 ____ mm
- 後輪左 ____ mm 右 ____ mm

#### 交換部品等

表形式で項目名と数量を記載：
- エンジン・オイル
- オイルフィルタ
- LLC(ロング・ライフ・クーラント)
- ブレーキ・フルード
- その他

#### その他の点検項目等

自由記述欄

#### 最下部の管理・完了情報

- **自動車分解整備事業者の氏名又は名称及び事業場の所在地並びに認証番号**: 整備事業者の情報
- **点検の年月日**: 年 月 日
- **整備主任者の氏名**
- **整備完了年月日**: 年 月 日
- **点検(整備)時の総走行距離**: ____ km

### 4-3. データ構造の実装要件

#### モバイル入力時のデータ構造

```typescript
interface InspectionItem {
  category: string; // "エンジン・ルーム点検", "室内点検", "足廻り点検", "下廻り点検", "外廻り点検", "日常点検"
  subCategory: string; // "パワー・ステアリング", "冷却装置", etc.
  itemName: string; // 具体的な項目名
  status: "正常" | "注意" | "要交換" | "調整" | "清掃" | "省略" | "該当なし";
  measurement?: number; // 測定値（mm、ppm、%など）
  photos?: string[]; // 写真URLの配列
  comment?: string; // コメント
  skipRule?: "☆" | "★"; // 省略規則（1年5,000km以下、2年10,000km以下）
}

interface InspectionData {
  vehicleInfo: {
    依頼者氏名: string;
    車名及び型式: string;
    登録番号: string;
    原動機の型式: string;
    初度登録年: string;
    車台番号: string;
  };
  items: InspectionItem[];
  measurements: {
    co: number; // CO濃度（%）
    hc: number; // HC濃度（ppm）
    tireDepth: {
      前輪左: number;
      前輪右: number;
      後輪左: number;
      後輪右: number;
    };
    brakePadThickness: {
      前輪左: number;
      前輪右: number;
      後輪左: number;
      後輪右: number;
    };
  };
  replacedParts: {
    itemName: string;
    quantity: number;
    unit: string; // "l", "個", etc.
  }[];
  otherItems?: string; // その他の点検項目等
  inspectionDate: string; // 点検の年月日
  mechanicName: string; // 整備主任者の氏名
  completionDate: string; // 整備完了年月日
  totalMileage: number; // 点検(整備)時の総走行距離
}
```

#### PDF出力時のマッピング

モバイルで入力したデータを、PDFテンプレートの各項目に対応させる必要があります：

1. **チェックボックスの配置**: 各項目の状態に応じて、適切なチェックボックスにマーク
2. **測定値の配置**: CO、HC濃度、タイヤ溝深さ、ブレーキパッド厚さを適切な位置に配置
3. **交換部品の配置**: 交換部品等の表に項目名と数量を配置
4. **写真の配置**: 不具合箇所の写真を適切な位置に配置（必要に応じて）

### 4-4. 実装上の注意事項

1. **複数日数の作業**: 作業が複数日にわたる場合、一時保存機能が必要
2. **進捗管理**: 各カテゴリの点検進捗を管理
3. **写真の圧縮**: 写真はクライアント側で圧縮してから保存（Google Drive容量対策）
4. **オフライン対応**: 工場内でWi-Fiが届かない場合に備え、オフラインでも入力可能にし、オンライン復帰時に同期

---

## 5. データ連携フロー

### 5-1. 車検の見積作成時

```
1. Zoho CRMから入庫管理レコードを取得
   ↓
2. 車両ID（field6.Name）を取得
   ↓
3. Google Sheets「車両_同期用」から車両情報と法定費用を取得
   ↓
4. 見積画面に表示
   ↓
5. 顧客承認後、PDFに転記
```

### 5-2. 前回整備履歴の参照時

```
1. 車両IDを取得
   ↓
2. Zoho CRMの入庫管理から、該当車両の過去レコードを検索
   ↓
3. 最新の整備履歴を取得
   ↓
4. 各画面で表示
```

---

## 6. 注意事項

### 6-1. データ整合性

- **車両ID**: Zoho CRMの`CustomModule1.Name`とGoogle Sheetsの「車両ID」は完全一致している必要がある
- **顧客ID**: Zoho CRMの`Contacts.ID1`とGoogle Sheetsの「顧客ID」は完全一致している必要がある

### 6-2. データ更新タイミング

- Google Sheetsは**毎日更新**される（スマートカーディーラーから出力）
- 法定費用は車両情報に基づいて自動計算されるため、Google Sheetsから取得する

### 6-3. エラーハンドリング

- 車両IDが見つからない場合のエラー処理
- 法定費用が未設定の場合のエラー処理
- 前回整備履歴が見つからない場合の処理（初回整備の場合）

---

## 更新履歴

- 2025-01-XX: 初版作成（車検の法定費用取得方法を追加）
- 2025-01-XX: 車両マスタのシート名を「【DB】車両マスタ」に修正、URLを追加
- 2025-01-XX: 分解整備記録簿（PDFテンプレート）の詳細な構造を追加
- 2025-01-XX: 前回整備履歴の現状（未実装）を明記、将来実装要件を追加



































