# UXレビュー - 包括的分析

**作成日:** 2024年
**目的:** アプリケーション全体のUXレビューと課題の洗い出し

---

## レビュー対象

- **利用者:** ワイエムワークスのスタッフ、顧客
- **視点:** 各ユーザー×入庫区分別のカスタマージャーニー
- **レビュー項目:**
  - UI的な課題（スマホ表示、文字はみ出し、コンポーネントの問題）
  - UX的な課題
  - 業務的に抜けている部分
  - システム連携の問題
  - システムの不整合（入庫区分と表示内容の不一致など）

---

## 入庫区分一覧

以下の入庫区分が存在します：

1. **車検**
2. **12ヵ月点検**
3. **エンジンオイル交換**
4. **タイヤ交換・ローテーション**
5. **故障診断**
6. **修理・整備**
7. **レストア**
8. **チューニング**
9. **パーツ取付**
10. **コーティング**
11. **その他**

---

## ユーザー×入庫区分別のカスタマージャーニー

### 1. スタッフ（受付・フロント）のフロー

#### 1-1. トップページ（`/`）

**開始地点:** すべての入庫区分で共通

**表示内容:**
- 本日の入庫予定リスト
- ステータス別フィルター（入庫待ち、入庫済み、見積作成待ち、見積提示済み、作業待ち、出庫待ち、再入庫予定）
- 入庫区分別フィルター
- 検索バー

**アクション:**
- ジョブカードをクリック → 詳細画面へ
- ステータスフィルターをクリック → フィルタリング
- 入庫区分フィルターをクリック → フィルタリング
- 検索 → ジョブ検索

**次の画面:**
- ジョブカードクリック → ステータスに応じて異なる画面へ遷移

---

#### 1-2. 入庫待ち → 入庫処理

**対象:** すべての入庫区分

**フロー:**
1. トップページで「入庫待ち」のジョブを確認
2. ジョブカードをクリック
3. チェックインダイアログが表示される
4. スマートタグを選択（QRスキャンまたはリストから選択）
5. 代車を選択（必要な場合）
6. チェックイン完了
7. ステータスが「入庫済み」に更新

**課題（要確認）:**
- [ ] スマートタグ選択UIがスマホで使いやすいか
- [ ] チェックイン時の車両確認が適切か
- [ ] 代車選択のUIが分かりやすいか

---

#### 1-3. 入庫済み → 診断画面への遷移

**対象:** すべての入庫区分

**フロー:**
1. トップページで「入庫済み」のジョブを確認
2. ジョブカードの「診断開始」ボタンをクリック
3. 診断画面（`/mechanic/diagnosis/[id]`）へ遷移

**課題（要確認）:**
- [ ] 診断画面への遷移がスムーズか
- [ ] 入庫区分に応じた適切な診断画面が表示されるか

---

### 2. スタッフ（メカニック）のフロー

#### 2-1. 診断画面（`/mechanic/diagnosis/[id]`）

**開始地点:** すべての入庫区分で共通

**表示内容（入庫区分別）:**

##### 2-1-1. 車検・12ヵ月点検

**表示:**
- 外観撮影（前・後・左・右）
- OBD診断結果セクション（12ヵ月点検の場合のみ）
- 車検診断ビュー（`InspectionDiagnosisView`）
  - カテゴリタブ（エンジン・ルーム点検、室内点検、足廻り点検、下廻り点検、外廻り点検、日常点検）
  - 検査項目リスト（信号機方式）
  - 測定値入力
  - 写真・動画撮影

**課題（要確認）:**
- [ ] カテゴリタブがスマホで使いやすいか（6タブが画面に収まるか）
- [ ] 検査項目が多すぎてスクロールが大変ではないか
- [ ] 測定値入力のUIが分かりやすいか

##### 2-1-2. エンジンオイル交換

**表示:**
- 外観撮影（前・後・左・右）
- エンジンオイル交換診断ビュー（`EngineOilInspectionView`）
  - 簡易検査項目（エンジンオイル、オイルフィルター、エアエレメント、冷却水、バッテリー、ワイパーゴム）
  - 信号機方式の状態選択
  - 写真撮影
  - コメント入力

**課題（要確認）:**
- [ ] 簡易検査項目が適切か
- [ ] エンジンオイル交換なのに、車検用の項目が表示されていないか（**ユーザー指摘の不整合**）

##### 2-1-3. タイヤ交換・ローテーション

**表示:**
- 外観撮影（前・後・左・右）
- タイヤ交換・ローテーション診断ビュー（`TireInspectionView`）
  - タイヤ検査項目
  - タイヤ溝深さ入力
  - タイヤ空気圧入力
  - 推奨空気圧入力

**課題（要確認）:**
- [ ] タイヤ溝深さ・空気圧入力のUIが分かりやすいか
- [ ] スマホでの数値入力がしやすいか

##### 2-1-4. 故障診断

**表示:**
- 外観撮影（前・後・左・右）
- 故障診断ビュー（`FaultDiagnosisView`）
  - エラーランプ情報（受付時に入力されたもの）
  - 症状の選択（カテゴリタブ：エンジン、トランスミッション、ブレーキ、電装、その他）
  - 診断機結果（OBD診断結果PDFアップロード）
  - 動画撮影
  - 音声録音
  - 追加メモ

**課題（要確認）:**
- [ ] 症状選択のUIが分かりやすいか
- [ ] 診断機結果のアップロードが簡単か
- [ ] 動画・音声録音のUIが使いやすいか

##### 2-1-5. 修理・整備

**表示:**
- 外観撮影（前・後・左・右）
- 診断機結果セクション（OBD診断結果PDFアップロード）
- 診断チェックリスト（デフォルトのチェックリスト）

**課題（要確認）:**
- [ ] 修理・整備用の専用ビューがあるか、それともデフォルトのチェックリストを使用しているか
- [ ] デフォルトのチェックリストが適切か

##### 2-1-6. その他の入庫区分

**表示:**
- 外観撮影（前・後・左・右）
- 各入庫区分専用の診断ビュー

**課題（要確認）:**
- [ ] 各入庫区分に適切な診断ビューが表示されているか

**共通課題（診断画面）:**
- [ ] **【重要】入庫区分がエンジンオイル交換なのに、車検用の項目（分解整備記録簿など）が表示されていないか**
- [ ] スマホでの撮影UIが使いやすいか
- [ ] 診断完了ボタンが固定フッターで常に表示されているか
- [ ] 整備士選択ダイアログが適切に表示されるか

---

#### 2-2. 見積画面（`/admin/estimate/[id]`）

**対象:** すべての入庫区分（診断完了後）

**表示内容（入庫区分別）:**

##### 2-2-1. 車検・12ヵ月点検

**表示:**
- 診断結果（写真、検査項目）
- 見積項目（松竹梅方式）
- オプションメニュー（12ヶ月点検の場合）
- 部品リスト
- 法定費用カード

**課題（要確認）:**
- [ ] 見積項目の追加・編集がしやすいか
- [ ] オプションメニューの選択UIが分かりやすいか
- [ ] 部品リストの入力が簡単か

##### 2-2-2. エンジンオイル交換

**表示:**
- 診断結果（簡易検査項目）
- 見積項目
- 部品リスト

**課題（要確認）:**
- [ ] エンジンオイル交換用の見積項目が適切か

##### 2-2-3. 故障診断

**表示:**
- 診断結果（症状、診断機結果、動画、音声）
- 故障診断見積ビュー（`FaultDiagnosisEstimateView`）
- 見積項目
- 部品リスト

**課題（要確認）:**
- [ ] 故障診断用の見積項目が適切か
- [ ] 診断機結果が適切に表示されているか

##### 2-2-4. その他の入庫区分

**表示:**
- 各入庫区分専用の見積ビュー

**課題（要確認）:**
- [ ] 各入庫区分に適切な見積ビューが表示されているか

**共通課題（見積画面）:**
- [ ] 見積項目の追加・編集が簡単か
- [ ] 部品リストの入力が簡単か
- [ ] 顧客への送信ボタンが分かりやすいか
- [ ] メカニック承認機能が適切に表示されているか

---

#### 2-3. 作業画面（`/mechanic/work/[id]`）

**対象:** すべての入庫区分（見積承認後）

**表示内容（入庫区分別）:**

##### 2-3-1. 車検・12ヵ月点検

**表示:**
- 承認された作業項目リスト
- 作業記録
- 作業完了ボタン
- **分解整備記録簿PDF生成機能**（作業完了時）

**課題（要確認）:**
- [ ] **【重要】エンジンオイル交換なのに、分解整備記録簿が表示されていないか（ユーザー指摘の不整合）**
- [ ] 作業記録の入力が簡単か
- [ ] 分解整備記録簿PDF生成が適切に動作するか

##### 2-3-2. エンジンオイル交換

**表示:**
- 承認された作業項目リスト
- 作業記録
- 作業完了ボタン

**課題（要確認）:**
- [ ] 作業記録の入力が簡単か
- [ ] 作業完了ボタンが分かりやすいか

##### 2-3-3. 故障診断

**表示:**
- 承認された作業項目リスト
- 作業記録
- 作業完了ボタン

**課題（要確認）:**
- [ ] 作業記録の入力が簡単か

##### 2-3-4. その他の入庫区分

**表示:**
- 各入庫区分専用の作業ビュー

**課題（要確認）:**
- [ ] 各入庫区分に適切な作業ビューが表示されているか

**共通課題（作業画面）:**
- [ ] 作業項目の完了チェックが簡単か
- [ ] Before/After写真の撮影が簡単か
- [ ] 作業完了ボタンが分かりやすいか

---

### 3. 顧客のフロー

#### 3-1. 見積承認画面（`/customer/approval/[id]`）

**対象:** すべての入庫区分（見積送付後）

**表示内容:**
- 顧客情報・車両情報
- 見積項目（松竹梅方式）
  - 必須整備（選択不可）
  - 推奨整備（選択可能、デフォルトON）
  - 任意整備（選択可能、デフォルトOFF）
- 合計金額（リアルタイム計算）
- 承認ボタン（スティッキーフッター）

**課題（要確認）:**
- [ ] スマホでの見積項目の選択がしやすいか
- [ ] 写真の拡大表示（Lightbox）が適切に動作するか
- [ ] 合計金額の表示が分かりやすいか
- [ ] 承認ボタンが常に表示されているか（スティッキーフッター）
- [ ] 文字がはみ出していないか

---

#### 3-2. 作業完了報告画面（`/customer/report/[id]`）

**対象:** すべての入庫区分（作業完了後）

**表示内容:**
- 顧客情報・車両情報
- 作業進捗（`CustomerProgressView`）
  - 進捗バー
  - ステップリスト（入庫、診断、見積もり、承認、作業、引渡）
- Before/Afterギャラリー
- 実施内容・請求情報
- 請求書PDF表示ボタン
- 作業動画
- 整備士コメント
- ブログ用写真選択

**課題（要確認）:**
- [ ] **【重要】「STEP2」に「分解整備記録簿（電子版）」と表示される問題（エンジンオイル交換の場合）**
- [ ] Before/After写真の表示が分かりやすいか
- [ ] 請求書PDFの表示が簡単か
- [ ] 作業進捗の表示が分かりやすいか
- [ ] スマホでの表示が適切か

---

#### 3-3. プレゼン画面（`/presentation/[id]`）

**対象:** すべての入庫区分（出庫時）

**表示内容:**
- 顧客情報・車両情報
- タブ（Before/After、作業内容、請求書）
- Before/Afterギャラリー
- 作業内容サマリー
- 請求書PDF表示

**課題（要確認）:**
- [ ] タブの切り替えが簡単か
- [ ] Before/After写真の表示が分かりやすいか
- [ ] 請求書PDFの表示が簡単か

---

## 発見された課題（リストアップ）

### UI的な課題

#### 1. スマホ表示の問題

**課題:**
- [ ] 診断画面のカテゴリタブ（6タブ）がスマホで収まるか
  - `InspectionCategoryTabs`コンポーネントで`grid-cols-3 lg:grid-cols-6`を使用
  - スマホでは3列表示になるが、6タブを3列で表示すると2行になる
  - タブのテキストが「エンジン・ルーム点検」「室内点検」など長いため、はみ出す可能性がある
- [ ] 見積画面の項目リストが長い場合、スクロールが大変ではないか
- [ ] スティッキーフッターが適切に表示されているか
  - 診断画面、見積画面、顧客承認画面で固定フッターを使用
- [ ] 文字がはみ出していないか（特に長い項目名、顧客名、車両名）
  - Badgeコンポーネントで`whitespace-nowrap`を使用しているが、親要素の幅制限がない場合、はみ出す可能性がある

**確認が必要な画面:**
- 診断画面（`/mechanic/diagnosis/[id]`）
- 見積画面（`/admin/estimate/[id]`）
- 顧客承認画面（`/customer/approval/[id]`）
- 顧客レポート画面（`/customer/report/[id]`）

---

#### 2. コンポーネントの問題

**課題:**
- [ ] Badgeコンポーネントが`rounded-full`で統一されているか
  - コード確認済み：`rounded-full`を使用
- [ ] ボタンのサイズが適切か（スマホでタップしやすいか）
  - 診断画面の完了ボタン：`h-12`（48px）→ 適切
  - 作業画面の撮影ボタン：`h-12`（48px）→ 適切
- [ ] 入力フィールドが適切なサイズか
- [ ] ダイアログがスマホで適切に表示されるか
  - `Dialog`コンポーネントを使用、レスポンシブ対応が必要

---

### UX的な課題

#### 1. ナビゲーション

**課題:**
- [ ] 各画面間の遷移がスムーズか
  - トップページ → 診断画面：ジョブカードの「診断開始」ボタン
  - 診断画面 → 見積画面：自動遷移なし（トップページに戻る）
  - 見積画面 → 顧客承認画面：LINE通知経由
- [ ] 戻るボタンが適切に配置されているか
  - `CompactJobHeader`コンポーネントで戻るボタンを表示
- [ ] 現在の位置が分かりやすいか
  - ヘッダーにページタイトルを表示

---

#### 2. 情報の階層

**課題:**
- [ ] 重要な情報が適切に強調されているか
  - ステータスバッジで色分け
  - アラート表示（作業指示、変更申請）
- [ ] 情報の優先順位が適切か
- [ ] 画面が情報過多ではないか
  - 診断画面：外観撮影、診断チェックリスト、完了ボタン
  - 見積画面：診断結果、見積項目、部品リスト、送信ボタン

---

#### 3. エラーハンドリング

**課題:**
- [ ] エラーメッセージが分かりやすいか
  - `toast.error`を使用
- [ ] エラー時のリカバリー方法が明確か
  - リトライボタンがない場合がある

---

### 業務的に抜けている部分

#### 1. 事前チェックイン機能

**課題:**
- [ ] 事前チェックインページが未実装
  - `src/app/customer/pre-checkin/[id]/page.tsx`が存在しない
- [ ] 顧客が事前に入力できる機能がない
- [ ] メール送信機能が未実装

---

#### 2. 部品管理

**課題:**
- [ ] 部品の発注先、到着状況、在庫場所の管理機能が未実装
  - `PartItem`インターフェースに`vendor`、`arrivalStatus`、`storageLocation`が定義されていない
- [ ] 全部品到着時の自動通知機能が未実装

---

#### 3. 診断料金管理

**課題:**
- [ ] 診断料金の管理機能が未実装
  - `diagnosisFee`フィールドは定義されているが、UIが未実装
- [ ] 診断料金の自動割引機能が未実装

---

#### 4. ジョブメモ機能

**課題:**
- [ ] ジョブメモ機能が未実装
  - `jobMemos`フィールドは定義されているが、UIが未実装
- [ ] 時間軸でのメモ管理ができない

---

#### 5. 車検チェックリスト

**課題:**
- [ ] 車検入庫時チェックリストが未実装
  - `InspectionChecklist`インターフェースが定義されていない
- [ ] 車検出庫時チェックリストが未実装

---

#### 6. 作業指示書PDF出力

**課題:**
- [ ] 作業指示書PDF出力機能が未実装
  - `src/lib/work-order-pdf-generator.ts`が存在しない

---

### システム連携の問題

#### 1. Zoho CRM連携

**課題:**
- [ ] 2回予約フローの自動紐付けワークフローが未設定
  - 外部作業（Zoho CRM側の設定）
- [ ] カスタムフィールド（`ID_BookingId_2`、`field26`、`field23`）が未追加
  - 外部作業（Zoho CRM側の設定）

---

#### 2. LINE通知

**課題:**
- [ ] 全部品到着通知が未実装
  - 部品管理機能と統合して実装が必要
- [ ] 通知履歴の管理が適切か
  - `src/app/api/line/history/route.ts`が存在

---

#### 3. Google Drive連携

**課題:**
- [ ] 写真の自動圧縮が適切に動作しているか
  - `src/lib/compress.ts`で実装済み
- [ ] フォルダ構造が適切か
  - `src/lib/google-drive.ts`で実装済み
- [ ] ファイル名の命名規則が守られているか
  - 命名規則が実装されているか確認が必要

---

### システムの不整合

#### 1. 入庫区分と表示内容の不一致

**課題:**
- [ ] **【重要・要確認】エンジンオイル交換なのに、診断画面に車検用の項目が表示される可能性**
  - 診断画面のコード確認済み：`isEngineOilChange`の場合、`EngineOilInspectionView`を表示
  - ただし、`isInspection`の判定が`serviceKinds.includes("車検") || serviceKinds.includes("12ヵ月点検")`となっており、エンジンオイル交換の場合は`false`になるはず
  - **問題の可能性：** 入庫区分の判定ロジックが正しく動作していない、または複数の入庫区分が設定されている場合に不整合が発生
- [ ] **【重要・要確認】エンジンオイル交換なのに、顧客レポート画面の「STEP2（診断）」に「分解整備記録簿（電子版）」と表示される**
  - `customer-progress-view.tsx`を確認：STEP2は「診断」で、説明は「車両の診断を実施中です」
  - 「分解整備記録簿（電子版）」という文字列は見つからない
  - **問題の可能性：** 別の場所で表示されている、または動的に生成されている
- [ ] **【重要・要確認】エンジンオイル交換なのに、作業画面で分解整備記録簿PDF生成が実行される**
  - 作業画面のコード確認済み：`isInspection`の場合のみ分解整備記録簿PDF生成を実行
  - エンジンオイル交換の場合は`isInspection`が`false`になるはず
  - **問題の可能性：** 入庫区分の判定ロジックが正しく動作していない
- [ ] 入庫区分の判定ロジックが正しいか
  - `serviceKinds = job.field_service_kinds || (job.serviceKind ? [job.serviceKind] : [])`
  - 複数の入庫区分が設定されている場合、最初の入庫区分のみを使用している可能性がある
- [ ] 各入庫区分に適切なビューが表示されているか
  - 診断画面：入庫区分別に適切なビューを表示（コード確認済み）
  - 作業画面：入庫区分別に適切な処理を実行（コード確認済み）

**確認が必要な箇所:**
- `src/app/mechanic/diagnosis/[id]/page.tsx` - 診断画面の表示ロジック（行567-611）
- `src/app/mechanic/work/[id]/page.tsx` - 作業画面の表示ロジック（行485-498, 619-716）
- `src/app/customer/report/[id]/page.tsx` - 顧客レポート画面の表示ロジック
- `src/components/features/customer-progress-view.tsx` - 進捗表示ロジック（行84-123）
- `src/types/index.ts` - 入庫区分の型定義（行28-39）

**推測される原因:**
1. 入庫区分の判定ロジックが正しく動作していない
2. 複数の入庫区分が設定されている場合、最初の入庫区分のみを使用している
3. データの不整合（Zoho CRM側のデータが正しく設定されていない）

---

#### 2. ステータス管理

**課題:**
- [ ] ステータスの遷移が適切か
- [ ] ステータスと表示内容が一致しているか

---

#### 3. データ整合性

**課題:**
- [ ] ワークオーダーとジョブのデータが一致しているか
- [ ] 複数作業管理が適切に動作しているか

---

## 詳細な課題リスト

### UI的な課題（詳細）

#### 1. スマホ表示の問題

##### 1-1. 診断画面のカテゴリタブ

**問題箇所:** `src/components/features/inspection-category-tabs.tsx`

**課題:**
- スマホでは`grid-cols-3`で3列表示、6タブが2行になる
- タブのテキストが長い（「エンジン・ルーム点検」「室内点検」など）
- `text-xs sm:text-sm`でフォントサイズを調整しているが、タブの幅が狭い場合、文字がはみ出す可能性がある
- タブ内にアイコン、チェックマーク、バッジが表示されるため、さらにスペースが不足する可能性がある

**推奨対応:**
- タブのテキストを短縮（「エンジン・ルーム」→「エンジン」など）
- または、スクロール可能なタブにする
- または、ドロップダウンメニューにする

---

##### 1-2. ジョブカードの文字はみ出し

**問題箇所:** `src/components/features/job-card.tsx`

**課題:**
- 顧客名、車両名が長い場合、はみ出す可能性がある
- `whitespace-nowrap`を使用しているが、親要素の幅制限がない場合、はみ出す
- 入庫区分名が長い場合（「タイヤ交換・ローテーション」など）、はみ出す可能性がある

**推奨対応:**
- `truncate`クラスを追加
- または、`min-w-0`を親要素に追加して、flexboxの幅制限を有効化

---

##### 1-3. 見積画面の項目リスト

**問題箇所:** `src/app/admin/estimate/[id]/page.tsx`

**課題:**
- 見積項目が多くなると、スクロールが大変
- 項目名が長い場合、はみ出す可能性がある
- 金額の表示が適切か

**推奨対応:**
- 項目名の`truncate`対応
- スクロール位置の最適化

---

##### 1-4. 顧客承認画面のスティッキーフッター

**問題箇所:** `src/app/customer/approval/[id]/page.tsx`

**課題:**
- 固定フッターが適切に表示されているか
- スマホでのタップしやすさ

**確認済み:**
- `fixed bottom-0`で固定フッターを実装
- ボタンサイズ：`h-14`（56px）→ 適切

---

#### 2. コンポーネントの問題

##### 2-1. Badgeコンポーネント

**確認済み:**
- `rounded-full`で統一されている
- `whitespace-nowrap`で文字のはみ出しを防止

---

##### 2-2. ボタンのサイズ

**確認済み:**
- 診断画面の完了ボタン：`h-12`（48px）→ 適切
- 作業画面の撮影ボタン：`h-12`（48px）→ 適切
- 顧客承認画面の承認ボタン：`h-14`（56px）→ 適切

---

##### 2-3. ダイアログ

**課題:**
- スマホでの表示が適切か
- スクロール可能か

**確認が必要:**
- `Dialog`コンポーネントの実装を確認

---

### UX的な課題（詳細）

#### 1. ナビゲーション

##### 1-1. 画面遷移

**課題:**
- 診断完了後、トップページに戻るが、見積画面に直接遷移できない
- 見積画面への遷移が分かりにくい

**推奨対応:**
- 診断完了後、見積画面へのリンクを表示
- または、自動で見積画面に遷移

---

##### 1-2. 戻るボタン

**確認済み:**
- `CompactJobHeader`コンポーネントで戻るボタンを表示
- 適切に配置されている

---

#### 2. 情報の階層

##### 2-1. 診断画面

**課題:**
- 外観撮影、診断チェックリスト、完了ボタンが縦に並んでいる
- スクロールが多くなる可能性がある

**推奨対応:**
- 重要な情報を上部に配置
- 完了ボタンを固定フッターに配置（実装済み）

---

##### 2-2. 見積画面

**課題:**
- 診断結果、見積項目、部品リスト、送信ボタンが縦に並んでいる
- 情報が多すぎて、見つけにくい可能性がある

**推奨対応:**
- タブで情報を分類
- または、折りたたみ可能にする

---

### 業務的に抜けている部分（詳細）

#### 1. 事前チェックイン機能

**現状:**
- `src/app/customer/pre-checkin/[id]/page.tsx`が存在しない
- メール送信機能が未実装
- マジックリンク生成機能が未実装（事前チェックイン用）

**影響:**
- 顧客が事前に入力できない
- 受付時の作業が増える

---

#### 2. 部品管理

**現状:**
- `PartItem`インターフェースに`vendor`、`arrivalStatus`、`storageLocation`が定義されていない
- 部品の発注先、到着状況、在庫場所の管理機能が未実装
- 全部品到着時の自動通知機能が未実装

**影響:**
- 部品の到着状況が分からない
- 全部品到着時の連絡が手動になる

---

#### 3. 診断料金管理

**現状:**
- `diagnosisFee`フィールドは定義されているが、UIが未実装
- 診断料金の選択肢（無料、¥3,000、¥5,000、¥10,000、その他）が未実装
- 診断料金の自動割引機能が未実装

**影響:**
- 診断料金の管理ができない
- 見積もりに診断料金が含まれない

---

#### 4. ジョブメモ機能

**現状:**
- `jobMemos`フィールドは定義されているが、UIが未実装
- メモの追加・編集・削除機能が未実装

**影響:**
- ジョブに関するメモが残せない
- 情報の共有が困難

---

#### 5. 車検チェックリスト

**現状:**
- `InspectionChecklist`インターフェースが定義されていない
- 車検入庫時チェックリストが未実装
- 車検出庫時チェックリストが未実装

**影響:**
- 車検時のチェックリストが手動になる
- ミスが発生する可能性がある

---

#### 6. 作業指示書PDF出力

**現状:**
- `src/lib/work-order-pdf-generator.ts`が存在しない
- 作業指示書PDF出力機能が未実装

**影響:**
- アナログ整備士が作業指示書を印刷できない
- 紙とデジタルの併用ができない

---

### システム連携の問題（詳細）

#### 1. Zoho CRM連携

**現状:**
- 2回予約フローの自動紐付けワークフローが未設定（外部作業）
- カスタムフィールド（`ID_BookingId_2`、`field26`、`field23`）が未追加（外部作業）

**影響:**
- 2回目の予約が自動で紐付けられない
- 手動で紐付ける必要がある

---

#### 2. LINE通知

**現状:**
- 全部品到着通知が未実装
- 通知履歴の管理機能は存在（`src/app/api/line/history/route.ts`）

**影響:**
- 全部品到着時の連絡が手動になる

---

#### 3. Google Drive連携

**確認済み:**
- 写真の自動圧縮機能が実装済み（`src/lib/compress.ts`）
- フォルダ構造が実装済み（`src/lib/google-drive.ts`）

**課題:**
- ファイル名の命名規則が守られているか確認が必要

---

### システムの不整合（詳細）

#### 1. 入庫区分と表示内容の不一致

##### 1-1. エンジンオイル交換なのに車検用の項目が表示される

**問題箇所:** 
- `src/app/mechanic/diagnosis/[id]/page.tsx`（行567-611）
- `src/app/mechanic/work/[id]/page.tsx`（行485-498, 619-716）

**現状のコード:**
```typescript
// 診断画面
const isInspection = serviceKinds.includes("車検" as ServiceKind) || serviceKinds.includes("12ヵ月点検" as ServiceKind);
const isEngineOilChange = serviceKinds.includes("エンジンオイル交換" as ServiceKind);

// 表示ロジック
{isInspection ? (
  <InspectionDiagnosisView ... />
) : isEngineOilChange ? (
  <EngineOilInspectionView ... />
) : ...}
```

**問題の可能性:**
1. `serviceKinds`に複数の入庫区分が含まれている場合、`isInspection`が`true`になる可能性がある
2. データの不整合（Zoho CRM側で「車検」と「エンジンオイル交換」の両方が設定されている）
3. 判定ロジックの順序の問題（`isInspection`を先に判定しているため、エンジンオイル交換でも車検が優先される可能性）

**推奨対応:**
- 入庫区分の判定ロジックを確認
- 複数の入庫区分が設定されている場合の処理を明確化
- データの整合性チェックを追加

---

##### 1-2. エンジンオイル交換なのに分解整備記録簿PDF生成が実行される

**問題箇所:** `src/app/mechanic/work/[id]/page.tsx`（行619-716）

**現状のコード:**
```typescript
if (isInspection) {
  // 車検・12ヵ月点検の場合：分解整備記録簿PDFを生成
  ...
}
```

**問題の可能性:**
- `isInspection`の判定が正しく動作していない
- エンジンオイル交換なのに`isInspection`が`true`になっている

**推奨対応:**
- `isInspection`の判定ロジックを確認
- デバッグログを追加して、実際の値を確認

---

##### 1-3. 顧客レポート画面の「STEP2」に「分解整備記録簿（電子版）」と表示される

**問題箇所:** 
- `src/components/features/customer-progress-view.tsx`（行84-123）
- `src/app/customer/report/[id]/page.tsx`（行600-604）

**現状のコード:**
```typescript
// customer-progress-view.tsx
const steps: ProgressStep[] = [
  { id: "reception", name: "入庫", ... },
  { id: "diagnosis", name: "診断", description: "車両の診断を実施中です", ... },
  ...
];
```

**問題の可能性:**
- 「分解整備記録簿（電子版）」という文字列は見つからない
- 別の場所で表示されている可能性がある
- または、動的に生成されている可能性がある

**推奨対応:**
- 顧客レポート画面の全体を確認
- 「分解整備記録簿（電子版）」という文字列を検索
- 実際の画面を確認

---

##### 1-4. 入庫区分の判定ロジック

**問題箇所:** 各画面で入庫区分を判定している箇所

**現状のコード:**
```typescript
const serviceKinds = job.field_service_kinds || (job.serviceKind ? [job.serviceKind] : []);
const isInspection = serviceKinds.includes("車検" as ServiceKind) || serviceKinds.includes("12ヵ月点検" as ServiceKind);
const isEngineOilChange = serviceKinds.includes("エンジンオイル交換" as ServiceKind);
```

**問題の可能性:**
1. 複数の入庫区分が設定されている場合、最初の入庫区分のみを使用している
2. `field_service_kinds`と`serviceKind`の両方が設定されている場合、どちらを優先するか不明確
3. データの不整合（Zoho CRM側のデータが正しく設定されていない）

**推奨対応:**
- 入庫区分の判定ロジックを統一
- 複数の入庫区分が設定されている場合の処理を明確化
- データの整合性チェックを追加

---

## 各画面の詳細レビュー

### 1. トップページ（`/`）

#### 1-1. 表示内容

**確認済み:**
- 本日の入庫予定リスト
- ステータス別フィルター
- 入庫区分別フィルター
- 検索バー
- サマリーカード（今日のサマリー、入庫区分別サマリー、長期プロジェクトサマリー）

#### 1-2. UI的な課題

**課題:**
- [ ] ジョブカードが多くなると、スクロールが大変
- [ ] フィルターの切り替えが分かりやすいか
- [ ] 検索バーの使いやすさ

#### 1-3. UX的な課題

**課題:**
- [ ] 重要なジョブが目立つか
- [ ] アクション（受付開始、診断開始など）が分かりやすいか

---

### 2. 診断画面（`/mechanic/diagnosis/[id]`）

#### 2-1. 表示内容（入庫区分別）

**確認済み:**
- 外観撮影（前・後・左・右）- すべての入庫区分で共通
- 入庫区分別の診断ビュー
- 診断完了ボタン（固定フッター）

#### 2-2. UI的な課題

**課題:**
- [ ] **【重要】カテゴリタブ（車検の場合）がスマホで収まるか**
  - `InspectionCategoryTabs`：`grid-cols-3 lg:grid-cols-6`
  - スマホでは3列表示、6タブが2行になる
  - タブのテキストが長い（「エンジン・ルーム点検」など）
  - タブ内にアイコン、チェックマーク、バッジが表示される
  - **推奨対応:** タブのテキストを短縮、またはスクロール可能にする
- [ ] 外観撮影の4つのボタンがスマホで使いやすいか
- [ ] 診断チェックリストが長い場合、スクロールが大変ではないか
- [ ] 診断完了ボタンが固定フッターで常に表示されているか（確認済み：実装済み）

#### 2-3. UX的な課題

**課題:**
- [ ] 診断項目の優先順位が分かりやすいか
- [ ] 証拠写真の撮影が簡単か
- [ ] コメント入力が簡単か（音声入力の利用可能性）

#### 2-4. システムの不整合

**課題:**
- [ ] **【重要・要確認】エンジンオイル交換なのに、車検用の項目（`InspectionDiagnosisView`）が表示される可能性**
  - コード確認済み：`isEngineOilChange`の場合、`EngineOilInspectionView`を表示
  - ただし、`isInspection`の判定が先に行われているため、複数の入庫区分が設定されている場合、車検が優先される可能性がある
  - **推奨対応:** 入庫区分の判定ロジックを確認、複数の入庫区分が設定されている場合の処理を明確化

---

### 3. 見積画面（`/admin/estimate/[id]`）

#### 3-1. 表示内容（入庫区分別）

**確認済み:**
- 診断結果（写真、検査項目）
- 見積項目（松竹梅方式）
- 部品リスト
- 顧客への送信ボタン

#### 3-2. UI的な課題

**課題:**
- [ ] 見積項目の追加・編集がしやすいか
- [ ] 部品リストの入力が簡単か
- [ ] 診断結果の写真が適切に表示されているか
- [ ] 送信ボタンが分かりやすいか

#### 3-3. UX的な課題

**課題:**
- [ ] 見積項目の優先順位（松竹梅）が分かりやすいか
- [ ] 診断結果から見積項目への自動追加が適切か
- [ ] 部品リストの入力が簡単か

#### 3-4. 業務的に抜けている部分

**課題:**
- [ ] 部品の発注先、到着状況、在庫場所の管理機能が未実装
- [ ] 全部品到着時の自動通知機能が未実装
- [ ] 診断料金の管理機能が未実装

---

### 4. 作業画面（`/mechanic/work/[id]`）

#### 4-1. 表示内容（入庫区分別）

**確認済み:**
- 承認された作業項目リスト
- 作業記録
- 作業完了ボタン

#### 4-2. UI的な課題

**課題:**
- [ ] 作業項目の完了チェックが簡単か
- [ ] Before/After写真の撮影が簡単か
- [ ] 作業完了ボタンが分かりやすいか

#### 4-3. UX的な課題

**課題:**
- [ ] 作業項目の優先順位が分かりやすいか
- [ ] 作業記録の入力が簡単か

#### 4-4. システムの不整合

**課題:**
- [ ] **【重要・要確認】エンジンオイル交換なのに、分解整備記録簿PDF生成が実行される可能性**
  - コード確認済み：`isInspection`の場合のみ分解整備記録簿PDF生成を実行
  - エンジンオイル交換の場合は`isInspection`が`false`になるはず
  - **推奨対応:** `isInspection`の判定ロジックを確認、デバッグログを追加

---

### 5. 顧客承認画面（`/customer/approval/[id]`）

#### 5-1. 表示内容

**確認済み:**
- 顧客情報・車両情報
- 見積項目（松竹梅方式）
  - 必須整備（選択不可）
  - 推奨整備（選択可能、デフォルトON）
  - 任意整備（選択可能、デフォルトOFF）
- 合計金額（リアルタイム計算）
- 承認ボタン（スティッキーフッター）

#### 5-2. UI的な課題

**課題:**
- [ ] スマホでの見積項目の選択がしやすいか
- [ ] 写真の拡大表示（Lightbox）が適切に動作するか
- [ ] 合計金額の表示が分かりやすいか
- [ ] 承認ボタンが常に表示されているか（確認済み：スティッキーフッターで実装済み）
- [ ] 文字がはみ出していないか（特に長い項目名）

#### 5-3. UX的な課題

**課題:**
- [ ] 見積項目の説明が分かりやすいか
- [ ] 証拠写真が適切に表示されているか
- [ ] 承認プロセスが分かりやすいか

---

### 6. 顧客レポート画面（`/customer/report/[id]`）

#### 6-1. 表示内容

**確認済み:**
- 顧客情報・車両情報
- 作業進捗（`CustomerProgressView`）
  - 進捗バー
  - ステップリスト（入庫、診断、見積もり、承認、作業、引渡）
- Before/Afterギャラリー
- 実施内容・請求情報
- 請求書PDF表示ボタン
- 作業動画
- 整備士コメント
- ブログ用写真選択

#### 6-2. UI的な課題

**課題:**
- [ ] **【重要・要確認】「STEP2（診断）」に「分解整備記録簿（電子版）」と表示される問題**
  - `customer-progress-view.tsx`を確認：STEP2は「診断」で、説明は「車両の診断を実施中です」
  - 「分解整備記録簿（電子版）」という文字列は見つからない
  - **推奨対応:** 実際の画面を確認、別の場所で表示されている可能性がある
- [ ] Before/After写真の表示が分かりやすいか
- [ ] 請求書PDFの表示が簡単か
- [ ] 作業進捗の表示が分かりやすいか
- [ ] スマホでの表示が適切か

#### 6-3. UX的な課題

**課題:**
- [ ] 作業内容が分かりやすいか
- [ ] 整備士コメントが適切に表示されているか
- [ ] ブログ用写真選択が分かりやすいか

---

### 7. プレゼン画面（`/presentation/[id]`）

#### 7-1. 表示内容

**確認済み:**
- 顧客情報・車両情報
- タブ（Before/After、作業内容、請求書）
- Before/Afterギャラリー
- 作業内容サマリー
- 請求書PDF表示

#### 7-2. UI的な課題

**課題:**
- [ ] タブの切り替えが簡単か
- [ ] Before/After写真の表示が分かりやすいか
- [ ] 請求書PDFの表示が簡単か

#### 7-3. UX的な課題

**課題:**
- [ ] 作業内容の説明が分かりやすいか
- [ ] 顧客への説明がしやすいか

---

## 次のステップ

1. **各画面の詳細レビュー**
   - 各画面のコードを確認
   - UIコンポーネントの実装を確認
   - スマホ表示を確認

2. **不整合の特定**
   - 入庫区分判定ロジックの確認
   - 表示条件の確認
   - データフローの確認

3. **課題の優先順位付け**
   - 緊急度の高い課題を特定
   - 影響範囲の大きい課題を特定

---

## 優先度別の課題リスト

### 🔴 緊急度：高（システムの不整合・動作不良）

#### 1. 入庫区分と表示内容の不一致

**課題:**
- [ ] **【最重要】エンジンオイル交換なのに、診断画面に車検用の項目（`InspectionDiagnosisView`）が表示される**
  - **影響:** メカニックが誤った診断項目を入力する可能性がある
  - **原因の可能性:** 入庫区分の判定ロジックが正しく動作していない、または複数の入庫区分が設定されている場合の処理が不適切
  - **確認箇所:** `src/app/mechanic/diagnosis/[id]/page.tsx`（行567-611）
  - **推奨対応:** 入庫区分の判定ロジックを確認、複数の入庫区分が設定されている場合の処理を明確化

- [ ] **【最重要】エンジンオイル交換なのに、作業画面で分解整備記録簿PDF生成が実行される**
  - **影響:** 不要なPDFが生成される、またはエラーが発生する可能性がある
  - **原因の可能性:** `isInspection`の判定が正しく動作していない
  - **確認箇所:** `src/app/mechanic/work/[id]/page.tsx`（行485-498, 619-716）
  - **推奨対応:** `isInspection`の判定ロジックを確認、デバッグログを追加

- [ ] **【最重要】エンジンオイル交換なのに、顧客レポート画面の「STEP2（診断）」に「分解整備記録簿（電子版）」と表示される**
  - **影響:** 顧客に誤った情報が表示される
  - **原因の可能性:** 別の場所で表示されている、または動的に生成されている
  - **確認箇所:** `src/app/customer/report/[id]/page.tsx`、`src/components/features/customer-progress-view.tsx`
  - **推奨対応:** 実際の画面を確認、「分解整備記録簿（電子版）」という文字列を検索

- [ ] **【重要】入庫区分の判定ロジックが正しく動作していない**
  - **影響:** 各画面で適切なビューが表示されない
  - **原因の可能性:** 複数の入庫区分が設定されている場合、最初の入庫区分のみを使用している、または判定の順序が不適切
  - **確認箇所:** 各画面の入庫区分判定ロジック
  - **推奨対応:** 入庫区分の判定ロジックを統一、複数の入庫区分が設定されている場合の処理を明確化

---

### 🟡 緊急度：中（UX的な課題・業務効率）

#### 2. UI的な課題

**課題:**
- [ ] **診断画面のカテゴリタブ（車検の場合）がスマホで収まらない可能性**
  - **影響:** タブがはみ出して使いにくくなる
  - **確認箇所:** `src/components/features/inspection-category-tabs.tsx`
  - **推奨対応:** タブのテキストを短縮、またはスクロール可能にする

- [ ] **ジョブカードの文字がはみ出す可能性**
  - **影響:** 顧客名、車両名、入庫区分名が長い場合、はみ出す
  - **確認箇所:** `src/components/features/job-card.tsx`
  - **推奨対応:** `truncate`クラスを追加、または`min-w-0`を親要素に追加

- [ ] **見積画面の項目リストが長い場合、スクロールが大変**
  - **影響:** 見積項目が多い場合、操作が困難になる
  - **確認箇所:** `src/app/admin/estimate/[id]/page.tsx`
  - **推奨対応:** スクロール位置の最適化、または折りたたみ機能の追加

---

#### 3. UX的な課題

**課題:**
- [ ] **診断完了後、見積画面への遷移が分かりにくい**
  - **影響:** メカニックが次の作業に移りにくい
  - **推奨対応:** 診断完了後、見積画面へのリンクを表示、または自動で見積画面に遷移

- [ ] **見積画面の情報が多すぎて、見つけにくい**
  - **影響:** 必要な情報を見つけるのに時間がかかる
  - **推奨対応:** タブで情報を分類、または折りたたみ可能にする

---

### 🟢 緊急度：低（機能追加・改善）

#### 4. 業務的に抜けている部分

**課題:**
- [ ] 事前チェックイン機能が未実装
- [ ] 部品管理機能が未実装
- [ ] 診断料金管理機能が未実装
- [ ] ジョブメモ機能が未実装
- [ ] 車検チェックリスト機能が未実装
- [ ] 作業指示書PDF出力機能が未実装

---

#### 5. システム連携の問題

**課題:**
- [ ] 2回予約フローの自動紐付けワークフローが未設定（外部作業）
- [ ] 全部品到着通知が未実装

---

## 確認が必要な箇所（詳細）

### 1. 入庫区分の判定ロジック

**確認箇所:**
- `src/app/mechanic/diagnosis/[id]/page.tsx`（行567-611）
- `src/app/mechanic/work/[id]/page.tsx`（行485-498）
- `src/app/admin/estimate/[id]/page.tsx`（行540-642）

**確認内容:**
- `serviceKinds`の取得方法が正しいか
- 複数の入庫区分が設定されている場合の処理が適切か
- 判定の順序が適切か（`isInspection`を先に判定しているため、エンジンオイル交換でも車検が優先される可能性）

---

### 2. 「分解整備記録簿（電子版）」の表示箇所

**確認箇所:**
- `src/app/customer/report/[id]/page.tsx`（全体）
- `src/components/features/customer-progress-view.tsx`（全体）
- その他の顧客向け画面

**確認内容:**
- 「分解整備記録簿（電子版）」という文字列がどこで表示されているか
- 表示条件が適切か（車検・12ヵ月点検の場合のみ表示すべき）

---

### 3. スマホ表示の確認

**確認箇所:**
- すべての画面

**確認内容:**
- コンポーネントがはみ出していないか
- 文字がはみ出していないか
- ボタンがタップしやすいか
- スクロールが適切に動作しているか

---

## 参照

- `SPECIFICATION.md` - システム仕様書
- `src/app/mechanic/diagnosis/[id]/page.tsx` - 診断画面
- `src/app/admin/estimate/[id]/page.tsx` - 見積画面
- `src/app/mechanic/work/[id]/page.tsx` - 作業画面
- `src/app/customer/approval/[id]/page.tsx` - 顧客承認画面
- `src/app/customer/report/[id]/page.tsx` - 顧客レポート画面
- `src/components/features/customer-progress-view.tsx` - 進捗表示コンポーネント
- `src/components/features/inspection-category-tabs.tsx` - カテゴリタブコンポーネント
- `src/components/features/job-card.tsx` - ジョブカードコンポーネント
- `src/types/index.ts` - 型定義（入庫区分の定義）







