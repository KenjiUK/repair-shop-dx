# Google Apps Script (GAS) 実装ガイド

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: マスタデータ同期用GASスクリプトの実装
- **目的**: 基幹システム（スマートカーディーラー）から出力されたCSV/ExcelファイルをGoogle Sheetsに自動変換

---

## 1. 概要

### 1-1. 役割

GAS（Google Apps Script）は、基幹システム（スマートカーディーラー）から出力されたCSV/Excelファイルを自動的に検知し、Google Sheetsに変換する役割を担います。

### 1-2. 処理フロー

```
1. 事務員が基幹システムからCSV/Excelを出力
   ↓
2. Google Driveの所定フォルダ（/repair-shop-dx/master-data/）にアップロード
   ↓
3. GASがファイルを検知（onChangeイベントまたはTime-drivenトリガー）
   ↓
4. ファイル形式を検証（CSV/Excel、エンコーディング）
   ↓
5. CSV/Excel → Google Sheetsに変換
   ↓
6. エラー発生時はGmail通知とログ記録
```

---

## 2. セットアップ手順

### 2-1. Google Apps Scriptプロジェクトの作成

1. **Google Drive**にアクセス
2. **新規** → **その他** → **Google Apps Script**を選択
3. プロジェクト名を設定（例: `マスタデータ同期GAS`）

### 2-2. スクリプトの実装

1. `scripts/gas-master-data-sync.gs`の内容をコピー
2. Google Apps Scriptエディタに貼り付け
3. 設定値を環境に合わせて変更（後述の「設定値」参照）

### 2-3. 必要な権限の付与

1. スクリプトを初回実行すると、権限の要求が表示されます
2. 以下の権限が必要です：
   - **Google Drive**: ファイルの読み取り、検索
   - **Google Sheets**: スプレッドシートの読み書き
   - **Gmail**: メール送信（エラー通知用）

### 2-4. トリガーの設定

#### 方法1: onChangeイベント（推奨）

1. **トリガー** → **トリガーを追加**
2. **実行する関数**: `onChange`
3. **イベントのソース**: **ドライブから**
4. **イベントの種類**: **変更時**
5. **保存**

#### 方法2: Time-drivenトリガー（フォールバック）

1. **トリガー** → **トリガーを追加**
2. **実行する関数**: `checkMasterDataFolder`
3. **イベントのソース**: **時間主導型**
4. **時間ベースのトリガー**: **分ベースのタイマー**
5. **分の間隔**: **5分おき**
6. **保存**

---

## 3. 設定値

### 3-1. 必須設定

スクリプト内の以下の定数を環境に合わせて変更してください：

```javascript
// Google DriveフォルダID（/repair-shop-dx/master-data/のフォルダID）
const MASTER_DATA_FOLDER_ID = 'YOUR_FOLDER_ID_HERE';

// マスタデータスプレッドシートID
const MASTER_DATA_SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';

// シート名
const SHEET_NAMES = {
  VEHICLE: '車両マスタ',
  CUSTOMER: '顧客マスタ'
};

// エラー通知先メールアドレス
const ERROR_NOTIFICATION_EMAIL = 'admin@example.com';
```

### 3-2. フォルダIDの取得方法

1. Google Driveで対象フォルダを開く
2. URLからフォルダIDを取得
   - 例: `https://drive.google.com/drive/folders/1a2b3c4d5e6f7g8h9i0j`
   - フォルダID: `1a2b3c4d5e6f7g8h9i0j`

### 3-3. スプレッドシートIDの取得方法

1. Google Sheetsで対象スプレッドシートを開く
2. URLからスプレッドシートIDを取得
   - 例: `https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j/edit`
   - スプレッドシートID: `1a2b3c4d5e6f7g8h9i0j`

---

## 4. ファイル命名規則

### 4-1. 対応ファイル名パターン

以下のファイル名パターンに対応しています：

- `車両マスタ_*.csv` → `車両マスタ`シートに変換
- `車両マスタ_*.xlsx` → `車両マスタ`シートに変換
- `車両マスタ_*.xls` → `車両マスタ`シートに変換
- `顧客マスタ_*.csv` → `顧客マスタ`シートに変換
- `顧客マスタ_*.xlsx` → `顧客マスタ`シートに変換
- `顧客マスタ_*.xls` → `顧客マスタ`シートに変換

### 4-2. ファイル名の例

- `車両マスタ_20250115.csv`
- `車両マスタ_20250115.xlsx`
- `顧客マスタ_20250115.csv`
- `顧客マスタ_20250115.xlsx`

---

## 5. エラーハンドリング

### 5-1. Gmail通知

エラー発生時、設定されたメールアドレスに通知が送信されます。

**通知内容**:
- エラー発生日時
- ファイル名
- エラー内容
- スタックトレース（該当する場合）

### 5-2. ログ記録

エラーログは、マスタデータスプレッドシート内の`エラーログ`シートに記録されます。

**ログ項目**:
- 日時
- ファイル名
- エラー内容
- ステータス（成功/失敗）

---

## 6. トラブルシューティング

### 6-1. トリガーが動作しない

- **確認事項**:
  - トリガーが正しく設定されているか
  - スクリプトの権限が付与されているか
  - フォルダIDが正しいか

### 6-2. ファイルが検知されない

- **確認事項**:
  - ファイル名が命名規則に従っているか
  - ファイルが正しいフォルダにアップロードされているか
  - フォルダIDが正しいか

### 6-3. エンコーディングエラー

- **確認事項**:
  - CSVファイルのエンコーディング（UTF-8またはShift-JIS）
  - スクリプトのエンコーディング検出ロジックが正しく動作しているか

### 6-4. スプレッドシートへの書き込みエラー

- **確認事項**:
  - スプレッドシートIDが正しいか
  - スプレッドシートへの書き込み権限があるか
  - シート名が正しいか（`車両マスタ`、`顧客マスタ`）

---

## 7. テスト方法

### 7-1. 手動テスト

1. テスト用CSV/Excelファイルを準備
2. Google Driveの所定フォルダにアップロード
3. GASスクリプトを手動実行（`checkMasterDataFolder`関数）
4. Google Sheetsにデータが正しく反映されているか確認

### 7-2. ログ確認

1. マスタデータスプレッドシートの`エラーログ`シートを確認
2. 処理結果とエラー内容を確認

---

## 8. 関連ドキュメント

- [実装ロードマップ](./ROADMAP.md): Phase 0のGAS実装項目
- [統合仕様書](./INTEGRATED_SPECIFICATION.md): GASの役割とデータフロー
- [技術スタックとファイル構造仕様](./TECH_STACK_AND_FILE_STRUCTURE.md): Google Driveフォルダ構造

---

## 更新履歴

- 2025-01-XX: 初版作成

















