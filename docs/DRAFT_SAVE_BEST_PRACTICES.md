# 下層ページの途中保存機能 - ベストプラクティス提案

## 1. 現状の実装状況レビュー

### 1.1 各ページの保存機能実装状況

| ページ | 自動保存 | 手動保存ボタン | 保存状態表示 | オフライン対応 |
|--------|---------|--------------|------------|--------------|
| **診断ページ** (`/mechanic/diagnosis/[id]`) | ✅ `useAutoSaveWithOffline` (2秒debounce) | ✅ `SaveStatusIndicator` | ✅ | ✅ 完全実装 |
| **作業ページ** (`/mechanic/work/[id]`) | ✅ `useAutoSaveWithOffline` (2秒debounce) | ✅ `SaveStatusIndicator` | ✅ | ✅ 完全実装 |
| **見積ページ** (`/admin/estimate/[id]`) | ✅ `useAutoSaveWithOffline` (3秒debounce) | ✅ `SaveStatusIndicator` | ✅ | ✅ 完全実装 |
| **報告ページ** (`/customer/report/[id]`) | ❌ | ❌ | ❌ | ❌ |

### 1.2 実装完了状況

#### 診断ページ
- ✅ 自動保存は実装済み
- ✅ 保存状態が視覚的に表示される（`SaveStatusIndicator`使用）
- ✅ オフライン時の保存が完全実装（IndexedDB + 同期キュー）

#### 作業ページ
- ✅ 自動保存と保存状態表示が実装済み
- ✅ オフライン時の保存が完全実装（IndexedDB + 同期キュー）

#### 見積ページ
- ✅ 自動保存が実装済み（3秒debounce）
- ✅ 保存状態が視覚的に表示される（`SaveStatusIndicator`使用）
- ✅ オフライン時の保存が完全実装（IndexedDB + 同期キュー）
- ✅ 長時間作業時のデータ損失リスクを解消

#### 報告ページ
- ❌ 保存機能自体が未実装（今後の実装予定）

---

## 2. 整備士の業務特性に基づく要件

### 2.1 業務特性
1. **長時間作業**: 数時間から数日にわたる作業
2. **中断と再開**: 作業を中断して別の作業に移る
3. **スマホでの記録**: 現場でスマホを使って記録
4. **オフライン環境**: 工場内でWi-Fiが不安定、または圏外
5. **写真・動画の記録**: 大量のメディアファイルを扱う

### 2.2 UX要件
- **データ損失の防止**: 入力内容を確実に保存
- **保存状態の可視化**: 保存中/保存済み/エラーを明確に表示
- **オフライン対応**: ネットワークがなくても保存可能
- **自動保存**: 手動操作なしで定期的に保存
- **手動保存**: 明示的に保存したい場合のボタン

---

## 3. ベストプラクティス提案

### 3.1 統一された保存戦略

#### 3.1.1 ハイブリッド保存アプローチ

```
┌─────────────────────────────────────────┐
│  ユーザー入力                           │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  1. 即座にIndexedDBに保存（ローカル）    │
│     - データ損失を防止                    │
│     - オフラインでも動作                 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  2. Debounced自動保存（2秒後）           │
│     - サーバーに保存                      │
│     - オンライン時のみ                    │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  3. オフライン時は同期キューに追加       │
│     - オンライン復帰時に自動同期          │
└─────────────────────────────────────────┘
```

#### 3.1.2 保存タイミング

| タイミング | 保存先 | 説明 |
|-----------|--------|------|
| **入力直後** | IndexedDB（ローカル） | データ損失を防止 |
| **2秒後（Debounce）** | サーバー（オンライン時） | 自動保存 |
| **ページ離脱時** | IndexedDB + サーバー | 未保存データを確実に保存 |
| **手動保存ボタン** | IndexedDB + サーバー | 明示的な保存 |

### 3.2 保存状態の可視化

#### 3.2.1 保存状態インジケーター（統一UI）

```
┌─────────────────────────────────────┐
│  [保存中...]  🔄                     │  ← saving
│  [保存済み]  ✅                      │  ← saved (3秒後に消える)
│  [保存失敗]  ❌  [再試行]            │  ← error
│  [未保存の変更]  [下書き保存]        │  ← hasUnsavedChanges
└─────────────────────────────────────┘
```

#### 3.2.2 オフライン状態の表示

```
┌─────────────────────────────────────┐
│  [オフライン] ローカルに保存済み     │
│  [同期待ち: 3件]                     │
└─────────────────────────────────────┘
```

### 3.3 オフライン対応の実装

#### 3.3.1 保存フロー（オフライン対応版）

```typescript
async function saveWithOfflineSupport(
  data: T,
  saveToServer: (data: T) => Promise<void>
) {
  // 1. まずIndexedDBに保存（常に成功）
  await saveToIndexedDB(STORE_NAMES.DIAGNOSIS, {
    id: jobId,
    data,
    timestamp: new Date().toISOString(),
  });

  // 2. オンライン時はサーバーに保存
  if (navigator.onLine) {
    try {
      await saveToServer(data);
      // 成功したら同期キューから削除
      await removeFromSyncQueue(jobId);
    } catch (error) {
      // 失敗したら同期キューに追加
      await addToSyncQueue({
        type: "update",
        storeName: STORE_NAMES.DIAGNOSIS,
        dataId: jobId,
        data,
        status: "pending",
      });
    }
  } else {
    // オフライン時は同期キューに追加
    await addToSyncQueue({
      type: "update",
      storeName: STORE_NAMES.DIAGNOSIS,
      dataId: jobId,
      data,
      status: "pending",
    });
  }
}
```

#### 3.3.2 同期キュー処理

- **オンライン復帰時**: 自動的に同期キューを処理
- **バックグラウンド同期**: Service Workerで定期的に同期
- **リトライロジック**: 失敗時は指数バックオフで再試行

### 3.4 ページ別の推奨実装

#### 3.4.1 診断ページ

**現状**: 自動保存あり、保存状態表示なし、オフライン未対応

**推奨改善**:
1. ✅ `SaveStatusIndicator`を追加
2. ✅ オフライン対応を実装（IndexedDB + 同期キュー）
3. ✅ ページ離脱時の保存確認

#### 3.4.2 作業ページ

**現状**: 自動保存あり、保存状態表示あり、オフライン未対応

**推奨改善**:
1. ✅ オフライン対応を実装（IndexedDB + 同期キュー）
2. ✅ ページ離脱時の保存確認

#### 3.4.3 見積ページ

**現状**: 自動保存なし、保存状態表示なし、オフライン未対応

**推奨改善**:
1. ✅ `useAutoSave`を追加（2秒debounce）
2. ✅ `SaveStatusIndicator`を追加
3. ✅ オフライン対応を実装（IndexedDB + 同期キュー）
4. ✅ ページ離脱時の保存確認

#### 3.4.4 報告ページ

**現状**: 保存機能なし

**推奨改善**:
1. ✅ 保存機能を追加（自動保存 + 手動保存）
2. ✅ `SaveStatusIndicator`を追加
3. ✅ オフライン対応を実装

---

## 4. 実装の優先順位

### Phase 1: 緊急（データ損失防止）
1. **見積ページに自動保存を追加**
   - 長時間作業でデータ損失のリスクが高い
   - `useAutoSave`の実装が比較的簡単

2. **診断ページに保存状態表示を追加**
   - 既に自動保存は実装済み
   - `SaveStatusIndicator`の追加のみ

### Phase 2: 重要（UX向上）
3. **全ページにオフライン対応を実装**
   - IndexedDBへの保存
   - 同期キューの実装
   - オンライン復帰時の自動同期

4. **ページ離脱時の保存確認**
   - `useDirtyCheck`の活用
   - 未保存データの警告

### Phase 3: 改善（最適化）
5. **バックグラウンド同期**
   - Service Workerの実装
   - 定期的な同期処理

6. **保存履歴の管理**
   - バージョン管理
   - 復元機能

---

## 5. 技術的な実装詳細

### 5.1 拡張された自動保存フック

```typescript
interface UseAutoSaveWithOfflineOptions<T> {
  data: T;
  onSave: (data: T) => Promise<void>;
  debounceMs?: number;
  disabled?: boolean;
  // オフライン対応
  enableOffline?: boolean;
  storeName?: string; // IndexedDBのストア名
  dataId?: string; // データID
}
```

### 5.2 保存状態の統一管理

```typescript
interface SaveState {
  status: 'idle' | 'saving' | 'saved' | 'error';
  hasUnsavedChanges: boolean;
  isOffline: boolean;
  pendingSyncCount: number; // 同期待ちの件数
}
```

### 5.3 ページ離脱時の処理

```typescript
useEffect(() => {
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    if (hasUnsavedChanges) {
      // IndexedDBに同期的に保存
      saveToIndexedDBSync(data);
      e.preventDefault();
      e.returnValue = '';
    }
  };
  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [hasUnsavedChanges, data]);
```

---

## 6. UXガイドライン

### 6.1 保存状態の表示ルール

1. **保存中**: スピナーアイコン + 「保存中...」
2. **保存済み**: チェックアイコン + 「保存済み」（3秒後に消える）
3. **エラー**: 警告アイコン + 「保存失敗」+ 再試行ボタン
4. **未保存**: 「未保存の変更があります」+ 下書き保存ボタン
5. **オフライン**: 「オフライン」+ 「ローカルに保存済み」+ 同期待ち件数

### 6.2 トースト通知の使い分け

- **自動保存成功**: 表示しない（保存状態インジケーターで十分）
- **手動保存成功**: トースト通知を表示
- **保存失敗**: トースト通知 + エラー詳細
- **オフライン保存**: トースト通知（「ローカルに保存しました」）

### 6.3 ページ離脱時の警告

- **未保存データがある場合**: ブラウザの標準警告を表示
- **オフライン時**: 「オフラインです。ローカルに保存しますか？」と確認

---

## 7. パフォーマンス考慮事項

### 7.1 Debounce時間の最適化

- **診断ページ**: 2秒（現在の設定を維持）
- **作業ページ**: 2秒（現在の設定を維持）
- **見積ページ**: 3秒（項目が多いため、少し長めに）

### 7.2 IndexedDBの最適化

- **バッチ保存**: 複数の変更をまとめて保存
- **データ圧縮**: 大きなデータは圧縮して保存
- **古いデータの削除**: 一定期間経過したデータを削除

### 7.3 同期キューの最適化

- **重複チェック**: 同じデータの重複保存を防止
- **優先度設定**: 重要なデータを優先的に同期
- **バッチ同期**: 複数のデータをまとめて同期

---

## 8. テスト項目

### 8.1 機能テスト

- [ ] 自動保存が正常に動作するか
- [ ] 手動保存ボタンが正常に動作するか
- [ ] 保存状態が正しく表示されるか
- [ ] オフライン時にIndexedDBに保存されるか
- [ ] オンライン復帰時に自動同期されるか
- [ ] ページ離脱時に未保存データが警告されるか

### 8.2 エッジケース

- [ ] ネットワークが不安定な場合
- [ ] ブラウザがクラッシュした場合
- [ ] タブを閉じた場合
- [ ] 長時間放置した場合
- [ ] 大量のデータを入力した場合

---

## 9. 実装完了レポート

### 9.1 実装完了項目

1. ✅ **見積ページに自動保存を追加**（完了）
2. ✅ **診断ページに保存状態表示を追加**（完了）
3. ✅ **全ページにオフライン対応を実装**（完了）
4. ✅ **ページ離脱時の保存確認を実装**（完了）

### 9.2 実装された効果

- ✅ **データ損失の防止**: 入力内容が確実に保存される
- ✅ **UXの向上**: 保存状態が明確に表示される
- ✅ **オフライン対応**: ネットワークがなくても作業可能
- ✅ **業務効率の向上**: 中断と再開が容易になる

### 9.3 実装詳細

詳細な実装内容については、`docs/DRAFT_SAVE_IMPLEMENTATION.md`を参照してください。

### 9.4 今後の改善点

- 報告ページへの実装（未実装）
- バックグラウンド同期の最適化
- 保存履歴の管理機能

