# フィードバック機能 仕様書

**作成日:** 2025-01-XX  
**対象環境:** テスト版のみ（本番環境では無効化）  
**目的:** ユーザーが業務中に短時間で簡単にフィードバックを入力できる機能を提供

---

## 1. 概要

### 1.1 目的
- テスト版アプリの使用中に、ユーザーが簡単にフィードバックを入力できる
- どの画面でどのようなフィードバックがあったかを記録
- 業務の流れを妨げない、最小限の操作でフィードバックを送信

### 1.2 対象環境
- **テスト版のみ有効:** 環境変数 `NEXT_PUBLIC_ENABLE_FEEDBACK` が `"true"` の場合のみ表示
- **本番環境では無効化:** 本番環境ではこの機能は表示されない

---

## 2. 機能要件

### 2.1 フィードバックの種類
以下のカテゴリから選択可能：

1. **🐛 バグ報告**
   - エラーが発生した
   - 動作がおかしい
   - データが正しく表示されない

2. **💡 UI/UX改善提案**
   - 使いにくい
   - ボタンの位置が分かりにくい
   - 情報が見つけにくい

3. **✨ 機能要望**
   - この機能が欲しい
   - この機能を追加してほしい

4. **❓ 質問・不明点**
   - 使い方が分からない
   - この機能はどう使うの？

5. **👍 良い点**
   - この機能が便利
   - 使いやすい

6. **その他**
   - 上記に当てはまらないフィードバック

### 2.2 フィードバック入力方法

#### 2.2.1 フローティングボタン
- **表示位置:** 画面右下に固定表示（z-index: 1000）
- **デザイン:** 円形のボタン、アイコンは「💬」または「📝」
- **サイズ:** 56px × 56px（モバイルでも押しやすいサイズ）
- **色:** プライマリカラー（青系）で目立つが、邪魔にならない透明度

#### 2.2.2 フィードバック入力フォーム
モーダルダイアログで表示：

1. **カテゴリ選択**（必須）
   - ラジオボタンまたはアイコンボタンで選択
   - デフォルト選択なし

2. **現在の画面情報**（自動取得）
   - 画面パス（例: `/mechanic/diagnosis/123`）
   - 画面名（例: "診断画面"）
   - ジョブID（該当する場合）

3. **フィードバック内容**（必須）
   - テキストエリア（3-5行程度）
   - プレースホルダー: "具体的な内容を入力してください..."
   - 最大文字数: 500文字

4. **スクリーンショット**（オプション）
   - 現在の画面のスクリーンショットを自動取得
   - ユーザーが削除可能

5. **緊急度**（オプション）
   - 低 / 中 / 高
   - デフォルト: 中

6. **送信ボタン**
   - 「送信」ボタンでGoogle Sheetsに保存
   - 送信後は「送信しました」トーストを表示

### 2.3 自動取得情報
以下の情報を自動的に取得して記録：

- **日時:** フィードバック送信日時（ISO8601形式）
- **画面パス:** `window.location.pathname`
- **画面名:** パスから自動判定（例: `/mechanic/diagnosis/[id]` → "診断画面"）
- **ユーザー情報:** 
  - ユーザー名（localStorageから取得、なければ"未設定"）
  - ユーザーID（あれば）
- **ブラウザ情報:**
  - User Agent
  - 画面サイズ
- **ジョブ情報:** （該当する場合）
  - ジョブID
  - 顧客名
  - 車両情報

### 2.4 データ保存先

#### Google Sheets
以下の列構成で保存：

| 列名 | 説明 | 例 |
|------|------|-----|
| 日時 | 送信日時 | 2025-01-15 14:30:25 |
| カテゴリ | フィードバックの種類 | 🐛 バグ報告 |
| 画面パス | 現在の画面パス | /mechanic/diagnosis/123 |
| 画面名 | 画面名（自動判定） | 診断画面 |
| ジョブID | ジョブID（該当する場合） | job-123 |
| 顧客名 | 顧客名（該当する場合） | 山田 太郎 |
| 車両情報 | 車両情報（該当する場合） | プリウス 白 |
| フィードバック内容 | ユーザー入力内容 | ボタンが押せません |
| 緊急度 | 緊急度 | 高 |
| ユーザー名 | ユーザー名 | 鈴木 一郎 |
| ブラウザ | User Agent | Chrome 120.0.0.0 |
| 画面サイズ | 画面サイズ | 1920x1080 |
| スクリーンショットURL | スクリーンショット（あれば） | https://... |

---

## 3. 技術仕様

### 3.1 環境変数
```env
# .env.local（テスト版のみ）
NEXT_PUBLIC_ENABLE_FEEDBACK=true

# Google Sheets API設定
NEXT_PUBLIC_GOOGLE_SHEETS_FEEDBACK_ID=<スプレッドシートID>
GOOGLE_SHEETS_FEEDBACK_SHEET_NAME=フィードバック
```

### 3.2 実装ファイル構成
```
src/
├── components/
│   └── feedback/
│       ├── feedback-button.tsx          # フローティングボタン
│       ├── feedback-dialog.tsx          # フィードバック入力ダイアログ
│       └── feedback-form.tsx            # フィードバック入力フォーム
├── lib/
│   ├── feedback-utils.ts                # フィードバック関連ユーティリティ
│   └── google-sheets-feedback.ts       # Google Sheets書き込みAPI
└── app/
    └── api/
        └── feedback/
            └── route.ts                 # フィードバック送信API
```

### 3.3 画面名の自動判定
パスから画面名を自動判定するマッピング：

```typescript
const PAGE_NAME_MAP: Record<string, string> = {
  "/": "トップページ",
  "/mechanic/diagnosis/[id]": "診断画面",
  "/mechanic/work/[id]": "作業画面",
  "/admin/estimate/[id]": "見積作成画面",
  "/customer/dashboard": "顧客ダッシュボード",
  "/customer/approval/[id]": "顧客承認画面",
  "/manager/analytics": "業務分析画面",
  // ... その他
};
```

### 3.4 スクリーンショット取得
- `html2canvas` ライブラリを使用（必要に応じて追加）
- または、ブラウザの `navigator.mediaDevices.getDisplayMedia()` APIを使用
- スクリーンショットはGoogle Driveに保存し、URLをSheetsに記録

---

## 4. UI/UX設計

### 4.1 フローティングボタン
- **位置:** 右下固定（`position: fixed; bottom: 24px; right: 24px;`）
- **アニメーション:** ホバー時に少し拡大、クリック時にリップルエフェクト
- **アクセシビリティ:** `aria-label="フィードバックを送信"`

### 4.2 モーダルダイアログ
- **サイズ:** 最大幅 600px、レスポンシブ対応
- **レイアウト:** 
  - カテゴリ選択（上部）
  - フィードバック内容（中央）
  - 送信ボタン（下部）
- **バリデーション:** 
  - カテゴリ未選択時は送信不可
  - フィードバック内容が空の場合は送信不可

### 4.3 送信後の動作
- トースト通知で「フィードバックを送信しました」を表示
- ダイアログを自動的に閉じる
- フローティングボタンは引き続き表示

---

## 5. セキュリティ・プライバシー

### 5.1 データ保護
- 個人情報（顧客名、車両情報など）は最小限に
- スクリーンショットには機密情報が含まれる可能性があるため、注意喚起を表示

### 5.2 アクセス制御
- Google Sheetsへの書き込み権限は管理者のみ
- API経由で書き込み、直接アクセスは不可

---

## 6. 本番環境での無効化

### 6.1 実装方法
```typescript
// フローティングボタンの表示条件
const isFeedbackEnabled = process.env.NEXT_PUBLIC_ENABLE_FEEDBACK === "true";

// コンポーネント内
{isFeedbackEnabled && <FeedbackButton />}
```

### 6.2 ドキュメント記載
- `README.md` に「テスト版のみの機能」として記載
- `docs/DEPLOYMENT.md` に本番環境での無効化手順を記載

---

## 7. 実装優先度

### Phase 1: 基本機能（必須）
1. フローティングボタンの実装
2. フィードバック入力フォームの実装
3. Google Sheetsへの書き込み機能
4. 画面情報の自動取得

### Phase 2: 拡張機能（推奨）
1. スクリーンショット機能
2. 緊急度選択
3. フィードバック履歴の表示（オプション）

---

## 8. 運用方針

### 8.1 フィードバックの確認
- 定期的にGoogle Sheetsを確認
- カテゴリ別、緊急度別に整理
- 対応状況を追跡（対応済み/対応中/未対応）

### 8.2 フィードバックへの対応
- バグ報告は優先的に対応
- UI/UX改善提案は検討して実装
- 機能要望はロードマップに反映

---

## 9. 注意事項

### 9.1 テスト版のみ
- **本番環境では絶対に有効化しない**
- 環境変数で制御し、誤って有効化されないようにする

### 9.2 パフォーマンス
- フローティングボタンは軽量に実装
- スクリーンショット取得はオプションとし、重い処理は避ける

### 9.3 ユーザビリティ
- 業務の流れを妨げない
- 最小限の操作で送信できる
- 送信後はすぐに業務に戻れる

---

## 10. 今後の拡張案

- フィードバックへの返信機能
- フィードバックのステータス管理（未対応/対応中/対応済み）
- フィードバックの統計表示
- よくあるフィードバックのFAQ化








