# 追加見積もりがない場合のワークフロー提案

## 現状の実装確認結果

### 現在の実装状況
1. **診断完了時（`src/app/mechanic/diagnosis/[id]/page.tsx`）**:
   - 常に「見積作成待ち」にステータスを更新（3617行目、3681行目）
   - 追加見積もりの有無を判定していない
   - 常に見積画面に遷移（3745-3772行目）

2. **見積画面（`src/app/admin/estimate/[id]/page.tsx`）**:
   - 診断データから追加見積項目（`additionalEstimateRequired`, `additionalEstimateRecommended`, `additionalEstimateOptional`）を読み込む（1755-1809行目）
   - 見積項目が0件の場合は送信できない（2729行目）
   - 見積送信時はステータスを「顧客承認待ち」に更新（3014行目）
   - 車検の場合は「追加見積を送信」ボタンを表示（4773行目）

3. **法定費用の扱い（重要）**:
   - 法定費用は**見積項目には含まれない**（別途表示される）
   - 法定費用は顧客承認画面で「法定費用（必須）」として表示される（仕様書より）
   - 法定費用は顧客承認の対象外（必須なので承認不要）
   - `LegalFeesCard`コンポーネントがインポートされているが、見積画面では表示されていない可能性がある

### 問題点
- **24ヶ月点検（車検）の場合**:
  - 法定費用（車検費用、重量税、自賠責保険料、印紙代など）は必ず発生するが、見積項目には含まれない
  - 追加見積もり（必須整備、推奨整備、任意整備）は、点検項目で「交換」「修理」「調整」などが検出された場合に自動追加される
  - **追加見積もりがない場合 = 見積項目が0件**
  - **見積項目が0件の場合、見積送信できない（2729行目）**
  - **現在の実装では、追加見積もりがない場合の処理が明確でない**

## 提案: 2つのケースに分けたワークフロー

### ケース1: 追加見積もりがない場合（見積項目0件）

#### シナリオ
- 24ヶ月点検（車検）で、すべての点検項目が「良好（レ）」
- 追加見積もり（必須整備、推奨整備、任意整備）が0件
- **見積項目が0件**（法定費用は見積項目に含まれないため）
- 法定費用は別途発生するが、見積項目には含まれない

#### 提案ワークフロー

**オプションA: 自動承認フロー（推奨）**
1. 診断完了時:
   - 追加見積もりがないことを判定（`additionalEstimateRequired`, `additionalEstimateRecommended`, `additionalEstimateOptional`がすべて空）
   - 見積項目が0件であることを確認
   - **ステータスを「見積作成待ち」→「出庫待ち」または「完了」に直接更新**（見積・承認・作業をスキップ）
   - 見積画面への遷移をスキップ
   - 作業画面への遷移をスキップ
   - **理由**: 追加見積もりがない場合、受入点検で点検は完了しており、追加作業が不要なため、作業画面で行うことはない
   - **注意**: 法定費用は見積項目に含まれないため、見積を作成する必要はない

**オプションB: 簡易承認フロー**
1. 診断完了時:
   - 追加見積もりがないことを判定
   - 見積項目が0件であることを確認
   - ステータスを「見積作成待ち」に更新
   - 見積画面に遷移（見積項目0件、法定費用は別途表示）
   - 見積画面で「追加見積もりがないため、承認をスキップして完了に進む」ボタンを表示
   - ボタンクリックで「出庫待ち」または「完了」に直接遷移

**オプションC: 通常フロー（現状維持）**
1. 診断完了時:
   - 追加見積もりがないことを判定
   - 見積項目が0件であることを確認
   - ステータスを「見積作成待ち」に更新
   - 見積画面に遷移（見積項目0件、法定費用は別途表示）
   - **問題1**: 見積項目が0件のため、見積送信できない（2729行目でエラー）
   - **問題2**: 見積送信後、作業画面に遷移するが、作業項目がないため作業完了できない（1232-1238行目でエラー）
   - **解決策**: 見積項目が0件でも送信できるようにし、作業画面をスキップして「出庫待ち」に直接進む

#### 推奨: オプションA（自動承認フロー）

**理由:**
- 追加見積もりがない場合、顧客の意思決定は不要
- 法定費用は見積項目に含まれないため、見積を作成する必要がない
- ワークフローが簡潔になり、作業開始までの時間を短縮できる
- 見積項目が0件の場合、見積送信できない問題を回避できる

### ケース2: 追加見積もりがある場合

#### シナリオ
- 24ヶ月点検（車検）で、一部の点検項目が「交換」「修理」「調整」
- 追加見積もり（必須整備、推奨整備、任意整備）が1件以上
- 見積項目が1件以上
- 法定費用は別途発生するが、見積項目には含まれない

#### 提案ワークフロー（現状維持）
1. 診断完了時:
   - 追加見積もりがあることを判定
   - ステータスを「見積作成待ち」に更新
   - 見積画面に遷移
2. 見積画面:
   - 追加見積もり（必須整備、推奨整備、任意整備）を表示
   - 法定費用は別途表示（`LegalFeesCard`を使用）
   - 顧客承認を経て「作業待ち」に遷移

## 実装方針

### 1. 診断完了時の判定ロジック（`src/app/mechanic/diagnosis/[id]/page.tsx`）

```typescript
// 追加見積もりの有無を判定
const hasAdditionalEstimate = 
  (additionalEstimateRequired?.length || 0) > 0 ||
  (additionalEstimateRecommended?.length || 0) > 0 ||
  (additionalEstimateOptional?.length || 0) > 0;

// 24ヶ月点検の場合のみ、追加見積もりがない場合の処理を実行
if (is24MonthInspection && !hasAdditionalEstimate) {
  // オプションA: 自動承認フロー
  // 1. 法定費用のみの見積もりを自動生成
  // 2. ステータスを「作業待ち」に直接更新
  // 3. 見積画面への遷移をスキップ
  // 4. 作業画面への遷移を提案
} else {
  // 通常フロー: 見積作成待ち → 見積画面
  // 現在の実装を維持
}
```

**実装箇所**: `handleCompleteInternal`関数内（約3740行目付近）

### 2. 追加見積もりがない場合の処理（見積項目0件）

```typescript
// 追加見積もりの有無を判定
const hasAdditionalEstimate = 
  (additionalEstimateRequired?.length || 0) > 0 ||
  (additionalEstimateRecommended?.length || 0) > 0 ||
  (additionalEstimateOptional?.length || 0) > 0;

// 24ヶ月点検の場合のみ、追加見積もりがない場合の処理を実行
if (is24MonthInspection && !hasAdditionalEstimate) {
  // オプションA: 自動承認フロー
  // 見積項目が0件なので、見積を作成する必要はない
  // 追加作業が不要なので、作業画面で行うことはない
  // ステータスを「出庫待ち」または「完了」に直接更新
  await updateWorkOrder(jobId, workOrderId, {
    status: "出庫待ち", // 見積・承認・作業をスキップして直接出庫待ちに
  });
  
  // 見積画面への遷移をスキップ
  // 作業画面への遷移をスキップ
  toast.success("点検完了", {
    description: "追加見積もりがないため、点検は完了しました",
    duration: 5000,
  });
  
  // 必要に応じて、報告画面や完了画面への遷移を提案
  // または、トップページに戻る
} else {
  // 通常フロー: 見積作成待ち → 見積画面
  // 現在の実装を維持
}
```

**実装箇所**: `handleCompleteInternal`関数内（約3740行目付近、現在の見積画面への遷移処理の前に追加）

**注意**: 法定費用は見積項目に含まれないため、見積を作成する必要はありません。

### 3. ステータス更新ロジック（診断完了時）

```typescript
// 追加見積もりがない場合
if (is24MonthInspection && !hasAdditionalEstimate) {
  // 法定費用のみの見積もりを自動生成（上記の処理）
  // ...
  
  // ステータスを「作業待ち」に直接更新（上記のupdateWorkOrder内で処理）
  // 見積画面への遷移をスキップ
  // 作業画面への遷移を提案
  toast.success("点検完了", {
    description: "追加見積もりがないため、作業画面に移動します",
    action: {
      label: "作業画面へ",
      onClick: () => {
        const workUrl = selectedWorkOrder?.id
          ? `/mechanic/work/${jobId}?workOrderId=${selectedWorkOrder.id}`
          : `/mechanic/work/${jobId}`;
        router.push(workUrl);
      },
    },
    duration: 5000,
  });
  
  // 3秒後に自動で作業画面へ遷移（オプション）
  setTimeout(() => {
    const workUrl = selectedWorkOrder?.id
      ? `/mechanic/work/${jobId}?workOrderId=${selectedWorkOrder.id}`
      : `/mechanic/work/${jobId}`;
    router.push(workUrl);
  }, 3000);
} else {
  // 通常フロー: 見積作成待ち
  // 現在の実装を維持（3617行目、3681行目）
  // 見積画面への遷移（3745-3772行目）
}
```

**実装箇所**: `handleCompleteInternal`関数内（約3740行目付近、現在の見積画面への遷移処理の前に追加）

## UI/UXの改善

### 診断完了時の確認ダイアログ（オプション）

追加見積もりがない場合、診断完了時に確認ダイアログを表示：

```
【点検完了】

追加見積もりがありません。
法定費用のみが発生します。

このまま作業を開始しますか？

[キャンセル] [作業を開始]
```

### 見積画面での表示（オプションBの場合）

追加見積もりがない場合、見積画面で以下のメッセージを表示：

```
【法定費用のみ】

追加見積もりはありません。
法定費用のみが発生します。

[承認をスキップして作業に進む]
```

## 注意事項

1. **見積書の生成**: 追加見積もりがない場合、見積項目が0件なので見積書を作成する必要はない
2. **顧客通知**: 追加見積もりがない場合、顧客に通知するかどうかは要検討
   - オプションAの場合: 通知をスキップ（自動承認のため）
   - オプションB/Cの場合: 通常通り通知（ただし、見積項目が0件なので、法定費用のみの通知になる）
3. **12ヶ月点検**: 12ヶ月点検の場合も同様の処理を適用するかどうかは要検討
4. **その他のメンテナンス**: その他のメンテナンス（エンジンオイル交換など）の場合も同様の処理を適用するかどうかは要検討
5. **法定費用の扱い**: 法定費用は見積項目に含まれないため、見積を作成する必要はない。法定費用は別途処理される（顧客承認画面で表示される）
6. **見積画面の表示**: 現在の実装では、法定費用が表示されていない可能性がある。見積画面に法定費用を表示する処理を追加する必要がある（オプションB/Cの場合）
7. **作業画面のスキップ**: 追加見積もりがない場合、作業項目がないため作業画面で作業完了できない（1232-1238行目でエラー）。作業画面をスキップして「出庫待ち」に直接進む必要がある
8. **ステータスの選択**: 「出庫待ち」と「完了」のどちらにするかは要検討。通常は「出庫待ち」が適切（請求書発行などの事務処理が必要な場合）

## 実装優先度

- **優先度**: 高
- **実装難易度**: 中
- **影響範囲**: 診断画面、見積画面、ワークフロー管理

## 次のステップ

1. **ユーザー確認**: オプションA/B/Cのどれを採用するか
2. **実装箇所の確認**:
   - `src/app/mechanic/diagnosis/[id]/page.tsx`の`handleCompleteInternal`関数（約3740行目付近）
   - `src/app/admin/estimate/[id]/page.tsx`の見積画面（法定費用の表示を追加する必要がある可能性）
3. **実装**: 
   - 診断完了時の判定ロジックを追加
   - 法定費用のみの見積もり自動生成処理を追加
   - 見積画面に法定費用を表示する処理を追加（必要に応じて）
4. **テスト**: 追加見積もりがない場合のワークフローをテスト
5. **ドキュメント更新**: ワークフロー仕様書を更新

