# レポート・分析画面 レビュー結果

**作成日**: 2025-01-XX  
**レビュー対象**: 新機能「レポート・分析画面」の実装可能性評価  
**評価基準**: データ取得可能性、UI/UXベストプラクティス、業務ユーザー目線

---

## 1. 実装可能性評価

### 1-1. 売上分析

#### ✅ 実装可能な項目

| 項目 | 実装可能性 | データソース | 備考 |
|------|-----------|------------|------|
| **平均単価** | ✅ 可能 | `EstimateItem`（見積データ） | 部品代 + 工賃の合計を計算 |
| **日次・週次・月次売上** | ✅ 可能 | `ZohoJob.field22`（入庫日時）+ 見積データ | 既存の`groupByDate`関数を活用 |
| **作業区分別売上** | ✅ 可能 | `ZohoJob.serviceKind` | 既存の`groupByServiceKind`関数を活用 |
| **技術者別生産性** | ✅ 可能 | `WorkRecord.mechanicName` + 作業時間 | 作業記録から集計 |
| **部品売上 vs 工賃売上** | ✅ 可能 | `EstimateItem.partQuantity/partUnitPrice` + `laborCost` | 見積データから分離計算 |

#### ⚠️ 実装可能だが要検討な項目

| 項目 | 実装可能性 | データソース | 課題・備考 |
|------|-----------|------------|----------|
| **推奨作業承認率** | ⚠️ 要検討 | `EstimateItem.priority` + 承認ステータス | 推奨作業の定義と承認判定ロジックが必要 |

#### ❌ 実装困難な項目

| 項目 | 実装可能性 | 理由 |
|------|-----------|------|
| **顧客満足度** | ❌ 困難 | 現在のシステムに顧客満足度データが存在しない。外部システム（アンケート、レビュー）との連携が必要 |

---

### 1-2. 顧客分析

#### ✅ 実装可能な項目

| 項目 | 実装可能性 | データソース | 備考 |
|------|-----------|------------|------|
| **リピート率** | ✅ 可能 | `ZohoJob.field4`（顧客ID） | 同一顧客の複数回入庫を集計 |
| **推奨作業承認率** | ⚠️ 要検討 | `EstimateItem.priority` + 承認ステータス | 売上分析と同じ課題 |

#### ❌ 実装困難な項目

| 項目 | 実装可能性 | 理由 |
|------|-----------|------|
| **顧客獲得コスト** | ❌ 困難 | マーケティング費用データが存在しない。外部システム（広告管理、CRM）との連携が必要 |

---

### 1-3. 業務効率

#### ✅ 実装可能な項目

| 項目 | 実装可能性 | データソース | 備考 |
|------|-----------|------------|------|
| **平均作業時間** | ✅ 可能 | `WorkRecord.duration` | 作業記録から集計 |
| **工程別ボトルネック分析** | ✅ 可能 | `ZohoJob.field5`（工程ステージ）+ 日時 | 各工程の滞留時間を計算 |

#### ❌ 実装困難な項目

| 項目 | 実装可能性 | 理由 |
|------|-----------|------|
| **設備稼働率** | ❌ 困難 | 設備データ（設備ID、使用時間、稼働状況）が存在しない。設備管理システムとの連携が必要 |

---

## 2. データ構造の確認

### 2-1. 見積データ（EstimateItem）

```typescript
interface EstimateItem {
  id: string;
  name: string;              // 作業内容
  partQuantity?: number;     // 数量
  partUnitPrice?: number;    // 単価
  laborCost?: number;        // 技術量（工賃）
  priority: "required" | "recommended" | "optional";
  // ...
}

// 計算式
const partTotal = (partQuantity || 0) * (partUnitPrice || 0);
const totalPrice = partTotal + (laborCost || 0);
```

### 2-2. 作業記録（WorkRecord）

```typescript
interface WorkRecord {
  time: string;              // 記録日時（ISO8601）
  content: string;            // 作業内容
  mechanicName?: string;     // 担当者名
  duration?: number;         // 作業時間（分）
  completedAt?: string;     // 完了日時
  // ...
}
```

### 2-3. ジョブデータ（ZohoJob）

```typescript
interface ZohoJob {
  id: string;
  field22: string;           // 入庫日時
  field5: JobStage;          // 工程ステージ
  field4: ZohoLookup | null; // 顧客情報
  serviceKind: ServiceKind;  // 入庫区分
  field13: string | null;    // 承認済み作業内容（見積テキスト）
  // ...
}
```

---

## 3. UI/UX設計提案

### 3-1. ページ構成

既存の`/manager/analytics`ページ`を拡張する形で実装することを推奨します。

**推奨レイアウト**:
```
┌─────────────────────────────────────────┐
│ レポート・分析                            │
├─────────────────────────────────────────┤
│ [タブ] 売上分析 | 顧客分析 | 業務効率    │
├─────────────────────────────────────────┤
│ 期間選択: [週次▼] [開始日] 〜 [終了日]  │
├─────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐│
│ │平均単価   │ │推奨作業  │ │部品/工賃  ││
│ │¥45,000   │ │承認率68% │ │比率グラフ ││
│ └──────────┘ └──────────┘ └──────────┘│
├─────────────────────────────────────────┤
│ [グラフ: 日次売上トレンド]                │
├─────────────────────────────────────────┤
│ [グラフ: 作業区分別売上]                 │
├─────────────────────────────────────────┤
│ [グラフ: 技術者別生産性]                 │
└─────────────────────────────────────────┘
```

### 3-2. デザインシステム準拠

**既存のデザインシステム（`docs/DESIGN_SYSTEM.md`）に準拠**:

- **フォントサイズ**: `text-base` (16px) 以上を使用
- **ボタンサイズ**: `h-12` (48px) を推奨
- **アイコンサイズ**: `h-4 w-4` (16px) 以上を使用
- **カード**: `border border-slate-300 rounded-xl shadow-md`
- **グラフ**: Rechartsを使用（既存実装と統一）

### 3-3. 情報階層の設計

**重要度順**:
1. **最重要**: 平均単価、推奨作業承認率、日次売上
2. **重要**: 作業区分別売上、技術者別生産性
3. **補助**: 部品売上 vs 工賃売上の比率

**視覚的階層**:
- 最重要指標: 大きな数値表示（`text-2xl font-bold`）
- 重要指標: 中サイズの数値表示（`text-xl font-bold`）
- 補助指標: グラフやテーブルで表示

---

## 4. 実装優先度

### Phase 1: 基本売上分析（高優先度）

1. **平均単価の計算・表示**
   - 見積データから合計金額を計算
   - 期間内の平均を算出

2. **日次・週次・月次売上グラフ**
   - 既存の`groupByDate`関数を活用
   - 売上金額を集計

3. **作業区分別売上**
   - 既存の`groupByServiceKind`関数を活用
   - 売上金額を集計

### Phase 2: 詳細分析（中優先度）

4. **技術者別生産性**
   - 作業記録から担当者別の作業時間・件数を集計
   - 生産性指標を計算（件数/時間、売上/時間）

5. **部品売上 vs 工賃売上**
   - 見積データから部品代と工賃を分離
   - 比率グラフを表示

6. **推奨作業承認率**
   - 推奨作業（`priority === "recommended"`）の承認率を計算
   - 承認判定ロジックの実装が必要

### Phase 3: 顧客・業務効率分析（低優先度）

7. **リピート率**
   - 同一顧客の複数回入庫を集計
   - リピート率を計算

8. **平均作業時間**
   - 作業記録から平均作業時間を計算

9. **工程別ボトルネック分析**
   - 各工程の滞留時間を計算
   - ボトルネック工程を特定

---

## 5. 技術的実装方針

### 5-1. データ集計ロジック

**新しいユーティリティ関数の追加**（`src/lib/analytics-utils.ts`）:

```typescript
/**
 * 売上データの集計
 */
export function calculateRevenueData(
  jobs: ZohoJob[],
  dateRange: "week" | "month" | "quarter" | "year",
  startDate: Date,
  endDate: Date
): RevenueAnalyticsData {
  // 見積データから売上を計算
  // 日別・週別・月別に集計
  // 作業区分別に集計
}

/**
 * 技術者別生産性データの集計
 */
export function calculateMechanicProductivity(
  jobs: ZohoJob[],
  startDate: Date,
  endDate: Date
): MechanicProductivityData {
  // 作業記録から担当者別の生産性を計算
}
```

### 5-2. API拡張

**既存の`/api/analytics`ルートを拡張**:

```typescript
// GET /api/analytics/revenue
// 売上分析データを返す

// GET /api/analytics/customer
// 顧客分析データを返す

// GET /api/analytics/efficiency
// 業務効率データを返す
```

### 5-3. フロントエンド実装

**既存の`/manager/analytics`ページを拡張**:

- タブで「売上分析」「顧客分析」「業務効率」を切り替え
- 各タブで適切なグラフ・指標を表示
- 期間選択は既存実装を活用

---

## 6. 課題と対応策

### 6-1. 推奨作業承認率の定義

**課題**: 「推奨作業」の定義と承認判定ロジックが不明確

**対応策**:
- `EstimateItem.priority === "recommended"`を推奨作業として定義
- 承認判定: `field5 === "作業待ち"` または `field5 === "出庫待ち"` を承認済みと判定
- 承認率 = 承認済み推奨作業数 / 推奨作業総数

### 6-2. 顧客満足度の取得

**課題**: 現在のシステムに顧客満足度データが存在しない

**対応策（将来実装）**:
- 顧客レポート画面（`/customer/report/[id]`）に満足度評価機能を追加
- 5段階評価（1-5）を実装
- 評価データをZoho CRMまたはGoogle Sheetsに保存

### 6-3. 設備稼働率の取得

**課題**: 設備データが存在しない

**対応策（将来実装）**:
- 設備管理システムとの連携
- または、作業記録から設備使用状況を推測（作業内容から設備を推定）

---

## 7. ベストプラクティス適用

### 7-1. 業務ユーザー目線

**重要な指標を優先表示**:
- 平均単価、推奨作業承認率を最初に表示
- 日次売上トレンドを視覚的に分かりやすく表示

**わかりやすい表現**:
- 数値は3桁区切り（`¥45,000`）
- パーセンテージは小数点以下1桁（`68.0%`）
- 期間は「今週」「今月」「今四半期」などの選択肢を提供

### 7-2. UI/UXベストプラクティス

**既存のデザインシステムに準拠**:
- カードレイアウト: `Card`コンポーネントを使用
- グラフ: Rechartsを使用（既存実装と統一）
- ボタン: `h-12` (48px) を使用
- フォント: `text-base` (16px) 以上を使用

**レスポンシブ対応**:
- モバイル: 1列レイアウト
- タブレット: 2列レイアウト
- PC: 3列レイアウト

**アクセシビリティ**:
- グラフに適切な`aria-label`を設定
- 数値は`tabular-nums`で等幅フォントを使用
- コントラスト比4.5:1以上を確保

---

## 8. 実装チェックリスト

### Phase 1: 基本売上分析

- [ ] `calculateRevenueData`関数の実装
- [ ] 平均単価の計算・表示
- [ ] 日次・週次・月次売上グラフの実装
- [ ] 作業区分別売上グラフの実装
- [ ] APIルート（`/api/analytics/revenue`）の実装
- [ ] フロントエンドページの実装

### Phase 2: 詳細分析

- [ ] `calculateMechanicProductivity`関数の実装
- [ ] 技術者別生産性グラフの実装
- [ ] 部品売上 vs 工賃売上グラフの実装
- [ ] 推奨作業承認率の計算・表示
- [ ] APIルート（`/api/analytics/mechanic`）の実装

### Phase 3: 顧客・業務効率分析

- [ ] `calculateCustomerAnalytics`関数の実装
- [ ] リピート率の計算・表示
- [ ] `calculateEfficiencyAnalytics`関数の実装
- [ ] 平均作業時間の計算・表示
- [ ] 工程別ボトルネック分析の実装

---

## 9. まとめ

### 実装可能な機能

✅ **売上分析**:
- 平均単価
- 日次・週次・月次売上
- 作業区分別売上
- 技術者別生産性
- 部品売上 vs 工賃売上

✅ **顧客分析**:
- リピート率

✅ **業務効率**:
- 平均作業時間
- 工程別ボトルネック分析

### 実装困難な機能

❌ **顧客満足度**: 外部システム連携が必要  
❌ **顧客獲得コスト**: マーケティングデータが必要  
❌ **設備稼働率**: 設備管理システム連携が必要

### 推奨実装順序

1. **Phase 1**: 基本売上分析（最重要）
2. **Phase 2**: 詳細分析（重要）
3. **Phase 3**: 顧客・業務効率分析（補助）

### 次のステップ

1. Phase 1の実装を開始
2. ユーザーフィードバックを収集
3. Phase 2、Phase 3を順次実装


