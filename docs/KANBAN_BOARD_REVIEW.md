# 作業指示・進捗管理画面（カンバンボード）レビュー結果

**作成日**: 2025-01-XX  
**レビュー対象**: 新機能「作業指示・進捗管理画面（カンバンボード形式）」の実装可能性評価  
**評価基準**: データ取得可能性、UI/UXベストプラクティス、業務ユーザー目線

---

## 1. 実装可能性評価

### 1-1. カンバンボード形式の表示

#### ✅ 実装可能な項目

| 項目 | 実装可能性 | データソース | 備考 |
|------|-----------|------------|------|
| **カンバンボード列（待機中/作業中/検査待ち/完了）** | ✅ 可能 | `ZohoJob.field5`（工程ステージ） | ステータスを4つの列にマッピング |
| **各車両カード表示** | ✅ 可能 | `ZohoJob` + `ZohoLookup`（車両・顧客） | 既存のジョブカードコンポーネントを活用可能 |
| **車種・ナンバー** | ✅ 可能 | `ZohoJob.field6`（車両Lookup） | 車両マスタから取得 |
| **顧客名** | ✅ 可能 | `ZohoJob.field4`（顧客Lookup） | 顧客マスタから取得 |
| **担当技術者** | ✅ 可能 | `ZohoJob.assignedMechanic` | 既存フィールド |
| **作業内容（アイコン表示）** | ✅ 可能 | `ZohoJob.serviceKind` + `WorkOrder.estimate.items` | 入庫区分と見積項目から取得 |
| **ステータスバー** | ✅ 可能 | `ZohoJob.field5` + 進捗計算ロジック | 既存の進捗計算ロジックを活用 |

#### ⚠️ 実装可能だが要検討な項目

| 項目 | 実装可能性 | データソース | 課題・備考 |
|------|-----------|------------|----------|
| **予定完了時刻** | ⚠️ 要検討 | 現在のシステムに存在しない | 予定完了時刻の管理方法を定義する必要がある（推定計算または新規フィールド追加） |

---

### 1-2. 技術者割り当て機能

#### ✅ 実装可能な項目

| 項目 | 実装可能性 | データソース | 備考 |
|------|-----------|------------|------|
| **ドラッグ&ドロップで担当変更** | ✅ 可能 | `ZohoJob.assignedMechanic` | ドラッグ&ドロップライブラリ（`@dnd-kit/core`など）を使用 |
| **技術者の稼働状況表示** | ✅ 可能 | `ZohoJob.assignedMechanic` + 作業記録 | 既存の技術者別集計ロジックを活用 |
| **稼働率** | ✅ 可能 | 作業記録の`duration`から計算 | 既存の業務効率分析ロジックを活用 |
| **空き時間** | ⚠️ 要検討 | 作業記録 + 予定完了時刻 | 予定完了時刻の管理が必要 |

---

## 2. データ構造の確認

### 2-1. ジョブデータ（ZohoJob）

```typescript
interface ZohoJob {
  id: string;
  field5: JobStage;              // 工程ステージ
  field4: ZohoLookup | null;     // 顧客情報
  field6: ZohoLookup | null;     // 車両情報
  field22: string;               // 入庫日時
  assignedMechanic?: string | null; // 担当整備士名
  serviceKind?: ServiceKind | null; // 入庫区分
  // ...
}
```

### 2-2. ワークオーダーデータ（WorkOrder）

```typescript
interface WorkOrder {
  id: string;
  jobId: string;
  serviceKind: ServiceKind;
  status: WorkOrderStatus;
  work?: {
    mechanicName?: string;       // 作業担当者名
    records?: WorkRecord[];      // 作業記録
    completedAt?: string;        // 作業完了日時
  };
  estimate?: {
    items?: EstimateItem[];     // 見積項目
  };
  // ...
}
```

### 2-3. ステータスマッピング

**カンバンボード列と工程ステージの対応**:

| カンバンボード列 | 対応する工程ステージ | 説明 |
|----------------|-------------------|------|
| **待機中** | `入庫待ち`, `入庫済み`, `見積作成待ち`, `お客様承認待ち`, `部品調達待ち`, `部品発注待ち` | 作業開始前の状態 |
| **作業中** | `作業待ち` | 作業が開始可能または進行中 |
| **検査待ち** | （新規ステータスまたは`作業待ち`の一部） | 作業完了後の検査待ち状態 |
| **完了** | `出庫待ち`, `出庫済み` | 作業完了・引渡準備完了 |

**注意**: 「検査待ち」は現在のシステムに明確なステータスが存在しないため、以下のいずれかの対応が必要:
- `作業待ち`の一部として扱う（作業完了フラグで判定）
- 新規ステータスを追加（`検査待ち`）
- `WorkOrder.status === "完了"`かつ`ZohoJob.field5 === "作業待ち"`で判定

---

## 3. UI/UX設計提案

### 3-1. ページ構成

**推奨レイアウト**:
```
┌─────────────────────────────────────────────────────────┐
│ 作業指示・進捗管理                                       │
├─────────────────────────────────────────────────────────┤
│ フィルター: [全技術者▼] [今日] [今週] [今月]            │
├─────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│ │ 待機中   │ │ 作業中   │ │ 検査待ち │ │ 完了     │  │
│ │   3台    │ │   5台    │ │   2台    │ │  10台    │  │
│ ├──────────┤ ├──────────┤ ├──────────┤ ├──────────┤  │
│ │ [カード] │ │ [カード] │ │ [カード] │ │ [カード] │  │
│ │ [カード] │ │ [カード] │ │ [カード] │ │ [カード] │  │
│ │ [カード] │ │ [カード] │ │          │ │ [カード] │  │
│ │          │ │ [カード] │ │          │ │ [カード] │  │
│ │          │ │ [カード] │ │          │ │ [カード] │  │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
├─────────────────────────────────────────────────────────┤
│ 技術者稼働状況                                           │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐               │
│ │ 山田太郎  │ │ 佐藤花子  │ │ 鈴木一郎  │               │
│ │ 稼働率:  │ │ 稼働率:  │ │ 稼働率:  │               │
│ │ 85%      │ │ 60%      │ │ 90%      │               │
│ │ 空き時間:│ │ 空き時間:│ │ 空き時間:│               │
│ │ 2時間    │ │ 4時間    │ │ 1時間    │               │
│ └──────────┘ └──────────┘ └──────────┘               │
└─────────────────────────────────────────────────────────┘
```

### 3-2. 車両カードの表示内容

**カードレイアウト**:
```
┌─────────────────────────────┐
│ 🚗 BMW X3  [東京 500 あ 1234] │
│ 👤 田中太郎                   │
│ 👷 山田太郎                   │
│ ⚙️ エンジンオイル交換          │
│ ⏰ 予定完了: 15:00            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ [進捗バー: 60%]              │
└─────────────────────────────┘
```

**デザインシステム準拠**:
- カード: `Card`コンポーネント（`border border-slate-300 rounded-xl shadow-md`）
- フォントサイズ: `text-base` (16px) 以上
- アイコンサイズ: `h-4 w-4` (16px) 以上
- ドラッグ可能なカード: `cursor-move` + ホバーエフェクト

### 3-3. ドラッグ&ドロップ機能

**推奨ライブラリ**: `@dnd-kit/core` + `@dnd-kit/sortable`
- モダンでアクセシビリティ対応
- TypeScript対応
- モバイル対応（タッチ操作）

**実装方針**:
- カードをドラッグ可能にする（`useDraggable`）
- 列をドロップゾーンにする（`useDroppable`）
- ドロップ時に`assignedMechanic`を更新
- 視覚的フィードバック（ドラッグ中のカードを半透明、ドロップゾーンをハイライト）

### 3-4. 技術者稼働状況表示

**表示内容**:
- 稼働率: 作業時間 / 総作業可能時間 × 100
- 空き時間: 総作業可能時間 - 作業時間
- 担当案件数: 各技術者の担当案件数
- 作業中案件数: 現在作業中の案件数

**計算方法**:
```typescript
// 稼働率の計算
const workDuration = workRecords.reduce((sum, record) => sum + (record.duration || 0), 0);
const totalAvailableTime = 8 * 60; // 8時間 = 480分（1日あたり）
const utilizationRate = (workDuration / totalAvailableTime) * 100;

// 空き時間の計算
const freeTime = totalAvailableTime - workDuration;
```

---

## 4. 実装優先度

### Phase 1: 基本カンバンボード表示（高優先度）

1. **カンバンボード列の実装**
   - 4列（待機中/作業中/検査待ち/完了）のレイアウト
   - 各列の件数表示

2. **車両カードの実装**
   - 車種・ナンバー表示
   - 顧客名表示
   - 担当技術者表示
   - 作業内容（アイコン表示）
   - ステータスバー

3. **ステータスフィルタリング**
   - 工程ステージからカンバンボード列へのマッピング
   - 各列へのジョブの振り分け

### Phase 2: ドラッグ&ドロップ機能（中優先度）

4. **ドラッグ&ドロップの実装**
   - カードのドラッグ機能
   - 列へのドロップ機能
   - 担当技術者の更新

5. **視覚的フィードバック**
   - ドラッグ中のカードのスタイル変更
   - ドロップゾーンのハイライト

### Phase 3: 技術者稼働状況（低優先度）

6. **技術者稼働状況の表示**
   - 稼働率の計算・表示
   - 空き時間の計算・表示
   - 担当案件数の表示

7. **予定完了時刻の管理**
   - 予定完了時刻の推定計算または新規フィールド追加
   - カードへの表示

---

## 5. 技術的実装方針

### 5-1. カンバンボードコンポーネント

**新しいコンポーネント**（`src/components/features/kanban-board.tsx`）:

```typescript
interface KanbanBoardProps {
  jobs: ZohoJob[];
  onJobUpdate: (jobId: string, updates: Partial<ZohoJob>) => void;
  onMechanicAssign: (jobId: string, mechanicName: string) => void;
}

export function KanbanBoard({ jobs, onJobUpdate, onMechanicAssign }: KanbanBoardProps) {
  // カンバンボード列の定義
  const columns = [
    { id: "waiting", title: "待機中", statuses: ["入庫待ち", "入庫済み", "見積作成待ち", "お客様承認待ち", "部品調達待ち", "部品発注待ち"] },
    { id: "working", title: "作業中", statuses: ["作業待ち"] },
    { id: "inspection", title: "検査待ち", statuses: [] }, // 要検討
    { id: "completed", title: "完了", statuses: ["出庫待ち", "出庫済み"] },
  ];

  // ジョブを列ごとに分類
  const jobsByColumn = columns.map(column => ({
    ...column,
    jobs: jobs.filter(job => column.statuses.includes(job.field5)),
  }));

  // ドラッグ&ドロップ処理
  // ...
}
```

### 5-2. ドラッグ&ドロップライブラリ

**推奨**: `@dnd-kit/core` + `@dnd-kit/sortable`

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**実装例**:
```typescript
import { DndContext, DragEndEvent } from "@dnd-kit/core";
import { useSortable } from "@dnd-kit/sortable";

function KanbanCard({ job }: { job: ZohoJob }) {
  const { attributes, listeners, setNodeRef, transform } = useSortable({ id: job.id });
  
  // ...
}
```

### 5-3. 技術者稼働状況の計算

**新しいユーティリティ関数**（`src/lib/kanban-utils.ts`）:

```typescript
export interface MechanicWorkload {
  mechanicName: string;
  totalJobs: number;
  workingJobs: number;
  utilizationRate: number; // 稼働率（%）
  freeTime: number; // 空き時間（分）
}

export function calculateMechanicWorkload(
  jobs: ZohoJob[],
  mechanicName: string
): MechanicWorkload {
  // 技術者の担当案件をフィルタリング
  // 作業記録から作業時間を集計
  // 稼働率と空き時間を計算
}
```

### 5-4. 予定完了時刻の管理

**課題**: 現在のシステムに予定完了時刻のフィールドが存在しない

**対応策**:
1. **推定計算**: 入庫日時 + 平均作業時間から推定
2. **新規フィールド追加**: `ZohoJob`に`expectedCompletionTime`フィールドを追加
3. **ワークオーダーから取得**: `WorkOrder.work.records`から作業時間を集計して推定

**推奨**: Phase 1では推定計算を使用し、Phase 2以降で新規フィールドを検討

---

## 6. 課題と対応策

### 6-1. 「検査待ち」ステータスの定義

**課題**: 現在のシステムに「検査待ち」という明確なステータスが存在しない

**対応策**:
- **案1**: `作業待ち`の一部として扱う（`WorkOrder.status === "完了"`かつ`ZohoJob.field5 === "作業待ち"`で判定）
- **案2**: 新規ステータス`検査待ち`を追加（`JobStage`に追加）
- **案3**: 「検査待ち」列を削除し、3列構成（待機中/作業中/完了）にする

**推奨**: 案1を採用（既存データ構造を活用）

### 6-2. 予定完了時刻の取得

**課題**: 現在のシステムに予定完了時刻のフィールドが存在しない

**対応策**:
- **Phase 1**: 推定計算（入庫日時 + 平均作業時間）
- **Phase 2**: 新規フィールド追加を検討

### 6-3. ドラッグ&ドロップのモバイル対応

**課題**: モバイルデバイスでのドラッグ&ドロップ操作

**対応策**:
- `@dnd-kit/core`はタッチ操作に対応
- モバイルでは長押しでドラッグ開始
- 視覚的フィードバックを強化

---

## 7. ベストプラクティス適用

### 7-1. 業務ユーザー目線

**重要な情報を優先表示**:
- 車種・ナンバー（最重要）
- 顧客名
- 担当技術者
- 作業内容
- 予定完了時刻

**わかりやすい表現**:
- アイコンで作業内容を視覚的に表現
- ステータスバーで進捗を可視化
- 色分けでステータスを区別

### 7-2. UI/UXベストプラクティス

**既存のデザインシステムに準拠**:
- カード: `Card`コンポーネントを使用
- フォントサイズ: `text-base` (16px) 以上
- アイコンサイズ: `h-4 w-4` (16px) 以上
- ボタン: `h-12` (48px) を使用

**レスポンシブ対応**:
- モバイル: 縦スクロール可能なカンバンボード
- タブレット: 横スクロール可能なカンバンボード
- PC: 4列を横並びで表示

**アクセシビリティ**:
- キーボード操作対応（ドラッグ&ドロップの代替操作）
- スクリーンリーダー対応
- フォーカス管理

---

## 8. 実装チェックリスト

### Phase 1: 基本カンバンボード表示

- [ ] カンバンボード列の実装（4列）
- [ ] 車両カードコンポーネントの実装
- [ ] ステータスフィルタリングロジックの実装
- [ ] 各列の件数表示
- [ ] ページルートの作成（`/manager/kanban`）

### Phase 2: ドラッグ&ドロップ機能

- [ ] `@dnd-kit`ライブラリのインストール
- [ ] ドラッグ&ドロップ機能の実装
- [ ] 担当技術者の更新API呼び出し
- [ ] 視覚的フィードバックの実装

### Phase 3: 技術者稼働状況

- [ ] 技術者稼働状況計算ロジックの実装
- [ ] 稼働状況表示コンポーネントの実装
- [ ] 予定完了時刻の推定計算（Phase 1）または新規フィールド追加（Phase 2）

---

## 9. まとめ

### 実装可能な機能

✅ **カンバンボード表示**:
- 4列（待機中/作業中/検査待ち/完了）のレイアウト
- 車両カードの表示（車種・ナンバー、顧客名、担当技術者、作業内容、ステータスバー）

✅ **ドラッグ&ドロップ機能**:
- カードのドラッグ&ドロップ
- 担当技術者の変更

✅ **技術者稼働状況**:
- 稼働率の計算・表示
- 空き時間の計算・表示

### 実装困難な機能

⚠️ **予定完了時刻**: 現在のシステムに存在しない（推定計算または新規フィールド追加が必要）

⚠️ **検査待ちステータス**: 現在のシステムに明確なステータスが存在しない（判定ロジックの定義が必要）

### 推奨実装順序

1. **Phase 1**: 基本カンバンボード表示（最重要）
2. **Phase 2**: ドラッグ&ドロップ機能（重要）
3. **Phase 3**: 技術者稼働状況（補助）

### 次のステップ

1. Phase 1の実装を開始
2. 「検査待ち」ステータスの判定ロジックを定義
3. 予定完了時刻の推定計算ロジックを実装
4. ユーザーフィードバックを収集
5. Phase 2、Phase 3を順次実装


