# その他のメンテナンス 画面設計書

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: その他のメンテナンスの各画面の詳細設計
- **設計方針**: 世界最高のUI/UX、ITコンサルの目線での推奨を元に設計
- **業務フローパターン**: パターンB（事前見積→了承→入庫→作業）
- **注意**: 12種類のメニューを統合管理、メニュー選択により画面が動的に変化

---

## 1. 画面一覧

### 1-1. 整備士向け画面

1. **診断画面** (`/mechanic/diagnosis/[id]`)
   - メニュー選択（受付時または診断開始時）
   - 簡易検査項目の入力（メニューに応じて動的）
   - 測定値入力（メニューに応じて動的）
   - 写真撮影（必要に応じて）

2. **見積画面** (`/admin/estimate/[id]`)
   - 部品選択・工賃入力（簡易）
   - 事前見積の確認

3. **作業画面** (`/mechanic/work/[id]`)
   - 作業記録の入力（メニューに応じて動的）
   - Before/After写真の撮影
   - 交換部品の記録

### 1-2. 特徴

- **メニュー選択**: 12種類のメニューから選択（バッテリー交換、ブレーキフルード交換など）
- **動的UI**: メニュー選択により、診断項目・測定値・見積項目・作業項目が動的に変化
- **見積もり画面**: 簡易的な見積画面（事前にメール等で見積もりを送信済み）
- **承認フロー**: 簡易化（確認のみ）
- **所要時間**: メニューによって異なる（15分〜3時間）

---

## 2. 診断画面の詳細設計

### 2-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 その他のメンテナンス診断 │
│ 整備士: 中村                             │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ │ 初度登録: H29.10                    │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 メニュー選択                          │
│ ┌─────────────────────────────────────┐ │
│ │ メンテナンスメニュー:                │ │
│ │ [バッテリー交換 ▼]                  │ │
│ │                                      │ │
│ │ 前回交換履歴:                        │ │
│ │ 2023年5月（2年前）                   │ │
│ │ 走行距離: 15,000km                   │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 簡易検査項目（メニューに応じて動的）   │
│ 進捗: ████████░░ 2/3項目完了 (67%)    │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 【バッテリー交換の場合】              │ │
│ │ 1. バッテリー電圧                    │ │
│ │ [正常] [注意] [要交換]              │ │
│ │                                      │ │
│ │ 2. 端子の状態                        │ │
│ │ [正常] [腐食] [緩み] [要交換]       │ │
│ │                                      │ │
│ │ 3. 充電状態                          │ │
│ │ [正常] [不足] [要交換]              │ │
│ │                                      │ │
│ │ [📷 写真を追加] [💬 コメント]       │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 【ブレーキフルード交換の場合】       │ │
│ │ 1. フルードの色                      │ │
│ │ [正常] [汚れ] [要交換]              │ │
│ │                                      │ │
│ │ 2. フルードの量                      │ │
│ │ [正常] [不足] [過多]                │ │
│ │                                      │ │
│ │ 3. 汚れ具合                          │ │
│ │ [正常] [軽微] [深刻] [要交換]       │ │
│ │                                      │ │
│ │ [📷 写真を追加] [💬 コメント]       │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 📏 測定値（メニューに応じて動的）     │ │
│ │                                      │ │
│ │ 【バッテリー交換の場合】             │ │
│ │ 電圧: [____] V                       │ │
│ │ CCA: [____] A                        │ │
│ │                                      │ │
│ │ 【ブレーキフルード交換の場合】       │ │
│ │ 水分含有率: [____] %                 │ │
│ │ 沸点: [____] ℃                      │ │
│ │                                      │ │
│ │ （メニューに応じて表示/非表示）       │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [一時保存] [診断完了]                    │
└─────────────────────────────────────────┘
```

### 2-2. コンポーネント設計

#### 2-2-1. 車両情報カード

**目的**: 診断対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**:
- 依頼者(使用者)の氏名又は名称
- 車名及び型式
- 自動車登録番号又は車両番号
- 原動機の型式
- 初度登録年又は初度検査年
- 車台番号

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

**UI/UXのポイント**:
- 背景色を薄くして、編集不可であることを視覚的に示す
- アイコン（🔒）で編集不可であることを示す

#### 2-2-2. メニュー選択セクション

**目的**: メンテナンスメニューを選択

**選択可能なメニュー**:
1. バッテリー交換
2. ブレーキフルード交換
3. エアフィルター交換
4. クーラント（冷却水）交換
5. スパークプラグ交換
6. ベルト類交換
7. ワイパー交換
8. ブレーキパッド交換
9. ブレーキローター交換
10. オイルフィルター交換（単独）
11. キャビンフィルター交換
12. ラジエーターキャップ交換

**UI/UXのポイント**:
- ドロップダウンまたはラジオボタンで選択
- 選択されたメニューの説明を表示
- 前回交換履歴を表示（該当する場合）
- メニュー選択により、以降の画面が動的に変化

#### 2-2-3. 簡易検査項目カード（動的）

**目的**: メニューに応じた検査項目の状態を入力

**メニュー別の検査項目例**:

**バッテリー交換**:
- バッテリー電圧: 正常/注意/要交換
- 端子の状態: 正常/腐食/緩み/要交換
- 充電状態: 正常/不足/要交換

**ブレーキフルード交換**:
- フルードの色: 正常/汚れ/要交換
- フルードの量: 正常/不足/過多
- 汚れ具合: 正常/軽微/深刻/要交換

**エアフィルター交換**:
- フィルターの汚れ具合: 正常/軽微/深刻/要交換
- 目詰まり: 正常/軽微/深刻/要交換

**その他のメニュー**: メニュー設定に基づいて動的に表示

**状態選択ボタンのデザイン**:
- **正常**: 緑色、チェックマークアイコン
- **注意**: 黄色、警告アイコン
- **要交換**: 赤色、Xアイコン
- **腐食/緩み/汚れ/深刻**: 黄色、警告アイコン

**UI/UXのポイント**:
- メニュー選択により、検査項目が動的に表示
- ボタンは画面幅いっぱいに配置（タッチしやすい）
- 選択された状態は明確に表示（背景色、アイコン）
- 写真ボタンは撮影済みの場合、サムネイルを表示
- コメントがある場合、アイコンで表示
- 各項目は独立したカードとして表示（視認性向上）

#### 2-2-4. 測定値入力セクション（動的）

**目的**: メニューに応じた測定値を入力

**メニュー別の測定値例**:

**バッテリー交換**:
- 電圧（V）
- CCA（Cold Cranking Amps、A）

**ブレーキフルード交換**:
- 水分含有率（%）
- 沸点（℃）

**クーラント交換**:
- 凍結防止性能（℃）
- pH値

**スパークプラグ交換**:
- ギャップ（mm）
- 抵抗値（Ω）

**ブレーキパッド交換**:
- パッド残量（mm）
- ローターの厚み（mm）

**その他のメニュー**: メニュー設定に基づいて動的に表示

**UI/UXのポイント**:
- メニュー選択により、測定値入力フィールドが動的に表示
- 数字キーパッドを表示（テンキー）
- 単位を明示（V、A、%、℃、mm、Ωなど）
- 範囲チェック（リアルタイムバリデーション）
- 測定値が不要なメニューは、このセクションを非表示

#### 2-2-5. 進捗バー

**目的**: 簡易検査の進捗を可視化

**表示内容**:
- 完了項目数 / 全項目数（メニューに応じて動的）
- 進捗パーセンテージ
- プログレスバー（視覚的）

**UI/UXのポイント**:
- 色で進捗を表現（0-50%: 赤、50-80%: 黄、80-100%: 緑）
- 数値と視覚的表現の両方で進捗を表示
- メニューに応じて項目数が変動

#### 2-2-6. 一時保存ボタン

**目的**: 現在の入力内容を保存（自動保存も実施）

**UI/UXのポイント**:
- 保存成功時にトースト通知（邪魔にならない程度に）
- オフライン時も保存可能（ローカルストレージ）
- 自動保存も実施（30秒ごと、または項目変更時）

#### 2-2-7. 診断完了ボタン

**目的**: 診断を完了し、見積画面への遷移を可能にする

**UI/UXのポイント**:
- 全ての項目が完了していない場合、警告を表示（任意）
- 測定値が未入力の場合、警告を表示（メニューに応じて）
- 確認ダイアログを表示（任意、簡易検査のため）
- 完了後、見積画面への遷移を可能にする

### 2-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 既存の診断結果を取得（Zoho CRM）
   ↓
4. メニューを選択（受付時または診断開始時）
   ↓
5. メニュー設定を取得（マスタデータ）
   ↓
6. 検査項目・測定値フィールドを動的に表示
   ↓
7. 整備士が各項目の状態を選択
   ↓
8. 測定値を入力（メニューに応じて）
   ↓
9. 自動保存（30秒ごと、または項目変更時）
   ↓
10. 診断完了ボタンをタップ
   ↓
11. 診断結果を保存（Zoho CRM）
   ↓
12. 見積画面への遷移を可能にする
```

### 2-4. インタラクション設計

#### 2-4-1. メニュー選択

- **タップ**: ドロップダウンまたはラジオボタンで選択
- **選択後**: 検査項目・測定値フィールドが動的に変化
- **変更**: 別のメニューを選択すると、前のメニューの入力内容は保持（確認ダイアログ表示）

#### 2-4-2. 状態選択

- **タップ**: 状態を選択
- **選択済み**: 背景色とアイコンで明確に表示
- **変更**: 別の状態をタップすると、前の選択が解除され、新しい状態が選択される

#### 2-4-3. 測定値入力

- **タップ**: 数字キーパッドを表示
- **入力**: 数値を入力
- **バリデーション**: リアルタイムで範囲チェック

#### 2-4-4. 写真撮影

- **タップ**: カメラを起動
- **撮影**: 写真を撮影
- **確認**: 撮影後、確認画面を表示（再撮影可能）
- **保存**: 確認後、写真を保存（Google Drive）
- **表示**: 撮影済みの場合、サムネイルを表示

#### 2-4-5. コメント入力

- **タップ**: コメント入力ダイアログを表示
- **入力**: テキストを入力
- **保存**: 保存ボタンをタップして保存
- **表示**: コメントがある場合、アイコンで表示

#### 2-4-6. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示
- **写真アップロードエラー**: エラーメッセージを表示、再アップロードボタンを表示

### 2-5. 状態管理

- **ローディング**: 車両情報取得中、メニュー設定取得中、診断結果保存中
- **エラー**: ネットワークエラー、保存エラー
- **成功**: 診断完了、見積画面への遷移可能

---

## 3. 見積画面の詳細設計

### 3-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 その他のメンテナンス見積 │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 選択されたメニュー                    │
│ ┌─────────────────────────────────────┐ │
│ │ バッテリー交換                      │ │
│ │ 前回交換: 2023年5月（2年前）        │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💰 事前見積（メール等で送信済み）        │
│ ┌─────────────────────────────────────┐ │
│ │ 部品代: ¥15,000                     │ │
│ │ 工賃:   ¥5,000                      │ │
│ │ ──────────────────────────────── │ │
│ │ 合計:   ¥20,000                     │ │
│ │                                      │ │
│ │ （事前にメール等で見積もりを送信済み）│ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 部品選択・工賃入力（簡易）            │
│ ┌─────────────────────────────────────┐ │
│ │ 部品:                                │ │
│ │ [＋部品を追加]                       │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ バッテリー（適合部品）          │ │ │
│ │ │ メーカー: [パナソニック ▼]     │ │ │
│ │ │ 型番:    [55B24L]              │ │ │
│ │ │ 数量:    [1] 個                │ │ │
│ │ │ 単価:    [¥15,000]             │ │ │
│ │ │ 金額:    ¥15,000                │ │ │
│ │ │ [削除]                           │ │ │
│ │ └────────────────────────────────┘ │ │
│ │                                      │ │
│ │ 工賃: [¥5,000]                      │ │
│ │                                      │ │
│ │ 合計: ¥20,000                       │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📋 診断結果（参考用）                    │
│ ┌─────────────────────────────────────┐ │
│ │ バッテリー電圧: [要交換]            │ │
│ │ 端子の状態: [正常]                  │ │
│ │ 充電状態: [不足]                    │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [確認] [顧客に送信]                     │
└─────────────────────────────────────────┘
```

### 3-2. コンポーネント設計

#### 3-2-1. 車両情報カード

**目的**: 見積対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**: 診断画面と同様

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

#### 3-2-2. 選択されたメニュー表示

**目的**: 選択されたメニューと前回交換履歴を表示

**表示内容**:
- メニュー名
- 前回交換履歴（該当する場合）
- 前回交換からの走行距離（該当する場合）

**UI/UXのポイント**:
- 選択されたメニューを明確に表示
- 前回交換履歴を参考情報として表示

#### 3-2-3. 事前見積表示

**目的**: 事前にメール等で送信済みの見積もりを表示

**表示内容**:
- 部品代
- 工賃
- 合計金額

**UI/UXのポイント**:
- 背景色を薄くして、参考情報であることを示す
- 「事前にメール等で見積もりを送信済み」と明記

#### 3-2-4. 部品選択・工賃入力セクション

**目的**: 部品を選択・工賃を入力（簡易）

**機能**:
- 部品の追加（「＋部品を追加」ボタン）
- 適合部品の自動提案（車両情報から）
- メーカー・型番・数量・単価の入力
- 工賃の入力
- 合計金額の自動計算

**UI/UXのポイント**:
- 適合部品を自動提案（車両情報から）
- メーカーはドロップダウン選択
- 型番はテキスト入力またはドロップダウン選択
- 数量・単価は数字キーパッドを表示
- 合計金額を自動計算

#### 3-2-5. 診断結果表示

**目的**: 診断画面で入力した診断結果を表示（参考用）

**表示内容**:
- 各検査項目の状態（正常/注意/要交換）
- 診断画面から自動で引き継ぎ

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す

#### 3-2-6. 確認ボタン

**目的**: 見積内容を確認

**UI/UXのポイント**:
- 見積内容を確認
- 承認フローは簡易化（確認のみ）

#### 3-2-7. 顧客に送信ボタン

**目的**: 見積もりを顧客に送信（必要に応じて）

**UI/UXのポイント**:
- 事前にメール等で送信済みの場合、このボタンは使用しない
- 必要に応じて再送信可能

### 3-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 診断結果を取得（Zoho CRM）
   ↓
4. 事前見積を取得（Zoho CRM、該当する場合）
   ↓
5. 適合部品を自動提案（車両情報から）
   ↓
6. フロントスタッフが部品・工賃を入力
   ↓
7. 合計金額を自動計算
   ↓
8. 確認ボタンをタップ
   ↓
9. 見積内容を保存（Zoho CRM）
   ↓
10. ステータスを「顧客承認待ち」に更新（簡易）
   ↓
11. 作業画面への遷移を可能にする
```

### 3-4. インタラクション設計

#### 3-4-1. 部品追加

- **タップ**: 「＋部品を追加」ボタンをタップ
- **選択**: 適合部品を選択（自動提案）
- **入力**: メーカー・型番・数量・単価を入力
- **削除**: 部品を削除（確認ダイアログ表示）

#### 3-4-2. 工賃入力

- **タップ**: 数字キーパッドを表示
- **入力**: 工賃を入力
- **計算**: 合計金額を自動計算

#### 3-4-3. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示

### 3-5. 状態管理

- **ローディング**: 車両情報取得中、見積内容保存中
- **エラー**: ネットワークエラー、保存エラー
- **成功**: 見積内容確認完了、作業画面への遷移可能

---

## 4. 作業画面の詳細設計

### 4-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 その他のメンテナンス作業 │
│ 整備士: 中村                             │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ │ 初度登録: H29.10                    │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 選択されたメニュー                    │
│ ┌─────────────────────────────────────┐ │
│ │ バッテリー交換                      │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 作業記録（メニューに応じて動的）      │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 【バッテリー交換の場合】             │ │
│ │ 交換した部品:                        │ │
│ │ ─────────────────────────────────── │ │
│ │ メーカー: [パナソニック]             │ │
│ │ 型番:     [55B24L]                  │ │
│ │ 数量:     [1] 個                    │ │
│ │                                      │ │
│ │ 動作確認:                            │ │
│ │ [✓] エンジン始動確認                 │ │
│ │ [✓] 充電状態確認                     │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 【ブレーキフルード交換の場合】       │ │
│ │ 交換した部品:                        │ │
│ │ ─────────────────────────────────── │ │
│ │ メーカー: [ブレンボ]                 │ │
│ │ 型番:     [DOT4]                    │ │
│ │ 数量:     [1] 本                    │ │
│ │                                      │ │
│ │ 動作確認:                            │ │
│ │ [✓] ブレーキペダルの踏み応え確認     │ │
│ │ [✓] ブレーキ効き確認                 │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ （メニューに応じて表示内容が変化）       │
├─────────────────────────────────────────┤
│ 📸 Before/After写真                     │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ Before: 交換前の部品の状態          │ │
│ │ [📷 写真を追加]                      │ │
│ │                                      │ │
│ │ [写真1] [写真2]                      │ │
│ │ （サムネイル表示、タップで拡大）     │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ After: 交換後の部品の状態           │ │
│ │ [📷 写真を追加]                      │ │
│ │                                      │ │
│ │ [写真1] [写真2]                      │ │
│ │ （サムネイル表示、タップで拡大）     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📋 簡易検査結果（診断画面から引き継ぎ）  │
│ ┌─────────────────────────────────────┐ │
│ │ バッテリー電圧: [要交換]            │ │
│ │ 端子の状態: [正常]                  │ │
│ │ 充電状態: [不足]                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📏 測定値（診断画面から引き継ぎ）        │
│ ┌─────────────────────────────────────┐ │
│ │ 電圧: 11.5V                          │ │
│ │ CCA: 450A                            │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💬 作業メモ                             │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  自由記述欄                          │ │
│ │  （複数行入力可能）                  │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [一時保存] [作業完了]                    │
└─────────────────────────────────────────┘
```

### 4-2. コンポーネント設計

#### 4-2-1. 車両情報カード

**目的**: 作業対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**: 診断画面と同様

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

#### 4-2-2. 選択されたメニュー表示

**目的**: 選択されたメニューを表示

**表示内容**:
- メニュー名

**UI/UXのポイント**:
- 選択されたメニューを明確に表示

#### 4-2-3. 作業記録セクション（動的）

**目的**: メニューに応じた作業記録を入力

**メニュー別の作業記録例**:

**バッテリー交換**:
- 交換した部品: メーカー、型番、数量
- 動作確認: エンジン始動確認、充電状態確認

**ブレーキフルード交換**:
- 交換した部品: メーカー、型番、数量
- 動作確認: ブレーキペダルの踏み応え確認、ブレーキ効き確認

**エアフィルター交換**:
- 交換した部品: メーカー、型番、数量
- 動作確認: エンジン始動確認、吸気確認

**その他のメニュー**: メニュー設定に基づいて動的に表示

**UI/UXのポイント**:
- メニュー選択により、作業記録項目が動的に表示
- 交換部品は見積画面から自動で引き継ぎ
- 動作確認はチェックボックスで選択
- メニューに応じた動作確認項目を表示

#### 4-2-4. Before/After写真セクション

**目的**: 作業前後の写真を撮影・表示

**Before写真**:
- **目的**: 交換前の部品の状態を記録
- **撮影タイミング**: 部品を交換する前
- **撮影枚数**: 1-2枚推奨

**After写真**:
- **目的**: 交換後の部品の状態を記録
- **撮影タイミング**: 部品を交換した後
- **撮影枚数**: 1-2枚推奨

**UI/UXのポイント**:
- 写真ボタンは大きく表示（タッチしやすい）
- 撮影済みの場合、サムネイルを表示
- サムネイルをタップすると拡大表示
- 複数枚撮影可能
- 写真の削除機能
- メニューによっては写真撮影が不要な場合もある

#### 4-2-5. 簡易検査結果表示

**目的**: 診断画面で入力した簡易検査結果を表示（参考用）

**表示内容**:
- 各検査項目の状態（正常/注意/要交換）
- 診断画面から自動で引き継ぎ

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す

#### 4-2-6. 測定値表示

**目的**: 診断画面で入力した測定値を表示（参考用）

**表示内容**:
- メニューに応じた測定値
- 診断画面から自動で引き継ぎ

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す
- メニューに応じて表示/非表示

#### 4-2-7. 作業メモ入力欄

**目的**: 作業に関する自由記述

**機能**:
- 複数行入力可能
- 文字数制限なし（ただし、システムの制限内）

**UI/UXのポイント**:
- テキストエリアで入力
- プレースホルダーで入力例を表示

#### 4-2-8. 一時保存ボタン

**目的**: 現在の入力内容を保存（自動保存も実施）

**UI/UXのポイント**:
- 保存成功時にトースト通知
- オフライン時も保存可能（ローカルストレージ）
- 自動保存も実施（30秒ごと、または項目変更時）

#### 4-2-9. 作業完了ボタン

**目的**: 作業を完了し、フロントスタッフに通知

**UI/UXのポイント**:
- Before/After写真が撮影されていない場合、警告を表示（メニューに応じて）
- 動作確認が未完了の場合、警告を表示（推奨）
- 確認ダイアログを表示
- 完了後、フロントスタッフに通知
- ステータスを「作業完了」に更新

### 4-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 診断結果を取得（Zoho CRM）
   ↓
4. 測定値を取得（Zoho CRM）
   ↓
5. 見積内容を取得（Zoho CRM）
   ↓
6. 作業記録を表示（既存の記録がある場合）
   ↓
7. 整備士が作業記録を入力
   ↓
8. Before/After写真を撮影
   ↓
9. 自動保存（30秒ごと、または項目変更時）
   ↓
10. 作業完了ボタンをタップ
   ↓
11. 作業記録を保存（Zoho CRM）
   ↓
12. 写真をアップロード（Google Drive）
   ↓
13. フロントスタッフに通知
   ↓
14. ステータスを「作業完了」に更新
```

### 4-4. インタラクション設計

#### 4-4-1. 作業記録入力

- **交換部品**: 見積画面から自動で引き継ぎ（編集可能）
- **動作確認**: チェックボックスで選択（メニューに応じて動的）

#### 4-4-2. 写真撮影

- **タップ**: カメラを起動
- **撮影**: 写真を撮影
- **確認**: 撮影後、確認画面を表示（再撮影可能）
- **保存**: 確認後、写真を保存（Google Drive）
- **表示**: 撮影済みの場合、サムネイルを表示
- **拡大**: サムネイルをタップすると拡大表示
- **削除**: 写真を削除（確認ダイアログ表示）

#### 4-4-3. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示
- **写真アップロードエラー**: エラーメッセージを表示、再アップロードボタンを表示

### 4-5. 状態管理

- **ローディング**: 車両情報取得中、作業記録保存中、写真アップロード中
- **エラー**: ネットワークエラー、保存エラー、写真アップロードエラー
- **成功**: 作業完了、フロントスタッフへの通知完了

---

## 5. データモデル

### 5-1. メンテナンスメニュー設定

```typescript
/**
 * メンテナンスメニュー種別
 */
export type MaintenanceType =
  | "バッテリー交換"
  | "ブレーキフルード交換"
  | "エアフィルター交換"
  | "クーラント交換"
  | "スパークプラグ交換"
  | "ベルト類交換"
  | "ワイパー交換"
  | "ブレーキパッド交換"
  | "ブレーキローター交換"
  | "オイルフィルター交換"
  | "キャビンフィルター交換"
  | "ラジエーターキャップ交換";

/**
 * メンテナンスメニュー設定
 */
export interface MaintenanceMenuConfig {
  /** メニュー名 */
  name: MaintenanceType;
  /** 所要時間（分） */
  duration: number;
  /** 検査項目 */
  inspectionItems: InspectionItem[];
  /** 測定値フィールド */
  measurementFields: MeasurementField[];
  /** 写真撮影が必要か */
  requiresPhoto: boolean;
  /** 動作確認項目 */
  operationCheckItems: OperationCheckItem[];
}

/**
 * 検査項目
 */
export interface InspectionItem {
  /** 項目ID */
  id: string;
  /** 項目名 */
  name: string;
  /** カテゴリ */
  category: string;
  /** 状態選択肢 */
  conditions: string[];
  /** 必須か */
  required: boolean;
}

/**
 * 測定値フィールド
 */
export interface MeasurementField {
  /** フィールドID */
  id: string;
  /** フィールド名 */
  name: string;
  /** 単位 */
  unit: string;
  /** 必須か */
  required: boolean;
  /** 最小値 */
  min?: number;
  /** 最大値 */
  max?: number;
}

/**
 * 動作確認項目
 */
export interface OperationCheckItem {
  /** 項目ID */
  id: string;
  /** 項目名 */
  name: string;
  /** 必須か */
  required: boolean;
}
```

### 5-2. メンテナンスジョブデータ

```typescript
/**
 * メンテナンスジョブ
 */
export interface MaintenanceJob {
  /** Job ID */
  jobId: string;
  /** 入庫区分 */
  serviceKind: "その他のメンテナンス";
  /** メンテナンスメニュー */
  maintenanceType: MaintenanceType;
  
  /** 車両情報 */
  vehicle: {
    /** 車両ID */
    vehicleId: string;
    /** 走行距離 */
    mileage: number;
  };
  
  /** 診断情報 */
  diagnosis: {
    /** 検査項目の結果 */
    inspectionResults: InspectionResult[];
    /** 測定値 */
    measurements: Record<string, number>;
    /** 診断写真 */
    photos: Photo[];
    /** コメント（整備士の所見） */
    comments: string;
  };
  
  /** 見積情報 */
  estimate: {
    /** 部品 */
    parts: PartItem[];
    /** 工賃 */
    labor: number;
    /** 合計 */
    total: number;
    /** 事前見積（メール等で送信済み） */
    preEstimate?: {
      parts: PartItem[];
      labor: number;
      total: number;
    };
    /** 承認日時 */
    approvedAt?: Date;
  };
  
  /** 作業情報 */
  work: {
    /** 交換部品 */
    replacedParts: ReplacedPart[];
    /** Before写真 */
    beforePhotos: Photo[];
    /** After写真 */
    afterPhotos: Photo[];
    /** 動作確認結果 */
    operationCheck: Record<string, boolean>;
    /** 作業メモ */
    notes: string;
    /** 作業完了日時 */
    completedAt?: Date;
  };
  
  /** ステータス */
  status: "入庫待ち" | "診断中" | "見積作成待ち" | "顧客承認待ち" | "作業待ち" | "作業中" | "作業完了" | "出庫待ち";
}

/**
 * 検査結果
 */
export interface InspectionResult {
  /** 項目ID */
  itemId: string;
  /** 項目名 */
  itemName: string;
  /** 状態 */
  condition: string;
  /** 写真 */
  photo?: Photo;
  /** コメント */
  comment?: string;
}

/**
 * 部品項目
 */
export interface PartItem {
  /** 部品ID */
  partId?: string;
  /** 部品名 */
  name: string;
  /** メーカー */
  manufacturer: string;
  /** 型番 */
  modelNumber: string;
  /** 数量 */
  quantity: number;
  /** 単価 */
  unitPrice: number;
  /** 金額 */
  amount: number;
}

/**
 * 交換部品
 */
export interface ReplacedPart {
  /** 部品名 */
  name: string;
  /** メーカー */
  manufacturer: string;
  /** 型番 */
  modelNumber: string;
  /** 数量 */
  quantity: number;
}
```

---

## 6. API設計

### 6-1. メニュー設定取得API

**エンドポイント**: `GET /api/maintenance/menus`

**レスポンス**:
```typescript
{
  menus: MaintenanceMenuConfig[];
}
```

### 6-2. 診断結果の保存API

**エンドポイント**: `POST /api/jobs/[id]/diagnosis`

**リクエストボディ**:
```typescript
{
  maintenanceType: MaintenanceType;
  inspectionResults: InspectionResult[];
  measurements: Record<string, number>;
  photos: Photo[];
  comments: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 6-3. 見積内容の保存API

**エンドポイント**: `POST /api/jobs/[id]/estimate`

**リクエストボディ**:
```typescript
{
  parts: PartItem[];
  labor: number;
  total: number;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 6-4. 作業記録の保存API

**エンドポイント**: `POST /api/jobs/[id]/work`

**リクエストボディ**:
```typescript
{
  replacedParts: ReplacedPart[];
  beforePhotos: Photo[];
  afterPhotos: Photo[];
  operationCheck: Record<string, boolean>;
  notes: string;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 6-5. 写真アップロードAPI

**エンドポイント**: `POST /api/photos/upload`

**リクエスト**: FormData（multipart/form-data）

**レスポンス**:
```typescript
{
  success: boolean;
  photoId: string;
  photoUrl: string;
  googleDriveFileId: string;
}
```

---

## 7. ユーザージャーニー

### 7-1. パターンBのフロー（事前見積→了承→入庫→作業）

```
【予約時】
1. 顧客がその他のメンテナンスを予約
2. フロントスタッフがメール等で見積もりを送信
   - メニューを選択（バッテリー交換など）
   - 部品代・工賃の見積もり
3. 顧客が了承
4. 部品を発注・用意（または部品持ち込みの場合もある）
5. 入庫日を確定

【入庫当日】
6. フロントスタッフが受付
   - 走行距離を入力
   - 車両情報を確認
   - メニューを選択（受付時または診断開始時）
   - ステータスを「診断中」に更新

7. 整備士が診断画面を開く
   - 車両情報を確認（自動入力済み）
   - メニューを選択（受付時または診断開始時）
   - メニュー設定を取得（マスタデータ）
   - 簡易検査を実施（メニューに応じて動的）
   - 測定値を入力（メニューに応じて動的）
   - 必要に応じて写真を撮影
   - 「診断完了」ボタンをタップ
   - ステータスを「見積作成待ち」に更新

8. フロントスタッフが見積画面を開く
   - 事前見積を確認（メール等で送信済み）
   - 部品・工賃を入力（簡易）
   - 「確認」ボタンをタップ
   - ステータスを「顧客承認待ち」に更新（簡易、確認のみ）
   - ステータスを「作業待ち」に更新

9. 整備士が作業画面を開く
   - 診断結果を確認（参考用）
   - 測定値を確認（参考用）
   - 見積内容を確認（参考用）
   - 作業を実施
   - 作業記録を入力
     - 交換部品の記録（見積画面から自動引き継ぎ）
     - 動作確認（メニューに応じて動的）
   - Before写真を撮影（必要に応じて）
   - After写真を撮影（必要に応じて）
   - 作業メモを入力（必要に応じて）
   - 「作業完了」ボタンをタップ
   - ステータスを「作業完了」に更新
   - フロントスタッフに通知

10. フロントスタッフが引渡し・説明
    - 作業内容を確認
    - 顧客に説明
    - 次回交換時期の案内
    - ステータスを「出庫待ち」に更新

11. 出庫完了
    - ステータスを「完了」に更新
```

### 7-2. 各画面でのユーザー操作の詳細

#### 7-2-1. 診断画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 既存の診断結果がある場合、自動で読み込まれる

2. **メニューを選択**
   - メニューを選択（受付時または診断開始時）
   - メニュー設定を取得（マスタデータ）
   - 検査項目・測定値フィールドが動的に表示

3. **簡易検査を実施**
   - 各項目の状態を選択（メニューに応じて動的）
   - 必要に応じて写真を撮影
   - コメントを入力

4. **測定値を入力**
   - メニューに応じた測定値を入力（メニューに応じて動的）
   - 測定値が不要なメニューは、このステップをスキップ

5. **診断完了**
   - 「診断完了」ボタンをタップ
   - 確認ダイアログを表示（任意）
   - 診断結果を保存
   - 見積画面への遷移を可能にする

#### 7-2-2. 見積画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 診断結果が自動で表示される（参考用）
   - 事前見積が自動で表示される（メール等で送信済み）

2. **部品・工賃を入力**
   - 部品を追加（適合部品を自動提案）
   - メーカー・型番・数量・単価を入力
   - 工賃を入力
   - 合計金額を自動計算

3. **確認**
   - 「確認」ボタンをタップ
   - 見積内容を保存
   - ステータスを「顧客承認待ち」に更新（簡易、確認のみ）
   - ステータスを「作業待ち」に更新

#### 7-2-3. 作業画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 診断結果が自動で表示される（参考用）
   - 測定値が自動で表示される（参考用）
   - 見積内容が自動で表示される（参考用）
   - 既存の作業記録がある場合、自動で読み込まれる

2. **作業記録を入力**
   - 交換部品を確認・編集（見積画面から自動引き継ぎ）
   - 動作確認を実施（メニューに応じて動的）

3. **Before/After写真を撮影**
   - Before写真を撮影（必要に応じて）
   - After写真を撮影（必要に応じて）
   - 写真を確認・削除（必要に応じて）

4. **作業メモを入力**
   - 作業に関する自由記述を入力

5. **作業完了**
   - 「作業完了」ボタンをタップ
   - Before/After写真が撮影されていない場合、警告を表示（メニューに応じて）
   - 動作確認が未完了の場合、警告を表示（推奨）
   - 確認ダイアログを表示
   - 作業記録を保存
   - 写真をアップロード
   - フロントスタッフに通知

---

## 8. メニュー設定マスタの例

### 8-1. バッテリー交換の設定例

```typescript
{
  name: "バッテリー交換",
  duration: 60, // 分
  inspectionItems: [
    {
      id: "battery_voltage",
      name: "バッテリー電圧",
      category: "電気系統",
      conditions: ["正常", "注意", "要交換"],
      required: true
    },
    {
      id: "terminal_condition",
      name: "端子の状態",
      category: "電気系統",
      conditions: ["正常", "腐食", "緩み", "要交換"],
      required: true
    },
    {
      id: "charge_condition",
      name: "充電状態",
      category: "電気系統",
      conditions: ["正常", "不足", "要交換"],
      required: true
    }
  ],
  measurementFields: [
    {
      id: "voltage",
      name: "電圧",
      unit: "V",
      required: true,
      min: 0,
      max: 20
    },
    {
      id: "cca",
      name: "CCA",
      unit: "A",
      required: false,
      min: 0,
      max: 1000
    }
  ],
  requiresPhoto: true,
  operationCheckItems: [
    {
      id: "engine_start",
      name: "エンジン始動確認",
      required: true
    },
    {
      id: "charge_status",
      name: "充電状態確認",
      required: true
    }
  ]
}
```

### 8-2. ブレーキフルード交換の設定例

```typescript
{
  name: "ブレーキフルード交換",
  duration: 60, // 分
  inspectionItems: [
    {
      id: "fluid_color",
      name: "フルードの色",
      category: "ブレーキ系統",
      conditions: ["正常", "汚れ", "要交換"],
      required: true
    },
    {
      id: "fluid_amount",
      name: "フルードの量",
      category: "ブレーキ系統",
      conditions: ["正常", "不足", "過多"],
      required: true
    },
    {
      id: "contamination",
      name: "汚れ具合",
      category: "ブレーキ系統",
      conditions: ["正常", "軽微", "深刻", "要交換"],
      required: true
    }
  ],
  measurementFields: [
    {
      id: "moisture_content",
      name: "水分含有率",
      unit: "%",
      required: false,
      min: 0,
      max: 100
    },
    {
      id: "boiling_point",
      name: "沸点",
      unit: "℃",
      required: false,
      min: 0,
      max: 300
    }
  ],
  requiresPhoto: true,
  operationCheckItems: [
    {
      id: "brake_pedal",
      name: "ブレーキペダルの踏み応え確認",
      required: true
    },
    {
      id: "brake_effectiveness",
      name: "ブレーキ効き確認",
      required: true
    }
  ]
}
```

---

## 9. 実装の優先順位

### Phase 1: MVP（最小限の機能）

1. **メニュー選択機能**
   - メニュー選択UI
   - メニュー設定マスタの読み込み

2. **診断画面の基本機能**
   - メニューに応じた検査項目の動的表示
   - 状態の選択（正常/注意/要交換）
   - 測定値の入力（メニューに応じて動的）
   - データの保存

3. **見積画面の基本機能**
   - 部品選択・工賃入力
   - 合計金額の自動計算
   - データの保存

4. **作業画面の基本機能**
   - 作業記録の入力（メニューに応じて動的）
   - Before/After写真の撮影
   - 動作確認（メニューに応じて動的）
   - データの保存

### Phase 2: 拡張機能

1. **メニュー設定マスタの管理**
   - メニュー設定の追加・編集機能

2. **写真機能の強化**
   - 写真の拡大表示
   - 写真の削除機能

3. **自動保存機能**
   - 30秒ごとの自動保存
   - オフライン対応

### Phase 3: 高度な機能

1. **通知機能**
   - フロントスタッフへの通知

2. **レポート機能**
   - 顧客向けレポート画面での表示

3. **前回交換履歴の表示**
   - 前回交換日・走行距離の表示

---

## 更新履歴

- 2025-01-XX: 初版作成（詳細画面設計書）

























