# ユーザージャーニー説明書

## 概要

このドキュメントでは、整備士がシステムを使用する際のユーザージャーニーを説明します。

## 基本フロー

### 1. トップページ（ジョブカード一覧）

整備士は最初にトップページでジョブカード一覧を確認します。

**ジョブカードの種類：**
- **単体作業**: 1つの作業のみ（例：車検のみ、オイル交換のみ）
- **複合作業**: 複数の作業が含まれる（例：車検 + 板金修理）

**ジョブカードの表示内容：**
- 顧客名・車両情報
- 入庫日時
- ステータス（入庫待ち、入庫済み、診断中、作業待ちなど）
- 作業内容（単体の場合は1つ、複合の場合は複数表示）

---

## パターン1: 単体作業の場合

### シナリオ: 車検のみの予約

**1. トップページ**
- ジョブカードに「車検」と表示
- ステータス: 「入庫済み」
- ボタン: 「受入点検を開始」

**2. ジョブカードをクリック**
- `/mechanic/diagnosis/{jobId}` に遷移
- 診断画面が表示される

**3. 診断画面**
- 受入点検の項目を入力
- 追加見積が必要な場合は「追加見積」セクションに入力
- 「保存」ボタンで保存

**4. 診断完了後**
- 「見積作成待ち」ステータスに変更
- 事務員が見積を作成

**5. 見積承認後**
- 「作業待ち」ステータスに変更
- 整備士が作業画面で作業を記録

**6. 作業完了後**
- 「出庫待ち」ステータスに変更
- 顧客に引渡し

---

## パターン2: 複合作業の場合（予約時点で複数）

### シナリオ: 車検 + 板金修理の予約

**1. トップページ**
- ジョブカードに「車検」「板金・塗装」と表示
- ステータス: 「入庫済み」
- ボタン: 「受入点検を開始」

**2. ジョブカードをクリック**
- `/mechanic/diagnosis/{jobId}` に遷移
- **作業グループ一覧（WorkOrderList）が表示される**
  - 「車検」（診断中）
  - 「板金・塗装」（外注調整中）

**3. 診断画面での操作**

**3-1. 車検を選択した場合**
- 車検の診断項目を入力
- 追加見積が必要な場合は「追加見積」セクションに入力
- 「保存」ボタンで保存

**3-2. 板金・塗装を選択した場合**
- 板金・塗装の診断項目を入力
- **外注先管理UI（VendorStatusManager）が表示される**
  - 外注先名・連絡先を入力
  - ステータスを更新（外注調整中 → 外注見積待ち → 外注作業中 → 完了）

**4. 各作業の進捗管理**
- 各作業グループは独立してステータス管理される
- 車検が「診断中」でも、板金修理が「外注作業中」でも問題ない
- 全体のステータスは、最も遅い作業グループのステータスに基づく

**5. すべての作業が完了したら**
- すべての作業グループが「完了」になったら、納車可能
- 統合請求書を発行

---

## パターン3: 単体作業から複合作業に変更（途中で追加）

### シナリオ: 車検のみで予約 → 診断中に板金修理を追加

**1. トップページ（初期）**
- ジョブカードに「車検」と表示
- ステータス: 「入庫済み」
- ボタン: 「受入点検を開始」

**2. ジョブカードをクリック**
- `/mechanic/diagnosis/{jobId}` に遷移
- 診断画面が表示される（単体作業なのでWorkOrderListは表示されない）

**3. 診断中に追加作業を発見**
- 診断中に「左ドアにへこみあり」を発見
- 整備士が「＋ 作業グループを追加」ボタンをクリック
- ダイアログで「板金・塗装」を選択

**4. 作業グループ追加後**
- **WorkOrderListが表示される**
  - 「車検」（診断中）
  - 「板金・塗装」（診断中）← 新規追加

**5. 各作業を進める**
- 車検の診断を完了
- 板金・塗装の診断を完了
- 板金・塗装を外注先に依頼（VendorStatusManagerで管理）

**6. 以降はパターン2と同じ**

---

## パターン4: 複合作業の詳細フロー

### シナリオ: 車検 + 板金修理（外注あり）

**1. トップページ**
- ジョブカードに「車検」「板金・塗装」と表示

**2. 診断画面**
- WorkOrderListが表示される
- 「車検」を選択 → 車検の診断を入力
- 「板金・塗装」を選択 → 板金の診断を入力、外注先情報を入力

**3. 見積作成**
- 事務員が各作業グループの見積を作成
- 車検: ¥66,000
- 板金修理: ¥50,000（外注先からの見積もりを反映）

**4. 顧客承認**
- 顧客が両方の見積を承認

**5. 作業開始**
- 車検: 自社で作業開始
- 板金修理: 外注先に依頼（VendorStatusManagerでステータス管理）

**6. 作業完了**
- 車検: 完了
- 板金修理: 外注先から完了報告 → ステータスを「完了」に更新

**7. 納車**
- すべての作業が完了したら納車可能
- 統合請求書を発行（車検 + 板金修理の合計）

---

## 重要なポイント

### 1. 作業グループの独立性
- 各作業グループ（WorkOrder）は独立してステータス管理される
- 1つの作業が「診断中」でも、別の作業が「作業中」でも問題ない

### 2. 全体ステータスの決定
- ジョブ全体のステータスは、最も遅い作業グループのステータスに基づく
- 例：車検が「完了」でも、板金修理が「外注作業中」なら、全体は「作業中」

### 3. 納車条件
- すべての作業グループが「完了」になったら納車可能
- 1つでも未完了の作業があれば納車できない

### 4. 外注管理
- 外注作業の場合は、VendorStatusManagerで外注先のステータスを管理
- 外注先からの見積もり受領日、作業完了日を記録

### 5. 作業グループの追加
- 診断中や作業中でも、いつでも作業グループを追加可能
- 「＋ 作業グループを追加」ボタンから追加

---

## UIの表示ルール

### WorkOrderListの表示条件
- **表示される**: 作業グループが2つ以上ある場合
- **表示されない**: 作業グループが1つのみの場合

### VendorStatusManagerの表示条件
- **表示される**: 選択中の作業グループが以下のいずれかに該当する場合
  - ステータスが「外注調整中」「外注見積待ち」「外注作業中」
  - または、`vendor`情報が設定されている
- **表示されない**: 上記以外の場合

---

## 画面遷移の流れ

```
トップページ（ジョブカード一覧）
    ↓
ジョブカードをクリック
    ↓
┌─────────────────────────────────┐
│ 単体作業の場合                  │
│ → 診断画面（WorkOrderListなし） │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 複合作業の場合                  │
│ → 診断画面（WorkOrderList表示）│
│ → 作業グループを選択            │
│ → 選択した作業の診断を入力      │
└─────────────────────────────────┘
    ↓
見積作成（事務員）
    ↓
顧客承認
    ↓
作業画面（整備士）
    ↓
納車
```

---

## よくある質問

### Q1: 複合作業の場合、どの作業から始めればいい？
**A:** どの作業から始めても構いません。各作業は独立して管理されるため、並行して進めることも可能です。

### Q2: 途中で作業を追加した場合、既存の作業に影響はある？
**A:** 影響はありません。既存の作業はそのまま続行でき、新しく追加した作業も独立して管理されます。

### Q3: 外注作業の進捗はどうやって確認する？
**A:** 板金・塗装などの外注作業を選択すると、VendorStatusManagerが表示され、外注先のステータスを確認・更新できます。

### Q4: すべての作業が完了する前に納車できる？
**A:** できません。すべての作業グループが「完了」になるまで、納車（チェックアウト）はできません。

---

## まとめ

- **単体作業**: 通常のワークフロー通り
- **複合作業**: WorkOrderListで作業グループを選択して進める
- **途中追加**: いつでも作業グループを追加可能
- **外注管理**: VendorStatusManagerで外注先のステータスを管理
- **納車条件**: すべての作業が完了したら納車可能

