# 故障診断 画面設計書

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.1
- **対象**: 故障診断の各画面の詳細設計
- **設計方針**: 世界最高のUI/UX、ITコンサルの目線での推奨を元に設計
- **業務フローパターン**: パターンA（入庫→診断→見積→承認→作業）
- **注意**: 症状カテゴリ選択により検査項目が動的に変化、診断機の利用有無、動画・音声撮影対応

---

## 複数作業管理対応

この画面設計書は、1つの入庫に対して複数の作業を管理する「複数作業管理」に対応しています。

**対応内容**:
- 各画面は特定のワークオーダー（作業）に対応
- URLパラメータ `workOrderId` で対象ワークオーダーを識別
- 画面ヘッダーに現在の作業名を表示
- 「他の作業を表示」ボタンで同じJobの他のワークオーダーに切替可能
- データはZoho CRM `field_work_orders` フィールドに作業ごとに保存
- **故障診断から修理・整備への移行**: 故障診断の診断結果を引き継いで、修理・整備のワークオーダーを追加可能

**詳細は [統合仕様書](./INTEGRATED_SPECIFICATION.md) の「2-4. 複数作業管理の実装」を参照してください。**

---

## 1. 画面一覧

### 1-1. 整備士向け画面

1. **診断画面** (`/mechanic/diagnosis/[id]`)
   - 症状カテゴリの選択
   - 検査項目の入力（カテゴリに応じて動的）
   - 診断機の利用選択
   - 測定値の入力（補助的）
   - 動画・音声撮影（ケースバイケース）
   - 写真撮影

2. **見積画面** (`/admin/estimate/[id]`)
   - 原因の説明（写真・動画・音声を紐付け）
   - 診断機費用の表示（診断機を使用した場合）
   - 診断機結果PDFの表示・ダウンロード（診断機を使用した場合）
   - 修理方法の提案（複数の選択肢がある場合）
   - 部品代・工賃の見積もり

3. **作業画面** (`/mechanic/work/[id]`)
   - 作業記録の入力
   - Before/After写真の撮影
   - 交換部品の記録
   - 動作確認の結果

### 1-2. フロントスタッフ向け画面

1. **受付画面** (`/admin/reception/[id]`)
   - 不具合情報の入力
   - エラーランプの有無・種類の選択
   - 走行距離の入力

### 1-3. 特徴

- **症状カテゴリ選択**: エンジン不調、ブレーキ不調、異音、電装系不調、エアコン不調、エラーランプ、その他
- **動的UI**: 症状カテゴリ選択により、検査項目が動的に表示
- **診断機の利用**: 診断機を使用する場合とない場合がある（診断機を使用する場合は費用がかかる）
- **動画・音声撮影**: ケースバイケースで必要（任意）
- **そのまま帰る人や預ける人**: 診断結果によって、そのまま帰る場合と預ける場合がある
- **所要時間**: 1-3時間（診断機の利用有無により異なる）

---

## 2. 受付画面の詳細設計

### 2-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 故障診断受付            │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ │ 初度登録: H29.10                    │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🚨 不具合情報                            │
│ ┌─────────────────────────────────────┐ │
│ │ 不具合の詳細:                        │ │
│ │ ─────────────────────────────────── │ │
│ │                                     │ │
│ │  いつから不具合が発生していますか？  │ │
│ │  どんな症状ですか？                  │ │
│ │  頻度はどのくらいですか？            │ │
│ │  走行中・停止中・エンジン始動時など  │ │
│ │  どのタイミングで発生しますか？      │ │
│ │                                     │ │
│ │  （複数行入力可能）                  │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ ⚠️ エラーランプ                          │
│ ┌─────────────────────────────────────┐ │
│ │ エラーランプの有無:                  │ │
│ │ [ ] エラーランプが点灯している       │ │
│ │                                      │ │
│ │ エラーランプの種類（該当する場合）:  │ │
│ │ [エンジン ▼]                         │ │
│ │                                      │ │
│ │ （エラーランプが点灯している場合のみ │ │
│ │   種類を選択可能）                   │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📏 走行距離                              │
│ ┌─────────────────────────────────────┐ │
│ │ 現在の走行距離: [____] km            │ │
│ │                                      │ │
│ │ 前回整備履歴:                        │ │
│ │ 2024年5月: オイル交換（15,000km）   │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [一時保存] [受付完了]                    │
└─────────────────────────────────────────┘
```

### 2-2. コンポーネント設計

#### 2-2-1. 車両情報カード

**目的**: 受付対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**:
- 依頼者(使用者)の氏名又は名称
- 車名及び型式
- 自動車登録番号又は車両番号
- 原動機の型式
- 初度登録年又は初度検査年
- 車台番号

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

**UI/UXのポイント**:
- 背景色を薄くして、編集不可であることを視覚的に示す
- アイコン（🔒）で編集不可であることを示す

#### 2-2-2. 不具合情報入力欄

**目的**: 顧客から聞いた不具合の詳細を記録

**入力項目**:
- 不具合の詳細（複数行入力可能）
  - いつから不具合が発生しているか
  - どんな症状か
  - 頻度はどのくらいか
  - 走行中・停止中・エンジン始動時など、どのタイミングで発生するか

**UI/UXのポイント**:
- テキストエリアで入力（複数行入力可能）
- プレースホルダーで入力例を表示
- 文字数制限なし（ただし、システムの制限内）
- 音声入力に対応（将来の拡張）

#### 2-2-3. エラーランプ選択セクション

**目的**: エラーランプの有無・種類を記録

**選択項目**:
- エラーランプの有無（チェックボックス）
- エラーランプの種類（エラーランプが点灯している場合のみ選択可能）
  - エンジン
  - ABS
  - エアバッグ
  - バッテリー
  - その他

**UI/UXのポイント**:
- チェックボックスでエラーランプの有無を選択
- エラーランプが点灯している場合のみ、種類を選択可能
- ドロップダウンで種類を選択
- エラーランプがある場合は、診断機での読み取りを推奨（診断画面で表示）

#### 2-2-4. 走行距離入力欄

**目的**: 現在の走行距離を記録

**入力項目**:
- 現在の走行距離（km）

**UI/UXのポイント**:
- 数字キーパッドを表示（テンキー）
- 前回整備履歴を表示（参考情報）
- 走行距離の異常値をチェック（リアルタイムバリデーション）

#### 2-2-5. 一時保存ボタン

**目的**: 現在の入力内容を保存（自動保存も実施）

**UI/UXのポイント**:
- 保存成功時にトースト通知（邪魔にならない程度に）
- オフライン時も保存可能（ローカルストレージ）
- 自動保存も実施（30秒ごと、または項目変更時）

#### 2-2-6. 受付完了ボタン

**目的**: 受付を完了し、診断画面への遷移を可能にする

**UI/UXのポイント**:
- 不具合情報が未入力の場合、警告を表示
- 走行距離が未入力の場合、警告を表示
- 確認ダイアログを表示（任意）
- 完了後、診断画面への遷移を可能にする
- ステータスを「診断中」に更新

### 2-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 前回整備履歴を取得（Zoho CRM）
   ↓
4. 既存の受付情報を取得（Zoho CRM）
   ↓
5. フロントスタッフが不具合情報を入力
   ↓
6. エラーランプの有無・種類を選択
   ↓
7. 走行距離を入力
   ↓
8. 自動保存（30秒ごと、または項目変更時）
   ↓
9. 受付完了ボタンをタップ
   ↓
10. 受付情報を保存（Zoho CRM）
   ↓
11. ステータスを「診断中」に更新
   ↓
12. 診断画面への遷移を可能にする
```

### 2-4. インタラクション設計

#### 2-4-1. 不具合情報入力

- **タップ**: テキストエリアにフォーカス
- **入力**: テキストを入力
- **音声入力**: 音声入力に対応（将来の拡張）

#### 2-4-2. エラーランプ選択

- **チェック**: エラーランプの有無を選択
- **選択後**: エラーランプが点灯している場合のみ、種類を選択可能
- **変更**: チェックを外すと、種類の選択も無効化

#### 2-4-3. 走行距離入力

- **タップ**: 数字キーパッドを表示
- **入力**: 数値を入力
- **バリデーション**: リアルタイムで異常値をチェック

#### 2-4-4. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示

### 2-5. 状態管理

- **ローディング**: 車両情報取得中、受付情報保存中
- **エラー**: ネットワークエラー、保存エラー
- **成功**: 受付完了、診断画面への遷移可能

---

## 3. 診断画面の詳細設計

### 3-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 故障診断               │
│ 整備士: 中村                             │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🚨 不具合情報（受付画面から引き継ぎ）     │
│ ┌─────────────────────────────────────┐ │
│ │ 不具合の詳細:                        │ │
│ │ エンジンがかからない。               │ │
│ │ 昨日から発生。                       │ │
│ │                                      │ │
│ │ エラーランプ: [エンジン]             │ │
│ │ 走行距離: 25,000km                  │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 症状カテゴリ選択                      │
│ ┌─────────────────────────────────────┐ │
│ │ 症状カテゴリ:                        │ │
│ │ [エンジン不調 ▼]                     │ │
│ │                                      │ │
│ │ （選択可能なカテゴリ）                │ │
│ │ - エンジン不調                        │ │
│ │ - ブレーキ不調                        │ │
│ │ - 異音                                │ │
│ │ - 電装系不調                          │ │
│ │ - エアコン不調                        │ │
│ │ - エラーランプ                        │ │
│ │ - その他                              │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 診断機の利用                          │
│ ┌─────────────────────────────────────┐ │
│ │ 診断機を使用しますか？               │ │
│ │ [ ] 診断機を使用する                 │ │
│ │                                      │ │
│ │ （診断機を使用する場合）              │ │
│ │ 診断機費用: ¥5,000                   │ │
│ │ 診断機結果PDF: [アップロード]        │ │
│ │                                      │ │
│ │ [📄 診断機結果PDFを表示]             │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 検査項目（カテゴリに応じて動的）      │
│ 進捗: ████████░░ 4/5項目完了 (80%)    │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 【エンジン不調の場合】                │ │
│ │ 1. エンジン始動確認                   │ │
│ │ ─────────────────────────────────── │ │
│ │ 始動状態:                            │ │
│ │ [正常] [不調] [始動しない]          │ │
│ │                                      │ │
│ │ [📷 写真を追加] [🎥 動画を追加]     │ │
│ │ [💬 コメント]                        │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 2. バッテリー電圧確認                 │ │
│ │ ─────────────────────────────────── │ │
│ │ 電圧: [____] V                       │ │
│ │ 状態: [正常] [不足] [要交換]        │ │
│ │                                      │ │
│ │ [📷 写真を追加] [💬 コメント]       │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 3. スパークプラグ確認                 │ │
│ │ ─────────────────────────────────── │ │
│ │ 状態: [正常] [汚れ] [要交換]        │ │
│ │                                      │ │
│ │ [📷 写真を追加] [💬 コメント]       │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ （カテゴリに応じて検査項目が動的に表示） │
├─────────────────────────────────────────┤
│ 📏 測定値（補助的）                      │
│ ┌─────────────────────────────────────┐ │
│ │ 圧力: [____] kPa                    │ │
│ │ 電圧: [____] V                      │ │
│ │ 温度: [____] ℃                     │ │
│ │ 抵抗: [____] Ω                      │ │
│ │                                      │ │
│ │ （診断機を使用する場合は補助的）     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🎤 異音の録音（異音カテゴリの場合）      │
│ ┌─────────────────────────────────────┐ │
│ │ [🎤 録音を開始]                      │ │
│ │                                      │ │
│ │ [録音1] [録音2]                      │ │
│ │ （音声ファイル、再生可能）           │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💬 整備士の所見                          │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  原因の推測や所見を記録              │ │
│ │  （複数行入力可能）                  │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🎯 原因の推測                            │
│ ┌─────────────────────────────────────┐ │
│ │ [＋原因を追加]                       │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 原因1: バッテリー劣化            │ │ │
│ │ │ 確信度: [80] %                  │ │ │
│ │ │ [削除]                           │ │ │
│ │ └────────────────────────────────┘ │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 原因2: スパークプラグ劣化        │ │ │
│ │ │ 確信度: [60] %                  │ │ │
│ │ │ [削除]                           │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [一時保存] [診断完了]                    │
└─────────────────────────────────────────┘
```

### 3-2. コンポーネント設計

#### 3-2-1. 車両情報カード

**目的**: 診断対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**: 受付画面と同様

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

#### 3-2-2. 不具合情報表示

**目的**: 受付画面で入力した不具合情報を表示（参考用）

**表示内容**:
- 不具合の詳細
- エラーランプの有無・種類
- 走行距離

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す
- 受付画面から自動で引き継ぎ

#### 3-2-3. 症状カテゴリ選択セクション

**目的**: 症状カテゴリを選択し、検査項目を動的に表示

**選択可能なカテゴリ**:
1. エンジン不調
2. ブレーキ不調
3. 異音
4. 電装系不調
5. エアコン不調
6. エラーランプ
7. その他

**UI/UXのポイント**:
- ドロップダウンまたはラジオボタンで選択
- カテゴリ選択により、検査項目が動的に表示
- エラーランプがある場合は、「エラーランプ」カテゴリを推奨

#### 3-2-4. 診断機の利用セクション

**目的**: 診断機の利用有無を選択し、診断機結果を管理

**機能**:
- 診断機の利用有無を選択（チェックボックス）
- 診断機を使用する場合、診断機費用を表示
- 診断機結果PDFをアップロード
- 診断機結果PDFを表示・ダウンロード

**UI/UXのポイント**:
- チェックボックスで診断機の利用有無を選択
- 診断機を使用する場合のみ、診断機費用を表示
- 診断機結果PDFはGoogle Driveに保存
- 診断機結果PDFは表示・ダウンロード可能
- エラーランプがある場合は、診断機の利用を推奨（メッセージ表示）

#### 3-2-5. 検査項目カード（動的）

**目的**: 症状カテゴリに応じた検査項目の状態を入力

**カテゴリ別の検査項目例**:

**エンジン不調**:
- エンジン始動確認: 正常/不調/始動しない
- バッテリー電圧確認: 電圧（V）、状態（正常/不足/要交換）
- スパークプラグ確認: 状態（正常/汚れ/要交換）
- エンジンオイル確認: 状態（正常/不足/汚れ/要交換）
- エンジン音確認: 正常/異音/異常

**ブレーキ不調**:
- ブレーキペダルの踏み応え: 正常/柔らかい/硬い/沈む
- ブレーキ効き: 正常/効きが悪い/片効き
- ブレーキパッド残量: 正常/注意/要交換
- ブレーキフルード量: 正常/不足/過多

**異音**:
- 異音の種類: キーキー/ガタガタ/ゴロゴロ/その他
- 異音の発生箇所: エンジン/ブレーキ/サスペンション/その他
- 異音の発生条件: 走行中/停止中/エンジン始動時/その他

**電装系不調**:
- バッテリー電圧: 電圧（V）、状態（正常/不足/要交換）
- オルタネーター出力: 正常/不足/異常
- ヒューズ確認: 正常/断線/異常

**エアコン不調**:
- 冷房効き: 正常/効きが悪い/効かない
- 暖房効き: 正常/効きが悪い/効かない
- エアコンフィルター: 正常/汚れ/要交換

**エラーランプ**:
- エラーランプの種類: エンジン/ABS/エアバッグ/バッテリー/その他
- 診断機での読み取り: 必須（推奨）
- エラーコード: 診断機から取得

**その他**:
- 自由記述

**状態選択ボタンのデザイン**:
- **正常**: 緑色、チェックマークアイコン
- **注意/不調**: 黄色、警告アイコン
- **要交換/異常**: 赤色、Xアイコン

**UI/UXのポイント**:
- カテゴリ選択により、検査項目が動的に表示
- ボタンは画面幅いっぱいに配置（タッチしやすい）
- 選択された状態は明確に表示（背景色、アイコン）
- 写真ボタンは撮影済みの場合、サムネイルを表示
- 動画ボタンは撮影済みの場合、サムネイルを表示（異音カテゴリの場合）
- コメントがある場合、アイコンで表示
- 各項目は独立したカードとして表示（視認性向上）

#### 3-2-6. 測定値入力セクション（補助的）

**目的**: 一般的な測定値を入力（診断機を使用する場合は補助的）

**測定値例**:
- 圧力（kPa）
- 電圧（V）
- 温度（℃）
- 抵抗（Ω）

**UI/UXのポイント**:
- 診断機を使用する場合は補助的な役割
- 診断機を使用しない場合は主要な入力手段
- 数字キーパッドを表示（テンキー）
- 単位を明示（kPa、V、℃、Ωなど）
- 範囲チェック（リアルタイムバリデーション）

#### 3-2-7. 異音の録音セクション（異音カテゴリの場合）

**目的**: 異音を音声で録音

**機能**:
- 音声録音（動画は不要）
- 録音した音声ファイルの再生
- 録音した音声ファイルの削除

**UI/UXのポイント**:
- 異音カテゴリの場合のみ表示
- 音声録音ボタンは大きく表示（タッチしやすい）
- 録音中は視覚的に表示（録音中のアイコン、タイマー）
- 録音済みの音声ファイルは再生可能
- 音声ファイルはGoogle Driveに保存

#### 3-2-8. 整備士の所見入力欄

**目的**: 整備士の所見を記録

**機能**:
- 複数行入力可能
- 文字数制限なし（ただし、システムの制限内）

**UI/UXのポイント**:
- テキストエリアで入力
- プレースホルダーで入力例を表示

#### 3-2-9. 原因の推測セクション

**目的**: 原因の推測を記録

**機能**:
- 原因の追加（「＋原因を追加」ボタン）
- 原因の説明を入力
- 確信度を入力（%）
- 原因の削除

**UI/UXのポイント**:
- 複数の原因を追加可能
- 確信度はスライダーまたは数字入力
- 原因の説明はテキスト入力
- 原因の削除は確認ダイアログ表示

#### 3-2-10. 進捗バー

**目的**: 検査の進捗を可視化

**表示内容**:
- 完了項目数 / 全項目数（カテゴリに応じて動的）
- 進捗パーセンテージ
- プログレスバー（視覚的）

**UI/UXのポイント**:
- 色で進捗を表現（0-50%: 赤、50-80%: 黄、80-100%: 緑）
- 数値と視覚的表現の両方で進捗を表示
- カテゴリに応じて項目数が変動

#### 3-2-11. 一時保存ボタン

**目的**: 現在の入力内容を保存（自動保存も実施）

**UI/UXのポイント**:
- 保存成功時にトースト通知（邪魔にならない程度に）
- オフライン時も保存可能（ローカルストレージ）
- 自動保存も実施（30秒ごと、または項目変更時）

#### 3-2-12. 診断完了ボタン

**目的**: 診断を完了し、次のステップに進む

**UI/UXのポイント**:
- 全ての項目が完了していない場合、警告を表示（任意）
- 診断機を使用する場合、診断機結果PDFが未アップロードの場合、警告を表示（任意）
- 確認ダイアログを表示
- 完了後、次のステップを選択
  - **そのまま帰る場合**: 「診断完了（帰宅）」を選択
  - **預ける場合**: 「診断完了（預かり）」を選択
- ステータスを更新
- 見積画面への遷移を可能にする（預ける場合）

### 3-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 受付情報を取得（Zoho CRM）
   ↓
4. 既存の診断結果を取得（Zoho CRM）
   ↓
5. 症状カテゴリを選択
   ↓
6. カテゴリ設定を取得（マスタデータ）
   ↓
7. 検査項目を動的に表示
   ↓
8. 整備士が各項目の状態を選択
   ↓
9. 診断機の利用有無を選択
   ↓
10. 診断機結果PDFをアップロード（診断機を使用する場合）
   ↓
11. 測定値を入力（補助的）
   ↓
12. 動画・音声を撮影（ケースバイケース）
   ↓
13. 原因の推測を記録
   ↓
14. 自動保存（30秒ごと、または項目変更時）
   ↓
15. 診断完了ボタンをタップ
   ↓
16. 次のステップを選択（そのまま帰る/預ける）
   ↓
17. 診断結果を保存（Zoho CRM）
   ↓
18. 写真・動画・音声をアップロード（Google Drive）
   ↓
19. ステータスを更新
   ↓
20. 見積画面への遷移を可能にする（預ける場合）
```

### 3-4. インタラクション設計

#### 3-4-1. 症状カテゴリ選択

- **タップ**: ドロップダウンまたはラジオボタンで選択
- **選択後**: 検査項目が動的に表示
- **変更**: 別のカテゴリを選択すると、前のカテゴリの入力内容は保持（確認ダイアログ表示）

#### 3-4-2. 診断機の利用選択

- **チェック**: 診断機の利用有無を選択
- **選択後**: 診断機を使用する場合、診断機費用を表示、診断機結果PDFのアップロードを可能にする
- **アップロード**: 診断機結果PDFをアップロード（Google Driveに保存）

#### 3-4-3. 検査項目の状態選択

- **タップ**: 状態を選択
- **選択済み**: 背景色とアイコンで明確に表示
- **変更**: 別の状態をタップすると、前の選択が解除され、新しい状態が選択される

#### 3-4-4. 測定値入力

- **タップ**: 数字キーパッドを表示
- **入力**: 数値を入力
- **バリデーション**: リアルタイムで範囲チェック

#### 3-4-5. 写真撮影

- **タップ**: カメラを起動
- **撮影**: 写真を撮影
- **確認**: 撮影後、確認画面を表示（再撮影可能）
- **保存**: 確認後、写真を保存（Google Drive）
- **表示**: 撮影済みの場合、サムネイルを表示

#### 3-4-6. 動画撮影

- **タップ**: カメラを起動（動画モード）
- **撮影**: 動画を撮影
- **確認**: 撮影後、確認画面を表示（再撮影可能）
- **保存**: 確認後、動画を保存（Google Drive）
- **表示**: 撮影済みの場合、サムネイルを表示

#### 3-4-7. 音声録音

- **タップ**: 音声録音を開始
- **録音中**: 録音中のアイコン、タイマーを表示
- **停止**: 録音を停止
- **確認**: 録音後、確認画面を表示（再録音可能）
- **保存**: 確認後、音声ファイルを保存（Google Drive）
- **再生**: 録音済みの音声ファイルを再生可能

#### 3-4-8. 原因の推測追加

- **タップ**: 「＋原因を追加」ボタンをタップ
- **入力**: 原因の説明を入力
- **確信度**: 確信度を入力（%）
- **削除**: 原因を削除（確認ダイアログ表示）

#### 3-4-9. 診断完了後の選択

- **タップ**: 「診断完了」ボタンをタップ
- **選択**: 次のステップを選択
  - **そのまま帰る場合**: 「診断完了（帰宅）」を選択
  - **預ける場合**: 「診断完了（預かり）」を選択
- **完了**: 診断結果を保存、ステータスを更新

#### 3-4-10. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示
- **写真・動画・音声アップロードエラー**: エラーメッセージを表示、再アップロードボタンを表示
- **診断機結果PDFアップロードエラー**: エラーメッセージを表示、再アップロードボタンを表示

### 3-5. 状態管理

- **ローディング**: 車両情報取得中、診断結果保存中、写真・動画・音声アップロード中
- **エラー**: ネットワークエラー、保存エラー、アップロードエラー
- **成功**: 診断完了、見積画面への遷移可能（預ける場合）

---

## 4. 見積画面の詳細設計

### 4-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 故障診断見積            │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🚨 不具合情報（診断画面から引き継ぎ）     │
│ ┌─────────────────────────────────────┐ │
│ │ 不具合の詳細:                        │ │
│ │ エンジンがかからない。               │ │
│ │                                      │ │
│ │ 症状カテゴリ: エンジン不調           │ │
│ │ エラーランプ: エンジン               │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 診断結果（診断画面から引き継ぎ）      │
│ ┌─────────────────────────────────────┐ │
│ │ 診断機を使用: はい                   │ │
│ │ 診断機費用: ¥5,000                  │ │
│ │                                      │ │
│ │ [📄 診断機結果PDFを表示・ダウンロード]│ │
│ │                                      │ │
│ │ 原因の推測:                          │ │
│ │ 1. バッテリー劣化（確信度: 80%）    │ │
│ │ 2. スパークプラグ劣化（確信度: 60%）│ │
│ │                                      │ │
│ │ 整備士の所見:                        │ │
│ │ バッテリー電圧が低く、エンジンが     │ │
│ │ かからない状態。スパークプラグも     │ │
│ │ 劣化している可能性がある。          │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💰 原因の説明                            │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  診断結果に基づいた原因の説明を      │ │
│ │  記録。写真・動画・音声を紐付け可能。│ │
│ │                                     │ │
│ │  [📷 写真を追加] [🎥 動画を追加]    │ │
│ │  [🎤 音声を追加]                     │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 修理方法の提案                        │
│ ┌─────────────────────────────────────┐ │
│ │ [＋修理方法を追加]                   │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 【推奨】修理方法1: バッテリー交換│ │ │
│ │ │ 費用: ¥20,000                  │ │ │
│ │ │ 所要時間: 1時間                 │ │ │
│ │ │ 説明: バッテリーを交換して       │ │ │
│ │ │       エンジン始動を改善        │ │ │
│ │ │ [編集] [削除]                   │ │ │
│ │ └────────────────────────────────┘ │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ 【代替】修理方法2: バッテリー充電│ │ │
│ │ │ 費用: ¥5,000                   │ │ │
│ │ │ 所要時間: 30分                 │ │ │
│ │ │ 説明: バッテリーを充電して       │ │ │
│ │ │       一時的に改善              │ │ │
│ │ │ [編集] [削除]                   │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💰 見積内訳                              │
│ ┌─────────────────────────────────────┐ │
│ │ 診断機費用: ¥5,000                  │ │
│ │                                      │ │
│ │ 修理方法1（バッテリー交換）:         │ │
│ │ 部品代: ¥15,000                     │ │
│ │ 工賃:   ¥5,000                      │ │
│ │ ──────────────────────────────── │ │
│ │ 小計:   ¥20,000                     │ │
│ │                                      │ │
│ │ ──────────────────────────────── │ │
│ │ 合計:   ¥25,000                     │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [一時保存] [顧客に送信] [承認待ち]      │
└─────────────────────────────────────────┘
```

### 4-2. コンポーネント設計

#### 4-2-1. 車両情報カード

**目的**: 見積対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**: 診断画面と同様

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

#### 4-2-2. 不具合情報表示

**目的**: 診断画面で入力した不具合情報を表示（参考用）

**表示内容**:
- 不具合の詳細
- 症状カテゴリ
- エラーランプの有無・種類

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す
- 診断画面から自動で引き継ぎ

#### 4-2-3. 診断結果表示

**目的**: 診断画面で入力した診断結果を表示（参考用）

**表示内容**:
- 診断機の利用有無
- 診断機費用（診断機を使用した場合）
- 診断機結果PDF（診断機を使用した場合）
- 原因の推測
- 整備士の所見

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す
- 診断画面から自動で引き継ぎ
- 診断機結果PDFは表示・ダウンロード可能

#### 4-2-4. 原因の説明入力欄

**目的**: 診断結果に基づいた原因の説明を記録

**機能**:
- 複数行入力可能
- 写真・動画・音声を紐付け可能

**UI/UXのポイント**:
- テキストエリアで入力
- プレースホルダーで入力例を表示
- 写真・動画・音声を紐付け可能（診断画面から自動で引き継ぎ、追加も可能）

#### 4-2-5. 修理方法の提案セクション

**目的**: 複数の修理方法を提案

**機能**:
- 修理方法の追加（「＋修理方法を追加」ボタン）
- 修理方法の説明を入力
- 費用を入力
- 所要時間を入力
- 推奨度を選択（推奨/代替/任意）
- 修理方法の編集・削除

**UI/UXのポイント**:
- 複数の修理方法を追加可能
- 推奨度で色分け（推奨: 緑、代替: 黄、任意: グレー）
- 費用・所要時間は数字キーパッドを表示
- 修理方法の説明はテキスト入力
- 修理方法の削除は確認ダイアログ表示

#### 4-2-6. 見積内訳表示

**目的**: 見積内訳を明確に表示

**表示内容**:
- 診断機費用（診断機を使用した場合）
- 各修理方法の部品代・工賃
- 合計金額

**基幹システム連携フロー**:
1. アドバイザー（フロントスタッフ）がWebアプリの見積作成画面を開く
2. 診断結果を確認（整備士の診断結果と原因の推測を確認）
3. **基幹システム（スマートカーディーラー）で該当作業の見積書を作成**（アドバイザーが実施）
4. **Webアプリに「品名」と「金額（税込）」を転記**（アドバイザーが実施）
5. 見積情報を保存（Zoho CRM field_work_orders内の該当作業の見積情報を更新）

**制約**:
- 見積計算は基幹システムで実施（Webアプリは転記のみ）
- 診断機費用は診断画面から自動で引き継ぎ

**UI/UXのポイント**:
- 診断機費用を明示（診断機を使用した場合）
- 各修理方法の内訳を明示
- 合計金額を大きく表示
- 選択された修理方法のみを合計に含める（複数の選択肢がある場合）

#### 4-2-7. 一時保存ボタン

**目的**: 現在の入力内容を保存（自動保存も実施）

**UI/UXのポイント**:
- 保存成功時にトースト通知
- オフライン時も保存可能（ローカルストレージ）
- 自動保存も実施（30秒ごと、または項目変更時）

#### 4-2-8. 顧客に送信ボタン

**目的**: 見積もりを顧客に送信

**UI/UXのポイント**:
- 見積内容を確認
- 顧客に送信（メール等）
- 送信成功時にトースト通知

#### 4-2-9. 承認待ちボタン

**目的**: 見積内容を確定し、顧客承認を待つ

**UI/UXのポイント**:
- 見積内容を確認
- 確認ダイアログを表示
- 見積内容を保存
- ステータスを「顧客承認待ち」に更新
- 作業画面への遷移を可能にする

### 4-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 診断結果を取得（Zoho CRM）
   ↓
4. 既存の見積内容を取得（Zoho CRM）
   ↓
5. フロントスタッフが原因の説明を入力
   ↓
6. 修理方法を追加・編集
   ↓
7. 部品代・工賃を入力
   ↓
8. 合計金額を自動計算
   ↓
9. 自動保存（30秒ごと、または項目変更時）
   ↓
10. 顧客に送信または承認待ちボタンをタップ
   ↓
11. 見積内容を保存（Zoho CRM）
   ↓
12. ステータスを「顧客承認待ち」に更新
   ↓
13. 作業画面への遷移を可能にする
```

### 4-4. インタラクション設計

#### 4-4-1. 原因の説明入力

- **タップ**: テキストエリアにフォーカス
- **入力**: テキストを入力
- **写真・動画・音声の紐付け**: 診断画面から自動で引き継ぎ、追加も可能

#### 4-4-2. 修理方法の追加

- **タップ**: 「＋修理方法を追加」ボタンをタップ
- **入力**: 修理方法の説明、費用、所要時間を入力
- **推奨度**: 推奨度を選択
- **削除**: 修理方法を削除（確認ダイアログ表示）

#### 4-4-3. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示

### 4-5. 状態管理

- **ローディング**: 車両情報取得中、見積内容保存中
- **エラー**: ネットワークエラー、保存エラー
- **成功**: 見積内容確定、作業画面への遷移可能

---

## 5. 作業画面の詳細設計

### 5-1. 画面構成

#### レイアウト構造

```
┌─────────────────────────────────────────┐
│ [←] 田中様 BMW X3 故障診断作業            │
│ 整備士: 中村                             │
├─────────────────────────────────────────┤
│ 📋 車両情報（自動入力済み・編集不可）     │
│ ┌─────────────────────────────────────┐ │
│ │ 登録番号: 堺 330 す 1669            │ │
│ │ 車台番号: VF3CUHNZTHY061316         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔍 診断結果（診断画面から引き継ぎ）      │
│ ┌─────────────────────────────────────┐ │
│ │ 症状カテゴリ: エンジン不調           │ │
│ │ 原因の推測: バッテリー劣化           │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 💰 見積内容（見積画面から引き継ぎ）      │
│ ┌─────────────────────────────────────┐ │
│ │ 修理方法: バッテリー交換             │ │
│ │ 費用: ¥20,000                        │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📝 作業記録                              │
│ ┌─────────────────────────────────────┐ │
│ │ 実施した修理:                        │ │
│ │                                     │ │
│ │  バッテリーを交換しました。          │ │
│ │  エンジン始動を確認しました。        │ │
│ │                                     │ │
│ │  （複数行入力可能）                  │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 🔧 交換部品                              │
│ ┌─────────────────────────────────────┐ │
│ │ [＋部品を追加]                       │ │
│ │                                      │ │
│ │ ┌────────────────────────────────┐ │ │
│ │ │ バッテリー                      │ │ │
│ │ │ メーカー: [パナソニック]         │ │ │
│ │ │ 型番:    [55B24L]              │ │ │
│ │ │ 数量:    [1] 個                │ │ │
│ │ │ [削除]                           │ │ │
│ │ └────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 📸 Before/After写真                     │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ Before: 修理前の状態                │ │
│ │ [📷 写真を追加]                      │ │
│ │                                      │ │
│ │ [写真1] [写真2]                      │ │
│ │ （サムネイル表示、タップで拡大）     │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ After: 修理後の状態                 │ │
│ │ [📷 写真を追加]                     │ │
│ │                                      │ │
│ │ [写真1] [写真2]                      │ │
│ │ （サムネイル表示、タップで拡大）     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ ✅ 動作確認                              │
│ ┌─────────────────────────────────────┐ │
│ │ [✓] エンジン始動確認                 │ │
│ │ [✓] エンジン音確認                   │ │
│ │ [✓] エラーランプ消灯確認             │ │
│ │                                      │ │
│ │ （修理内容に応じて動的に表示）       │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [一時保存] [作業完了]                    │
└─────────────────────────────────────────┘
```

### 5-2. コンポーネント設計

#### 5-2-1. 車両情報カード

**目的**: 作業対象の車両情報を表示（誤操作防止のため編集不可）

**表示項目**: 診断画面と同様

**データソース**: Google Sheets「【DB】車両マスタ」から自動取得

#### 5-2-2. 診断結果表示

**目的**: 診断画面で入力した診断結果を表示（参考用）

**表示内容**:
- 症状カテゴリ
- 原因の推測

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す
- 診断画面から自動で引き継ぎ

#### 5-2-3. 見積内容表示

**目的**: 見積画面で入力した見積内容を表示（参考用）

**表示内容**:
- 修理方法
- 費用

**UI/UXのポイント**:
- 読み取り専用（編集不可）
- 背景色を薄くして、参考情報であることを示す
- 見積画面から自動で引き継ぎ

#### 5-2-4. 作業記録入力欄

**目的**: 実施した修理の詳細を記録

**機能**:
- 複数行入力可能
- 文字数制限なし（ただし、システムの制限内）

**UI/UXのポイント**:
- テキストエリアで入力
- プレースホルダーで入力例を表示

#### 5-2-5. 交換部品セクション

**目的**: 交換した部品を記録

**機能**:
- 部品の追加（「＋部品を追加」ボタン）
- メーカー・型番・数量の入力
- 部品の削除

**UI/UXのポイント**:
- 見積画面から自動で引き継ぎ（編集可能）
- メーカーはドロップダウン選択
- 型番はテキスト入力またはドロップダウン選択
- 数量は数字キーパッドを表示

#### 5-2-6. Before/After写真セクション

**目的**: 作業前後の写真を撮影・表示

**Before写真**:
- **目的**: 修理前の状態を記録
- **撮影タイミング**: 修理を開始する前
- **撮影枚数**: 1-3枚推奨

**After写真**:
- **目的**: 修理後の状態を記録
- **撮影タイミング**: 修理を完了した後
- **撮影枚数**: 1-3枚推奨

**UI/UXのポイント**:
- 写真ボタンは大きく表示（タッチしやすい）
- 撮影済みの場合、サムネイルを表示
- サムネイルをタップすると拡大表示
- 複数枚撮影可能
- 写真の削除機能

#### 5-2-7. 動作確認セクション

**目的**: 動作確認の結果を記録

**機能**:
- 修理内容に応じた動作確認項目を表示（動的）
- チェックボックスで確認結果を記録

**動作確認項目例**:
- エンジン始動確認
- エンジン音確認
- エラーランプ消灯確認
- ブレーキ効き確認
- エアコン効き確認

**UI/UXのポイント**:
- 修理内容に応じて動作確認項目が動的に表示
- チェックボックスで確認結果を記録
- 必須項目は明確に表示

#### 5-2-8. 一時保存ボタン

**目的**: 現在の入力内容を保存（自動保存も実施）

**UI/UXのポイント**:
- 保存成功時にトースト通知
- オフライン時も保存可能（ローカルストレージ）
- 自動保存も実施（30秒ごと、または項目変更時）

#### 5-2-9. 作業完了ボタン

**目的**: 作業を完了し、フロントスタッフに通知

**UI/UXのポイント**:
- Before/After写真が撮影されていない場合、警告を表示（推奨）
- 動作確認が未完了の場合、警告を表示（推奨）
- 確認ダイアログを表示
- 完了後、フロントスタッフに通知
- ステータスを「作業完了」に更新

### 5-3. データフロー

```
1. 画面読み込み
   ↓
2. 車両情報を取得（Google Sheets）
   ↓
3. 診断結果を取得（Zoho CRM）
   ↓
4. 見積内容を取得（Zoho CRM）
   ↓
5. 作業記録を表示（既存の記録がある場合）
   ↓
6. 整備士が作業記録を入力
   ↓
7. 交換部品を記録
   ↓
8. Before/After写真を撮影
   ↓
9. 動作確認を実施
   ↓
10. 自動保存（30秒ごと、または項目変更時）
   ↓
11. 作業完了ボタンをタップ
   ↓
12. 作業記録を保存（Zoho CRM）
   ↓
13. 写真をアップロード（Google Drive）
   ↓
14. フロントスタッフに通知
   ↓
15. ステータスを「作業完了」に更新
```

### 5-4. インタラクション設計

#### 5-4-1. 作業記録入力

- **タップ**: テキストエリアにフォーカス
- **入力**: テキストを入力

#### 5-4-2. 交換部品入力

- **追加**: 「＋部品を追加」ボタンをタップ
- **入力**: メーカー・型番・数量を入力
- **削除**: 部品を削除（確認ダイアログ表示）

#### 5-4-3. 写真撮影

- **タップ**: カメラを起動
- **撮影**: 写真を撮影
- **確認**: 撮影後、確認画面を表示（再撮影可能）
- **保存**: 確認後、写真を保存（Google Drive）
- **表示**: 撮影済みの場合、サムネイルを表示
- **拡大**: サムネイルをタップすると拡大表示
- **削除**: 写真を削除（確認ダイアログ表示）

#### 5-4-4. 動作確認

- **チェック**: チェックボックスで確認結果を記録
- **必須項目**: 必須項目は明確に表示

#### 5-4-5. エラーハンドリング

- **ネットワークエラー**: オフライン時はローカルストレージに保存、オンライン時に自動同期
- **保存エラー**: エラーメッセージを表示、再試行ボタンを表示
- **写真アップロードエラー**: エラーメッセージを表示、再アップロードボタンを表示

### 5-5. 状態管理

- **ローディング**: 車両情報取得中、作業記録保存中、写真アップロード中
- **エラー**: ネットワークエラー、保存エラー、写真アップロードエラー
- **成功**: 作業完了、フロントスタッフへの通知完了

---

## 6. データモデル

### 6-1. 故障診断ジョブデータ

```typescript
/**
 * 故障診断ジョブ
 */
export interface FaultDiagnosisJob {
  /** Job ID */
  jobId: string;
  /** 入庫区分 */
  serviceKind: "故障診断";
  
  /** 車両情報 */
  vehicle: {
    /** 車両ID */
    vehicleId: string;
    /** 走行距離 */
    mileage: number;
  };
  
  /** 不具合情報 */
  fault: {
    /** 不具合の詳細（顧客の説明） */
    description: string;
    /** 症状カテゴリ */
    symptomCategory: SymptomCategory;
    /** エラーランプの有無 */
    hasErrorLamp: boolean;
    /** エラーランプの種類 */
    errorLampType?: ErrorLampType;
  };
  
  /** 診断情報 */
  diagnosis: {
    /** 診断機の利用有無 */
    usesDiagnosticTool: boolean;
    /** 診断機費用 */
    diagnosticToolCost?: number;
    /** 診断機結果PDF URL */
    diagnosticToolResultUrl?: string;
    /** 検査項目の結果 */
    inspectionResults: InspectionResult[];
    /** 測定値 */
    measurements: Record<string, number>;
    /** 写真 */
    photos: Photo[];
    /** 動画 */
    videos: Video[];
    /** 音声 */
    audio: Audio[];
    /** コメント（整備士の所見） */
    comments: string;
    /** 原因の推測 */
    suspectedCauses: SuspectedCause[];
  };
  
  /** 見積情報 */
  estimate: {
    /** 原因の説明 */
    causeExplanation: string;
    /** 原因説明に紐づく写真・動画・音声 */
    causeMedia: {
      photos: Photo[];
      videos: Video[];
      audio: Audio[];
    };
    /** 修理方法の提案 */
    repairOptions: RepairOption[];
    /** 部品代・工賃の見積もり */
    parts: PartItem[];
    labor: number;
    /** 診断機費用 */
    diagnosticToolCost?: number;
    total: number;
    /** 承認日時 */
    approvedAt?: Date;
  };
  
  /** 作業情報 */
  work: {
    /** 実施した修理の記録 */
    repairRecords: string;
    /** Before写真 */
    beforePhotos: Photo[];
    /** After写真 */
    afterPhotos: Photo[];
    /** 交換部品 */
    replacedParts: ReplacedPart[];
    /** 動作確認結果 */
    operationCheck: Record<string, boolean>;
    /** 作業完了日時 */
    completedAt?: Date;
  };
  
  /** ステータス */
  status: "入庫待ち" | "診断中" | "診断完了（帰宅）" | "診断完了（預かり）" | "見積作成待ち" | "顧客承認待ち" | "作業待ち" | "作業中" | "作業完了" | "出庫待ち";
}

/**
 * 症状カテゴリ
 */
export type SymptomCategory =
  | "エンジン不調"
  | "ブレーキ不調"
  | "異音"
  | "電装系不調"
  | "エアコン不調"
  | "エラーランプ"
  | "その他";

/**
 * エラーランプの種類
 */
export type ErrorLampType =
  | "エンジン"
  | "ABS"
  | "エアバッグ"
  | "バッテリー"
  | "その他";

/**
 * 検査結果
 */
export interface InspectionResult {
  /** 項目ID */
  itemId: string;
  /** 項目名 */
  itemName: string;
  /** 状態 */
  condition: string;
  /** 写真 */
  photo?: Photo;
  /** 動画 */
  video?: Video;
  /** 音声 */
  audio?: Audio;
  /** コメント */
  comment?: string;
}

/**
 * 原因の推測
 */
export interface SuspectedCause {
  /** 原因ID */
  id: string;
  /** 原因の説明 */
  description: string;
  /** 確信度（%） */
  confidence: number;
}

/**
 * 修理方法の選択肢
 */
export interface RepairOption {
  /** 選択肢ID */
  id: string;
  /** 修理方法の説明 */
  description: string;
  /** 費用 */
  cost: number;
  /** 所要時間（分） */
  duration: number;
  /** 推奨度 */
  recommendation: "recommended" | "alternative" | "optional";
  /** 部品代 */
  partsCost?: number;
  /** 工賃 */
  laborCost?: number;
}

/**
 * 部品項目
 */
export interface PartItem {
  /** 部品ID */
  partId?: string;
  /** 部品名 */
  name: string;
  /** メーカー */
  manufacturer: string;
  /** 型番 */
  modelNumber: string;
  /** 数量 */
  quantity: number;
  /** 単価 */
  unitPrice: number;
  /** 金額 */
  amount: number;
}

/**
 * 交換部品
 */
export interface ReplacedPart {
  /** 部品名 */
  name: string;
  /** メーカー */
  manufacturer: string;
  /** 型番 */
  modelNumber: string;
  /** 数量 */
  quantity: number;
}
```

---

## 7. API設計

### 7-1. 症状カテゴリ設定取得API

**エンドポイント**: `GET /api/fault-diagnosis/symptom-categories`

**レスポンス**:
```typescript
{
  categories: SymptomCategoryConfig[];
}

interface SymptomCategoryConfig {
  id: string;
  name: SymptomCategory;
  inspectionItems: InspectionItem[];
}
```

### 7-2. 受付情報の保存API

**エンドポイント**: `POST /api/jobs/[id]/reception`

**リクエストボディ**:
```typescript
{
  faultDescription: string;
  hasErrorLamp: boolean;
  errorLampType?: ErrorLampType;
  mileage: number;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 7-3. 診断結果の保存API

**エンドポイント**: `POST /api/jobs/[id]/diagnosis`

**リクエストボディ**:
```typescript
{
  symptomCategory: SymptomCategory;
  usesDiagnosticTool: boolean;
  diagnosticToolCost?: number;
  diagnosticToolResultUrl?: string;
  inspectionResults: InspectionResult[];
  measurements: Record<string, number>;
  photos: Photo[];
  videos: Video[];
  audio: Audio[];
  comments: string;
  suspectedCauses: SuspectedCause[];
  nextStep: "go_home" | "leave_car";
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 7-4. 見積内容の保存API

**エンドポイント**: `POST /api/jobs/[id]/estimate`

**リクエストボディ**:
```typescript
{
  causeExplanation: string;
  causeMedia: {
    photos: Photo[];
    videos: Video[];
    audio: Audio[];
  };
  repairOptions: RepairOption[];
  parts: PartItem[];
  labor: number;
  diagnosticToolCost?: number;
  total: number;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 7-5. 作業記録の保存API

**エンドポイント**: `POST /api/jobs/[id]/work`

**リクエストボディ**:
```typescript
{
  repairRecords: string;
  beforePhotos: Photo[];
  afterPhotos: Photo[];
  replacedParts: ReplacedPart[];
  operationCheck: Record<string, boolean>;
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  jobId: string;
  status: string;
}
```

### 7-6. 動画・音声アップロードAPI

**エンドポイント**: `POST /api/media/upload`

**リクエスト**: FormData（multipart/form-data）

**レスポンス**:
```typescript
{
  success: boolean;
  mediaId: string;
  mediaUrl: string;
  googleDriveFileId: string;
  type: "video" | "audio";
}
```

---

## 8. ユーザージャーニー

### 8-1. パターンAのフロー（入庫→診断→見積→承認→作業）

```
【入庫】
1. 顧客が不具合を感じた車両を入庫
2. フロントスタッフが受付画面を開く
   - 不具合の詳細を入力
   - エラーランプの有無・種類を選択
   - 走行距離を入力
   - 「受付完了」ボタンをタップ
   - ステータスを「診断中」に更新

【診断】
3. 整備士が診断画面を開く
   - 車両情報を確認（自動入力済み）
   - 不具合情報を確認（受付画面から自動引き継ぎ）
   - 症状カテゴリを選択
   - カテゴリ設定を取得（マスタデータ）
   - 検査項目を動的に表示
   - 各項目の状態を選択
   - 診断機の利用有無を選択
   - 診断機結果PDFをアップロード（診断機を使用する場合）
   - 測定値を入力（補助的）
   - 動画・音声を撮影（ケースバイケース）
   - 原因の推測を記録
   - 「診断完了」ボタンをタップ
   - 次のステップを選択（そのまま帰る/預ける）
   - ステータスを更新
     - そのまま帰る場合: 「診断完了（帰宅）」
     - 預ける場合: 「診断完了（預かり）」

【そのまま帰る場合】
4. 診断結果を説明して帰る
   - 診断機を使用した場合、診断機結果PDFを渡す
   - 修理は後日実施

【預ける場合】
5. フロントスタッフが見積画面を開く
   - 診断結果を確認（診断画面から自動引き継ぎ）
   - 原因の説明を入力（写真・動画・音声を紐付け）
   - 修理方法を追加・編集
   - 部品代・工賃を入力
   - 合計金額を自動計算
   - 「顧客に送信」ボタンをタップ
   - 見積内容を保存
   - ステータスを「顧客承認待ち」に更新

6. 顧客が承認
   - 見積内容を確認
   - 承認
   - ステータスを「作業待ち」に更新

7. 整備士が作業画面を開く
   - 診断結果を確認（参考用）
   - 見積内容を確認（参考用）
   - 作業を実施
   - 作業記録を入力
   - 交換部品を記録
   - Before/After写真を撮影
   - 動作確認を実施
   - 「作業完了」ボタンをタップ
   - ステータスを「作業完了」に更新
   - フロントスタッフに通知

8. フロントスタッフが引渡し・説明
   - 作業内容を確認
   - 顧客に説明
   - ステータスを「出庫待ち」に更新

9. 出庫完了
   - ステータスを「完了」に更新
```

### 8-2. 各画面でのユーザー操作の詳細

#### 8-2-1. 受付画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 既存の受付情報がある場合、自動で読み込まれる

2. **不具合情報を入力**
   - 不具合の詳細を入力（複数行入力可能）
   - エラーランプの有無を選択
   - エラーランプの種類を選択（エラーランプが点灯している場合）

3. **走行距離を入力**
   - 現在の走行距離を入力

4. **受付完了**
   - 「受付完了」ボタンをタップ
   - 確認ダイアログを表示（任意）
   - 受付情報を保存
   - 診断画面への遷移を可能にする

#### 8-2-2. 診断画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 不具合情報が自動で表示される（受付画面から自動引き継ぎ）
   - 既存の診断結果がある場合、自動で読み込まれる

2. **症状カテゴリを選択**
   - 症状カテゴリを選択
   - カテゴリ設定を取得（マスタデータ）
   - 検査項目が動的に表示

3. **検査を実施**
   - 各項目の状態を選択（カテゴリに応じて動的）
   - 必要に応じて写真を撮影
   - 必要に応じて動画を撮影（ケースバイケース）
   - 必要に応じて音声を録音（異音カテゴリの場合）
   - コメントを入力

4. **診断機の利用**
   - 診断機の利用有無を選択
   - 診断機を使用する場合、診断機結果PDFをアップロード

5. **測定値を入力**
   - 一般的な測定値を入力（補助的）

6. **原因の推測を記録**
   - 原因を追加
   - 原因の説明を入力
   - 確信度を入力（%）

7. **診断完了**
   - 「診断完了」ボタンをタップ
   - 次のステップを選択（そのまま帰る/預ける）
   - 診断結果を保存
   - 写真・動画・音声をアップロード
   - ステータスを更新

#### 8-2-3. 見積画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 診断結果が自動で表示される（診断画面から自動引き継ぎ）
   - 既存の見積内容がある場合、自動で読み込まれる

2. **原因の説明を入力**
   - 診断結果に基づいた原因の説明を入力
   - 写真・動画・音声を紐付け（診断画面から自動引き継ぎ、追加も可能）

3. **修理方法を追加・編集**
   - 修理方法を追加
   - 修理方法の説明、費用、所要時間を入力
   - 推奨度を選択
   - 修理方法を編集・削除

4. **部品代・工賃を入力**
   - 部品代・工賃を入力
   - 合計金額を自動計算

5. **顧客に送信または承認待ち**
   - 「顧客に送信」ボタンをタップ（見積内容を顧客に送信）
   - または「承認待ち」ボタンをタップ（見積内容を確定）
   - 見積内容を保存
   - ステータスを「顧客承認待ち」に更新

#### 8-2-4. 作業画面での操作

1. **画面を開く**
   - 車両情報が自動で表示される
   - 診断結果が自動で表示される（参考用）
   - 見積内容が自動で表示される（参考用）
   - 既存の作業記録がある場合、自動で読み込まれる

2. **作業を実施**
   - 作業を実施

3. **作業記録を入力**
   - 実施した修理の詳細を記録

4. **交換部品を記録**
   - 交換した部品を記録（見積画面から自動引き継ぎ、編集可能）

5. **Before/After写真を撮影**
   - Before写真を撮影
   - After写真を撮影

6. **動作確認を実施**
   - 修理内容に応じた動作確認を実施

7. **作業完了**
   - 「作業完了」ボタンをタップ
   - Before/After写真が撮影されていない場合、警告を表示（推奨）
   - 動作確認が未完了の場合、警告を表示（推奨）
   - 確認ダイアログを表示
   - 作業記録を保存
   - 写真をアップロード
   - フロントスタッフに通知

---

## 9. 症状カテゴリ設定マスタの例

### 9-1. エンジン不調の設定例

```typescript
{
  id: "engine_issue",
  name: "エンジン不調",
  inspectionItems: [
    {
      id: "engine_start",
      name: "エンジン始動確認",
      category: "エンジン系統",
      conditions: ["正常", "不調", "始動しない"],
      required: true
    },
    {
      id: "battery_voltage",
      name: "バッテリー電圧確認",
      category: "電気系統",
      conditions: ["正常", "不足", "要交換"],
      required: true,
      measurementFields: [
        {
          id: "voltage",
          name: "電圧",
          unit: "V",
          required: true,
          min: 0,
          max: 20
        }
      ]
    },
    {
      id: "spark_plug",
      name: "スパークプラグ確認",
      category: "エンジン系統",
      conditions: ["正常", "汚れ", "要交換"],
      required: true
    },
    {
      id: "engine_oil",
      name: "エンジンオイル確認",
      category: "エンジン系統",
      conditions: ["正常", "不足", "汚れ", "要交換"],
      required: true
    },
    {
      id: "engine_sound",
      name: "エンジン音確認",
      category: "エンジン系統",
      conditions: ["正常", "異音", "異常"],
      required: true,
      allowsVideo: true
    }
  ]
}
```

### 9-2. 異音の設定例

```typescript
{
  id: "noise",
  name: "異音",
  inspectionItems: [
    {
      id: "noise_type",
      name: "異音の種類",
      category: "異音",
      conditions: ["キーキー", "ガタガタ", "ゴロゴロ", "その他"],
      required: true
    },
    {
      id: "noise_location",
      name: "異音の発生箇所",
      category: "異音",
      conditions: ["エンジン", "ブレーキ", "サスペンション", "その他"],
      required: true
    },
    {
      id: "noise_condition",
      name: "異音の発生条件",
      category: "異音",
      conditions: ["走行中", "停止中", "エンジン始動時", "その他"],
      required: true
    }
  ],
  allowsAudio: true
}
```

---

## 10. 実装の優先順位

### Phase 1: MVP（最小限の機能）

1. **受付画面の基本機能**
   - 不具合情報の入力
   - エラーランプの有無・種類の選択
   - 走行距離の入力
   - データの保存

2. **診断画面の基本機能**
   - 症状カテゴリの選択
   - カテゴリに応じた検査項目の動的表示
   - 状態の選択
   - 診断機の利用選択
   - 原因の推測の記録
   - データの保存

3. **見積画面の基本機能**
   - 原因の説明の入力
   - 修理方法の追加・編集
   - 部品代・工賃の入力
   - 合計金額の自動計算
   - データの保存

4. **作業画面の基本機能**
   - 作業記録の入力
   - 交換部品の記録
   - Before/After写真の撮影
   - 動作確認の記録
   - データの保存

### Phase 2: 拡張機能

1. **診断機連携**
   - 診断機結果PDFのアップロード
   - 診断機結果PDFの表示・ダウンロード

2. **動画・音声撮影**
   - 動画撮影機能
   - 音声録音機能
   - 動画・音声の再生機能

3. **自動保存機能**
   - 30秒ごとの自動保存
   - オフライン対応

### Phase 3: 高度な機能

1. **通知機能**
   - フロントスタッフへの通知

2. **レポート機能**
   - 顧客向けレポート画面での表示

3. **症状カテゴリ設定マスタの管理**
   - 症状カテゴリ設定の追加・編集機能

---

## 関連ドキュメント

- [統合仕様書](./INTEGRATED_SPECIFICATION.md): システム全体の統合仕様
  - 「2-3. データフローの統一」: マスタデータ同期の制約と対応方法
  - 「2-4. 複数作業管理の実装」: 複数作業管理の実装方法
  - 「4-2-6. 請求書統合フロー」: 基幹システムでの統合請求書作成手順
- [システム進化計画](./SYSTEM_EVOLUTION_PLAN.md): 基幹システム制約下での設計変更方針
- [ユーザーワークフロー詳細設計 v2.0](./USER_WORKFLOW_DETAILED_DESIGN_V2.md): ユーザー別業務・システム利用詳細設計

**マスタデータ同期の制約**:
- 車両マスタ・顧客マスタはGoogle Sheets経由で取得（基幹システムからGAS経由で同期）
- マスタデータの更新は基幹システムで実施（Webアプリからは更新不可）
- データ不整合が発生した場合は、「Human Middleware」（スタッフ）が基幹システムを修正

---

## 更新履歴

- 2025-01-XX: 初版作成（詳細画面設計書）
- 2025-01-XX: 基幹システム連携フローを追加、関連ドキュメントへの参照を追加
- 2025-01-XX: マスタデータ同期の制約を追加

























