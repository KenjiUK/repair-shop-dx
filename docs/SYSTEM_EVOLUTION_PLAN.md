# システム進化計画書：基幹システム制約下での設計変更方針

## ドキュメント情報

- **作成日**: 2025-01-XX
- **バージョン**: 1.0
- **対象**: 基幹システム（スマートカーディーラー）制約下でのシステム進化計画
- **ステータス**: 提案中

---

## 1. 現状の理解と制約の整理

### 1-1. 基幹システム（スマートカーディーラー）の役割

**維持すべき機能（変更不可）**:
- ✅ **帳票系業務**: 各種帳票の作成・管理
- ✅ **請求書管理**: 請求書の作成・確定・発行
- ✅ **顧客マスタ管理**: 顧客情報の登録・更新・管理
- ✅ **車両マスタ管理**: 車両情報の登録・更新・管理
- ✅ **売上管理**: 売上データの最終保管場所

**データ連携方法（MVP）**:
- **下り（基幹 → アプリ）**: CSV/Excel経由でGoogle Sheetsに展開
- **上り（アプリ → 基幹）**: Zoho CRMの`Description`に追記、事務員が手動で基幹システムを更新

### 1-2. 現在のシステム構成

```
┌─────────────────────────────────────┐
│  基幹システム（スマートカーディーラー）│
│  - The Truth（絶対正）              │
│  - 帳票・請求書・マスタ管理          │
│  - API連携なし（CSV/Excel経由）     │
└─────────────────────────────────────┘
           │ CSV/Excel
           ↓
┌─────────────────────────────────────┐
│  Google Sheets（マスタキャッシュ）   │
│  - Read Only                        │
│  - 車両・顧客マスタの参照用         │
└─────────────────────────────────────┘
           │ API
           ↓
┌─────────────────────────────────────┐
│  Zoho CRM（Transaction Hub）        │
│  - 進捗管理                         │
│  - アプリ用データハブ                │
│  - 入庫管理（CustomModule2）        │
└─────────────────────────────────────┘
           │ API
           ↓
┌─────────────────────────────────────┐
│  Webアプリ（Next.js）               │
│  - 受付・診断・見積・作業・報告     │
│  - 顧客向けプレゼン                 │
└─────────────────────────────────────┘
```

### 1-3. 現状の課題（提案書より）

1. **途中で作業が追加される**: 車検で入庫したが、車検後に一緒にオイル交換やコーティングもお願いされたりする
2. **入庫区分≠最終的な作業**: 入庫区分（車検）と最終的な作業（車検+オイル交換+コーティング）が一致しない
3. **請求書の統合**: 入庫単位のJOBをすべて紐づけて出庫時にまとめて請求書をあげる
4. **長期カスタムの管理**: 長期で色々カスタムする場合、入庫単位の車両で管理したい

---

## 2. 設計変更方針：基幹システム制約下での実装

### 2-1. 基本方針

**原則**:
1. **基幹システムの役割は維持**: 帳票・請求書・マスタ管理は基幹システムで継続
2. **Zoho CRMを拡張**: 複数作業管理とワークオーダー情報をZoho CRM内で管理
3. **Webアプリは表示・入力支援**: 基幹システムの計算結果を転記するだけ
4. **請求書は基幹システムで統合**: 複数作業をまとめた請求書は基幹システムで作成

### 2-2. 推奨設計：案3（ハイブリッド）を基幹システム制約下で実装

#### 2-2-1. Zoho CRMの拡張

**入庫管理（CustomModule2）の拡張**:

| **項目名** | **API名** | **データ型** | **用途・ロジック** |
| --- | --- | --- | --- |
| 入庫日時 | field22 | DateTime | 入庫日時 |
| 工程ステージ | field5 | PickList | ステータス管理（入庫済み / 診断中 / 見積作成待ち / 作業待ち / 出庫待ち / 出庫済み） |
| 顧客名 | field4 | Lookup | 顧客モジュール(Contacts)への参照 |
| 車両ID | field6 | Lookup | 車両モジュール(CustomModule1)への参照 |
| **実施作業リスト** | **field_service_kinds** | **Multi-Select** | **実施する作業のリスト（車検、オイル交換、コーティングなど）** |
| **ワークオーダー詳細** | **field_work_orders** | **Multi-Line (JSON)** | **各作業の詳細情報（診断・見積・作業情報）をJSON形式で保存** |
| **基幹システム連携ID** | **field_base_system_id** | **Text** | **基幹システムの入庫IDまたは伝票番号（請求書統合用）** |
| 詳細情報 | field7 | Multi-Line | 顧客が事前入力した不具合・問診内容 |
| 走行距離 | field10 | Number | 走行距離 |
| 作業指示書 | field | Multi-Line | 社内からの申し送り事項 |
| 作業内容 | field13 | Multi-Line | 顧客承認済みの見積もり明細（テキスト） |

**ワークオーダー詳細（JSON形式）**:
```json
{
  "workOrders": [
    {
      "id": "wo-001",
      "serviceKind": "車検",
      "status": "完了",
      "diagnosis": { ... },
      "estimate": { ... },
      "work": { ... },
      "baseSystemItemId": "INV-2025-001-1",  // 基幹システムの明細ID
      "cost": 134750
    },
    {
      "id": "wo-002",
      "serviceKind": "エンジンオイル交換",
      "status": "完了",
      "diagnosis": { ... },
      "estimate": { ... },
      "work": { ... },
      "baseSystemItemId": "INV-2025-001-2",  // 基幹システムの明細ID
      "cost": 10560
    }
  ],
  "totalCost": 145310,
  "baseSystemInvoiceId": "INV-2025-001"  // 基幹システムの請求書ID
}
```

#### 2-2-2. 業務フロー（基幹システム連携）

**シナリオ: 車検で入庫、途中でオイル交換とコーティングを追加**

```
1. 入庫: Jobレコードを作成
   - 入庫区分: 車検
   - field_service_kinds: ["車検"]
   - field_work_orders: [{ id: "wo-001", serviceKind: "車検", ... }]

2. 車検の診断・見積・作業: 完了
   - field_work_orders内の車検のワークオーダーを更新

3. 途中で追加: オイル交換
   - field_service_kinds: ["車検", "エンジンオイル交換"]
   - field_work_orders: [...既存..., { id: "wo-002", serviceKind: "エンジンオイル交換", ... }]

4. オイル交換の診断・見積・作業: 完了
   - field_work_orders内のオイル交換のワークオーダーを更新

5. 途中で追加: コーティング
   - field_service_kinds: ["車検", "エンジンオイル交換", "コーティング"]
   - field_work_orders: [...既存..., { id: "wo-003", serviceKind: "コーティング", ... }]

6. コーティングの診断・見積・作業: 完了
   - field_work_orders内のコーティングのワークオーダーを更新

7. 出庫時: 基幹システムで請求書を作成
   - 事務員が基幹システムを開く
   - field_base_system_idを参照して、基幹システムの入庫IDまたは伝票番号を確認
   - 基幹システムで、すべてのワークオーダーをまとめた請求書を作成
   - 請求書IDをfield_work_orders内のbaseSystemInvoiceIdに記録
   - 請求書PDFをGoogle Driveにアップロード（Phase 5の手順通り）
```

### 2-3. 見積作成フローの変更

**現状のフロー（SPECIFICATION.md Phase 3より）**:
1. アドバイザーが基幹システムで正確な見積書を作成
2. Webアプリの見積作成画面に「品名」と「金額（税込）」を転記

**変更後のフロー（複数作業対応）**:

```
1. 診断完了: メカニックが診断を完了
   - 各作業ごとに診断結果を記録
   - field_work_orders内に各作業の診断情報を保存

2. 見積作成（各作業ごと）:
   - アドバイザーがWebアプリの見積作成画面を開く
   - 作業選択タブまたはドロップダウンで作業を選択
   - 選択された作業の診断結果を確認
   - 基幹システムで該当作業の見積書を作成
   - Webアプリに「品名」と「金額（税込）」を転記
   - field_work_orders内の該当作業の見積情報を更新

3. 途中で作業を追加:
   - アドバイザーが「作業を追加」ボタンを押す
   - 作業種類を選択（オイル交換、コーティングなど）
   - 新しい作業の診断・見積を実施（上記2の手順を繰り返し）

4. 顧客への提示:
   - すべての作業の見積をまとめて顧客に提示
   - 顧客が各作業ごとに承認・却下を選択
   - 承認された作業のみをfield_work_orders内に記録
```

### 2-4. 請求書作成フローの変更

**現状のフロー（SPECIFICATION.md Phase 5より）**:
1. メカニックが作業完了
2. 事務員が基幹システムで請求書を作成・確定
3. 請求書PDFをアップロード

**変更後のフロー（複数作業対応）**:

```
1. すべての作業完了: メカニックがすべての承認された作業を完了
   - field_work_orders内の各作業のステータスを「完了」に更新

2. 基幹システムで統合請求書を作成:
   - 事務員が基幹システムを開く
   - field_base_system_idを参照して、基幹システムの入庫IDまたは伝票番号を確認
   - 基幹システムで、すべての完了したワークオーダーをまとめた統合請求書を作成
   - 請求書IDをfield_work_orders内のbaseSystemInvoiceIdに記録

3. 請求書PDFをアップロード:
   - 基幹システムで作成した請求書PDFをGoogle Driveにアップロード
   - ファイル名に「invoice」「seikyu」「請求書」を含める（Phase 5の手順通り）

4. 顧客への通知:
   - 請求書PDFがアップロードされたことを確認
   - 顧客に完了通知と請求書リンクを送信（Phase 6の手順通り）
```

---

## 3. 実装の優先順位

### Phase 1（MVP）: 複数作業管理の基本機能

**目標**: 1つの入庫に対して複数の作業を管理できるようにする

**実装項目**:
1. **Zoho CRMの拡張**:
   - `field_service_kinds`（Multi-Select）の追加
   - `field_work_orders`（Multi-Line JSON）の追加
   - `field_base_system_id`（Text）の追加

2. **Webアプリの拡張**:
   - JobCardに実施作業リストを表示
   - 「作業を追加」ボタンの実装
   - 診断・見積・作業画面に作業選択タブまたはドロップダウンを追加
   - 各作業ごとの診断・見積・作業情報の表示・編集

3. **APIの拡張**:
   - `addWorkOrder`: 既存のJobにワークオーダーを追加
   - `updateWorkOrder`: ワークオーダーを更新
   - `getWorkOrders`: Jobに紐づくすべてのワークオーダーを取得

**制約の遵守**:
- ✅ 見積計算は基幹システムで実施（Webアプリは転記のみ）
- ✅ 請求書作成は基幹システムで実施（WebアプリはPDF表示のみ）
- ✅ 顧客・車両マスタは基幹システムで管理（Webアプリは参照のみ）

### Phase 2（拡張）: 長期カスタムの管理機能

**目標**: 長期で色々カスタムする場合、入庫単位の車両で管理できるようにする

**実装項目**:
1. **前回Job IDの参照機能**:
   - `field_previous_job_id`（Text）の追加
   - 前回のJobを参照して表示する機能

2. **プロジェクト全体の進捗表示**:
   - 同じ車両の過去のJobを一覧表示
   - 長期カスタムの進捗を可視化

**制約の遵守**:
- ✅ 各回の請求書は基幹システムで個別に作成（統合請求は要確認）

### Phase 3（将来）: 次世代機能の追加

**目標**: ビデオコミュニケーション、顧客ポータルなどの次世代機能を追加

**実装項目**:
1. **ビデオコミュニケーション機能**:
   - 診断・作業内容をビデオで記録
   - Google Driveに保存し、ワークオーダーに紐付け

2. **顧客ポータル機能**:
   - 顧客が作業進捗を確認できる画面
   - 請求書の確認・ダウンロード

3. **リアルタイム同期機能**:
   - SWRを使用したリアルタイムデータ同期の強化

**制約の遵守**:
- ✅ 基幹システムの役割は維持（帳票・請求書・マスタ管理）

---

## 4. データフローの詳細設計

### 4-1. マスタデータの流れ（変更なし）

**下り（基幹 → アプリ）**:
1. 事務員が毎日、スマートカーディーラーからCSV/Excelで書き出し、Driveへアップロード
2. GAS (Google Apps Script) がファイルを検知し、Google Sheetsに上書き展開
3. Webアプリ（Next.js）は、このSheetsをAPI経由で参照

**変更点**: なし（既存の仕組みを維持）

### 4-2. 更新データの流れ（変更なし）

**上り（アプリ → 基幹）**:
1. 顧客がWebアプリで「新住所」を入力
2. WebアプリはZoho CRM (Contacts) の`Description`にデータを書き込む
3. 事務員がZohoの変更通知を見て、手動でスマートカーディーラーの登録情報を修正

**変更点**: なし（既存の仕組みを維持）

### 4-3. ワークオーダーデータの流れ（新規）

**アプリ → Zoho CRM**:
1. メカニックが診断を実施
2. 診断結果を`field_work_orders`（JSON形式）に保存
3. アドバイザーが見積を作成
4. 見積情報を`field_work_orders`内の該当作業に追加
5. 顧客が承認
6. 承認された作業のみを`field_work_orders`内に記録
7. メカニックが作業を実施
8. 作業情報を`field_work_orders`内の該当作業に追加

**Zoho CRM → 基幹システム**:
1. 事務員がZoho CRMの`field_work_orders`を確認
2. 基幹システムで、すべての完了したワークオーダーをまとめた統合請求書を作成
3. 請求書IDを`field_work_orders`内の`baseSystemInvoiceId`に記録

**基幹システム → アプリ**:
1. 事務員が基幹システムで作成した請求書PDFをGoogle Driveにアップロード
2. WebアプリがGoogle Drive APIで請求書PDFを検索・表示

---

## 5. UI設計の変更

### 5-1. 受付画面（Phase 1）の変更

**追加要素**:
- Jobカード内に実施作業リスト（バッジ形式）を表示
- 「作業を追加」ボタン（受付中または診断中に表示）
- 各作業のステータス表示（診断中、見積作成待ち、作業待ち、完了）

**変更点**: 既存のJobカードに作業リストを追加

### 5-2. 診断画面（Phase 2）の変更

**追加要素**:
- 作業選択タブまたはドロップダウン
- 選択された作業の診断情報を表示・編集
- 各作業ごとの診断結果を保存

**変更点**: 既存の診断画面に作業選択機能を追加

### 5-3. 見積作成画面（Phase 3）の変更

**追加要素**:
- 作業選択タブまたはドロップダウン
- 選択された作業の見積情報を表示・編集
- 各作業ごとの見積結果を保存
- すべての作業の見積をまとめて顧客に提示

**変更点**: 既存の見積作成画面に作業選択機能を追加

### 5-4. 作業画面（Phase 5）の変更

**追加要素**:
- 作業選択タブまたはドロップダウン
- 選択された作業の作業情報を表示・編集
- 各作業ごとの作業結果を保存

**変更点**: 既存の作業画面に作業選択機能を追加

### 5-5. 顧客承認画面（Phase 4）の変更

**追加要素**:
- すべての作業の見積を表示
- 各作業ごとに承認・却下を選択可能
- 承認された作業のみを確定

**変更点**: 既存の承認画面に複数作業対応を追加

---

## 6. データモデルの拡張

### 6-1. ZohoJob型の拡張

```typescript
export interface ZohoJob {
  // 既存のフィールド
  id: string;
  field5: JobStage;
  field4: string; // 顧客名Lookup
  field6: string; // 車両ID Lookup
  field22: string; // 入庫日時
  field7: string; // 詳細情報
  field10: number; // 走行距離
  field13: string; // 作業内容
  
  // 新規フィールド
  /** 実施作業リスト */
  field_service_kinds?: string[]; // Multi-Select: ["車検", "オイル交換", "コーティング"]
  
  /** ワークオーダー詳細（JSON形式） */
  field_work_orders?: string; // Multi-Line (JSON): WorkOrder[]
  
  /** 基幹システム連携ID */
  field_base_system_id?: string; // Text: 基幹システムの入庫IDまたは伝票番号
  
  /** 前回のJob ID（長期カスタムの場合） */
  field_previous_job_id?: string; // Text: 前回のJob ID
}

/**
 * ワークオーダー
 */
export interface WorkOrder {
  /** ワークオーダーID */
  id: string;
  /** 入庫区分 */
  serviceKind: ServiceKind;
  /** ステータス */
  status: WorkOrderStatus;
  /** 診断情報 */
  diagnosis?: DiagnosisInfo;
  /** 見積情報 */
  estimate?: EstimateInfo;
  /** 作業情報 */
  work?: WorkInfo;
  /** 基幹システムの明細ID */
  baseSystemItemId?: string;
  /** 費用 */
  cost: number;
  /** 作成日時 */
  createdAt: Date;
  /** 完了日時 */
  completedAt?: Date;
}

/**
 * ワークオーダー詳細（JSON形式のルート）
 */
export interface WorkOrdersData {
  /** ワークオーダーリスト */
  workOrders: WorkOrder[];
  /** 合計金額 */
  totalCost: number;
  /** 基幹システムの請求書ID */
  baseSystemInvoiceId?: string;
}
```

---

## 7. API設計の拡張

### 7-1. ワークオーダーの追加

```typescript
/**
 * 既存のJobにワークオーダーを追加
 */
export async function addWorkOrder(
  jobId: string,
  serviceKind: ServiceKind
): Promise<ApiResponse<ZohoJob>> {
  // 1. Jobレコードを取得
  // 2. field_service_kindsに新しい作業を追加
  // 3. field_work_ordersに新しいワークオーダーを追加
  // 4. Jobレコードを更新
}
```

### 7-2. ワークオーダーの更新

```typescript
/**
 * ワークオーダーを更新
 */
export async function updateWorkOrder(
  jobId: string,
  workOrderId: string,
  workOrder: Partial<WorkOrder>
): Promise<ApiResponse<ZohoJob>> {
  // 1. Jobレコードを取得
  // 2. field_work_orders内の該当ワークオーダーを更新
  // 3. Jobレコードを更新
}
```

### 7-3. ワークオーダーの取得

```typescript
/**
 * Jobに紐づくすべてのワークオーダーを取得
 */
export async function getWorkOrders(
  jobId: string
): Promise<ApiResponse<WorkOrder[]>> {
  // 1. Jobレコードを取得
  // 2. field_work_ordersをパース
  // 3. WorkOrder[]を返す
}
```

---

## 8. 制約の遵守チェックリスト

### 8-1. 基幹システムの役割維持

- ✅ **帳票系業務**: 基幹システムで継続（変更なし）
- ✅ **請求書管理**: 基幹システムで作成・確定（変更なし）
- ✅ **顧客マスタ管理**: 基幹システムで管理（変更なし）
- ✅ **車両マスタ管理**: 基幹システムで管理（変更なし）
- ✅ **売上管理**: 基幹システムで最終保管（変更なし）

### 8-2. データ連携方法の維持

- ✅ **下り（基幹 → アプリ）**: CSV/Excel経由でGoogle Sheetsに展開（変更なし）
- ✅ **上り（アプリ → 基幹）**: Zoho CRMの`Description`に追記、事務員が手動で更新（変更なし）

### 8-3. 見積・請求書フローの維持

- ✅ **見積計算**: 基幹システムで実施（Webアプリは転記のみ）
- ✅ **請求書作成**: 基幹システムで実施（WebアプリはPDF表示のみ）
- ✅ **請求書PDF**: 基幹システムで作成後、Google Driveにアップロード（変更なし）

---

## 9. 確認事項

以下の点について確認が必要です：

1. **基幹システム連携ID**: `field_base_system_id`に基幹システムの入庫IDまたは伝票番号を記録することに問題はないか？
2. **統合請求書のタイミング**: すべての作業完了後に基幹システムで統合請求書を作成することに問題はないか？
3. **長期カスタムの請求**: 長期カスタムの場合、各回の出庫時に請求するのか、すべての回をまとめて請求するのか？
4. **JSON形式の管理**: `field_work_orders`をJSON形式で管理することに問題はないか？

---

## 10. 次のステップ

1. **確認事項の回答**: 上記の確認事項について回答を得る
2. **Zoho CRMの拡張**: `field_service_kinds`、`field_work_orders`、`field_base_system_id`の追加
3. **Webアプリの拡張**: 作業追加機能、作業選択機能の実装
4. **APIの拡張**: ワークオーダー関連APIの実装
5. **テスト**: 複数作業の追加・管理・請求書統合のテスト

---

## 更新履歴

- 2025-01-XX: 初版作成（基幹システム制約下での設計変更方針）


























