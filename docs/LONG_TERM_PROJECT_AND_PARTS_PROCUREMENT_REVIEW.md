# 長期プロジェクトと長期化部品調達のロジック・仕様レビュー

## 現状の問題点

### 1. 長期プロジェクトの定義
- **判定条件**: `serviceKind` が "レストア" または "板金・塗装"
- **進捗管理**: `workData` から進捗データを取得
- **ステータス**: 通常 "作業待ち" など（"部品調達待ち" ではない）

### 2. 長期化部品調達の定義
- **判定条件**: 
  - `field5` が "部品調達待ち" または "部品発注待ち"
  - `partsInfo` から `isLongPartsProcurement` で判定（7日以上がデフォルト）
- **ロジック**: `src/lib/parts-info-utils.ts` の `isLongPartsProcurement` 関数

### 3. 問題点の詳細

#### 問題1: 長期プロジェクトでも部品調達が必要な場合がある
- レストアや板金・塗装の長期プロジェクトでも、部品調達が必要な場合がある
- しかし、長期プロジェクトのステータスは通常 "作業待ち" などで、"部品調達待ち" ではない
- そのため、長期プロジェクトで部品調達が長期化していても、「長期化部品調達」フィルターでは検出できない

#### 問題2: ロジックの分離
- 長期プロジェクトの進捗管理と部品調達の管理が別々のロジックで実装されている
- 統合的な管理ができていない

#### 問題3: ステータスの矛盾
- 長期プロジェクトが "作業待ち" の状態で、同時に部品調達が必要な場合、ステータスが矛盾する可能性がある

## 実装内容

### ✅ 修正1: 長期プロジェクトでも部品調達を検出できるようにする（実装済み）
- `filter-utils.ts` の `longPartsProcurement` フィルターを修正
- ステータスチェック（`field5 !== "部品調達待ち" && field5 !== "部品発注待ち"`）を削除
- `partsInfo` の存在と `isLongPartsProcurement` の結果のみで判定するように変更
- これにより、長期プロジェクト（レストア・板金・塗装）でも、`partsInfo` があり、7日以上経過していれば「長期化部品調達」として検出可能

### 変更内容
```typescript
// 修正前
if (filters.longPartsProcurement === true) {
  if (job.field5 !== "部品調達待ち" && job.field5 !== "部品発注待ち") {
    return false;
  }
  const partsInfo = parsePartsInfoFromField26(job.field26);
  if (!isLongPartsProcurement(partsInfo)) {
    return false;
  }
}

// 修正後
if (filters.longPartsProcurement === true) {
  const partsInfo = parsePartsInfoFromField26(job.field26);
  if (!isLongPartsProcurement(partsInfo)) {
    return false;
  }
}
```

## 今後の検討事項

### 提案2: 長期プロジェクトの進捗管理に部品調達情報を統合する
- 長期プロジェクトの進捗データに、部品調達の状況も含める
- 部品調達が長期化している場合、長期プロジェクトの進捗に影響を与える

### 提案3: ステータスの明確化
- 長期プロジェクトで部品調達が必要な場合、ステータスを "部品調達待ち" にするか、または別の管理方法を検討する

## 確認事項

1. 長期プロジェクト（レストア・板金・塗装）でも部品調達が必要な場合があるか？
2. その場合、ステータスは "部品調達待ち" になるのか、それとも "作業待ち" のままなのか？
3. 長期プロジェクトの進捗管理と部品調達の管理を統合すべきか？

