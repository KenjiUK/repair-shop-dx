/**
 * 法定点検作業ビュー（InspectionWorkView）
 * 
 * Phase 5（整備・完成検査）で使用するコンポーネント
 * - Phase 2（受入点検）からのデータ引き継ぎ表示
 * - 承認作業の実施チェック
 * - After値（交換後の残量等）の入力
 * - 完成検査モード（テスター値入力）
 * - 品質管理・最終検査
 */

"use client";

import { useState, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import { Separator } from "@/components/ui/separator";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import {
  Check,
  CheckCircle2,
  ChevronDown,
  ChevronUp,
  AlertCircle,
  Wrench,
  ClipboardCheck,
  Gauge,
  ArrowRight,
} from "lucide-react";
import { cn } from "@/lib/utils";

// =============================================================================
// 型定義
// =============================================================================

/**
 * 受入点検データ（Phase 2からの引き継ぎ）
 */
export interface AcceptanceInspectionData {
  /** 点検項目リスト */
  items: Array<{
    id: string;
    name: string;
    category: string;
    status: string; // good, exchange, adjust, repair, etc.
    comment?: string | null;
  }>;
  /** 測定値 */
  measurements?: {
    coConcentration?: number;
    hcConcentration?: number;
    brakePadFrontLeft?: number;
    brakePadFrontRight?: number;
    brakePadRearLeft?: number;
    brakePadRearRight?: number;
    tireDepthFrontLeft?: number;
    tireDepthFrontRight?: number;
    tireDepthRearLeft?: number;
    tireDepthRearRight?: number;
  };
}

/**
 * 承認済み作業項目
 */
export interface ApprovedWorkItem {
  id: string;
  name: string;
  isCompleted: boolean;
  /** 交換後の値（After値） */
  afterValue?: number;
  /** 交換前の値（Before値、Phase 2から） */
  beforeValue?: number;
}

/**
 * 完成検査データ（テスター値）
 */
export interface FinalInspectionData {
  /** サイドスリップ測定値 (mm/m) */
  sideSlip?: number;
  /** ブレーキ制動力（前輪左） */
  brakeForceFrontLeft?: number;
  /** ブレーキ制動力（前輪右） */
  brakeForceFrontRight?: number;
  /** ブレーキ制動力（後輪左） */
  brakeForceRearLeft?: number;
  /** ブレーキ制動力（後輪右） */
  brakeForceRearRight?: number;
  /** スピードメーター誤差 (km/h) */
  speedometerError?: number;
  /** ヘッドライト光度（左） */
  headlightIntensityLeft?: number;
  /** ヘッドライト光度（右） */
  headlightIntensityRight?: number;
  /** 排ガスCO（アイドリング時） */
  exhaustCO?: number;
  /** 排ガスHC（アイドリング時） */
  exhaustHC?: number;
}

/**
 * 品質管理・最終検査データ
 */
export interface QualityCheckData {
  wheelNutTorque?: boolean;
  torqueWrenchUsed?: boolean;
  brakeEffect?: boolean;
  noAbnormalNoise?: boolean;
  allLightsOn?: boolean;
  warningLightsOff?: boolean;
  voltageOk?: boolean;
  steeringBehavior?: boolean;
  noSuspensionNoise?: boolean;
}

/**
 * 交換部品項目
 */
export interface ReplacementPartItem {
  id: string;
  name: string;
  quantity: number;
  unit: string;
  partNumber?: string;
  /** 承認された作業から自動生成されたかどうか */
  isAutoGenerated?: boolean;
}

/**
 * InspectionWorkViewのProps
 */
export interface InspectionWorkViewProps {
  /** 受入点検データ（Phase 2から） */
  acceptanceData?: AcceptanceInspectionData;
  /** 承認済み作業項目 */
  approvedWorkItems: ApprovedWorkItem[];
  /** 承認済み作業項目の変更ハンドラ */
  onApprovedWorkItemsChange: (items: ApprovedWorkItem[]) => void;
  /** 完成検査データ */
  finalInspectionData: FinalInspectionData;
  /** 完成検査データの変更ハンドラ */
  onFinalInspectionDataChange: (data: FinalInspectionData) => void;
  /** 品質管理・最終検査データ */
  qualityCheckData: QualityCheckData;
  /** 品質管理・最終検査データの変更ハンドラ */
  onQualityCheckDataChange: (data: QualityCheckData) => void;
  /** 交換部品等 */
  replacementParts: ReplacementPartItem[];
  /** 交換部品等の変更ハンドラ */
  onReplacementPartsChange: (parts: ReplacementPartItem[]) => void;
  /** 無効化状態 */
  disabled?: boolean;
  /** 車検かどうか（true の場合、完成検査モードを表示） */
  isShaken?: boolean;
}

// =============================================================================
// コンポーネント
// =============================================================================

/**
 * 法定点検作業ビュー
 */
export function InspectionWorkView({
  acceptanceData,
  approvedWorkItems,
  onApprovedWorkItemsChange,
  finalInspectionData,
  onFinalInspectionDataChange,
  qualityCheckData,
  onQualityCheckDataChange,
  replacementParts,
  onReplacementPartsChange,
  disabled = false,
  isShaken = false,
}: InspectionWorkViewProps) {
  // セクションの開閉状態
  const [isAcceptanceOpen, setIsAcceptanceOpen] = useState(true);
  const [isFinalInspectionOpen, setIsFinalInspectionOpen] = useState(true);
  const [isQualityCheckOpen, setIsQualityCheckOpen] = useState(true);
  const [isReplacementPartsOpen, setIsReplacementPartsOpen] = useState(true);

  // 受入点検で問題があった項目
  const flaggedItems = useMemo(() => {
    if (!acceptanceData?.items) return [];
    return acceptanceData.items.filter(
      (item) =>
        item.status === "exchange" ||
        item.status === "repair" ||
        item.status === "adjust" ||
        item.status === "red" ||
        item.status === "yellow"
    );
  }, [acceptanceData?.items]);

  // 受入点検で良好だった項目
  const goodItems = useMemo(() => {
    if (!acceptanceData?.items) return [];
    return acceptanceData.items.filter(
      (item) =>
        item.status === "good" ||
        item.status === "green" ||
        item.status === "ok"
    );
  }, [acceptanceData?.items]);

  // 作業完了ハンドラ
  const handleWorkItemComplete = (itemId: string, isCompleted: boolean) => {
    const updatedItems = approvedWorkItems.map((item) =>
      item.id === itemId ? { ...item, isCompleted } : item
    );
    onApprovedWorkItemsChange(updatedItems);
  };

  // After値変更ハンドラ
  const handleAfterValueChange = (itemId: string, afterValue: number | undefined) => {
    const updatedItems = approvedWorkItems.map((item) =>
      item.id === itemId ? { ...item, afterValue } : item
    );
    onApprovedWorkItemsChange(updatedItems);
  };

  // 完成検査データ変更ハンドラ
  const handleFinalInspectionChange = (key: keyof FinalInspectionData, value: number | undefined) => {
    onFinalInspectionDataChange({
      ...finalInspectionData,
      [key]: value,
    });
  };

  // 品質管理変更ハンドラ
  const handleQualityCheckChange = (key: keyof QualityCheckData, value: boolean) => {
    onQualityCheckDataChange({
      ...qualityCheckData,
      [key]: value,
    });
  };

  // 交換部品の数量変更ハンドラ
  const handlePartQuantityChange = (partId: string, quantity: number) => {
    const updatedParts = replacementParts.map((part) =>
      part.id === partId ? { ...part, quantity } : part
    );
    onReplacementPartsChange(updatedParts);
  };

  // 交換部品の品番変更ハンドラ
  const handlePartNumberChange = (partId: string, partNumber: string) => {
    const updatedParts = replacementParts.map((part) =>
      part.id === partId ? { ...part, partNumber } : part
    );
    onReplacementPartsChange(updatedParts);
  };

  // 交換部品の追加ハンドラ
  const handleAddPart = () => {
    const newPart: ReplacementPartItem = {
      id: `part-${Date.now()}`,
      name: "",
      quantity: 1,
      unit: "個",
      isAutoGenerated: false,
    };
    onReplacementPartsChange([...replacementParts, newPart]);
  };

  // 交換部品の名前変更ハンドラ
  const handlePartNameChange = (partId: string, name: string) => {
    const updatedParts = replacementParts.map((part) =>
      part.id === partId ? { ...part, name } : part
    );
    onReplacementPartsChange(updatedParts);
  };

  // 交換部品の削除ハンドラ
  const handleRemovePart = (partId: string) => {
    const updatedParts = replacementParts.filter((part) => part.id !== partId);
    onReplacementPartsChange(updatedParts);
  };

  // ステータスに応じたバッジ
  const getStatusBadge = (status: string) => {
    switch (status) {
      case "good":
      case "green":
      case "ok":
        return <Badge variant="default" className="bg-green-600">良好</Badge>;
      case "exchange":
      case "red":
        return <Badge variant="destructive">要交換</Badge>;
      case "repair":
        return <Badge variant="destructive">要修理</Badge>;
      case "adjust":
      case "yellow":
        return <Badge variant="secondary" className="bg-amber-500 text-white">要調整</Badge>;
      default:
        return <Badge variant="outline">未確認</Badge>;
    }
  };

  return (
    <div className="space-y-6">
      {/* =================================================================== */}
      {/* 受入点検結果（Phase 2からの引き継ぎ） */}
      {/* =================================================================== */}
      {acceptanceData && (
        <Collapsible open={isAcceptanceOpen} onOpenChange={setIsAcceptanceOpen}>
          <Card className="border-slate-200 shadow-md">
            <CollapsibleTrigger asChild>
              <CardHeader className="cursor-pointer hover:bg-slate-50 transition-colors">
                <CardTitle className="text-lg font-semibold flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <ClipboardCheck className="h-5 w-5 text-slate-600 shrink-0" />
                    受入点検結果（Phase 2）
                    <Badge variant="outline" className="ml-2">
                      {flaggedItems.length > 0 ? `${flaggedItems.length}件の要対応` : "問題なし"}
                    </Badge>
                  </div>
                  {isAcceptanceOpen ? (
                    <ChevronUp className="h-5 w-5 text-slate-500" />
                  ) : (
                    <ChevronDown className="h-5 w-5 text-slate-500" />
                  )}
                </CardTitle>
              </CardHeader>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <CardContent className="pt-0 space-y-4">
                {/* 問題あり項目 */}
                {flaggedItems.length > 0 && (
                  <div>
                    <h4 className="font-medium text-slate-700 mb-2 flex items-center gap-2">
                      <AlertCircle className="h-4 w-4 text-amber-500" />
                      要対応項目
                    </h4>
                    <div className="space-y-2">
                      {flaggedItems.map((item) => (
                        <div
                          key={item.id}
                          className="p-3 border rounded-lg bg-amber-50 border-amber-200"
                        >
                          <div className="flex items-center justify-between">
                            <span className="text-base">{item.name}</span>
                            {getStatusBadge(item.status)}
                          </div>
                          {item.comment && (
                            <p className="text-sm text-slate-600 mt-1">{item.comment}</p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* 良好項目（折りたたみ） */}
                {goodItems.length > 0 && (
                  <div>
                    <h4 className="font-medium text-slate-700 mb-2 flex items-center gap-2">
                      <CheckCircle2 className="h-4 w-4 text-green-600" />
                      良好項目 ({goodItems.length}件)
                    </h4>
                    <p className="text-sm text-slate-500">
                      受入点検で良好と判定された項目は、整備後も変更がなければ「みなし完了」となります。
                    </p>
                  </div>
                )}

                {/* 測定値 */}
                {acceptanceData.measurements && (
                  <div>
                    <h4 className="font-medium text-slate-700 mb-2 flex items-center gap-2">
                      <Gauge className="h-4 w-4 text-blue-600" />
                      測定値（受入時）
                    </h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      {acceptanceData.measurements.brakePadFrontLeft !== undefined && (
                        <div className="flex justify-between p-2 bg-slate-50 rounded">
                          <span>ブレーキパッド前左:</span>
                          <span className="font-medium">{acceptanceData.measurements.brakePadFrontLeft}mm</span>
                        </div>
                      )}
                      {acceptanceData.measurements.brakePadFrontRight !== undefined && (
                        <div className="flex justify-between p-2 bg-slate-50 rounded">
                          <span>ブレーキパッド前右:</span>
                          <span className="font-medium">{acceptanceData.measurements.brakePadFrontRight}mm</span>
                        </div>
                      )}
                      {acceptanceData.measurements.tireDepthFrontLeft !== undefined && (
                        <div className="flex justify-between p-2 bg-slate-50 rounded">
                          <span>タイヤ溝前左:</span>
                          <span className="font-medium">{acceptanceData.measurements.tireDepthFrontLeft}mm</span>
                        </div>
                      )}
                      {acceptanceData.measurements.tireDepthFrontRight !== undefined && (
                        <div className="flex justify-between p-2 bg-slate-50 rounded">
                          <span>タイヤ溝前右:</span>
                          <span className="font-medium">{acceptanceData.measurements.tireDepthFrontRight}mm</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </CardContent>
            </CollapsibleContent>
          </Card>
        </Collapsible>
      )}

      {/* =================================================================== */}
      {/* 承認済み作業（After値入力） */}
      {/* =================================================================== */}
      {approvedWorkItems.length > 0 && (
        <Card className="border-slate-200 shadow-md">
          <CardHeader>
            <CardTitle className="text-lg font-semibold flex items-center gap-2">
              <Wrench className="h-5 w-5 text-slate-600 shrink-0" />
              承認済み作業
              <Badge variant="outline" className="ml-2">
                {approvedWorkItems.filter((i) => i.isCompleted).length}/{approvedWorkItems.length} 完了
              </Badge>
            </CardTitle>
          </CardHeader>
          <CardContent className="pt-0 space-y-4">
            {approvedWorkItems.map((item) => (
              <div
                key={item.id}
                className={cn(
                  "p-4 border rounded-lg transition-colors",
                  item.isCompleted ? "bg-green-50 border-green-200" : "bg-white border-slate-200"
                )}
              >
                <div className="flex items-start gap-3">
                  <Checkbox
                    id={`work-${item.id}`}
                    checked={item.isCompleted}
                    onCheckedChange={(checked) =>
                      handleWorkItemComplete(item.id, checked as boolean)
                    }
                    disabled={disabled}
                    className="mt-1 h-5 w-5"
                  />
                  <div className="flex-1">
                    <Label
                      htmlFor={`work-${item.id}`}
                      className={cn(
                        "text-base font-medium cursor-pointer",
                        item.isCompleted && "text-green-700"
                      )}
                    >
                      {item.name}
                    </Label>
                    
                    {/* Before/After表示 */}
                    {item.beforeValue !== undefined && (
                      <div className="mt-2 flex items-center gap-2 text-sm">
                        <span className="text-slate-500">Before:</span>
                        <span className="font-medium text-red-600">{item.beforeValue}mm</span>
                        <ArrowRight className="h-4 w-4 text-slate-400" />
                        <span className="text-slate-500">After:</span>
                        <Input
                          type="number"
                          value={item.afterValue ?? ""}
                          onChange={(e) =>
                            handleAfterValueChange(
                              item.id,
                              e.target.value ? parseFloat(e.target.value) : undefined
                            )
                          }
                          disabled={disabled}
                          className="w-20 h-8 text-sm"
                          placeholder="mm"
                        />
                        <span className="text-green-600 font-medium">
                          {item.afterValue !== undefined ? `${item.afterValue}mm` : ""}
                        </span>
                      </div>
                    )}
                  </div>
                  {item.isCompleted && (
                    <Check className="h-5 w-5 text-green-600 shrink-0" />
                  )}
                </div>
              </div>
            ))}
          </CardContent>
        </Card>
      )}

      {/* =================================================================== */}
      {/* 完成検査モード（車検の場合のみ表示） */}
      {/* =================================================================== */}
      {isShaken && (
        <Collapsible open={isFinalInspectionOpen} onOpenChange={setIsFinalInspectionOpen}>
          <Card className="border-slate-200 shadow-md">
            <CollapsibleTrigger asChild>
              <CardHeader className="cursor-pointer hover:bg-slate-50 transition-colors">
                <CardTitle className="text-lg font-semibold flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Gauge className="h-5 w-5 text-blue-600 shrink-0" />
                    完成検査（テスター値入力）
                  </div>
                  {isFinalInspectionOpen ? (
                    <ChevronUp className="h-5 w-5 text-slate-500" />
                  ) : (
                    <ChevronDown className="h-5 w-5 text-slate-500" />
                  )}
                </CardTitle>
              </CardHeader>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <CardContent className="pt-0 space-y-4">
                {/* サイドスリップ */}
                <div>
                  <Label htmlFor="sideSlip" className="text-base">サイドスリップ (mm/m)</Label>
                  <Input
                    id="sideSlip"
                    type="number"
                    value={finalInspectionData.sideSlip ?? ""}
                    onChange={(e) =>
                      handleFinalInspectionChange(
                        "sideSlip",
                        e.target.value ? parseFloat(e.target.value) : undefined
                      )
                    }
                    disabled={disabled}
                    className="mt-1"
                    placeholder="例: 2.5"
                  />
                </div>

                {/* ブレーキ制動力 */}
                <div>
                  <Label className="text-base mb-2 block">ブレーキ制動力 (N)</Label>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <Label htmlFor="brakeFrontLeft" className="text-sm text-slate-500">前輪左</Label>
                      <Input
                        id="brakeFrontLeft"
                        type="number"
                        value={finalInspectionData.brakeForceFrontLeft ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "brakeForceFrontLeft",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                    <div>
                      <Label htmlFor="brakeFrontRight" className="text-sm text-slate-500">前輪右</Label>
                      <Input
                        id="brakeFrontRight"
                        type="number"
                        value={finalInspectionData.brakeForceFrontRight ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "brakeForceFrontRight",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                    <div>
                      <Label htmlFor="brakeRearLeft" className="text-sm text-slate-500">後輪左</Label>
                      <Input
                        id="brakeRearLeft"
                        type="number"
                        value={finalInspectionData.brakeForceRearLeft ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "brakeForceRearLeft",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                    <div>
                      <Label htmlFor="brakeRearRight" className="text-sm text-slate-500">後輪右</Label>
                      <Input
                        id="brakeRearRight"
                        type="number"
                        value={finalInspectionData.brakeForceRearRight ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "brakeForceRearRight",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                  </div>
                </div>

                {/* スピードメーター */}
                <div>
                  <Label htmlFor="speedometer" className="text-base">スピードメーター誤差 (km/h)</Label>
                  <Input
                    id="speedometer"
                    type="number"
                    value={finalInspectionData.speedometerError ?? ""}
                    onChange={(e) =>
                      handleFinalInspectionChange(
                        "speedometerError",
                        e.target.value ? parseFloat(e.target.value) : undefined
                      )
                    }
                    disabled={disabled}
                    className="mt-1"
                    placeholder="例: 0.5"
                  />
                </div>

                {/* ヘッドライト */}
                <div>
                  <Label className="text-base mb-2 block">ヘッドライト光度 (cd)</Label>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <Label htmlFor="headlightLeft" className="text-sm text-slate-500">左</Label>
                      <Input
                        id="headlightLeft"
                        type="number"
                        value={finalInspectionData.headlightIntensityLeft ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "headlightIntensityLeft",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                    <div>
                      <Label htmlFor="headlightRight" className="text-sm text-slate-500">右</Label>
                      <Input
                        id="headlightRight"
                        type="number"
                        value={finalInspectionData.headlightIntensityRight ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "headlightIntensityRight",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                  </div>
                </div>

                {/* 排ガス */}
                <div>
                  <Label className="text-base mb-2 block">排ガス（アイドリング時）</Label>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <Label htmlFor="exhaustCO" className="text-sm text-slate-500">CO (%)</Label>
                      <Input
                        id="exhaustCO"
                        type="number"
                        step="0.01"
                        value={finalInspectionData.exhaustCO ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "exhaustCO",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                    <div>
                      <Label htmlFor="exhaustHC" className="text-sm text-slate-500">HC (ppm)</Label>
                      <Input
                        id="exhaustHC"
                        type="number"
                        value={finalInspectionData.exhaustHC ?? ""}
                        onChange={(e) =>
                          handleFinalInspectionChange(
                            "exhaustHC",
                            e.target.value ? parseFloat(e.target.value) : undefined
                          )
                        }
                        disabled={disabled}
                      />
                    </div>
                  </div>
                </div>
              </CardContent>
            </CollapsibleContent>
          </Card>
        </Collapsible>
      )}

      {/* =================================================================== */}
      {/* 交換部品等 */}
      {/* =================================================================== */}
      <Collapsible open={isReplacementPartsOpen} onOpenChange={setIsReplacementPartsOpen}>
        <Card className="border-slate-200 shadow-md hover:shadow-lg transition-shadow">
          <CollapsibleTrigger asChild>
            <CardHeader className="cursor-pointer hover:bg-slate-50 transition-colors">
              <CardTitle className="text-lg font-semibold flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Wrench className="h-5 w-5 text-slate-600 shrink-0" />
                  交換部品等
                  {replacementParts.length > 0 && (
                    <Badge variant="secondary" className="ml-2">
                      {replacementParts.length}
                    </Badge>
                  )}
                </div>
                {isReplacementPartsOpen ? (
                  <ChevronUp className="h-5 w-5 text-slate-500" />
                ) : (
                  <ChevronDown className="h-5 w-5 text-slate-500" />
                )}
              </CardTitle>
            </CardHeader>
          </CollapsibleTrigger>
          <CollapsibleContent>
            <CardContent className="pt-0 space-y-4">
              <p className="text-sm text-slate-500">
                実際に使用した交換部品を記録してください。
              </p>

              {replacementParts.length === 0 ? (
                <div className="text-center py-6 text-slate-400">
                  交換部品がありません
                </div>
              ) : (
                <div className="space-y-3">
                  {replacementParts.map((part) => (
                    <div
                      key={part.id}
                      className={cn(
                        "p-4 rounded-lg border transition-colors",
                        part.isAutoGenerated 
                          ? "bg-blue-50 border-blue-200" 
                          : "bg-white border-slate-200"
                      )}
                    >
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex-1 space-y-3">
                          {/* 部品名 */}
                          <div>
                            <Label className="text-sm text-slate-500">品目</Label>
                            {part.isAutoGenerated ? (
                              <div className="flex items-center gap-2 mt-1">
                                <span className="text-base font-medium">{part.name}</span>
                                <Badge variant="outline" className="text-xs text-blue-600 border-blue-300">
                                  自動追加
                                </Badge>
                              </div>
                            ) : (
                              <Input
                                value={part.name}
                                onChange={(e) => handlePartNameChange(part.id, e.target.value)}
                                placeholder="部品名を入力"
                                disabled={disabled}
                                className="mt-1"
                              />
                            )}
                          </div>

                          {/* 数量・品番 */}
                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <Label className="text-sm text-slate-500">数量</Label>
                              <div className="flex items-center gap-2 mt-1">
                                <Input
                                  type="number"
                                  min={1}
                                  value={part.quantity}
                                  onChange={(e) => handlePartQuantityChange(part.id, parseInt(e.target.value) || 1)}
                                  disabled={disabled}
                                  className="w-20"
                                />
                                <span className="text-base text-slate-600">{part.unit}</span>
                              </div>
                            </div>
                            <div>
                              <Label className="text-sm text-slate-500">品番（任意）</Label>
                              <Input
                                value={part.partNumber ?? ""}
                                onChange={(e) => handlePartNumberChange(part.id, e.target.value)}
                                placeholder="例: 12345-ABCDE"
                                disabled={disabled}
                                className="mt-1"
                              />
                            </div>
                          </div>
                        </div>

                        {/* 削除ボタン（自動追加以外） */}
                        {!part.isAutoGenerated && (
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => handleRemovePart(part.id)}
                            disabled={disabled}
                            className="text-slate-400 hover:text-red-500 hover:bg-red-50 shrink-0"
                          >
                            ×
                          </Button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* 部品追加ボタン */}
              <Button
                variant="outline"
                onClick={handleAddPart}
                disabled={disabled}
                className="w-full border-dashed border-2 h-12 text-base"
              >
                ＋ 部品を追加
              </Button>
            </CardContent>
          </CollapsibleContent>
        </Card>
      </Collapsible>

      {/* =================================================================== */}
      {/* 品質管理・最終検査 */}
      {/* =================================================================== */}
      <Collapsible open={isQualityCheckOpen} onOpenChange={setIsQualityCheckOpen}>
        <Card className="border-slate-200 shadow-md">
          <CollapsibleTrigger asChild>
            <CardHeader className="cursor-pointer hover:bg-slate-50 transition-colors">
              <CardTitle className="text-lg font-semibold flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <ClipboardCheck className="h-5 w-5 text-green-600 shrink-0" />
                  品質管理・最終検査
                </div>
                {isQualityCheckOpen ? (
                  <ChevronUp className="h-5 w-5 text-slate-500" />
                ) : (
                  <ChevronDown className="h-5 w-5 text-slate-500" />
                )}
              </CardTitle>
            </CardHeader>
          </CollapsibleTrigger>
          <CollapsibleContent>
            <CardContent className="pt-0 space-y-3">
              {/* タイヤ・ホイール */}
              <div className="space-y-2">
                <h4 className="text-sm font-medium text-slate-500">タイヤ・ホイール</h4>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="wheelNutTorque"
                    checked={qualityCheckData.wheelNutTorque ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("wheelNutTorque", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="wheelNutTorque" className="text-base cursor-pointer">
                    ホイールナット締付トルク
                  </Label>
                </div>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="torqueWrenchUsed"
                    checked={qualityCheckData.torqueWrenchUsed ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("torqueWrenchUsed", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="torqueWrenchUsed" className="text-base cursor-pointer">
                    トルクレンチ使用の確認
                  </Label>
                </div>
              </div>

              <Separator />

              {/* ブレーキ */}
              <div className="space-y-2">
                <h4 className="text-sm font-medium text-slate-500">ブレーキ</h4>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="brakeEffect"
                    checked={qualityCheckData.brakeEffect ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("brakeEffect", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="brakeEffect" className="text-base cursor-pointer">
                    ブレーキ効き（試運転）
                  </Label>
                </div>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="noAbnormalNoise"
                    checked={qualityCheckData.noAbnormalNoise ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("noAbnormalNoise", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="noAbnormalNoise" className="text-base cursor-pointer">
                    異音なし（試運転）
                  </Label>
                </div>
              </div>

              <Separator />

              {/* 電装系 */}
              <div className="space-y-2">
                <h4 className="text-sm font-medium text-slate-500">電装系</h4>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="allLightsOn"
                    checked={qualityCheckData.allLightsOn ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("allLightsOn", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="allLightsOn" className="text-base cursor-pointer">
                    全灯火点灯
                  </Label>
                </div>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="warningLightsOff"
                    checked={qualityCheckData.warningLightsOff ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("warningLightsOff", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="warningLightsOff" className="text-base cursor-pointer">
                    警告灯消灯
                  </Label>
                </div>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="voltageOk"
                    checked={qualityCheckData.voltageOk ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("voltageOk", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="voltageOk" className="text-base cursor-pointer">
                    電圧・充電状態
                  </Label>
                </div>
              </div>

              <Separator />

              {/* 足回り */}
              <div className="space-y-2">
                <h4 className="text-sm font-medium text-slate-500">足回り</h4>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="steeringBehavior"
                    checked={qualityCheckData.steeringBehavior ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("steeringBehavior", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="steeringBehavior" className="text-base cursor-pointer">
                    ステアリング・挙動
                  </Label>
                </div>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="noSuspensionNoise"
                    checked={qualityCheckData.noSuspensionNoise ?? false}
                    onCheckedChange={(checked) =>
                      handleQualityCheckChange("noSuspensionNoise", checked as boolean)
                    }
                    disabled={disabled}
                    className="h-5 w-5"
                  />
                  <Label htmlFor="noSuspensionNoise" className="text-base cursor-pointer">
                    足回り異音なし
                  </Label>
                </div>
              </div>
            </CardContent>
          </CollapsibleContent>
        </Card>
      </Collapsible>
    </div>
  );
}

